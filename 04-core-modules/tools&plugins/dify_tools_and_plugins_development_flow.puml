@startuml Dify工具和插件开发流程时序图
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding      6
skinparam ParticipantPadding    30

title Dify工具和插件开发流程

actor 开发者 as Developer
participant "Web前端" as Frontend
participant "API控制器" as Controller
participant "工具管理服务" as ToolService
participant "工具管理器" as ToolManager
participant "工具引擎" as ToolEngine
participant "工具实现" as ToolImpl
participant "数据库" as Database
participant "外部服务" as External

== 工具注册和配置阶段 ==

Developer -> Frontend: 访问工具管理界面
Frontend -> Controller: GET /console/api/workspaces/<workspace_id>/tool-providers
Controller -> ToolService: list_tool_providers()
ToolService -> ToolManager: list_builtin_providers()
ToolService -> ToolManager: list_plugin_providers()
ToolManager -> Database: 查询已配置的工具提供者
Database --> ToolManager: 返回工具提供者列表
ToolManager --> ToolService: 工具提供者信息
ToolService --> Controller: 工具列表数据
Controller --> Frontend: JSON响应
Frontend --> Developer: 显示工具列表

note over Developer, Frontend: 开发者可以看到内置工具、插件工具、API工具等不同类型

== 内置工具配置 ==

Developer -> Frontend: 配置内置工具（如搜索、HTTP请求等）
Frontend -> Controller: POST /console/api/workspaces/<workspace_id>/tool-provider/builtin/<provider>/add
Controller -> ToolService: 验证工具配置参数
ToolService -> ToolManager: get_builtin_provider(provider_name)
ToolManager -> Database: 保存工具配置和凭据
Database --> ToolManager: 确认保存
ToolManager --> ToolService: 配置成功
ToolService --> Controller: 返回结果
Controller --> Frontend: 配置成功响应
Frontend --> Developer: 显示配置完成

== API工具开发 ==

Developer -> Frontend: 创建自定义API工具
Frontend -> Controller: POST /console/api/workspaces/<workspace_id>/tool-provider/api
note over Controller: 包含API规范（OpenAPI/Swagger）
Controller -> ToolService: 验证API规范
ToolService -> ToolManager: get_api_provider_controller()
ToolManager -> External: 验证API端点可访问性
External --> ToolManager: 验证结果
ToolManager -> Database: 保存API工具配置
Database --> ToolManager: 确认保存
ToolManager --> ToolService: API工具创建成功
ToolService --> Controller: 返回API工具信息
Controller --> Frontend: 创建成功响应
Frontend --> Developer: 显示API工具已创建

== 插件工具开发 ==

Developer -> Frontend: 上传插件工具包
Frontend -> Controller: POST /console/api/workspaces/<workspace_id>/tool-provider/plugin
Controller -> ToolService: 验证插件包
ToolService -> ToolManager: get_plugin_provider()
ToolManager -> ToolManager: 解析插件manifest
ToolManager -> Database: 保存插件信息
Database --> ToolManager: 确认保存
ToolManager --> ToolService: 插件注册成功
ToolService --> Controller: 返回插件信息
Controller --> Frontend: 上传成功响应
Frontend --> Developer: 显示插件已安装

== MCP工具配置 ==

Developer -> Frontend: 配置MCP工具服务器
Frontend -> Controller: POST /console/api/workspaces/<workspace_id>/tool-provider/mcp
Controller -> ToolService: 验证MCP服务器配置
ToolService -> ToolManager: get_mcp_provider_controller()
ToolManager -> External: 连接MCP服务器并获取工具列表
External --> ToolManager: MCP工具列表
ToolManager -> Database: 保存MCP工具配置
Database --> ToolManager: 确认保存
ToolManager --> ToolService: MCP工具配置成功
ToolService --> Controller: 返回MCP工具信息
Controller --> Frontend: 配置成功响应
Frontend --> Developer: 显示MCP工具已配置

== 工具运行时执行阶段 ==

note over Developer, External: 当用户在应用中使用工具时的执行流程

Developer -> Frontend: 在应用中调用工具
Frontend -> Controller: POST /service-api/apps/<app_id>/chat-messages
note over Controller: 包含工具调用请求
Controller -> ToolEngine: agent_invoke() 或 generic_invoke()
ToolEngine -> ToolManager: get_tool_runtime(provider_type, provider_name, tool_name)

alt 内置工具
    ToolManager -> ToolImpl: 创建BuiltinTool实例
    ToolImpl -> ToolEngine: 返回工具运行时
else API工具
    ToolManager -> ToolImpl: 创建ApiTool实例
    ToolImpl -> ToolEngine: 返回工具运行时
else 插件工具
    ToolManager -> ToolImpl: 创建PluginTool实例
    ToolImpl -> ToolEngine: 返回工具运行时
else MCP工具
    ToolManager -> ToolImpl: 创建MCPTool实例
    ToolImpl -> ToolEngine: 返回工具运行时
end

ToolEngine -> ToolImpl: invoke(user_id, tool_parameters)
ToolImpl -> External: 调用外部服务/API
External --> ToolImpl: 返回执行结果
ToolImpl --> ToolEngine: 工具执行结果
ToolEngine -> ToolEngine: _convert_tool_response_to_str()
ToolEngine -> ToolEngine: _extract_tool_response_binary_and_text()
ToolEngine --> Controller: 格式化的工具结果
Controller --> Frontend: 包含工具结果的响应
Frontend --> Developer: 显示工具执行结果

== 工具监控和管理 ==

Developer -> Frontend: 查看工具使用统计
Frontend -> Controller: GET /console/api/workspaces/<workspace_id>/tool-provider/<provider>/tools
Controller -> ToolService: 获取工具使用统计
ToolService -> Database: 查询工具调用日志
Database --> ToolService: 工具统计数据
ToolService --> Controller: 统计信息
Controller --> Frontend: 工具使用报告
Frontend --> Developer: 显示工具性能指标

== 工具更新和维护 ==

Developer -> Frontend: 更新工具配置
Frontend -> Controller: PUT /console/api/workspaces/<workspace_id>/tool-provider/<provider>
Controller -> ToolService: 验证新配置
ToolService -> ToolManager: 更新工具提供者配置
ToolManager -> Database: 保存更新
Database --> ToolManager: 确认更新
ToolManager -> ToolManager: clear_hardcoded_providers_cache()
note over ToolManager: 清除缓存确保新配置生效
ToolManager --> ToolService: 更新成功
ToolService --> Controller: 返回更新结果
Controller --> Frontend: 更新成功响应
Frontend --> Developer: 显示配置已更新

@enduml