@startuml Excel文档导入流程
!theme plain
skinparam backgroundColor white
skinparam sequenceArrowColor black
skinparam sequenceLifeLineBackgroundColor white
skinparam sequenceLifeLineBorderColor black
skinparam sequenceParticipantBackgroundColor lightblue

title Excel 文档详细导入流程

actor "用户" as User
participant "前端Web" as Web
participant "DatasetInitApi" as API
participant "DocumentService" as DocService
participant "IndexingRunner" as Runner
participant "IndexProcessorFactory" as Factory
participant "ExcelExtractor" as Extractor
participant "TextSplitter" as Splitter
participant "DatasetDocumentStore" as DocStore
participant "Vector Database" as VDB
participant "PostgreSQL" as DB

== 1. 文档上传阶段 ==
User -> Web: 选择Excel文件上传
Web -> API: POST /datasets/init\n{upload_file_id, indexing_technique, process_rule}
note right
  请求参数包含：
  - upload_file_id: 文件ID
  - indexing_technique: high_quality/economy
  - process_rule: 分段规则
  - doc_form: text_model/hierarchical_model
end note

API -> API: 验证用户权限和配置
note right
  验证内容：
  - 用户是否有数据集编辑权限
  - embedding模型配置（高质量索引）
  - 文档上传配额限制
end note

== 2. 数据集创建阶段 ==
API -> DocService: save_document_without_dataset_id()
DocService -> DB: 创建Dataset记录
note right
  Dataset属性：
  - tenant_id, name
  - data_source_type: upload_file
  - indexing_technique
  - embedding_model/provider
  - collection_binding_id
end note

DocService -> DocService: save_document_with_dataset_id()
DocService -> DB: 创建Document记录
note right
  Document属性：
  - dataset_id, name, data_source_info
  - doc_form (text_model/hierarchical_model)
  - doc_language, indexing_status: waiting
  - batch: 批次标识符
end note

== 3. 异步索引处理阶段 ==
DocService -> Runner: 异步触发索引任务
note right
  IndexingRunner.run()
  处理文档列表
end note

Runner -> Runner: run_in_splitting_status()
note right
  更新状态：indexing_status = splitting
end note

== 4. 文档提取阶段 ==
Runner -> Factory: IndexProcessorFactory(doc_form)
Factory -> Factory: init_index_processor()
note right
  根据doc_form选择处理器：
  - text_model → ParagraphIndexProcessor
  - hierarchical_model → ParentChildIndexProcessor
  - qa_model → QAIndexProcessor
end note

Runner -> Runner: _extract()
Runner -> Extractor: ExcelExtractor.extract()

note over Extractor
**Excel 处理核心逻辑**
1. 检测文件类型 (.xlsx/.xls)
2. 使用 openpyxl/pandas 读取
3. 遍历工作表
4. 逐行处理数据
end note

Extractor -> Extractor: 处理.xlsx文件
note right
  使用 openpyxl.load_workbook()
  - data_only=True 获取计算值
  - 提取超链接信息
  - 支持多工作表
end note

Extractor -> Extractor: 处理每行数据
note right
  **行数据转换格式**：
  原始: | 产品名称 | 价格 | 描述 |
        | 笔记本A | 5000 | 高性能 |
  
  转换为: "产品名称":"笔记本A";"价格":"5000";"描述":"高性能"
end note

Extractor -> Runner: 返回Document列表
note right
  每行数据 = 一个Document对象
  page_content = 键值对字符串
  metadata = {source: file_path}
end note

== 5. 文档转换阶段 ==
Runner -> Runner: _transform()
Runner -> Splitter: TextSplitter处理

note over Splitter
**文本分割处理**
1. 默认chunk_size=4000字符
2. chunk_overlap=200字符  
3. 分割优先级: \n\n → \n → 空格 → 字符级
4. 保持键值对结构完整性
end note

Splitter -> Splitter: split_documents()
note right
  **分割风险评估**：
  - 单行 < 4000字符：保持完整
  - 单行 > 4000字符：可能按空格分割
  - 风险：破坏"列名":"值"结构
end note

Splitter -> Runner: 返回分割后的Documents

Runner -> Runner: 生成doc_id和hash
note right
  为每个分块生成：
  - doc_id: UUID
  - doc_hash: 内容哈希
  - 清理前导符号
end note

== 6. 分段存储阶段 ==
Runner -> Runner: _load_segments()
Runner -> DocStore: DatasetDocumentStore.add_documents()

DocStore -> DB: 保存DocumentSegment记录
note right
  DocumentSegment属性：
  - dataset_id, document_id
  - content: 分段内容
  - word_count, tokens
  - position: 段落位置
  - index_node_id: 向量索引ID
  - status: completed
end note

alt 父子分段模式
    DocStore -> DB: 保存ChildChunk记录
    note right
      ChildChunk属性：
      - segment_id, position
      - content: 子分块内容
      - index_node_id: 向量索引ID
    end note
end

== 7. 向量索引阶段 ==
Runner -> Runner: _load()

alt 高质量索引 (high_quality)
    Runner -> Runner: 并发处理分块
    note right
      ThreadPoolExecutor(max_workers=10)
      按内容哈希分组避免死锁
    end note
    
    loop 每个分块组
        Runner -> VDB: 创建向量索引
        note right
          使用embedding模型生成向量
          存储到向量数据库
          (Weaviate/Qdrant/Milvus等)
        end note
    end
end

alt 经济索引 (economy)
    Runner -> DB: 创建关键词索引
    note right
      使用jieba分词
      创建倒排索引
      存储在PostgreSQL
    end note
end

== 8. 完成处理 ==
Runner -> DB: 更新Document状态
note right
  更新属性：
  - indexing_status: completed
  - completed_at: 当前时间
  - tokens: 总token数
  - indexing_latency: 处理耗时
end note

DB -> API: 返回处理结果
API -> Web: 返回成功响应
Web -> User: 显示导入完成

note over User, VDB
**Excel导入关键特性**：
1. 保持表头语义：每个值都有对应列名
2. 行级完整性：单行数据不跨Document分散  
3. 结构化存储：键值对格式便于检索
4. 支持超链接：xlsx文件保留链接信息
5. 多工作表：自动处理所有工作表
6. 容错处理：跳过空行和无效数据
end note

@enduml