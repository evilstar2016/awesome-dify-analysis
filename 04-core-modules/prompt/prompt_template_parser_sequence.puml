@startuml Prompt_Template_Parser_Sequence
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding      6
skinparam ParticipantPadding    30

title PromptTemplateParser 模板解析流程时序图

actor "PromptTransform" as Transform
participant "PromptTemplateParser" as Parser
participant "Regex Engine" as Regex

== 1. 创建解析器 ==

Transform -> Parser: new PromptTemplateParser(template, with_variable_tmpl=False)
activate Parser

Parser -> Parser: 保存 template
Parser -> Parser: 保存 with_variable_tmpl

alt with_variable_tmpl == True
    Parser -> Parser: regex = WITH_VARIABLE_TMPL_REGEX
    note right
        支持 Workflow 变量语法:
        {{#node_id.variable_name#}}
    end note
else with_variable_tmpl == False
    Parser -> Parser: regex = REGEX
    note right
        标准变量语法:
        {{variable_name}}
        {{#special#}}
    end note
end

== 2. 提取变量 ==

Parser -> Parser: variable_keys = extract()

Parser -> Regex: re.findall(regex, template)
activate Regex

note over Regex
    正则表达式匹配规则:
    
    REGEX:
    \{\{([a-zA-Z_][a-zA-Z0-9_]{0,29}|#histories#|#query#|#context#)\}\}
    
    WITH_VARIABLE_TMPL_REGEX:
    \{\{([a-zA-Z_][a-zA-Z0-9_]{0,29}|
        #[a-zA-Z0-9_]{1,50}\.[a-zA-Z0-9_\.]{1,100}#|
        #histories#|#query#|#context#)\}\}
end note

Regex --> Parser: variable_keys
deactivate Regex

note right of Parser
    示例:
    模板: "Hello {{name}}, context: {{#context#}}"
    提取: ["name", "#context#"]
end note

Parser --> Transform: parser 实例
deactivate Parser

== 3. 格式化模板 ==

Transform -> Parser: format(inputs, remove_template_variables=True)
activate Parser

note right of Transform
    inputs 示例:
    {
        "name": "Alice",
        "#context#": "Some context text",
        "#query#": "User question"
    }
end note

Parser -> Parser: 定义 replacer 函数

Parser -> Regex: re.sub(regex, replacer, template)
activate Regex

loop 每个匹配的变量
    Regex -> Parser: 调用 replacer(match)
    
    Parser -> Parser: key = match.group(1)
    Parser -> Parser: value = inputs.get(key, match.group(0))
    note right
        如果 key 不在 inputs 中，
        保留原始匹配字符串
    end note
    
    alt remove_template_variables == True
        Parser -> Parser: remove_template_variables(value)
        note right
            将嵌套的 {{var}} 转换为 {var}
            防止二次解析
        end note
    end
    
    Parser --> Regex: 替换后的值
end

Regex --> Parser: 格式化后的模板
deactivate Regex

== 4. 清理特殊标记 ==

Parser -> Regex: re.sub(r"<\|.*?\|>", "", prompt)
activate Regex
note right
    移除 <|...|> 格式的特殊标记
    （用于模型特定的控制标记）
end note
Regex --> Parser: 清理后的 prompt
deactivate Regex

Parser --> Transform: 最终格式化的 prompt
deactivate Parser

== 使用示例 ==

note over Transform, Parser
    输入模板:
    "你好 {{name}}！以下是上下文信息：\n{{#context#}}\n\n请回答：{{#query#}}"
    
    输入变量:
    {"name": "用户", "#context#": "产品文档...", "#query#": "如何使用?"}
    
    输出结果:
    "你好 用户！以下是上下文信息：\n产品文档...\n\n请回答：如何使用?"
end note

@enduml
