@startuml Dify 工作流组件开发流程
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding      6
skinparam ParticipantPadding    30

title Dify 工作流组件开发流程时序图

actor Developer as dev
box "Backend (Python)" #E3F2FD
    participant "entities.py\n(节点数据模型)" as entities
    participant "your_node.py\n(节点实现)" as node
    participant "enums.py\n(节点类型枚举)" as enums
    participant "node_mapping.py\n(节点映射)" as mapping
end box

box "Frontend (TypeScript/React)" #E8F5E9
    participant "types.ts\n(类型定义)" as ftypes
    participant "default.ts\n(默认配置)" as fdefault
    participant "node.tsx\n(节点组件)" as fnode
    participant "panel.tsx\n(配置面板)" as fpanel
    participant "components.ts\n(组件注册)" as fcomponents
end box

box "Resources" #FFF3E0
    participant "i18n\n(国际化)" as i18n
    participant "tests\n(测试)" as tests
end box

== 1. 后端开发阶段 ==

dev -> entities : 1.1 创建节点数据模型
activate entities
note right of entities
  继承 BaseNodeData
  定义配置字段:
  - variables
  - 节点特定配置
end note
entities --> dev : YourNodeData 类
deactivate entities

dev -> node : 1.2 实现节点类
activate node
note right of node
  继承 Node 基类
  实现核心方法:
  - init_node_data()
  - _run()
  - version()
  - get_default_config()
end note
node -> entities : 引用 YourNodeData
node --> dev : YourNode 类
deactivate node

dev -> enums : 1.3 注册节点类型
activate enums
note right of enums
  在 NodeType 枚举中添加:
  YOUR_NODE = "your-node"
end note
enums --> dev : NodeType.YOUR_NODE
deactivate enums

dev -> mapping : 1.4 注册节点映射
activate mapping
note right of mapping
  在 NODE_TYPE_CLASSES_MAPPING 中添加:
  NodeType.YOUR_NODE: {
    LATEST_VERSION: YourNode,
    "1": YourNode,
  }
end note
mapping -> node : 引用 YourNode
mapping --> dev : 映射完成
deactivate mapping

== 2. 前端开发阶段 ==

dev -> ftypes : 2.1 定义节点类型
activate ftypes
note right of ftypes
  在 BlockEnum 中添加:
  YourNode = 'your-node'
  
  创建 types.ts:
  export type YourNodeType = CommonNodeType & {...}
end note
ftypes --> dev : BlockEnum.YourNode
deactivate ftypes

dev -> fdefault : 2.2 创建默认配置
activate fdefault
note right of fdefault
  定义 NodeDefault:
  - metaData (分类、排序)
  - defaultValue (默认值)
  - checkValid (验证函数)
  - getOutputVars (输出变量)
end note
fdefault -> ftypes : 引用 YourNodeType
fdefault --> dev : nodeDefault
deactivate fdefault

dev -> fnode : 2.3 实现节点组件
activate fnode
note right of fnode
  画布上的节点预览
  显示关键配置信息
end note
fnode -> ftypes : 引用 YourNodeType
fnode --> dev : Node 组件
deactivate fnode

dev -> fpanel : 2.4 实现配置面板
activate fpanel
note right of fpanel
  右侧配置面板
  - 变量选择器
  - 配置输入项
  - 表单验证
end note
fpanel -> ftypes : 引用 YourNodeType
fpanel --> dev : Panel 组件
deactivate fpanel

dev -> fcomponents : 2.5 注册组件
activate fcomponents
note right of fcomponents
  在 NodeComponentMap 添加:
  [BlockEnum.YourNode]: YourNodeNode
  
  在 PanelComponentMap 添加:
  [BlockEnum.YourNode]: YourNodePanel
end note
fcomponents -> fnode : 引用 Node
fcomponents -> fpanel : 引用 Panel
fcomponents --> dev : 注册完成
deactivate fcomponents

== 3. 资源配置阶段 ==

dev -> i18n : 3.1 添加国际化文本
activate i18n
note right of i18n
  在 en-US/workflow.ts 添加:
  nodes.yourNode: {
    title, description, ...
  }
  
  在其他语言文件添加翻译
end note
i18n --> dev : 国际化完成
deactivate i18n

dev -> tests : 3.2 编写测试
activate tests
note right of tests
  后端单元测试:
  tests/unit_tests/core/workflow/nodes/
  
  使用 pytest 框架
  Arrange-Act-Assert 模式
end note
tests --> dev : 测试用例
deactivate tests

== 4. 验证阶段 ==

dev -> dev : 4.1 本地测试
note right of dev
  后端检查:
  - make lint
  - make type-check
  - pytest
  
  前端检查:
  - pnpm lint
  - pnpm test
end note

dev -> dev : 4.2 功能验证
note right of dev
  - 启动开发环境
  - 在工作流编辑器中添加新节点
  - 配置节点参数
  - 运行工作流验证
end note

@enduml
