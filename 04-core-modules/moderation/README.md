# å†…å®¹å®¡æ ¸æ¨¡å—ï¼ˆModerationï¼‰

## æ¨¡å—æ¦‚è¿°

å†…å®¹å®¡æ ¸ï¼ˆModerationï¼‰æ¨¡å—æ˜¯ Dify å¹³å°çš„æ ¸å¿ƒå®‰å…¨åŠŸèƒ½ï¼Œè´Ÿè´£å¯¹ç”¨æˆ·è¾“å…¥å’Œ LLM è¾“å‡ºè¿›è¡Œå†…å®¹åˆè§„æ€§æ£€æŸ¥ã€‚è¯¥æ¨¡å—é‡‡ç”¨**æ’ä»¶åŒ–æ¶æ„**ï¼Œæ”¯æŒå¤šç§å®¡æ ¸ç­–ç•¥ï¼ˆå…³é”®è¯ã€OpenAIã€è‡ªå®šä¹‰APIç­‰ï¼‰ï¼Œå¹¶èƒ½å¤Ÿçµæ´»é…ç½®è¾“å…¥/è¾“å‡ºå®¡æ ¸è§„åˆ™ã€‚

**æ ¸å¿ƒä»·å€¼**ï¼š
- ğŸ›¡ï¸ **å†…å®¹å®‰å…¨**ï¼šé˜²æ­¢ä¸å½“å†…å®¹çš„è¾“å…¥å’Œè¾“å‡º
- ğŸ”Œ **æ‰©å±•æ€§**ï¼šæ”¯æŒå¤šç§ç¬¬ä¸‰æ–¹å®¡æ ¸æœåŠ¡é›†æˆ
- âš™ï¸ **çµæ´»é…ç½®**ï¼šç‹¬ç«‹é…ç½®è¾“å…¥å’Œè¾“å‡ºå®¡æ ¸ç­–ç•¥
- ğŸ“Š **å¯è§‚æµ‹**ï¼šé›†æˆ Trace ç³»ç»Ÿè¿›è¡Œå®¡æ ¸å†³ç­–è·Ÿè¸ª

## ä¸»è¦åŠŸèƒ½

1. **è¾“å…¥å®¡æ ¸** - å¯¹ç”¨æˆ·æäº¤çš„å†…å®¹è¿›è¡Œå®¡æ ¸
   - æ£€æŸ¥ç”¨æˆ·è¾“å…¥å’ŒæŸ¥è¯¢å†…å®¹
   - æ ¹æ®å®¡æ ¸ç»“æœç›´æ¥æ‹’ç»æˆ–ä¿®æ”¹
   - æ€§èƒ½è¿½è¸ªå’Œé”™è¯¯è®°å½•

2. **è¾“å‡ºå®¡æ ¸** - å¯¹ LLM ç”Ÿæˆçš„å†…å®¹è¿›è¡Œå®¡æ ¸
   - æµå¼è¾“å‡ºå®æ—¶å®¡æ ¸
   - ç¼“å†²å¼æ‰¹é‡å®¡æ ¸
   - å¼‚æ­¥å¤šçº¿ç¨‹å¤„ç†

3. **å®¡æ ¸ç­–ç•¥** - å¤šç§å†…ç½®å’Œå¯æ‰©å±•çš„å®¡æ ¸æ–¹æ¡ˆ
   - å…³é”®è¯åŒ¹é…ï¼ˆkeywordsï¼‰
   - OpenAI å®˜æ–¹å®¡æ ¸ API
   - è‡ªå®šä¹‰ API é›†æˆï¼ˆapiï¼‰

4. **çµæ´»é…ç½®** - åº”ç”¨çº§å®¡æ ¸è§„åˆ™ç®¡ç†
   - ç‹¬ç«‹é…ç½®è¾“å…¥/è¾“å‡ºå®¡æ ¸
   - åŠ¨æ€ç”Ÿæ•ˆæ— éœ€é‡å¯
   - é¢„è®¾å“åº”æ¶ˆæ¯å®šåˆ¶

## ç›®å½•ç»“æ„

```
api/core/moderation/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ base.py                          # åŸºç±»å’Œæ•°æ®æ¨¡å‹
â”œâ”€â”€ factory.py                       # å·¥å‚ç±»
â”œâ”€â”€ input_moderation.py              # è¾“å…¥å®¡æ ¸å…¥å£
â”œâ”€â”€ output_moderation.py             # è¾“å‡ºå®¡æ ¸å…¥å£
â”œâ”€â”€ keywords/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ keywords.py                  # å…³é”®è¯å®¡æ ¸å®ç°
â”œâ”€â”€ openai_moderation/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ openai_moderation.py         # OpenAI å®¡æ ¸å®ç°
â””â”€â”€ api/
    â”œâ”€â”€ __init__.py
    â””â”€â”€ api.py                       # è‡ªå®šä¹‰ API å®¡æ ¸å®ç°
```

## æ ¸å¿ƒæµç¨‹

- [è¾“å…¥å®¡æ ¸æµç¨‹](./01-input-moderation-sequence.puml) - ç”¨æˆ·è¾“å…¥æäº¤æ—¶çš„å®¡æ ¸æµç¨‹
- [è¾“å‡ºå®¡æ ¸æµç¨‹](./02-output-moderation-sequence.puml) - LLM è¾“å‡ºç”Ÿæˆæ—¶çš„å®¡æ ¸æµç¨‹
- [ç­–ç•¥æ‰©å±•æµç¨‹](./03-moderation-extension-sequence.puml) - æ–°å¢è‡ªå®šä¹‰å®¡æ ¸ç­–ç•¥çš„æµç¨‹

## ç›¸å…³æ–‡æ¡£

- [åŠŸèƒ½è¯¦ç»†è¯´æ˜](./moderation-management.md) - å®¡æ ¸é€»è¾‘ã€API æ¥å£ã€é…ç½®è¯´æ˜
- [å­åŠŸèƒ½åˆ†æ](./sub-features/) - å„ä¸ªå®¡æ ¸å®ç°çš„æ·±åº¦åˆ†æ

## æŠ€æœ¯æ ˆ

| æŠ€æœ¯/æ¡†æ¶ | ç‰ˆæœ¬/è¯´æ˜ |
|----------|---------|
| Python | 3.10+ |
| Pydantic | æ•°æ®éªŒè¯ |
| Flask | åº”ç”¨æ¡†æ¶ |
| Threading | å¼‚æ­¥å®¡æ ¸å¤„ç† |
| æ‰©å±•ç³»ç»Ÿ | æ’ä»¶åŒ–æ¶æ„ |

## ä¾èµ–å…³ç³»

### ä¾èµ–çš„æ¨¡å—
- **core.extension** - æ‰©å±•æ¡†æ¶
- **core.model_manager** - æ¨¡å‹ç®¡ç†ï¼ˆç”¨äº OpenAI å®¡æ ¸ï¼‰
- **core.app** - åº”ç”¨é…ç½®ç®¡ç†
- **core.ops** - å¯è§‚æµ‹æ€§è¿½è¸ª

### è¢«ä¾èµ–çš„æ¨¡å—
- **core.app.apps.base_app_runner** - åŸºç¡€åº”ç”¨è¿è¡Œå™¨
- **core.app.apps.advanced_chat.app_runner** - é«˜çº§èŠå¤©åº”ç”¨
- **core.app.task_pipeline.based_generate_task_pipeline** - ä»»åŠ¡ç®¡é“

## API æ¥å£

### è¾“å…¥å®¡æ ¸æ¥å£

| æ¥å£ | ç­¾å | è¯´æ˜ |
|-----|------|------|
| `InputModeration.check()` | `(app_id, tenant_id, app_config, inputs, query, message_id, trace_manager) â†’ tuple` | æ‰§è¡Œè¾“å…¥å®¡æ ¸æ£€æŸ¥ |

### è¾“å‡ºå®¡æ ¸æ¥å£

| æ¥å£ | ç­¾å | è¯´æ˜ |
|-----|------|------|
| `OutputModeration.append_new_token()` | `(token: str) â†’ None` | è¿½åŠ æ–°çš„ç”Ÿæˆ token |
| `OutputModeration.moderation_completion()` | `(completion: str, public_event: bool) â†’ tuple` | å®¡æ ¸å®Œæˆçš„è¾“å‡º |
| `OutputModeration.should_direct_output()` | `() â†’ bool` | æ˜¯å¦åº”ç›´æ¥è¾“å‡º |
| `OutputModeration.get_final_output()` | `() â†’ str` | è·å–æœ€ç»ˆå®¡æ ¸åçš„è¾“å‡º |

## é…ç½®é€‰é¡¹

### åº”ç”¨çº§å®¡æ ¸é…ç½®

```python
# æ•æ„Ÿè¯å›é¿é…ç½®
sensitive_word_avoidance: {
    type: str,              # "keywords", "openai_moderation", "api"
    config: {
        inputs_config: {
            enabled: bool,
            preset_response: str
        },
        outputs_config: {
            enabled: bool,
            preset_response: str
        }
        # ç­–ç•¥ç‰¹å®šå‚æ•°...
    }
}
```

## æ‰©å±•ç‚¹

### æ–°å¢å®¡æ ¸ç­–ç•¥

1. **å®ç°åŸºç±»** - ç»§æ‰¿ `Moderation`
2. **æ³¨å†Œç­–ç•¥** - é€šè¿‡æ‰©å±•ç³»ç»Ÿæ³¨å†Œ
3. **é…ç½®éªŒè¯** - å®ç° `validate_config` æ–¹æ³•
4. **å®¡æ ¸é€»è¾‘** - å®ç° `moderation_for_inputs` å’Œ `moderation_for_outputs`

è¯¦è§ [sub-features/custom-moderation.md](./sub-features/custom-moderation.md)

## æµ‹è¯•è¦†ç›–

- å•å…ƒæµ‹è¯•ï¼š[api/tests/unit_tests/core/moderation/](../../../api/tests/unit_tests/core/moderation/)
- æµ‹è¯•æ–‡ä»¶ï¼š
  - `test_content_moderation.py` - ç»¼åˆæµ‹è¯•ï¼ˆå…³é”®è¯ã€OpenAI å®¡æ ¸ã€å·¥å‚æ¨¡å¼ï¼‰
  - `test_sensitive_word_filter.py` - å…³é”®è¯è¿‡æ»¤è¯¦ç»†æµ‹è¯•
- æµ‹è¯•ç±»ï¼š`TestKeywordsModeration`, `TestOpenAIModeration`, `TestModerationFactoryIntegration`
- è¦†ç›–åœºæ™¯ï¼šé…ç½®éªŒè¯ã€è¾“å…¥å®¡æ ¸ã€è¾“å‡ºå®¡æ ¸ã€å¼‚å¸¸å¤„ç†ã€å¤šè¯­è¨€æ”¯æŒã€æ€§èƒ½æµ‹è¯•

## å…³é”®è®¾è®¡æ¨¡å¼

| æ¨¡å¼ | åº”ç”¨ |
|-----|------|
| **å·¥å‚æ¨¡å¼** | `ModerationFactory` åˆ›å»ºä¸åŒå®¡æ ¸å®ç° |
| **ç­–ç•¥æ¨¡å¼** | å¤šç§å®¡æ ¸ç­–ç•¥ï¼ˆå…³é”®è¯ã€APIã€OpenAIï¼‰çš„åˆ‡æ¢ |
| **è£…é¥°è€…æ¨¡å¼** | `InputModeration`ã€`OutputModeration` åŒ…è£…å®¡æ ¸é€»è¾‘ |
| **æ‰©å±•ç³»ç»Ÿ** | åŸºäº `Extensible` æ¡†æ¶çš„æ’ä»¶åŒ–è®¾è®¡ |

## æ€§èƒ½è€ƒè™‘

- **ç¼“å†²æœºåˆ¶** - `OutputModeration` ä½¿ç”¨ç¼“å†²åŒºå’Œçº¿ç¨‹è¿›è¡Œå¼‚æ­¥å®¡æ ¸
- **å•çº¿ç¨‹å¤„ç†** - é¿å…å¹¶å‘å®¡æ ¸å¯¼è‡´çš„æ•°æ®ç«äº‰
- **è¶…æ—¶ä¿æŠ¤** - å®¡æ ¸è¿‡ç¨‹ä¸­çš„å¼‚å¸¸è¢«æ•è·å’Œè®°å½•
- **å†…å­˜ä¼˜åŒ–** - å…³é”®è¯é¢„å¤„ç†å’Œç¼“å­˜

## å·²çŸ¥é™åˆ¶

1. å…³é”®è¯å®¡æ ¸é™åˆ¶ï¼šæœ€å¤š 10000 å­—ç¬¦ï¼Œ100 è¡Œ
2. è¾“å‡ºå®¡æ ¸ä»…æ”¯æŒæ–‡æœ¬å†…å®¹
3. OpenAI å®¡æ ¸ä¾èµ–ç½‘ç»œè¿æ¥
4. ç¼“å†²å®¡æ ¸å­˜åœ¨æ•°ç§’å»¶è¿Ÿ
