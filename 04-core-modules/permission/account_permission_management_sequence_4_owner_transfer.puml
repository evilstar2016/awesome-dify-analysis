@startuml AccountPermission_OwnerTransfer
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding 6
skinparam ParticipantPadding 30

title Dify 账号权限管理核心流程 - 4. 安全的所有权转移

participant CurrentOwner as "当前所有者\n(OWNER)"
participant EmailClient as "邮件客户端"
participant API as "转移API"
participant AccountService as "AccountService\n(令牌服务)"
participant Database as "数据库"
participant RedisCache as "Redis\n(令牌存储)"
participant EmailService as "邮件任务"

autonumber

note over CurrentOwner
  所有权转移是一个三步骤的安全过程：
  1. 发送确认邮件到当前所有者
  2. 验证邮件中的验证码
  3. 转移给目标成员
end note

CurrentOwner ->> API: POST /workspaces/current/members/send-owner-transfer-confirm-email\n{language: "en-US"}
activate API

note over API
  装饰器验证：
  - @is_allow_transfer_owner 
  - @account_initialization_required
  - @login_required
end note

API ->> API: current_user = current_account_with_tenant()

API ->> AccountService: is_email_send_ip_limit(ip_address)
activate AccountService
AccountService -->> API: is_limited (bool)
deactivate AccountService

alt 达到IP发送限制
  API -->> CurrentOwner: EmailSendIpLimitError\n429 Too Many Requests
  deactivate API
else IP 未限制
  
  API ->> API: 验证当前用户是 OWNER\nTenantService.is_owner(user, tenant)
  
  alt 不是 OWNER
    API -->> CurrentOwner: NotOwnerError\n403 Forbidden
    deactivate API
  else 是 OWNER
    
    note over API
      生成转移验证令牌和验证码
    end note
    
    API ->> AccountService: send_owner_transfer_email(\n  account, email, language, workspace_name)
    activate AccountService
    
    AccountService ->> AccountService: code = generate_6digit_code()
    
    AccountService ->> AccountService: token = TokenManager.generate_token(\n  account=user,\n  token_type="owner_transfer",\n  additional_data={code: code})
    
    note over AccountService
      令牌包含：
      - 账号 ID
      - 邮箱
      - 验证码
      - 过期时间
    end note
    
    AccountService ->> RedisCache: 存储令牌和验证码
    activate RedisCache
    RedisCache -->> AccountService: stored
    deactivate RedisCache
    
    AccountService ->> EmailService: send_owner_transfer_confirm_task(\n  email, code, workspace_name, language)
    activate EmailService
    EmailService -->> AccountService: task_queued
    deactivate EmailService
    
    AccountService -->> API: token
    deactivate AccountService
    
    API -->> CurrentOwner: {result: "success", data: token}\n200 OK
    
  end
  
end

deactivate API

CurrentOwner ->> EmailClient: 收到邮件\n包含验证码

note over EmailClient
  邮件内容：
  - 验证码（6位数字）
  - 工作区名称
  - 警告信息
end note

CurrentOwner ->> API: POST /workspaces/current/members/owner-transfer-check\n{token: token, code: "123456"}
activate API

API ->> AccountService: is_owner_transfer_error_rate_limit(\n  user_email)
activate AccountService
AccountService -->> API: is_limited (bool)
deactivate AccountService

alt 超过尝试限制
  API -->> CurrentOwner: OwnerTransferLimitError\n429 Too Many Requests
  deactivate API
else 未超过限制
  
  API ->> AccountService: get_owner_transfer_data(token)
  activate AccountService
  
  note over AccountService
    从 Redis 获取令牌数据
  end note
  
  AccountService ->> RedisCache: GET owner_transfer_token:{token_hash}
  activate RedisCache
  RedisCache -->> AccountService: token_data | null
  deactivate RedisCache
  
  alt 令牌不存在或过期
    AccountService -->> API: null
    API -->> CurrentOwner: InvalidTokenError\n400 Bad Request
    deactivate API
    deactivate AccountService
  else 令牌有效
    
    AccountService -->> API: token_data {email, code}
    deactivate AccountService
    
    API ->> API: 验证邮箱匹配\nif token_data.email != current_user.email
    
    alt 邮箱不匹配
      API -->> CurrentOwner: InvalidEmailError\n400 Bad Request
      deactivate API
    else 邮箱匹配
      
      alt 验证码错误
        API ->> AccountService: add_owner_transfer_error_rate_limit(\n  user_email)
        activate AccountService
        AccountService -->> API: limit_added
        deactivate AccountService
        
        API -->> CurrentOwner: EmailCodeError\n400 Bad Request
        deactivate API
      else 验证码正确
        
        note over API
          验证通过，撤销原令牌并生成新令牌
        end note
        
        API ->> AccountService: revoke_owner_transfer_token(token)
        activate AccountService
        
        AccountService ->> RedisCache: DEL owner_transfer_token:{hash}
        activate RedisCache
        RedisCache -->> AccountService: deleted
        deactivate RedisCache
        
        AccountService -->> API: revoked
        deactivate AccountService
        
        API ->> AccountService: generate_owner_transfer_token(\n  email, code, additional_data={})
        activate AccountService
        
        AccountService ->> AccountService: new_token = TokenManager.generate_token(...)
        
        AccountService ->> RedisCache: 存储新令牌
        activate RedisCache
        RedisCache -->> AccountService: stored
        deactivate RedisCache
        
        AccountService -->> API: new_token
        deactivate AccountService
        
        API ->> AccountService: reset_owner_transfer_error_rate_limit(\n  user_email)
        activate AccountService
        AccountService -->> API: reset
        deactivate AccountService
        
        API -->> CurrentOwner: {is_valid: true, email: email, token: new_token}\n200 OK
        
      end
      
    end
    
  end
  
end

deactivate API

CurrentOwner ->> API: POST /workspaces/current/members/{new_owner_id}/owner-transfer\n{token: new_token}
activate API

note over API
  最终的转移执行
  此时已验证邮箱和验证码
end note

API ->> API: new_owner = db.session.get(Account, new_owner_id)

alt 新所有者不存在
  API -->> CurrentOwner: 404 Not Found
  deactivate API
else 新所有者存在
  
  API ->> API: 验证新所有者在工作区内\nTenantService.is_member(new_owner, tenant)
  
  alt 不是成员
    API -->> CurrentOwner: MemberNotInTenantError\n404 Not Found
    deactivate API
  else 是成员
    
    API ->> AccountService: get_owner_transfer_data(token)
    activate AccountService
    AccountService -->> API: token_data
    deactivate AccountService
    
    alt 令牌无效
      API -->> CurrentOwner: InvalidTokenError\n400 Bad Request
      deactivate API
    else 令牌有效
      
      API ->> API: 最终验证邮箱\nif token_data.email != current_user.email
      
      alt 邮箱不匹配
        API -->> CurrentOwner: InvalidEmailError\n400 Bad Request
        deactivate API
      else 邮箱匹配
        
        note over API
          执行角色转移
        end note
        
        API ->> AccountService: revoke_owner_transfer_token(token)
        activate AccountService
        AccountService -->> API: revoked
        deactivate AccountService
        
        API ->> Database: UPDATE tenant_account_joins\nSET role = "owner"\nWHERE account_id = new_owner_id
        activate Database
        Database -->> API: updated
        deactivate Database
        
        API ->> Database: UPDATE tenant_account_joins\nSET role = "admin"\nWHERE account_id = current_owner_id
        activate Database
        Database -->> API: updated
        deactivate Database
        
        API ->> EmailService: send_new_owner_transfer_notify_email(\n  new_owner, email, workspace_name)
        activate EmailService
        EmailService -->> API: task_queued
        deactivate EmailService
        
        API ->> EmailService: send_old_owner_transfer_notify_email(\n  current_owner, email, workspace_name, new_owner_email)
        activate EmailService
        EmailService -->> API: task_queued
        deactivate EmailService
        
        API -->> CurrentOwner: {result: "success"}\n200 OK
        
      end
      
    end
    
  end
  
end

deactivate API

note over CurrentOwner
  所有权转移完成：
  1. 原所有者降级为 ADMIN
  2. 新所有者升级为 OWNER
  3. 两者都收到邮件通知
  4. 转移令牌已撤销
  5. 新权限立即生效
end note

@enduml
