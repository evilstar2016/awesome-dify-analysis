@startuml AccountPermission_Matrix
!theme plain
skinparam backgroundColor #FFFFFF
skinparam classBackgroundColor #E8F4F8
skinparam classBorderColor #1976D2
skinparam arrowColor #1976D2

title Dify 账号权限矩阵与权限检查流程

package "权限体系" #F5F5F5 {
  enum Role {
    OWNER: 工作区所有者（最高权限）
    ADMIN: 管理员（接近最高权限）
    EDITOR: 编辑者（可编辑应用和知识库）
    NORMAL: 普通成员（只读访问）
    DATASET_OPERATOR: 数据集操作员（仅数据集相关操作）
  }
  
  class PermissionMatrix {
    --
    成员管理权限
    查看成员列表: [OWNER, ADMIN, EDITOR, NORMAL]
    邀请新成员: [OWNER, ADMIN]
    移除成员: [OWNER]
    更新成员角色: [OWNER]
    --
    工作区管理权限
    修改工作区设置: [OWNER, ADMIN]
    转移所有权: [OWNER]
    --
    应用管理权限
    创建应用: [OWNER, ADMIN, EDITOR]
    编辑应用: [OWNER, ADMIN, EDITOR]
    删除应用: [OWNER, ADMIN, EDITOR]
    发布应用: [OWNER, ADMIN, EDITOR]
    --
    知识库管理权限
    创建知识库: [OWNER, ADMIN, EDITOR]
    编辑知识库: [OWNER, ADMIN, EDITOR, NORMAL, DATASET_OPERATOR]
    删除知识库: [OWNER, ADMIN, EDITOR]
    上传文档: [OWNER, ADMIN, EDITOR, NORMAL, DATASET_OPERATOR]
  }
}

package "权限检查流程" #F0F8FF {
  class PermissionCheckFlow {
    --
    .. 步骤 1: 认证检查 ..
    验证用户已登录
    验证账号状态（非 BANNED/CLOSED）
    验证访问令牌有效
    --
    .. 步骤 2: 初始化检查 ..
    验证账号已初始化
    验证工作区已设置
    --
    .. 步骤 3: 角色获取 ..
    从 TenantAccountJoin 获取用户角色
    将角色加载到 Account 对象的 role 属性
    --
    .. 步骤 4: 权限验证 ..
    获取所需的权限列表
    检查用户角色是否在权限列表中
    --
    .. 步骤 5: 操作验证 ..
    检查操作的具体业务规则
    例如：不能操作自己、不能移除最后的 OWNER
    --
    .. 步骤 6: 执行操作 ..
    执行数据库操作
    更新相关缓存
    发送通知
  }
}

package "权限检查实现" #FFF5E6 {
  class RoleCheckers {
    --
    is_privileged_role(role): bool
    -> 检查是否为 OWNER 或 ADMIN
    --
    is_admin_role(role): bool
    -> 检查是否为 ADMIN
    --
    is_editing_role(role): bool
    -> 检查是否为 OWNER, ADMIN 或 EDITOR
    --
    is_dataset_edit_role(role): bool
    -> 检查是否可编辑数据集
    --
    is_non_owner_role(role): bool
    -> 检查是否为非 OWNER 角色
  }
  
  class ActionPermissionMatrix {
    --
    add(邀请成员): [OWNER, ADMIN]
    remove(移除成员): [OWNER]
    update(更新角色): [OWNER]
    --
    检查逻辑：
    1. 获取操作者的角色
    2. 检查角色是否在允许列表
    3. 检查不能操作自己
  }
}

package "权限相关装饰器" #E6F3FF {
  class Decorators {
    @login_required
    -> 验证用户已登录
    -> 注入 current_user
    --
    @setup_required
    -> 验证系统初始化
    --
    @account_initialization_required
    -> 验证账号已初始化
    --
    @edit_permission_required
    -> 验证用户有编辑权限
    -> account.has_edit_permission == True
    --
    @is_allow_transfer_owner
    -> 验证工作区允许转移所有权
    --
    @cloud_edition_billing_resource_check(resource)
    -> 检查计费限额
    -> 成员数, 应用数, 存储空间等
  }
}

package "权限检查的关键点" #F0FFF0 {
  class CriticalChecks {
    --
    1. TenantService.check_member_permission()
    -> 核心权限检查函数
    -> 验证操作者权限
    -> 防止自操作
    --
    2. Account.has_edit_permission
    -> 编辑权限属性检查
    -> 用于 @edit_permission_required
    --
    3. 速率限制
    -> 登录错误次数限制
    -> 邮件发送 IP 限制
    -> 所有权转移尝试限制
    --
    4. 令牌验证
    -> JWT 令牌签名验证
    -> 刷新令牌有效性检查
    -> 邀请令牌时间限制
    --
    5. 工作区状态检查
    -> 确保工作区状态为 NORMAL（非 ARCHIVE）
    -> 确保账号-工作区关系存在
  }
}

package "特殊权限场景" #FFE6E6 {
  class SpecialPermissions {
    --
    成员邀请权限
    -> 只有 OWNER 和 ADMIN 可邀请
    -> 检查工作区成员数量限制
    -> 验证邮箱地址有效性
    --
    角色更新权限
    -> 只有 OWNER 可更新他人角色
    -> 不能操作自己
    -> 新角色不能与旧角色相同
    --
    成员移除权限
    -> 只有 OWNER 可移除成员
    -> 不能移除自己
    -> 需要验证成员确实在工作区内
    --
    所有权转移权限
    -> 只有 OWNER 可转移
    -> 需要邮件验证码二次确认
    -> 原所有者自动降为 ADMIN
    -> 新所有者必须已是成员
  }
}

'' 权限检查流程关系
PermissionCheckFlow -- RoleCheckers: uses
PermissionCheckFlow -- ActionPermissionMatrix: checks
PermissionCheckFlow -- Decorators: uses
ActionPermissionMatrix -- Role: validates
RoleCheckers -- Role: checks
CriticalChecks -- PermissionCheckFlow: implements
SpecialPermissions -- ActionPermissionMatrix: extends

@enduml
