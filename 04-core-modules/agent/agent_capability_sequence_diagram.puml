@startuml
!theme plain
skinparam backgroundColor white
skinparam defaultFontSize 12
skinparam sequenceArrowThickness 2
skinparam roundcorner 10
skinparam maxmessagesize 250

' 定义参与者颜色
skinparam participant {
    BackgroundColor<<User>> #E1F5FE
    BackgroundColor<<API>> #F3E5F5
    BackgroundColor<<Agent>> #E8F5E8
    BackgroundColor<<Tool>> #FFF3E0
    BackgroundColor<<LLM>> #FCE4EC
    BackgroundColor<<Memory>> #F1F8E9
}

title **Dify 智能体能力核心场景时序图**\n//Function Calling & Chain of Thought 智能体执行流程//

actor "用户" as User <<User>>
participant "API Controller" as API <<API>>
participant "Agent Service" as Service <<Agent>>
participant "Agent Runner\n(FC/CoT)" as Runner <<Agent>>
participant "Tool Manager" as ToolMgr <<Tool>>
participant "Tool Engine" as ToolEngine <<Tool>>
participant "LLM Model" as LLM <<LLM>>
participant "Memory Buffer" as Memory <<Memory>>
participant "数据库" as DB <<Memory>>

== 智能体初始化阶段 ==

User -> API: **POST /chat-messages**\n发送用户查询
activate API #FFCCCC

API -> Service: **创建智能体会话**\nget_agent_logs()
activate Service #CCFFCC

Service -> Runner: **初始化智能体运行器**\n- 选择策略 (FC/CoT)\n- 加载配置参数
activate Runner #CCFFFF

Runner -> ToolMgr: **获取可用工具**\nget_agent_tool_runtime()
activate ToolMgr #FFFFCC

ToolMgr -> ToolMgr: **工具发现与验证**\n- 内置工具\n- API工具\n- 工作流工具\n- 数据集检索工具

ToolMgr --> Runner: **返回工具实例列表**\nPromptMessageTool[]
deactivate ToolMgr

Runner -> Memory: **加载历史对话**\norganize_agent_history()
activate Memory #CCFFCC

Memory -> DB: **查询对话历史**
activate DB #FFCCFF
DB --> Memory: **历史消息**
deactivate DB

Memory --> Runner: **格式化提示消息**\nPromptMessage[]
deactivate Memory

== 智能体推理与工具调用循环 ==

loop **最大迭代次数 (max_iteration)**

    Runner -> Runner: **构建提示消息**\n- 系统提示\n- 工具描述\n- 历史对话\n- 当前查询

    Runner -> LLM: **LLM推理请求**\n- Function Calling模式\n- 或CoT/ReAct模式
    activate LLM #FFCCFF

    alt **Function Calling 模式**
        LLM --> Runner: **结构化工具调用**\n{\n  "tool_calls": [\n    {"name": "tool_name",\n     "arguments": {...}}\n  ]\n}
    else **CoT/ReAct 模式**
        LLM --> Runner: **思维链响应**\nThought: ...\nAction: {"action": "tool_name", \n        "action_input": {...}}\nObservation: ...
    end
    deactivate LLM

    alt **需要工具调用**
        
        Runner -> ToolEngine: **执行工具调用**\nagent_invoke(tool, parameters)
        activate ToolEngine #FFFFCC

        ToolEngine -> ToolEngine: **参数验证**\n- 类型检查\n- 必填参数验证\n- 权限验证

        ToolEngine -> ToolEngine: **工具执行**\n- API调用\n- 数据库查询\n- 文件处理\n- 工作流执行

        ToolEngine -> DB: **记录智能体思考**\nMessageAgentThought
        activate DB
        DB --> ToolEngine: **保存成功**
        deactivate DB

        ToolEngine --> Runner: **工具执行结果**\nToolInvokeMessage
        deactivate ToolEngine

        Runner -> Runner: **更新智能体状态**\n- 累计LLM使用量\n- 更新思考记录\n- 检查继续条件

    else **无需工具调用 (最终答案)**
        
        Runner -> Runner: **提取最终答案**\n- Function Calling: assistant_message\n- CoT: Final Answer action
        
        break **结束迭代循环**
    end

end

== 响应生成与流式输出 ==

Runner -> Service: **流式响应生成**\nGenerator[LLMResultChunk]
deactivate Runner

Service -> API: **智能体执行结果**\n- 最终答案\n- 工具调用记录\n- Token使用统计
deactivate Service

API -> User: **SSE流式响应**\n- 实时思考过程\n- 工具调用状态\n- 最终答案
deactivate API

== 后处理与存储 ==

API -> DB: **保存对话记录**\n- Message\n- MessageAgentThought\n- MessageFile
activate DB
DB --> API: **存储完成**
deactivate DB

note right of Runner #FFE082
**核心技术组件:**
• **Agent Runner**: 智能体执行引擎
• **Tool Manager**: 工具发现与管理
• **Tool Engine**: 工具执行引擎  
• **Memory Buffer**: 对话记忆管理
• **Prompt Template**: 提示模板系统
• **LLM Integration**: 模型集成层
• **Stream Processing**: 流式响应处理
• **Database**: 持久化存储
end note

note left of LLM #E1BEE7
**智能体策略:**
• **Function Calling**: 
  结构化工具调用,精确参数传递
• **Chain of Thought**: 
  思维链推理,ReAct模式
• **混合模式**: 
  根据模型能力自适应选择
end note

@enduml