@startuml
!theme plain
skinparam backgroundColor white
skinparam defaultFontSize 11
skinparam roundcorner 8

' 定义组件颜色
skinparam component {
    BackgroundColor<<Core>> #E8F5E8
    BackgroundColor<<Agent>> #E1F5FE
    BackgroundColor<<Tool>> #FFF3E0
    BackgroundColor<<Model>> #FCE4EC
    BackgroundColor<<Storage>> #F1F8E9
    BackgroundColor<<Interface>> #F3E5F5
}

skinparam package {
    BackgroundColor #FAFAFA
    BorderColor #CCCCCC
}

title **Dify 智能体能力技术组件架构图**\n//Agent Capability Technical Components Architecture//

package "用户接口层 (Interface Layer)" #F8F9FA {
    component [REST API\nControllers] as API <<Interface>>
    component [WebSocket\nStream Handler] as WS <<Interface>>
    component [Agent Service\nBusiness Logic] as Service <<Interface>>
}

package "智能体核心层 (Agent Core Layer)" #E8F5E8 {
    component [Base Agent Runner\n基础智能体运行器] as BaseRunner <<Agent>>
    component [Function Call\nAgent Runner] as FCRunner <<Agent>>
    component [Chain of Thought\nAgent Runner] as CoTRunner <<Agent>>
    component [Agent Factory\n智能体工厂] as AgentFactory <<Agent>>
    component [Agent Node\n工作流智能体节点] as AgentNode <<Agent>>
}

package "工具管理层 (Tool Management Layer)" #FFF3E0 {
    component [Tool Manager\n工具管理器] as ToolManager <<Tool>>
    component [Tool Engine\n工具执行引擎] as ToolEngine <<Tool>>
    component [Builtin Tools\n内置工具] as BuiltinTools <<Tool>>
    component [API Tools\nAPI工具] as APITools <<Tool>>
    component [Plugin Tools\n插件工具] as PluginTools <<Tool>>
    component [Workflow Tools\n工作流工具] as WorkflowTools <<Tool>>
    component [Dataset Retriever\n数据集检索工具] as DatasetTools <<Tool>>
}

package "模型集成层 (Model Integration Layer)" #FCE4EC {
    component [Model Manager\n模型管理器] as ModelManager <<Model>>
    component [LLM Runtime\n大语言模型运行时] as LLMRuntime <<Model>>
    component [Model Providers\n模型提供商] as ModelProviders <<Model>>
    component [Prompt Templates\n提示模板] as PromptTemplates <<Model>>
}

package "内存管理层 (Memory Management Layer)" #F1F8E9 {
    component [Token Buffer Memory\n令牌缓冲内存] as TokenMemory <<Storage>>
    component [Agent History\n智能体历史] as AgentHistory <<Storage>>
    component [Conversation Store\n对话存储] as ConversationStore <<Storage>>
}

package "数据持久层 (Data Persistence Layer)" #F1F8E9 {
    database "PostgreSQL" as DB {
        component [Conversation\n对话表] as ConvTable <<Storage>>
        component [Message\n消息表] as MsgTable <<Storage>>
        component [MessageAgentThought\n智能体思考表] as ThoughtTable <<Storage>>
        component [MessageFile\n消息文件表] as FileTable <<Storage>>
    }
    database "Redis" as Redis {
        component [Session Cache\n会话缓存] as SessionCache <<Storage>>
        component [Tool Cache\n工具缓存] as ToolCache <<Storage>>
    }
}

package "外部集成层 (External Integration Layer)" #FAFAFA {
    cloud "LLM Providers" as LLMProviders {
        component [OpenAI] as OpenAI
        component [Anthropic] as Anthropic
        component [Local Models] as LocalModels
    }
    cloud "Tool Providers" as ToolProviders {
        component [REST APIs] as RestAPIs
        component [Vector DB] as VectorDB
        component [File Systems] as FileSystems
    }
}

' 连接关系
API --> Service : "调用业务逻辑"
WS --> Service : "流式数据传输"
Service --> AgentFactory : "创建智能体实例"

AgentFactory --> BaseRunner : "继承基础能力"
BaseRunner <|-- FCRunner : "Function Calling实现"
BaseRunner <|-- CoTRunner : "Chain of Thought实现"

FCRunner --> ToolManager : "获取工具"
CoTRunner --> ToolManager : "获取工具"
AgentNode --> ToolManager : "工作流工具调用"

ToolManager --> ToolEngine : "执行工具"
ToolManager --> BuiltinTools : "管理内置工具"
ToolManager --> APITools : "管理API工具"
ToolManager --> PluginTools : "管理插件工具"
ToolManager --> WorkflowTools : "管理工作流工具"
ToolManager --> DatasetTools : "管理数据集工具"

FCRunner --> ModelManager : "模型推理"
CoTRunner --> ModelManager : "模型推理"
ModelManager --> LLMRuntime : "运行时调用"
LLMRuntime --> ModelProviders : "提供商适配"

FCRunner --> TokenMemory : "内存管理"
CoTRunner --> TokenMemory : "内存管理"
TokenMemory --> AgentHistory : "历史记录"
AgentHistory --> ConversationStore : "对话存储"

ConversationStore --> ConvTable : "持久化对话"
ConversationStore --> MsgTable : "持久化消息"
ConversationStore --> ThoughtTable : "持久化思考"
ConversationStore --> FileTable : "持久化文件"

ToolCache --> Redis : "工具缓存"
SessionCache --> Redis : "会话缓存"

ModelProviders --> LLMProviders : "外部模型调用"
ToolEngine --> ToolProviders : "外部工具调用"

' 标注关键流程
note top of FCRunner #E3F2FD
**Function Calling 流程:**
1. 构建工具schema
2. LLM生成结构化调用
3. 并行工具执行
4. 结果聚合返回
end note

note top of CoTRunner #FFF8E1
**Chain of Thought 流程:**
1. ReAct提示模板
2. 思维链推理
3. 单步工具执行
4. 观察-行动循环
end note

note right of ToolEngine #F3E5F5
**工具执行特性:**
• 参数验证与类型转换
• 错误处理与重试机制
• 执行结果流式传输
• 工具调用链路追踪
• 安全沙箱执行环境
end note

note left of TokenMemory #E8F5E8
**内存管理策略:**
• Token数量限制
• 滑动窗口机制
• 重要信息保留
• 上下文压缩算法
• 多轮对话连续性
end note

@enduml