@startuml dify_workflow_api_sequence
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding      6
skinparam ParticipantPadding    30

title Dify Workflow API 调用流程

actor "Client" as client
participant "API Gateway\n/v1/workflows/run" as api
participant "validate_app_token\n装饰器" as auth
participant "WorkflowRunApi\nResource" as workflow
participant "AppGenerateService" as service
participant "WorkflowEntry" as engine
participant "GraphEngineManager" as graph
database "PostgreSQL" as db
participant "LLM Provider" as llm

== 认证阶段 ==

client -> api: POST /v1/workflows/run\n(Authorization: Bearer {token})
api -> auth: 验证请求
auth -> db: 验证 ApiToken
db --> auth: token & app_model
auth -> db: 创建/更新 EndUser
auth --> workflow: 注入依赖

== 验证阶段 ==

workflow -> workflow: 验证 app_mode == WORKFLOW

alt 非工作流应用
    workflow --> client: 400 NotWorkflowAppError
end

workflow -> workflow: 解析参数\n(inputs, files, response_mode)

== 执行阶段 ==

workflow -> service: generate(app_model, user, args, streaming)

service -> db: 获取 Workflow 定义
db --> service: workflow_graph

service -> engine: 初始化工作流引擎
engine -> db: 创建 WorkflowRun 记录
db --> engine: workflow_run_id

loop 遍历工作流节点
    engine -> engine: 执行当前节点
    engine -> db: 记录 WorkflowNodeExecution
    
    alt 需要 LLM 调用
        engine -> llm: 调用模型
        llm --> engine: 模型响应
    end
    
    alt 流式模式
        engine --> client: SSE: node_started
        engine --> client: SSE: node_finished
    end
end

== 完成阶段 ==

engine -> db: 更新 WorkflowRun 状态
db --> engine: 更新成功

alt 阻塞模式
    engine --> service: 完整结果
    service --> workflow: response
    workflow --> client: JSON 响应
else 流式模式
    engine --> client: SSE: workflow_finished
    engine --> client: SSE: [DONE]
end

== 获取运行详情 ==

client -> api: GET /v1/workflows/run/{run_id}
api -> auth: 验证请求
auth --> workflow: 验证通过
workflow -> db: 查询 WorkflowRun
db --> workflow: 运行记录
workflow --> client: 运行详情 JSON

== 停止工作流 ==

client -> api: POST /v1/workflows/tasks/{task_id}/stop
api -> auth: 验证请求
auth --> workflow: 验证通过
workflow -> graph: send_stop_command(task_id)
graph --> workflow: 命令发送成功
workflow --> client: {"result": "success"}

@enduml
