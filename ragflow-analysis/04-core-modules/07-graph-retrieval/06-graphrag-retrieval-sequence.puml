@startuml GraphRAG 检索流程
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceMessageAlign center
skinparam maxMessageSize 150

title GraphRAG 知识图谱增强检索流程

actor 用户 as User
participant "Web UI/API" as API
participant "DialogService" as Dialog
participant "KGSearch" as KG
participant "Dealer\n(传统检索)" as Dealer
participant "LLM" as LLM
participant "Embedding\nModel" as Emb
participant "Elasticsearch" as ES
participant "Infinity\n(Vector DB)" as Infinity
database "NetworkX\n(图谱)" as Graph
database "Redis\n(缓存)" as Redis

== 1. 用户查询 ==
User -> API: POST /api/v1/dialog/chat\n{"question": "What are the side effects of aspirin?"}
activate API
API -> Dialog: chat(question, use_kg=true)
activate Dialog

== 2. 查询理解 ==
Dialog -> Dialog: 分词、去停用词
Dialog -> LLM: query_rewrite(question)\n"Extract entities from query"
activate LLM
LLM --> Dialog: type_keywords=["side effect", "drug"]\nentities=["aspirin"]
deactivate LLM

== 3a. 传统检索（并行） ==
Dialog -> Dealer: search(question, kb_ids)
activate Dealer

group 向量检索
    Dealer -> Emb: encode_queries(question)
    activate Emb
    Emb --> Dealer: query_vector[768]
    deactivate Emb
    
    Dealer -> Infinity: kNN search\n(vector, similarity>0.1)
    activate Infinity
    Infinity --> Dealer: top 30 chunks\n(similarity scores)
    deactivate Infinity
end

group 全文检索
    Dealer -> ES: match query\n(BM25, keywords)
    activate ES
    ES --> Dealer: top 30 chunks\n(BM25 scores)
    deactivate ES
end

Dealer -> Dealer: fusion(vector, BM25)\nweights=[0.05, 0.95]
Dealer --> Dialog: doc_chunks[30]
deactivate Dealer

== 3b. 图谱检索（并行） ==
Dialog -> KG: retrieval(question, kb_ids, use_kg=true)
activate KG

group 实体检索 - 通过关键词
    KG -> Emb: encode("aspirin")
    activate Emb
    Emb --> KG: entity_vector[768]
    deactivate Emb
    
    KG -> Redis: get_cached_entities("aspirin")
    activate Redis
    Redis --> KG: cache miss
    deactivate Redis
    
    KG -> ES: search(knowledge_graph_kwd="entity"\n+ kNN, topk=56, sim>0.3)
    activate ES
    ES --> KG: entities_from_query = [\n  {"aspirin": sim=0.92, pagerank=0.0045,\n   n_hop_ents=[...]}\n]
    deactivate ES
    
    KG -> Redis: cache_entities("aspirin", 3600)
    activate Redis
    deactivate Redis
end

group 实体检索 - 通过类型
    KG -> ES: search(knowledge_graph_kwd="entity"\n+ entity_type_kwd=["drug", "side effect"]\n+ sort by rank_flt)
    activate ES
    ES --> KG: entities_from_types = [\n  {"stomach irritation": pagerank=0.0032},\n  {"bleeding": pagerank=0.0028}\n]
    deactivate ES
end

group 关系检索
    KG -> Emb: encode(question)
    activate Emb
    Emb --> KG: question_vector[768]
    deactivate Emb
    
    KG -> ES: search(knowledge_graph_kwd="relation"\n+ kNN, topk=56, sim>0.3)
    activate ES
    ES --> KG: relations_from_txt = [\n  {("aspirin", "stomach irritation"):\n   sim=0.85, pagerank=0.0021},\n  {("aspirin", "bleeding"):\n   sim=0.78, pagerank=0.0019}\n]
    deactivate ES
end

group N-hop 遍历
    KG -> Graph: get_neighbors("aspirin", k=2)
    activate Graph
    Graph --> KG: nhop_pathes = [\n  ("aspirin", "COX-2", "inflammation"),\n  weights=[0.0045, 0.0032]\n]
    deactivate Graph
    
    KG -> KG: 距离衰减\nsim = entity_sim / (2 + hop_distance)
end

group 社区检索
    KG -> ES: search(knowledge_graph_kwd="community_report"\n+ entities_kwd=["aspirin", ...]\n+ sort by weight_flt, topk=1)
    activate ES
    ES --> KG: community_reports = [\n  {"docnm_kwd": "NSAID Drug Interactions",\n   "content": {...}}\n]
    deactivate ES
end

== 4. 图谱结果排序 ==
KG -> KG: 实体排序: score = sim × pagerank\n类型匹配加权 (×2)
note right
实体排序公式：
P(E|Q) = P(E) × P(Q|E)
       = pagerank × sim
       
类型匹配加权：
if entity in entities_from_types:
  sim *= 2
end note

KG -> KG: 关系排序: score = sim × pagerank × type_boost
note right
关系排序公式：
boost = 0
if from_ent in types: boost += 1
if to_ent in types: boost += 1
if in n_hop_paths: boost += nhop_sim

final_score = sim × pagerank × (boost + 1)
end note

KG -> KG: 取 top-k 实体 (6) + 关系 (6)\n+ 社区报告 (1)

== 5. 上下文构建 ==
KG -> KG: 格式化为 CSV + Markdown\n---- Entities ----\nEntity, Score, Description\naspirin, 0.41, A nonsteroidal...\n\n---- Relations ----\nFrom, To, Score, Description\naspirin, stomach irritation, 0.18, ...\n\n---- Community Report ----\n# NSAID Drug Interactions\n## Content\n...

KG -> KG: Token 预算管理\nmax_token=8196\nfor each entity/relation:\n  max_token -= token_count\n  if max_token <= 0: break

KG --> Dialog: kg_chunk = {\n  "content_with_weight": formatted_context,\n  "docnm_kwd": "Knowledge Graph",\n  "similarity": 1.0\n}
deactivate KG

== 6. 上下文融合 ==
Dialog -> Dialog: kbinfos["chunks"].insert(0, kg_chunk)\n# 图谱上下文插入首位
note right
最终上下文结构：
[0] Knowledge Graph Context
  - Entities (CSV)
  - Relations (CSV)
  - Community Reports (MD)
[1-30] Document Chunks
  - Vector search results
  - BM25 search results
end note

Dialog -> Dialog: 重排序 (Rerank)\n融合图谱 + 文档上下文

== 7. LLM 生成 ==
Dialog -> Dialog: 构建 System Prompt\n"You are a helpful assistant.\nUse the following knowledge..."
Dialog -> Dialog: 注入知识上下文\nknowledge = "\\n------\\n".join(\n  [kg_chunk, doc_chunks]\n)

Dialog -> LLM: generate(prompt, knowledge, max_tokens=2048)
activate LLM
note right of LLM
Prompt 结构：
```
System: You are a helpful assistant.

Knowledge:
---- Entities ----
aspirin, 0.41, A nonsteroidal...
---- Relations ----
aspirin -> stomach irritation...
---- Community Report ----
NSAID Drug Interactions...
---- Document Chunks ----
[1] Aspirin is commonly used...

Query: What are the side effects of aspirin?
```
end note

LLM --> Dialog: answer = "The side effects of aspirin include:\\n\
1. Stomach irritation [ID:0]\\n\
2. Increased bleeding risk [ID:1]\\n\
According to the knowledge graph..."
deactivate LLM

== 8. 引用注入 ==
Dialog -> Dialog: insert_citations(answer, chunks)\n正则匹配 [ID:n]\n替换为引用链接

Dialog -> Dialog: repair_bad_citation_formats()\n修复引用格式错误

Dialog -> Dialog: 过滤引用文档\nrecall_docs = [doc for doc if cited]

== 9. 返回结果 ==
Dialog --> API: response = {\n  "answer": answer_with_citations,\n  "reference": {\n    "chunks": [kg_chunk, cited_chunks],\n    "doc_aggs": recall_docs\n  },\n  "prompt": full_prompt\n}
deactivate Dialog

API --> User: JSON response\n{\n  "answer": "The side effects include...",\n  "knowledge_graph_used": true,\n  "entities": ["aspirin", "stomach irritation"],\n  "relations": [("aspirin", "stomach irritation")],\n  "cited_docs": [...]\n}
deactivate API

== 性能指标 ==
note across
**检索耗时分解**：
- 查询改写: ~500ms (LLM)
- 实体检索: ~100ms (ES + Vector)
- 关系检索: ~80ms (ES + Vector)
- N-hop遍历: ~50ms (NetworkX)
- 社区检索: ~60ms (ES)
- 传统检索: ~200ms (Infinity + ES)
- LLM生成: ~2000ms (gpt-4)
**总耗时: ~3000ms**
end note

@enduml
