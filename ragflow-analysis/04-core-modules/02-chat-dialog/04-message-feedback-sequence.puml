@startuml
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding 6
skinparam ParticipantPadding 30

title 消息反馈流程 (Message Feedback)

actor 用户
participant "前端界面\nReact App" as Frontend
participant "Nginx\n反向代理" as Nginx
participant "API 服务\nconversation_app.py" as API
participant "对话服务\nConversationService" as ConvSvc
database "MySQL" as DB

== 用户反馈操作 ==

用户 -> Frontend: 点击 👍 或 👎
activate Frontend

Frontend -> Frontend: 记录反馈类型\n- thumbup\n- thumbdown

Frontend -> Nginx: POST /api/v1/conversation/thumbup\nAuthorization: Bearer {token}\n{\n  "conversation_id": "conv_uuid",\n  "message_id": "msg_uuid",\n  "feedback": "thumbup"\n}
activate Nginx

Nginx -> API: 转发请求
activate API

== 1. 身份验证 ==

API -> API: 验证 JWT Token\n@login_required

alt Token 无效
    API --> Frontend: 401 Unauthorized
    Frontend --> 用户: 显示"请重新登录"
else Token 有效
    API -> API: 提取用户信息
end

== 2. 参数验证 ==

API -> API: 验证必需参数\n- conversation_id\n- message_id\n- feedback

alt 参数缺失
    API --> Frontend: 400 Bad Request\n{"code": 101, "message": "Missing required field"}
    Frontend --> 用户: 显示错误提示
end

== 3. 权限检查 ==

API -> ConvSvc: get_by_id(conversation_id)
activate ConvSvc

ConvSvc -> DB: SELECT * FROM conversation\nWHERE id = ?
activate DB

DB --> ConvSvc: 对话轮次数据
deactivate DB

ConvSvc --> API: Conversation 对象
deactivate ConvSvc

alt 对话不存在
    API --> Frontend: 404 Not Found\n{"code": 102, "message": "Conversation not found"}
    Frontend --> 用户: 显示"对话不存在"
end

API -> API: 检查用户权限\nuser_id == conv.user_id

alt 无权限
    API --> Frontend: 403 Forbidden\n{"code": 105, "message": "No authorization"}
    Frontend --> 用户: 显示"无权限操作"
end

== 4. 更新反馈 ==

API -> API: 更新消息反馈字段\nmessages[message_id]["feedback"] = "thumbup"

API -> ConvSvc: update_by_id(\n  conversation_id,\n  {"message": updated_messages}\n)
activate ConvSvc

ConvSvc -> DB: UPDATE conversation\nSET message = ?,\n    update_time = NOW()\nWHERE id = ?
activate DB

DB --> ConvSvc: 更新成功
deactivate DB

ConvSvc --> API: 更新结果
deactivate ConvSvc

== 5. 记录反馈日志 ==

API -> API: 记录反馈事件\nlogging.info(\n  f"User {user_id} feedback: {feedback}"\n)

note right of API
  可选: 发送到分析系统
  - Langfuse
  - Google Analytics
  - 自定义埋点
end note

== 6. 返回结果 ==

API --> Nginx: 200 OK\n{\n  "code": 0,\n  "message": "Feedback recorded",\n  "data": true\n}
deactivate API

Nginx --> Frontend: 转发响应
deactivate Nginx

Frontend -> Frontend: 更新 UI 状态\n- 高亮选中的按钮\n- 显示反馈成功提示

Frontend --> 用户: ✅ 反馈已记录
deactivate Frontend

== 可选: 反馈分析 ==

note over DB
  反馈数据用于:
  1. 答案质量评估
  2. 模型微调训练数据
  3. 知识库优化
  4. 用户满意度分析
end note

@enduml
