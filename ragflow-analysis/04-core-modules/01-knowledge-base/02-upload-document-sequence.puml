@startuml
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding 6
skinparam ParticipantPadding 30

title 文档上传流程 (Document Upload)

actor 用户
participant "前端\nReact" as Frontend
participant "API服务\ndocument_app.py" as API
participant "文档服务\nDocumentService" as DocService
participant "MinIO\n对象存储" as MinIO
database "MySQL" as DB
participant "任务队列\nRedis" as Redis
participant "任务Worker\nCelery" as Worker

用户 -> Frontend: 选择文件上传
activate Frontend
Frontend -> Frontend: 验证文件\n- 类型检查\n- 大小限制 (<100MB)

Frontend -> API: POST /api/v1/document/upload\nContent-Type: multipart/form-data\nForm: {file, kb_id, parser_id}
activate API

API -> API: 解析 multipart 请求\nfile = request.files['file']

API -> API: 安全文件名处理\nfilename = secure_filename(file.filename)

API -> API: 生成文档 ID\ndoc_id = get_uuid()

API -> MinIO: 上传文件\nPUT /ragflow/docs/{kb_id}/{doc_id}/{filename}
activate MinIO

MinIO -> MinIO: 存储文件\nS3 bucket: ragflow

MinIO --> API: 上传成功\n{location: "docs/kb_id/doc_id/filename"}
deactivate MinIO

API -> DocService: save_document(\n  id=doc_id,\n  kb_id=kb_id,\n  name=filename,\n  type=file_ext,\n  size=file_size,\n  location=location,\n  status='NEW'\n)
activate DocService

DocService -> DB: INSERT INTO document\nVALUES (doc_id, kb_id, ...)
activate DB
DB --> DocService: 插入成功
deactivate DB

DocService --> API: 返回 Document 对象
deactivate DocService

API -> Redis: 推送解析任务\nRPUSH task:parse\n{\n  "doc_id": doc_id,\n  "kb_id": kb_id,\n  "parser_id": parser_id\n}
activate Redis
Redis --> API: 任务入队成功\nlength=1
deactivate Redis

API --> Frontend: 200 OK\n{\n  "code": 0,\n  "data": {\n    "doc_id": doc_id,\n    "status": "NEW"\n  }\n}
deactivate API

Frontend -> Frontend: 显示上传成功\n开始轮询解析进度

Frontend --> 用户: "文件上传成功，正在解析..."
deactivate Frontend

== 异步解析任务 ==

Redis -> Worker: BLPOP task:parse\n获取任务
activate Worker

Worker -> DB: 查询文档信息\nSELECT * FROM document\nWHERE id = doc_id
activate DB
DB --> Worker: 返回文档记录
deactivate DB

Worker -> MinIO: 下载文件\nGET /ragflow/docs/{kb_id}/{doc_id}/{filename}
activate MinIO
MinIO --> Worker: 返回文件内容\nbinary data
deactivate MinIO

Worker -> Worker: 选择解析器\nparser = get_parser(parser_id)

Worker -> Worker: 开始解析\nparser.parse(file_content)

Worker -> DB: 更新进度\nUPDATE document\nSET progress = 0.5,\n    status = 'PARSING'
activate DB
DB --> Worker: 更新成功
deactivate DB

Worker -> Worker: 文档分块\nchunks = chunk_document(content)

Worker -> Worker: 生成嵌入\nembeddings = embed(chunks)

Worker -> DB: 更新最终状态\nUPDATE document\nSET progress = 1.0,\n    status = 'DONE',\n    chunk_num = len(chunks)
activate DB
DB --> Worker: 更新成功
deactivate DB

Worker --> Redis: 任务完成
deactivate Worker

note right of Worker
  解析流程：
  1. 下载文件
  2. 选择解析器
  3. 提取文本/表格/图片
  4. 智能分块
  5. 生成嵌入
  6. 存储到 ES
  7. 更新文档状态
end note

note left of MinIO
  MinIO 存储路径：
  /ragflow/docs/{kb_id}/{doc_id}/
    - original.pdf
    - images/
      - page_1.png
      - page_2.png
    - metadata.json
end note

@enduml
