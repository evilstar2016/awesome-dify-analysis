@startuml
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding 6
skinparam ParticipantPadding 30

title 工具调用流程 (Tool Calling with ReAct)

participant "Agent 组件\nAgentWithTools" as Agent
participant "LLM 服务\nChatModel" as LLM
participant "工具管理器\nToolManager" as ToolMgr
participant "DuckDuckGo\n搜索工具" as DDG
participant "Wikipedia\n百科工具" as Wiki
participant "Code Executor\n代码执行" as CodeExec
participant "GitHub API\n代码仓库" as GitHub

Agent -> Agent: 初始化 Agent\nquestion = "RAGFlow 最新版本是什么？"\ntools = ["duckduckgo", "github"]

== 1. 准备工具定义 ==

Agent -> ToolMgr: 加载工具列表\nload_tools(["duckduckgo", "github"])
activate ToolMgr

ToolMgr -> ToolMgr: 构建工具描述\nfor tool_name in tools:\n  tool = get_tool(tool_name)\n  tool_schemas.append({\n    "name": tool.name,\n    "description": tool.description,\n    "parameters": tool.parameters\n  })

ToolMgr --> Agent: 返回工具定义\n[\n  {\n    "name": "duckduckgo_search",\n    "description": "搜索互联网信息",\n    "parameters": {\n      "query": {"type": "string"}\n    }\n  },\n  {\n    "name": "github_get_repo_info",\n    "description": "获取 GitHub 仓库信息",\n    "parameters": {\n      "repo": {"type": "string"}\n    }\n  }\n]
deactivate ToolMgr

== 2. ReAct 推理循环 ==

Agent -> Agent: 初始化对话历史\nhistory = [{\n  "role": "system",\n  "content": REACT_PROMPT + tool_descriptions\n}]

loop ReAct 迭代 (max_iterations=10)
    
    == 2.1 Thought - 思考 ==
    
    Agent -> Agent: 添加用户问题\nhistory.append({\n  "role": "user",\n  "content": question\n})
    
    Agent -> LLM: chat(\n  messages=history,\n  tools=tool_schemas,\n  tool_choice="auto"\n)
    activate LLM
    
    LLM -> LLM: 分析问题\n需要什么信息？\n哪些工具可用？
    
    LLM --> Agent: 返回响应\n{\n  "content": "我需要搜索 RAGFlow 的最新信息",\n  "tool_calls": [\n    {\n      "id": "call_123",\n      "function": {\n        "name": "duckduckgo_search",\n        "arguments": "{\\"query\\": \\"RAGFlow latest version\\"}"\n      }\n    }\n  ]\n}
    deactivate LLM
    
    Agent -> Agent: 记录 LLM 响应\nhistory.append({\n  "role": "assistant",\n  "content": response.content,\n  "tool_calls": response.tool_calls\n})
    
    == 2.2 Action - 执行工具 ==
    
    alt 有工具调用
        loop 每个工具调用
            Agent -> Agent: 提取工具信息\ntool_name = tool_call["function"]["name"]\ntool_args = json.loads(\n  tool_call["function"]["arguments"]\n)
            
            Agent -> ToolMgr: 执行工具\nexecute_tool(\n  name=tool_name,\n  args=tool_args\n)
            activate ToolMgr
            
            alt 工具 = duckduckgo_search
                ToolMgr -> DDG: search(\n  query="RAGFlow latest version"\n)
                activate DDG
                
                DDG -> DDG: 调用 DuckDuckGo API\nresponse = requests.get(\n  "https://api.duckduckgo.com/",\n  params={"q": query}\n)
                
                DDG --> ToolMgr: 返回搜索结果\n[\n  {\n    "title": "RAGFlow v0.22.1 Released",\n    "url": "https://...",\n    "snippet": "...",\n  }\n]
                deactivate DDG
                
            else 工具 = github_get_repo_info
                ToolMgr -> GitHub: get_repo(\n  repo="infiniflow/ragflow"\n)
                activate GitHub
                
                GitHub -> GitHub: 调用 GitHub API\nresponse = requests.get(\n  "https://api.github.com/repos/infiniflow/ragflow"\n)
                
                GitHub --> ToolMgr: 返回仓库信息\n{\n  "name": "ragflow",\n  "latest_release": "v0.22.1",\n  "updated_at": "2024-12-15"\n}
                deactivate GitHub
            end
            
            ToolMgr --> Agent: 返回工具结果\ntool_result
            deactivate ToolMgr
            
            == 2.3 Observation - 观察 ==
            
            Agent -> Agent: 记录工具结果\nhistory.append({\n  "role": "tool",\n  "tool_call_id": tool_call.id,\n  "content": json.dumps(tool_result)\n})
        end
        
        Agent -> Agent: 继续下一轮推理\niteration += 1
        
    else 无工具调用（得到最终答案）
        Agent -> Agent: 提取最终答案\nfinal_answer = response.content
        
        Agent -> Agent: 退出循环\nbreak
    end
    
    alt 超过最大迭代次数
        Agent -> Agent: 强制结束\nfinal_answer = "抱歉，无法完成任务"
        break
    end
end

== 3. 返回结果 ==

Agent -> Agent: 格式化最终答案\nresult = {\n  "answer": final_answer,\n  "tool_calls": tool_call_history,\n  "iterations": iteration_count\n}

Agent --> Agent: 输出结果\n{\n  "answer": "RAGFlow 的最新版本是 v0.22.1，\n    发布于 2024-12-15。",\n  "tool_calls": [\n    {"tool": "duckduckgo_search", "result": "..."},\n    {"tool": "github_get_repo_info", "result": "..."}\n  ],\n  "iterations": 2\n}

note right of LLM
  ReAct Prompt 示例：
  
  You have access to the following tools:
  - duckduckgo_search: Search the web
  - github_get_repo_info: Get GitHub repo info
  
  Use the following format:
  
  Thought: Think about what to do
  Action: The tool to use
  Action Input: The input to the tool
  Observation: The result of the tool
  ... (repeat Thought/Action/Observation)
  Thought: I now know the final answer
  Final Answer: [your answer]
end note

note right of Agent
  工具调用策略：
  
  1. 自动模式 (tool_choice="auto")
     - LLM 自主决定是否使用工具
  
  2. 强制模式 (tool_choice="required")
     - 必须使用至少一个工具
  
  3. 指定模式 (tool_choice={"name": "..."}]
     - 指定使用某个工具
  
  4. 禁用模式 (tool_choice="none")
     - 禁止使用工具
end note

note left of ToolMgr
  工具注册：
  
  @tool(
    name="custom_tool",
    description="工具描述",
    parameters={
      "param1": {"type": "string"}
    }
  )
  def custom_tool(param1: str):
    # 工具逻辑
    return result
  
  错误处理：
  - 超时重试
  - 参数验证
  - 异常捕获
end note

@enduml
