@startuml permission-architecture
!theme plain
skinparam backgroundColor #FEFEFE
skinparam componentStyle rectangle
skinparam roundcorner 10

title RAGFlow 权限管理系统架构图

' 定义颜色
!define COLOR_AUTH #E1F5FE
!define COLOR_PERM #FFF9C4
!define COLOR_DATA #E8F5E9
!define COLOR_SERVICE #FCE4EC
!define COLOR_EXTERNAL #F3E5F5

package "认证层 (Authentication)" COLOR_AUTH {
    [本地密码认证] as LocalAuth
    [OAuth2/OIDC] as OAuth
    [GitHub OAuth] as GitHub
    [Feishu OAuth] as Feishu
    [会话管理\n(Quart-Auth)] as Session
    
    LocalAuth -down-> Session : 创建会话
    OAuth -down-> Session : 创建会话
    GitHub -down-> Session : 创建会话
    Feishu -down-> Session : 创建会话
}

package "权限控制层 (Authorization)" COLOR_PERM {
    [装饰器验证\n@login_required] as Decorator
    [租户权限检查\ncheck_kb_team_permission] as TenantCheck
    [角色权限\nUserTenantRole] as RoleCheck
    [资源权限\nTenantPermission] as ResourcePerm
    
    Decorator --> TenantCheck
    TenantCheck --> RoleCheck
    TenantCheck --> ResourcePerm
}

package "服务层 (Service Layer)" COLOR_SERVICE {
    [UserService] as UserSvc
    [TenantService] as TenantSvc
    [UserTenantService] as UserTenantSvc
    [KnowledgebaseService] as KBSvc
    [DocumentService] as DocSvc
    [FileService] as FileSvc
    
    UserSvc -right-> TenantSvc : 查询租户
    TenantSvc -down-> UserTenantSvc : 查询关联
    KBSvc -down-> DocSvc : 管理文档
    DocSvc -down-> FileSvc : 管理文件
}

package "数据层 (Data Layer)" COLOR_DATA {
    database "MySQL" {
        [User表] as UserTable
        [Tenant表] as TenantTable
        [UserTenant表\n(关联表)] as UTTable
        [Knowledgebase表] as KBTable
        [Document表] as DocTable
        [File表] as FileTable
        
        UserTable -- UTTable : user_id
        TenantTable -- UTTable : tenant_id
        TenantTable -- KBTable : tenant_id
        KBTable -- DocTable : kb_id
        DocTable -- FileTable : doc_id
    }
    
    database "搜索引擎\n(Elasticsearch/Infinity)" {
        [租户索引 A\nindex_tenant_a] as IndexA
        [租户索引 B\nindex_tenant_b] as IndexB
    }
    
    database "对象存储\n(MinIO)" {
        [知识库Bucket A\nkb_xxx] as BucketA
        [知识库Bucket B\nkb_yyy] as BucketB
    }
}

cloud "第三方服务" COLOR_EXTERNAL {
    [GitHub API] as GitHubAPI
    [Feishu API] as FeishuAPI
    [自定义OIDC Provider] as OIDC
}

' 关系连接
Session --> Decorator : 验证会话
Decorator --> UserSvc : 获取当前用户

UserSvc --> UserTable
TenantSvc --> TenantTable
UserTenantSvc --> UTTable
KBSvc --> KBTable
DocSvc --> DocTable
FileSvc --> FileTable

TenantCheck --> TenantSvc : 查询用户租户
TenantCheck --> KBSvc : 检查知识库权限

KBSvc --> IndexA : 租户A的数据
KBSvc --> IndexB : 租户B的数据
KBSvc --> BucketA : 知识库A的文件
KBSvc --> BucketB : 知识库B的文件

OAuth --> GitHubAPI : 获取用户信息
GitHub --> GitHubAPI
Feishu --> FeishuAPI
OAuth --> OIDC : OIDC认证

' 注释说明
note right of LocalAuth
**本地认证流程**:
1. 密码加密传输
2. 数据库验证
3. 生成access_token
4. 创建会话
end note

note right of OAuth
**OAuth2/OIDC流程**:
1. 重定向到认证服务器
2. 用户授权
3. 交换access_token
4. 获取用户信息
5. 自动注册/登录
end note

note bottom of TenantCheck
**多租户隔离检查**:
1. 验证用户-租户关系
2. 检查资源权限类型(ME/TEAM)
3. 验证知识库创建者
4. 返回权限判断结果
end note

note bottom of KBTable
**权限字段**:
- tenant_id: 租户隔离
- permission: ME/TEAM
- created_by: 所有者
end note

note bottom of UTTable
**角色字段**:
- role: owner/admin/normal/invite
- invited_by: 邀请人
- status: 激活状态
end note

note right of IndexA
**索引隔离**:
每个租户有独立的索引
index_name = ragflow_{tenant_id}
防止跨租户数据泄露
end note

@enduml
