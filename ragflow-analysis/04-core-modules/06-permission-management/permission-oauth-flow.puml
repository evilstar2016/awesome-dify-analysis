@startuml permission-oauth-flow
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding 6
skinparam ParticipantPadding 30

title RAGFlow OAuth/OIDC 第三方认证流程

actor "用户" as User
participant "前端" as Frontend
participant "RAGFlow API" as API
participant "OAuthClient\n/OIDCClient" as OAuth
participant "第三方认证服务器\n(GitHub/Feishu/OIDC)" as AuthServer
participant "UserService" as UserSvc
participant "数据库" as DB

== 1. 发起OAuth登录 ==
User -> Frontend: 点击"使用GitHub登录"
activate Frontend

Frontend -> API: GET /v1/user/oauth/login?channel=github
activate API

API -> API: 加载OAuth配置
note right
config = {
  client_id: "xxx",
  client_secret: "yyy",
  authorization_url: "https://github.com/login/oauth/authorize",
  token_url: "https://github.com/login/oauth/access_token",
  userinfo_url: "https://api.github.com/user",
  redirect_uri: "https://ragflow.io/v1/user/oauth/callback/github"
}
end note

API -> OAuth: new OAuthClient(config)
activate OAuth
OAuth --> API: client实例
deactivate OAuth

API -> OAuth: get_authorization_url(state)
activate OAuth
OAuth -> OAuth: 生成CSRF防护state
OAuth --> API: authorization_url
deactivate OAuth

API --> Frontend: 302 Redirect\nLocation: authorization_url
Frontend -> User: 重定向到GitHub授权页面
deactivate Frontend

== 2. 用户授权 ==
User -> AuthServer: 访问授权页面
activate AuthServer
AuthServer --> User: 显示授权界面\n"RAGFlow wants to access..."
User -> AuthServer: 点击"Authorize"
AuthServer -> AuthServer: 生成authorization_code

AuthServer --> User: 302 Redirect\nLocation: redirect_uri?code=xxx&state=yyy
User -> Frontend: 回调到RAGFlow
deactivate AuthServer

== 3. 处理OAuth回调 ==
Frontend -> API: GET /v1/user/oauth/callback/github?\ncode=xxx&state=yyy
activate API

API -> API: 验证state参数
note right: CSRF防护检查
alt state验证失败
    API --> Frontend: 401 Unauthorized
else state验证成功
    
    API -> OAuth: exchange_code_for_token(code)
    activate OAuth
    OAuth -> AuthServer: POST /oauth/token\n{code, client_id, client_secret}
    activate AuthServer
    AuthServer -> AuthServer: 验证授权码
    AuthServer --> OAuth: {access_token, refresh_token}
    deactivate AuthServer
    OAuth --> API: access_token
    deactivate OAuth
    
    == 4. 获取用户信息 ==
    API -> OAuth: fetch_user_info(access_token)
    activate OAuth
    
    alt OIDC流程
        OAuth -> OAuth: parse_id_token(id_token)
        note right
        1. 获取JWKS公钥
        2. 验证JWT签名
        3. 验证issuer和audience
        4. 解析用户信息
        end note
    end
    
    OAuth -> AuthServer: GET /user\nAuthorization: Bearer {access_token}
    activate AuthServer
    AuthServer --> OAuth: {email, name, avatar_url}
    deactivate AuthServer
    
    alt GitHub特殊处理
        OAuth -> AuthServer: GET /user/emails
        activate AuthServer
        AuthServer --> OAuth: [{email, primary: true}]
        deactivate AuthServer
    end
    
    OAuth -> OAuth: normalize_user_info()
    OAuth --> API: UserInfo{email, username, nickname, avatar}
    deactivate OAuth
    
    == 5. 创建或登录用户 ==
    API -> UserSvc: query(email=user_info.email)
    activate UserSvc
    UserSvc -> DB: SELECT * FROM user WHERE email=?
    activate DB
    DB --> UserSvc: 用户记录（如果存在）
    deactivate DB
    
    alt 用户不存在（首次登录）
        UserSvc -> UserSvc: 创建新用户
        note right
        user = User(
          id = get_uuid(),
          email = user_info.email,
          nickname = user_info.nickname,
          avatar = user_info.avatar_url,
          login_channel = 'github',
          access_token = get_uuid()
        )
        end note
        
        UserSvc -> DB: INSERT INTO user VALUES (...)
        activate DB
        DB --> UserSvc: 插入成功
        deactivate DB
        
        UserSvc -> UserSvc: 创建默认租户
        UserSvc -> DB: INSERT INTO tenant\nINSERT INTO user_tenant
        activate DB
        DB --> UserSvc: 创建成功
        deactivate DB
    end
    
    UserSvc --> API: User对象
    deactivate UserSvc
    
    == 6. 创建会话 ==
    API -> API: login_user(user)
    note right: Quart-Auth会话管理
    
    API -> DB: UPDATE user\nSET last_login_time=NOW()
    activate DB
    DB --> API: 更新成功
    deactivate DB
    
    API --> Frontend: 302 Redirect\nLocation: /\n[Set-Cookie: session_id]
    Frontend --> User: 登录成功，进入主页
end

deactivate API

== OIDC特有流程（标准化） ==
note over OAuth, AuthServer
**OIDC自动发现配置**
1. 访问 {issuer}/.well-known/openid-configuration
2. 获取 authorization_endpoint, token_endpoint, jwks_uri
3. 无需手动配置各个端点

**ID Token验证**
1. 从token_endpoint获取id_token (JWT)
2. 从jwks_uri获取公钥
3. 验证签名、issuer、audience、过期时间
4. 解析用户信息（email, name, sub等）
end note

@enduml
