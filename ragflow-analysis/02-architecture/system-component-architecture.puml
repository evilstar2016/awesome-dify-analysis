@startuml
!theme plain
skinparam componentStyle rectangle
skinparam backgroundColor white
skinparam Package { 
  BackgroundColor LightGray
  FontColor Blue
}
skinparam component {
  BackgroundColor LightBlue
  BorderColor Black
  ArrowColor Black
  FontColor DarkBlue
}
skinparam database {
  BackgroundColor LightYellow
  BorderColor DarkGreen
}
skinparam note {
  backgroundColor LightYellow
}

' ==================== 展示层 ====================
package "展示层 (Presentation Layer)" {
  [Web 前端] as WebUI
  [移动端 (未来)] as Mobile
  [Chrome 扩展] as ChromeExt
  [第三方集成] as ThirdParty
}

' ==================== 网关层 ====================
package "网关层 (Gateway Layer)" {
  [Nginx] as Nginx
}

' ==================== API 服务层 ====================
package "API 服务层 (API Service Layer)" {
  package "API Blueprints" {
    [知识库 API] as KbAPI
    [文档 API] as DocAPI
    [对话 API] as ConvAPI
    [Agent 画布 API] as CanvasAPI
    [用户 API] as UserAPI
    [系统 API] as SysAPI
    [LLM API] as LLMAPI
    [MCP 服务器 API] as MCPAPI
  }
  
  [认证中间件] as AuthMW
  [Session 管理] as SessionMgr
  [API 网关] as APIGateway
}

' ==================== 业务逻辑层 ====================
package "业务逻辑层 (Business Logic Layer)" {
  
  package "RAG 核心引擎" {
    [文档分块器] as Chunker
    [向量嵌入] as Embedder
    [检索引擎] as Retriever
    [重排序器] as Reranker
    [上下文组装] as ContextAsm
    [LLM 调用器] as LLMCaller
  }
  
  package "文档解析系统" {
    [PDF 解析器] as PDFParser
    [Word 解析器] as WordParser
    [PPT 解析器] as PPTParser
    [Excel 解析器] as ExcelParser
    [OCR 引擎] as OCR
    [版面分析] as Layout
  }
  
  package "Agent 系统" {
    [Agent 工作流引擎] as AgentEngine
    [工具调用器] as ToolCaller
    [Agent 组件库] as AgentComps
    [代码执行器] as CodeExec
  }
  
  package "图RAG系统" {
    [实体抽取] as EntityExt
    [知识图谱构建] as GraphBuilder
    [图查询引擎] as GraphQuery
    [图计算引擎\n(NetworkX)] as NetworkX
    [PageRank 计算] as PageRank
    [社区检测\n(Leiden)] as Community
  }
  
  [插件管理器] as PluginMgr
  [MCP 客户端] as MCPClient
  [任务调度器] as TaskScheduler
}

' ==================== 数据访问层 ====================
' 注意: RAGFlow使用双ORM架构
' - Peewee: 应用层业务数据 (api/db/)
' - SQLAlchemy: 向量数据库操作 (rag/utils/ob_conn.py)
package "数据访问层 (Data Access Layer)" {
  [数据库服务\n(Peewee ORM)] as DBService
  [向量数据服务\n(SQLAlchemy)] as VectorDBService
  [搜索服务] as SearchService
  [缓存服务] as CacheService
  [存储服务] as StorageService
  [队列服务] as QueueService
}

' ==================== 基础设施层 ====================
package "基础设施层 (Infrastructure Layer)" {
  database "MySQL/\nPostgreSQL" as MySQL {
  }
  database "OceanBase\n(向量数据库)" as OceanBase {
  }
  database "Elasticsearch/\nOpenSearch" as ES {
  }
  database "Infinity\n(向量数据库)" as Infinity {
  }
  database "Redis" as Redis {
  }
  database "MinIO\n(对象存储)" as MinIO {
  }
  
  note bottom of MinIO
    文档存储
    解析结果
    **图谱序列化**:
    - graph.pkl
    - communities.json
  end note
}

' ==================== 外部服务 ====================
package "外部服务 (External Services)" {
  cloud "LLM 提供商" as LLMProviders {
    [OpenAI]
    [Anthropic]
    [Google]
    [通义千问]
    [其他...]
  }
  
  cloud "第三方数据源" as DataSources {
    [Confluence]
    [Notion]
    [Google Drive]
    [Slack]
    [其他...]
  }
  
  cloud "Embedding 服务" as EmbedServices {
    [Infinity Embed]
    [OpenAI Embed]
  }
}

' ==================== 展示层连接 ====================
WebUI --> Nginx : HTTPS
Mobile --> Nginx : HTTPS
ChromeExt --> Nginx : HTTPS
ThirdParty --> Nginx : HTTPS/API

' ==================== 网关层连接 ====================
Nginx --> APIGateway : 反向代理

' ==================== API 层连接 ====================
APIGateway --> AuthMW : 认证检查
AuthMW --> SessionMgr : Session 验证
APIGateway --> KbAPI
APIGateway --> DocAPI
APIGateway --> ConvAPI
APIGateway --> CanvasAPI
APIGateway --> UserAPI
APIGateway --> SysAPI
APIGateway --> LLMAPI
APIGateway --> MCPAPI

' ==================== API 到业务逻辑层 ====================
KbAPI --> Retriever
KbAPI --> DBService

DocAPI --> PDFParser
DocAPI --> WordParser
DocAPI --> PPTParser
DocAPI --> ExcelParser
DocAPI --> StorageService
DocAPI --> TaskScheduler

ConvAPI --> Retriever
ConvAPI --> LLMCaller
ConvAPI --> DBService

CanvasAPI --> AgentEngine
CanvasAPI --> DBService

LLMAPI --> LLMCaller
MCPAPI --> MCPClient

' ==================== 业务逻辑层内部连接 ====================
Chunker --> Embedder
Embedder --> SearchService
Retriever --> SearchService
Retriever --> Reranker
Reranker --> ContextAsm
ContextAsm --> LLMCaller

PDFParser --> Layout
PDFParser --> OCR
WordParser --> Layout
PPTParser --> Layout

AgentEngine --> AgentComps
AgentEngine --> ToolCaller
AgentEngine --> Retriever
AgentEngine --> LLMCaller
ToolCaller --> CodeExec

EntityExt --> GraphBuilder
GraphBuilder --> NetworkX : 构建图结构
NetworkX --> PageRank : 计算重要性
NetworkX --> Community : 社区检测
PageRank --> SearchService : 序列化到ES
Community --> SearchService : 序列化到ES
GraphQuery --> SearchService : 检索预计算结果

PluginMgr --> AgentComps
MCPClient --> ToolCaller

TaskScheduler --> QueueService

' ==================== 业务逻辑层到数据访问层 ====================
Embedder --> SearchService
Retriever --> SearchService
Retriever --> CacheService
GraphBuilder --> SearchService
AgentEngine --> DBService
LLMCaller --> CacheService

PDFParser --> StorageService
WordParser --> StorageService
PPTParser --> StorageService
ExcelParser --> StorageService

' ==================== 数据访问层到基础设施层 ====================
' Peewee ORM 连接到 MySQL/PostgreSQL (业务数据)
NetworkX --> MinIO : 图谱持久化\n(可选)
DBService --> MySQL
' SQLAlchemy 连接到 OceanBase (向量数据)
VectorDBService --> OceanBase
SearchService --> ES
SearchService --> Infinity
CacheService --> Redis
StorageService --> MinIO
QueueService --> Redis

SessionMgr --> Redis

' ==================== 外部服务连接 ====================
LLMCaller --> LLMProviders : API 调用
Embedder --> EmbedServices : API 调用
DocAPI --> DataSources : 数据同步

' ==================== 注释 ====================
note right of WebUI
  React + TypeScript
  Ant Design + UmiJS
  Tailwind CSS
end note

note right of Nginx
  反向代理
  SSL 终止
  负载均衡
  静态资源服务
end note

note right of APIGateway
  Quart (异步 Flask)
  Blueprint 模块化
  认证授权
  请求路由
end note

note bottom of Retriever
  向量检索
  关键词检索
  混合检索
  多路召回
end note

note bottom of AgentEngine
  工作流编排
  节点执行
  条件分支
  工具调用
end note

note right of NetworkX
  **仅在构建时使用**:
  - 图结构管理
  - PageRank 计算
  - N-hop 邻居遍历
  - 社区检测 (Leiden)
  - 结果序列化到 ES
  
  **检索时不使用**:
  直接从 ES 读取
  预计算结果
end note

note right of MySQL
  用户数据
  知识库元数据
  文档元数据
  对话历史
  **图谱任务追踪**
  (graphrag_task_id)
end note

note right of ES
  全文检索
  向量检索
  文档分块索引
  **知识图谱索引**:
  - 实体 (entity)
  - 关系 (relation)
  - 社区报告 (community_report)
  - N-hop邻居 (预存储在JSON中)
end note

note right of Redis
  Session 存储
  任务队列
  缓存
end note

note bottom of LLMProviders
  支持多种 LLM:
  - OpenAI GPT-4
  - Claude 3
  - Gemini
  - 通义千问
  - 文心一言
  等等...
end note

@enduml
