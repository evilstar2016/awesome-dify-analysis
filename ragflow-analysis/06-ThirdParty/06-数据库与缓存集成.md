# 数据库与缓存集成

## 概述

RAGFlow 使用多种数据库和缓存系统进行数据持久化、会话管理和性能优化。

## 支持的数据库

### 1. Redis / Valkey

#### 简介

Redis/Valkey 用于缓存、会话管理、分布式锁和消息队列。

#### 配置

```yaml
# conf/service_conf.yaml
redis:
  host: localhost
  port: 6379
  password: xxxxx
  db: 1

# 环境变量
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=xxxxx
```

#### 连接实现

**核心文件**：[rag/utils/redis_conn.py](../../rag/utils/redis_conn.py)

```python
import valkey

class RedisDB:
    def __init__(self, host, port, password, db):
        self.conn = valkey.Redis(
            host=host,
            port=port,
            password=password,
            db=db,
            decode_responses=True
        )
```

#### 主要功能

1. **缓存**
```python
# 设置缓存
redis_conn.set("key", "value", ex=3600)  # 1小时过期

# 获取缓存
value = redis_conn.get("key")
```

2. **分布式锁**
```python
from rag.utils.redis_conn import RedisDistributedLock

with RedisDistributedLock("my_lock", timeout=30):
    # 执行需要加锁的操作
    pass
```

3. **消息队列**
```python
from rag.utils.redis_conn import RedisMsg

# 发布消息
RedisMsg.publish("channel", {"type": "task", "data": "xxx"})

# 订阅消息
for msg in RedisMsg.subscribe("channel"):
    print(msg)
```

**依赖**：`valkey==6.0.2`

### 2. MySQL

#### 配置

```yaml
mysql:
  host: localhost
  port: 3306
  user: root
  password: xxxxx
  database: ragflow
```

#### ORM

RAGFlow 使用 Peewee ORM：

**核心文件**：[api/db/db_models.py](../../api/db/db_models.py)

```python
from peewee import MySQLDatabase, Model

db = MySQLDatabase(
    'ragflow',
    host='localhost',
    port=3306,
    user='root',
    password='xxxxx'
)

class BaseModel(Model):
    class Meta:
        database = db
```

**依赖**：`pymysql>=1.1.1`

### 3. PostgreSQL

支持 PostgreSQL 作为 MySQL 替代方案。

**依赖**：`psycopg2-binary>=2.9.11`

### 4. OceanBase

分布式关系型数据库。

**核心文件**：[rag/utils/ob_conn.py](../../rag/utils/ob_conn.py)

**依赖**：`pyobvector==0.2.18`

### 5. SQL 执行（Agent 工具）

Agent 可以执行 SQL 查询：

**核心文件**：[agent/tools/exesql.py](../../agent/tools/exesql.py)

支持的数据库：
- MySQL (`pymysql`)
- PostgreSQL (`psycopg2`)
- SQL Server (`pyodbc`)

## Docker 部署

### MySQL

```yaml
mysql:
  image: mysql:8.0
  environment:
    MYSQL_ROOT_PASSWORD: infini_rag_flow
    MYSQL_DATABASE: ragflow
  ports:
    - "3306:3306"
  volumes:
    - mysql_data:/var/lib/mysql
```

### Redis

```yaml
redis:
  image: redis:latest
  command: redis-server --requirepass infini_rag_flow
  ports:
    - "6379:6379"
  volumes:
    - redis_data:/data
```

## 性能优化

### Redis 连接池

```python
REDIS_CONN = valkey.ConnectionPool(
    host=REDIS_HOST,
    port=REDIS_PORT,
    password=REDIS_PASSWORD,
    max_connections=100
)

redis_client = valkey.Redis(connection_pool=REDIS_CONN)
```

### MySQL 连接池

```python
db = MySQLDatabase(
    'ragflow',
    max_connections=20,
    stale_timeout=300
)
```

## 参考文档

- [Redis 文档](https://redis.io/docs)
- [MySQL 文档](https://dev.mysql.com/doc/)
- [Peewee ORM](http://docs.peewee-orm.com/)

## 许可证

遵循项目主许可证 [Apache 2.0](../../LICENSE)
