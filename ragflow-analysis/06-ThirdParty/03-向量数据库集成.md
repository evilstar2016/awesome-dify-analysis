# 向量数据库集成

## 概述

RAGFlow 支持多种向量数据库和检索引擎，用于高效存储和检索文档向量。系统主要使用 Elasticsearch 作为默认向量检索引擎，同时支持 OpenSearch、Infinity 和 OceanBase 等替代方案。

## 支持的向量数据库

### 1. Elasticsearch

#### 简介

Elasticsearch 是 RAGFlow 的默认向量检索引擎，提供强大的全文搜索和向量检索能力。

#### 配置

```yaml
# conf/service_conf.yaml
elasticsearch:
  hosts: http://localhost:9200
  username: elastic
  password: infini_rag_flow
  
# 环境变量
ELASTICSEARCH_HOST=http://localhost:9200
ELASTICSEARCH_USER=elastic  
ELASTICSEARCH_PASSWORD=infini_rag_flow
```

#### 连接实现

**核心文件**：[rag/utils/es_conn.py](../../rag/utils/es_conn.py)

```python
from elasticsearch import Elasticsearch
from elasticsearch_dsl import Search

class ESConnection:
    """Elasticsearch 连接管理"""
    
    def __init__(self, hosts, user, password):
        self.client = Elasticsearch(
            hosts=hosts,
            basic_auth=(user, password),
            request_timeout=30,
            max_retries=3,
            retry_on_timeout=True
        )
    
    def create_index(self, index_name, mappings):
        """创建索引"""
        self.client.indices.create(
            index=index_name,
            body={"mappings": mappings}
        )
    
    def bulk_insert(self, index_name, documents):
        """批量插入文档"""
        from elasticsearch.helpers import bulk
        actions = [
            {
                "_index": index_name,
                "_source": doc
            }
            for doc in documents
        ]
        bulk(self.client, actions)
    
    def search(self, index_name, query_vector, top_k=10):
        """向量检索"""
        query = {
            "knn": {
                "field": "embedding",
                "query_vector": query_vector,
                "k": top_k,
                "num_candidates": top_k * 10
            }
        }
        response = self.client.search(
            index=index_name,
            body=query
        )
        return response['hits']['hits']
```

#### 索引映射

**配置文件**：[conf/mapping.json](../../conf/mapping.json)

```json
{
  "mappings": {
    "properties": {
      "doc_id": {"type": "keyword"},
      "content": {"type": "text"},
      "embedding": {
        "type": "dense_vector",
        "dims": 1536,
        "index": true,
        "similarity": "cosine"
      },
      "create_time": {"type": "date"},
      "kb_id": {"type": "keyword"}
    }
  }
}
```

#### 使用示例

```python
from rag.utils.es_conn import ESConnection

# 连接 Elasticsearch
es_conn = ESConnection(
    hosts="http://localhost:9200",
    user="elastic",
    password="your_password"
)

# 创建索引
es_conn.create_index("my_index", mappings)

# 插入文档
documents = [
    {
        "doc_id": "doc1",
        "content": "文档内容",
        "embedding": [0.1, 0.2, ..., 0.5]  # 1536维
    }
]
es_conn.bulk_insert("my_index", documents)

# 向量检索
results = es_conn.search(
    index_name="my_index",
    query_vector=query_embedding,
    top_k=10
)
```

#### 性能优化

```python
# 1. 批量索引
es_conn.bulk_insert(index_name, documents, chunk_size=500)

# 2. 刷新策略
es_conn.client.indices.put_settings(
    index=index_name,
    body={"index": {"refresh_interval": "30s"}}
)

# 3. 分片策略
mappings = {
    "settings": {
        "number_of_shards": 5,
        "number_of_replicas": 1
    }
}
```

**依赖**：
```toml
elasticsearch-dsl==8.12.0
```

### 2. OpenSearch

#### 简介

OpenSearch 是 Elasticsearch 的开源替代品，提供相似的功能和API。

#### 配置

```yaml
# conf/service_conf.yaml
opensearch:
  hosts: http://localhost:9200
  username: admin
  password: admin
```

#### 连接实现

**核心文件**：[rag/utils/opensearch_conn.py](../../rag/utils/opensearch_conn.py)

```python
from opensearchpy import OpenSearch

class OpenSearchConnection:
    def __init__(self, hosts, user, password):
        self.client = OpenSearch(
            hosts=hosts,
            http_auth=(user, password),
            use_ssl=False,
            verify_certs=False
        )
```

#### 索引配置

**配置文件**：[conf/os_mapping.json](../../conf/os_mapping.json)

```json
{
  "settings": {
    "index.knn": true,
    "index.knn.space_type": "cosinesimil"
  },
  "mappings": {
    "properties": {
      "embedding": {
        "type": "knn_vector",
        "dimension": 1536,
        "method": {
          "name": "hnsw",
          "space_type": "cosinesimil",
          "engine": "lucene"
        }
      }
    }
  }
}
```

**依赖**：
```toml
opensearch-py==2.7.1
```

### 3. Infinity

#### 简介

Infinity 是专为 RAG 应用优化的高性能向量数据库，提供更快的检索速度和更低的延迟。

#### 配置

```yaml
# conf/service_conf.yaml
infinity:
  host: localhost
  port: 23817

# 环境变量
INFINITY_HOST=localhost
INFINITY_PORT=23817
```

#### 连接实现

**核心文件**：[rag/utils/infinity_conn.py](../../rag/utils/infinity_conn.py)

```python
import infinity
from infinity import index

class InfinityConnection:
    """Infinity 向量数据库连接"""
    
    def __init__(self, host="localhost", port=23817):
        self.client = infinity.connect(
            infinity.NetworkAddress(host, port)
        )
    
    def create_table(self, db_name, table_name, schema):
        """创建表"""
        db = self.client.get_database(db_name)
        table = db.create_table(table_name, schema)
        return table
    
    def insert_vectors(self, table, documents):
        """插入向量"""
        table.insert(documents)
    
    def search(self, table, query_vector, top_k=10):
        """向量检索"""
        results = table.output(["doc_id", "content", "distance"]).knn(
            "embedding",
            query_vector,
            "float",
            "ip",  # 内积相似度
            top_k
        ).to_pl()
        return results
```

#### 索引配置

**配置文件**：[conf/infinity_mapping.json](../../conf/infinity_mapping.json)

```json
{
  "fields": [
    {"name": "doc_id", "type": "varchar"},
    {"name": "content", "type": "varchar"},
    {"name": "embedding", "type": "vector,1536,float"}
  ],
  "indexes": [
    {
      "index_name": "embedding_idx",
      "index_type": "IVFFlat",
      "index_column": "embedding",
      "params": {
        "metric": "ip",
        "centroids_count": 128
      }
    }
  ]
}
```

#### 使用示例

```python
from rag.utils.infinity_conn import InfinityConnection

# 连接 Infinity
conn = InfinityConnection(host="localhost", port=23817)

# 创建表
schema = {
    "doc_id": "varchar",
    "content": "varchar",
    "embedding": {"type": "vector", "dimension": 1536}
}
table = conn.create_table("my_db", "my_table", schema)

# 插入向量
documents = [
    {
        "doc_id": "doc1",
        "content": "文档内容",
        "embedding": [0.1, 0.2, ..., 0.5]
    }
]
conn.insert_vectors(table, documents)

# 检索
results = conn.search(table, query_vector, top_k=10)
```

**依赖**：
```toml
infinity-sdk==0.6.11
infinity-emb>=0.0.66
```

### 4. OceanBase

#### 简介

OceanBase 是分布式关系型数据库，支持向量检索功能。

#### 配置

```yaml
# conf/service_conf.yaml
oceanbase:
  host: localhost
  port: 2881
  user: root@test
  password: password
  database: ragflow
```

#### 连接实现

**核心文件**：[rag/utils/ob_conn.py](../../rag/utils/ob_conn.py)

```python
class OBConnection:
    """OceanBase 连接"""
    
    def __init__(self, host, port, user, password, database):
        import pymysql
        self.conn = pymysql.connect(
            host=host,
            port=port,
            user=user,
            password=password,
            database=database
        )
    
    def create_table(self, table_name):
        """创建向量表"""
        sql = f"""
        CREATE TABLE {table_name} (
            id BIGINT PRIMARY KEY AUTO_INCREMENT,
            doc_id VARCHAR(255),
            content TEXT,
            embedding VARBINARY(8192)
        )
        """
        cursor = self.conn.cursor()
        cursor.execute(sql)
        self.conn.commit()
```

**依赖**：
```toml
pyobvector==0.2.18
```

## 功能对比

| 特性 | Elasticsearch | OpenSearch | Infinity | OceanBase |
|------|--------------|-----------|----------|-----------|
| 向量检索 | ✅ KNN | ✅ KNN | ✅ 优化 | ✅ 基础 |
| 全文搜索 | ✅ 强大 | ✅ 强大 | ❌ | ✅ |
| 混合检索 | ✅ | ✅ | ✅ | ✅ |
| 分布式 | ✅ | ✅ | ✅ | ✅ |
| 索引类型 | HNSW | HNSW | IVFFlat | - |
| 延迟 | ~50ms | ~50ms | ~10ms | ~100ms |
| 吞吐量 | 高 | 高 | 极高 | 中 |
| 成本 | 中 | 低（开源） | 中 | 高 |

## 混合检索

### 向量 + 全文搜索

```python
# Elasticsearch 混合检索
query = {
    "query": {
        "bool": {
            "should": [
                {
                    "knn": {
                        "field": "embedding",
                        "query_vector": query_vector,
                        "k": 50
                    }
                },
                {
                    "match": {
                        "content": {
                            "query": "检索关键词",
                            "boost": 2.0
                        }
                    }
                }
            ]
        }
    }
}

results = es_conn.client.search(index=index_name, body=query)
```

### 向量 + 过滤

```python
# 带过滤条件的向量检索
query = {
    "knn": {
        "field": "embedding",
        "query_vector": query_vector,
        "k": 100,
        "filter": {
            "bool": {
                "must": [
                    {"term": {"kb_id": "kb_123"}},
                    {"range": {"create_time": {"gte": "2024-01-01"}}}
                ]
            }
        }
    }
}
```

## 性能优化

### 1. 索引优化

```python
# 使用 IVF 索引
mappings = {
    "settings": {
        "index.knn": true,
        "index.knn.algo_param.ef_construction": 512,
        "index.knn.algo_param.m": 32
    }
}
```

### 2. 查询优化

```python
# 调整 num_candidates
query = {
    "knn": {
        "field": "embedding",
        "query_vector": query_vector,
        "k": 10,
        "num_candidates": 100  # k 的 10 倍
    }
}
```

### 3. 批量操作

```python
# 批量插入
from elasticsearch.helpers import bulk

actions = []
for doc in documents:
    actions.append({
        "_index": index_name,
        "_source": doc
    })
    
    if len(actions) >= 500:
        bulk(es_conn.client, actions)
        actions = []

if actions:
    bulk(es_conn.client, actions)
```

## 监控与维护

### 健康检查

```python
# Elasticsearch 健康检查
health = es_conn.client.cluster.health()
print(f"Status: {health['status']}")
print(f"Active shards: {health['active_shards']}")
```

### 索引统计

```python
# 获取索引统计
stats = es_conn.client.indices.stats(index=index_name)
print(f"Docs count: {stats['indices'][index_name]['total']['docs']['count']}")
print(f"Store size: {stats['indices'][index_name]['total']['store']['size_in_bytes']}")
```

## Docker 部署

### Elasticsearch

```yaml
# docker-compose.yml
elasticsearch:
  image: docker.elastic.co/elasticsearch/elasticsearch:8.11.3
  environment:
    - discovery.type=single-node
    - xpack.security.enabled=false
    - "ES_JAVA_OPTS=-Xms4g -Xmx4g"
  ports:
    - "9200:9200"
  volumes:
    - es_data:/usr/share/elasticsearch/data
```

### Infinity

```yaml
infinity:
  image: infiniflow/infinity:latest
  ports:
    - "23817:23817"
  volumes:
    - infinity_data:/var/infinity/data
```

## 测试

```bash
# 测试 Elasticsearch 连接
uv run pytest test/test_es_conn.py -v

# 测试向量检索
uv run pytest test/test_vector_search.py -v
```

## 故障排查

### 问题 1：连接失败

```python
# 检查服务状态
curl http://localhost:9200/_cluster/health

# 检查网络
telnet localhost 9200
```

### 问题 2：索引性能差

```python
# 增加副本
es_conn.client.indices.put_settings(
    index=index_name,
    body={"index": {"number_of_replicas": 0}}  # 禁用副本提升写入速度
)

# 优化刷新间隔
es_conn.client.indices.put_settings(
    index=index_name,
    body={"index": {"refresh_interval": "-1"}}  # 禁用自动刷新
)
```

### 问题 3：内存不足

```bash
# 增加 JVM 堆内存
ES_JAVA_OPTS="-Xms8g -Xmx8g"
```

## 参考文档

- [Elasticsearch 向量搜索](https://www.elastic.co/guide/en/elasticsearch/reference/current/knn-search.html)
- [OpenSearch K-NN](https://opensearch.org/docs/latest/search-plugins/knn/index/)
- [Infinity 文档](https://github.com/infiniflow/infinity)

## 许可证

遵循项目主许可证 [Apache 2.0](../../LICENSE)
