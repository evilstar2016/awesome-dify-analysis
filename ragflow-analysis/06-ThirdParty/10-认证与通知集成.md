# 认证与通知集成

## 概述

RAGFlow 集成了多种认证和通知服务，用于用户身份验证、第三方授权和消息推送。

## 认证服务

### 1. OAuth 2.0

#### Google OAuth

**文件**：
- [api/apps/auth/oauth.py](../../api/apps/auth/oauth.py)
- [common/data_source/google_util/oauth_flow.py](../../common/data_source/google_util/oauth_flow.py)

**依赖**：`google-auth-oauthlib>=1.2.0`

**配置示例**：

```python
from google.oauth2.credentials import Credentials
from google_auth_oauthlib.flow import Flow

# OAuth 流程
flow = Flow.from_client_config(
    client_config={
        "web": {
            "client_id": "YOUR_CLIENT_ID",
            "client_secret": "YOUR_CLIENT_SECRET",
            "auth_uri": "https://accounts.google.com/o/oauth2/auth",
            "token_uri": "https://oauth2.googleapis.com/token"
        }
    },
    scopes=['https://www.googleapis.com/auth/drive.readonly']
)

# 获取授权 URL
auth_url, state = flow.authorization_url(prompt='consent')

# 交换授权码
flow.fetch_token(code=authorization_code)
credentials = flow.credentials
```

#### 使用示例

```python
# 初始化 OAuth 流程
from api.apps.auth.oauth import init_oauth_flow

oauth_url = init_oauth_flow(
    provider="google",
    redirect_uri="http://localhost:8000/callback"
)

# 用户授权后回调处理
from api.apps.auth.oauth import handle_oauth_callback

credentials = handle_oauth_callback(
    provider="google",
    code=authorization_code
)
```

### 2. 本地认证

基于 Flask-Login 的会话管理：

**依赖**：
- `flask-login==0.6.3`
- `flask-session==0.8.0`

### 3. 密钥加密

RSA 加密存储敏感信息：

**文件**：[common/crypto_utils.py](../../common/crypto_utils.py)

**密钥对**：
- [conf/private.pem](../../conf/private.pem) - 私钥
- [conf/public.pem](../../conf/public.pem) - 公钥

**依赖**：`pycryptodomex==3.20.0`

## 通知服务

### 1. 邮件通知 (SMTP)

**文件**：[agent/tools/email.py](../../agent/tools/email.py)

**依赖**：
- `aiosmtplib>=5.0.0`
- `flask-mail>=0.10.0`

#### 配置

```python
# SMTP 配置
SMTP_CONFIG = {
    "host": "smtp.gmail.com",
    "port": 587,
    "username": "your-email@gmail.com",
    "password": "your-app-password",
    "use_tls": True
}
```

#### 使用示例

```python
import aiosmtplib
from email.mime.text import MIMEText

async def send_email(to, subject, body):
    message = MIMEText(body, "html")
    message["From"] = "sender@example.com"
    message["To"] = to
    message["Subject"] = subject
    
    await aiosmtplib.send(
        message,
        hostname="smtp.gmail.com",
        port=587,
        username="your-email",
        password="your-password",
        use_tls=True
    )
```

### 2. Slack 通知

**文件**：[common/data_source/slack_connector.py](../../common/data_source/slack_connector.py)

**依赖**：`slack-sdk==3.37.0`

#### 使用示例

```python
from slack_sdk import WebClient

client = WebClient(token="xoxb-your-token")

# 发送消息
response = client.chat_postMessage(
    channel="#general",
    text="Hello from RAGFlow!"
)
```

### 3. Discord 通知

**文件**：
- [rag/svr/discord_svr.py](../../rag/svr/discord_svr.py)
- [common/data_source/discord_connector.py](../../common/data_source/discord_connector.py)

**依赖**：`discord-py==2.3.2`

#### Discord Bot 服务

```python
import discord

class RagFlowBot(discord.Client):
    async def on_ready(self):
        print(f'Logged in as {self.user}')
    
    async def on_message(self, message):
        if message.author == self.user:
            return
        
        if message.content.startswith('!ragflow'):
            await message.channel.send('Hello!')

# 启动 Bot
bot = RagFlowBot()
bot.run('YOUR_BOT_TOKEN')
```

**服务文件**：[rag/svr/discord_svr.py](../../rag/svr/discord_svr.py)

### 4. 企业通讯集成

#### 4.1 微信

通过插件集成：

**目录**：[intergrations/chatgpt-on-wechat/](../../intergrations/chatgpt-on-wechat/)

#### 4.2 企业微信/钉钉

需要自定义开发或使用第三方插件。

## 安全最佳实践

### 1. 密钥管理

```bash
# 使用环境变量
export GOOGLE_CLIENT_ID=xxxxx
export GOOGLE_CLIENT_SECRET=xxxxx
export SMTP_PASSWORD=xxxxx

# 不要在代码中硬编码
```

### 2. Token 刷新

```python
from google.auth.transport.requests import Request

# 刷新过期的 token
if credentials.expired and credentials.refresh_token:
    credentials.refresh(Request())
```

### 3. HTTPS Only

```python
# 强制 HTTPS
if not request.is_secure:
    return redirect(request.url.replace("http://", "https://"))
```

## 使用示例

### OAuth + 数据同步

```python
# 1. 用户授权
oauth_url = init_oauth_flow("google")
# 用户访问 oauth_url 并授权

# 2. 获取凭据
credentials = handle_oauth_callback(code)

# 3. 同步 Google Drive 数据
from common.data_source.google_drive import GoogleDriveConnector

connector = GoogleDriveConnector(credentials)
files = connector.list_files()
```

### 邮件通知 + 任务完成

```python
async def notify_task_complete(user_email, task_name):
    subject = f"任务完成: {task_name}"
    body = f"""
    <html>
    <body>
        <h2>任务已完成</h2>
        <p>您的任务 <strong>{task_name}</strong> 已成功完成。</p>
    </body>
    </html>
    """
    
    await send_email(user_email, subject, body)
```

## 配置示例

### Flask-Session 配置

```python
from flask import Flask
from flask_session import Session

app = Flask(__name__)
app.config['SESSION_TYPE'] = 'redis'
app.config['SESSION_REDIS'] = redis_client
Session(app)
```

### CORS 配置

**依赖**：`flask-cors==6.0.2`

```python
from flask_cors import CORS

app = Flask(__name__)
CORS(app, 
     origins=["http://localhost:3000"],
     supports_credentials=True)
```

## 测试

```bash
# 测试 OAuth 流程
uv run pytest test/test_oauth.py -v

# 测试邮件发送
uv run pytest test/test_email.py -v
```

## 故障排查

### 问题 1：OAuth 回调失败

```python
# 检查 redirect_uri 是否匹配
print(f"Expected: {flow.redirect_uri}")
print(f"Actual: {request.url}")
```

### 问题 2：邮件发送失败

```python
# 检查 SMTP 连接
import smtplib

try:
    server = smtplib.SMTP("smtp.gmail.com", 587)
    server.starttls()
    server.login(username, password)
    print("SMTP connection successful")
except Exception as e:
    print(f"SMTP error: {e}")
```

## 参考文档

- [Google OAuth 2.0](https://developers.google.com/identity/protocols/oauth2)
- [Flask-Login 文档](https://flask-login.readthedocs.io/)
- [Slack API](https://api.slack.com/)
- [Discord Bot](https://discord.com/developers/docs)

## 许可证

遵循项目主许可证 [Apache 2.0](../../LICENSE)
