# 代码执行沙箱集成

## 概述

RAGFlow 提供安全的代码执行环境，支持在隔离的 Docker 容器中运行用户代码，确保系统安全性。

## 核心组件

### 1. Agent 代码执行工具

**文件**：[agent/tools/code_exec.py](../../agent/tools/code_exec.py)

### 2. Sandbox 服务

**目录**：[sandbox/](../../sandbox/)

#### 项目结构

```
sandbox/
├── executor_manager/     # 执行器管理
├── sandbox_base_image/   # 基础镜像
├── scripts/             # 脚本工具
├── tests/               # 测试
├── docker-compose.yml   # Docker 配置
└── pyproject.toml       # 依赖管理
```

## 功能特性

### 1. 支持的语言

- **Python** - 主要支持
- **JavaScript** - Node.js 环境
- **SQL** - 数据库查询

### 2. 安全隔离

- Docker 容器隔离
- 资源限制（CPU、内存）
- 超时控制
- 网络隔离（可选）

### 3. 资源限制

```yaml
# docker-compose.yml
sandbox:
  image: ragflow/sandbox:latest
  deploy:
    resources:
      limits:
        cpus: '2.0'
        memory: 4G
      reservations:
        cpus: '1.0'
        memory: 2G
```

## 使用示例

### Python 代码执行

```python
from agent.tools.code_exec import execute_code

code = """
import numpy as np

# 计算数组平均值
arr = np.array([1, 2, 3, 4, 5])
result = np.mean(arr)
print(f"平均值: {result}")
"""

result = execute_code(
    code=code,
    language="python",
    timeout=30
)

print(result['output'])
print(result['error'])
```

### SQL 执行

```python
from agent.tools.exesql import execute_sql

sql = """
SELECT * FROM users 
WHERE age > 18 
LIMIT 10
"""

result = execute_sql(
    sql=sql,
    connection_string="mysql://user:pass@localhost/db"
)
```

## Docker 部署

### 构建沙箱镜像

```bash
cd sandbox
docker build -t ragflow/sandbox:latest .
```

### 运行沙箱服务

```bash
cd sandbox
docker-compose up -d
```

## 安全配置

### 1. 网络隔离

```yaml
sandbox:
  networks:
    - isolated_network
  
networks:
  isolated_network:
    driver: bridge
    internal: true  # 禁止外部访问
```

### 2. 文件系统限制

```yaml
sandbox:
  volumes:
    - /tmp/sandbox:/workspace:ro  # 只读挂载
```

### 3. 权限控制

```dockerfile
# 使用非 root 用户
USER sandbox
WORKDIR /workspace
```

## 执行流程

1. **提交代码** → Agent 接收用户代码
2. **安全检查** → 检测危险操作
3. **创建容器** → 启动隔离环境
4. **执行代码** → 运行用户代码
5. **收集结果** → 获取输出和错误
6. **清理环境** → 销毁容器

## 限制与约束

### 1. 执行时间

- 默认超时：30 秒
- 最大超时：5 分钟

### 2. 内存限制

- 默认：2GB
- 最大：4GB

### 3. 磁盘空间

- 临时文件：100MB
- 禁止写入敏感路径

### 4. 网络访问

- 默认：禁止外部网络
- 可配置白名单

## 监控与日志

```python
# 记录执行日志
logger.info(f"Executing code in sandbox")
logger.info(f"Language: {language}, Timeout: {timeout}s")
logger.info(f"Execution time: {elapsed_time:.2f}s")
logger.error(f"Execution failed: {error_message}")
```

## 故障排查

### 问题 1：容器启动失败

```bash
# 检查 Docker 服务
docker ps -a
docker logs sandbox_container

# 重启服务
docker-compose restart
```

### 问题 2：执行超时

```python
# 增加超时时间
result = execute_code(code, timeout=60)
```

### 问题 3：内存不足

```yaml
# 增加内存限制
deploy:
  resources:
    limits:
      memory: 8G
```

## 测试

```bash
# 运行沙箱测试
cd sandbox
uv run pytest tests/ -v
```

## 参考文档

- [Docker Security](https://docs.docker.com/engine/security/)
- [Container Best Practices](https://cloud.google.com/architecture/best-practices-for-operating-containers)

## 许可证

遵循项目主许可证 [Apache 2.0](../../LICENSE)
