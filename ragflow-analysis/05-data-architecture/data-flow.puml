@startuml Data_Flow

title RAGFlow 主要数据流程

!define ACTIVITY rectangle

skinparam activity {
  BackgroundColor LightYellow
  BorderColor Black
  DiamondBackgroundColor LightGreen
}

|用户|
start
:用户上传文档;

|API层|
:接收文件上传请求;
:验证用户权限;

|服务层|
partition "文档处理流程" {
  :保存文件元数据到 MySQL;
  
  fork
    :上传文件到 MinIO;
  fork again
    :创建解析任务;
    :任务入队 Redis Stream;
  end fork
}

|任务执行器|
:从队列拉取任务;
:从 MinIO 下载文件;

partition "文档解析" {
  :调用解析器处理文档;
  :提取文本和结构;
  :分块处理;
  
  fork
    :文本向量化 (Embedding);
    :插入向量到 Infinity;
  fork again
    :创建全文索引;
    :插入到 Elasticsearch;
  fork again
    :更新进度到 MySQL;
  end fork
}

:任务完成 ACK;

|用户|
:查看文档状态;

stop

|#LightBlue|用户查询流程|
start

:用户提问;

|API层|
:接收查询请求;
:获取 Dialog 配置;

|服务层|
partition "检索流程" {
  :查询向量化;
  
  fork
    :向量检索 (Infinity);
    :KNN Search Top 1024;
  fork again
    :全文检索 (Elasticsearch);
    :BM25 Search Top 1024;
  end fork
  
  :融合检索结果;
  :重排序 (Rerank) Top N;
}

partition "生成流程" {
  :构建 Prompt;
  :调用 LLM 生成答案;
  :流式返回结果;
}

:保存对话历史到 MySQL;
:缓存结果到 Redis;

|用户|
:接收答案;

stop

|#LightCoral|数据同步流程|
start

:定时触发 / Webhook;

|同步服务|
:连接数据源 (S3/SharePoint等);

partition "增量同步" {
  :获取文件列表;
  :比对已有文档;
  
  if (有新文档?) then (yes)
    :下载新文档;
    :保存到 MinIO;
    :创建文档记录;
    :触发解析任务;
  else (no)
    :跳过;
  endif
  
  if (有删除?) then (yes)
    :标记文档为删除;
    :从 ES 删除索引;
    :从 Infinity 删除向量;
  else (no)
    :跳过;
  endif
}

:记录同步日志;

stop

|#LightGreen|缓存更新流程|
start

:数据库数据更新;

|服务层|
:更新 MySQL 记录;

partition "缓存失效" {
  :删除 Redis 缓存;
  
  if (涉及索引?) then (yes)
    fork
      :更新 Elasticsearch;
    fork again
      :更新 Infinity;
    end fork
  endif
}

:返回更新结果;

stop

@enduml
