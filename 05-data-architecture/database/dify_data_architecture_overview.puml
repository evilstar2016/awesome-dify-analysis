@startuml Dify Data Architecture Overview
!theme plain
skinparam backgroundColor #FFFFFF
skinparam linetype ortho
skinparam roundcorner 10
skinparam class {
    BackgroundColor #F8F9FA
    BorderColor #1976D2
    ArrowColor #1976D2
    FontColor #212529
}
skinparam package {
    BackgroundColor #E3F2FD
    BorderColor #1976D2
    FontColor #1976D2
}
skinparam note {
    BackgroundColor #FFF3E0
    BorderColor #F57C00
}

title Dify 核心数据架构概览 (Core Data Architecture Overview)

' ========== Core Entities ==========
package "账户与租户 (Account & Tenant)" as AT #E3F2FD {
    class Account {
        id: UUID
        name: String
        email: String
        status: AccountStatus
    }
    
    class Tenant {
        id: UUID
        name: String
        plan: String
        status: TenantStatus
    }
    
    class TenantAccountJoin {
        id: UUID
        role: TenantAccountRole
    }
}

package "应用 (Application)" as APP #E8F5E9 {
    class App {
        id: UUID
        name: String
        mode: AppMode
        description: Text
    }
    
    class AppModelConfig {
        id: UUID
        model_id: String
        agent_mode: JSON
    }
    
    class Workflow {
        id: UUID
        type: WorkflowType
        graph: JSON
        features: JSON
    }
}

package "对话 (Conversation)" as CONV #FFF3E0 {
    class Conversation {
        id: UUID
        name: String
        mode: String
        status: String
    }
    
    class Message {
        id: UUID
        query: Text
        answer: Text
        tokens: Integer
    }
    
    class EndUser {
        id: UUID
        session_id: String
    }
}

package "知识库 (Knowledge Base)" as KB #FCE4EC {
    class Dataset {
        id: UUID
        name: String
        indexing_technique: String
        embedding_model: String
    }
    
    class Document {
        id: UUID
        name: String
        indexing_status: String
        word_count: Integer
    }
    
    class DocumentSegment {
        id: UUID
        content: Text
        tokens: Integer
        position: Integer
    }
    
    class Embedding {
        id: UUID
        hash: String
        embedding: Bytes
    }
}

package "工作流执行 (Workflow Execution)" as WF #E1BEE7 {
    class WorkflowRun {
        id: UUID
        status: ExecutionStatus
        inputs: JSON
        outputs: JSON
    }
    
    class WorkflowNodeExecution {
        id: UUID
        node_type: NodeType
        status: String
    }
}

package "工具 (Tools)" as TOOLS #B2DFDB {
    class BuiltinToolProvider {
        id: UUID
        provider: String
    }
    
    class ApiToolProvider {
        id: UUID
        name: String
        schema: Text
    }
    
    class WorkflowToolProvider {
        id: UUID
        name: String
        app_id: UUID
    }
}

' ========== Relationships ==========

' Account & Tenant
Tenant "1" -- "*" TenantAccountJoin
Account "1" -- "*" TenantAccountJoin

' Application
Tenant "1" -- "*" App
App "1" -- "0..1" AppModelConfig
App "1" -- "*" Workflow

' Conversation
App "1" -- "*" Conversation
Conversation "1" -- "*" Message
Conversation "*" -- "0..1" EndUser

' Knowledge Base
Tenant "1" -- "*" Dataset
Dataset "1" -- "*" Document
Document "1" -- "*" DocumentSegment
DocumentSegment "*" -- "*" Embedding

' Workflow Execution
Workflow "1" -- "*" WorkflowRun
WorkflowRun "1" -- "*" WorkflowNodeExecution
Message "*" -- "0..1" WorkflowRun

' Tools
Tenant "1" -- "*" BuiltinToolProvider
Tenant "1" -- "*" ApiToolProvider
Tenant "1" -- "*" WorkflowToolProvider

' Cross-package relationships
App "*" -- "*" Dataset : "AppDatasetJoin"

' ========== Legend ==========
legend right
  |= 颜色 |= 领域 |
  | <#E3F2FD> | 账户与租户 |
  | <#E8F5E9> | 应用 |
  | <#FFF3E0> | 对话 |
  | <#FCE4EC> | 知识库 |
  | <#E1BEE7> | 工作流执行 |
  | <#B2DFDB> | 工具 |
end legend

note as N1
  <b>核心数据流:</b>
  1. Tenant 是多租户的顶层实体
  2. App 是应用的核心，可以配置多种模式
  3. Dataset 提供知识库能力
  4. Workflow 实现复杂业务逻辑
  5. Conversation/Message 记录交互历史
end note

@enduml
