@startuml Langfuse System Component Architecture
!theme plain
skinparam componentStyle rectangle
skinparam backgroundColor white
skinparam Package { 
  BackgroundColor LightGray
  FontColor Blue
}
skinparam component {
  BackgroundColor LightBlue
  BorderColor Black
  ArrowColor Black
  FontColor DarkBlue
}
skinparam database {
  BackgroundColor LightYellow
  BorderColor DarkGreen
}
skinparam note {
  backgroundColor LightYellow
}
skinparam cloud {
  BackgroundColor WhiteSmoke
  BorderColor Gray
}

' 用户和外部系统
actor "用户\n(Browser)" as User
actor "SDK\n(Python/JS/TS)" as SDK

' LLM 提供商
cloud "LLM 提供商" as LLM {
  [OpenAI]
  [Azure OpenAI]
  [Anthropic]
  [Google Vertex AI]
  [AWS Bedrock]
  [Google Gemini]
}

' Layer 1: 前端展示层
package "Layer 1: 前端展示层 (Next.js 15.5 + React 19)" {
  [页面路由\n(pages/)] as Pages
  [React 组件\n(shadcn/ui)] as Components
  [状态管理\n(TanStack Query)] as StateManagement
  
  Pages -down-> Components
  Pages -down-> StateManagement
}

' Layer 2: tRPC API 层
package "Layer 2: tRPC API 层" {
  [tRPC Root Router\n(60+ routers)] as TRPC
  [中间件\n(Auth/RBAC)] as Middleware
  [输入验证\n(Zod schemas)] as Validation
  
  TRPC -right-> Middleware
  TRPC -right-> Validation
}

' Layer 3: 业务服务层
package "Layer 3: 业务服务层 (Features)" {
  package "核心模块" {
    [Traces\n追踪管理] as TracesFeature
    [Observations\n观测数据] as ObservationsFeature
    [Prompts\n提示词管理] as PromptsFeature
    [Scores\n评分系统] as ScoresFeature
  }
  
  package "评估与测试" {
    [Datasets\n数据集] as DatasetsFeature
    [Evaluations\n评估系统] as EvalsFeature
    [Playground\nLLM 测试] as PlaygroundFeature
  }
  
  package "分析与展示" {
    [Dashboard\n仪表盘] as DashboardFeature
    [Analytics\n数据分析] as AnalyticsFeature
    [Batch Export\n批量导出] as ExportFeature
  }
  
  package "基础设施" {
    [Authentication\n认证] as Auth
    [RBAC\n权限控制] as RBAC
    [Notifications\n通知] as Notifications
    [LLM API Key\n密钥管理] as LLMKeyManagement
  }
}

' Layer 4: 数据访问层
package "Layer 4: 数据访问层" {
  [Prisma ORM\n(PostgreSQL)] as PrismaORM
  [Kysely\n(ClickHouse)] as KyselyQuery
  [Redis Client\n(ioredis)] as RedisClient
  [S3 Client\n(AWS SDK)] as S3Client
  [BullMQ Client\n(任务队列)] as BullMQClient
}

' Layer 5: 共享包层
package "Layer 5: 共享包层 (packages/shared)" {
  [Domain Models\n领域模型] as Domain
  [Database Schema\n(Prisma)] as PrismaSchema
  [ClickHouse 迁移] as CHMigrations
  [加密工具\n(Encryption)] as Encryption
  [验证工具\n(Zod)] as ZodValidation
  [日志工具\n(Winston)] as Logger
  [工具函数\n(Utils)] as Utils
  
  PrismaSchema -down-> Domain
}

' Layer 6: Worker 服务层
package "Layer 6: Worker 服务层 (Async Processing)" {
  package "BullMQ 队列" {
    [Ingestion Queue\n数据摄取] as IngestionQueue
    [Evaluation Queue\n评估任务] as EvalQueue
    [Dataset Queue\n数据集处理] as DatasetQueue
    [Webhook Queue\nWebhook 推送] as WebhookQueue
    [Export Queue\n批量导出] as ExportQueue
    [Sync Queue\nCH 同步] as SyncQueue
  }
  
  package "Worker 服务" {
    [Ingestion Service] as IngestionService
    [Evaluation Service] as EvaluationService
    [Dataset Service] as DatasetService
    [Export Service] as ExportService
    [Sync Service] as SyncService
  }
  
  package "后台任务" {
    [Background Migrations\n数据迁移] as Migrations
    [Scheduled Jobs\n定时任务] as ScheduledJobs
  }
  
  IngestionQueue -down-> IngestionService
  EvalQueue -down-> EvaluationService
  DatasetQueue -down-> DatasetService
  ExportQueue -down-> ExportService
  SyncQueue -down-> SyncService
}

' 企业版扩展
package "企业版 (ee/) - 可选" {
  [License Check\n许可证验证] as License
  [SSO/SAML\n单点登录] as SSO
  [Advanced RBAC\n高级权限] as AdvancedRBAC
}

' Infrastructure: 数据存储层
package "Infrastructure: 数据存储层" {
  database "PostgreSQL\n(OLTP - Prisma)" as PG {
    folder "用户/组织/项目"
    folder "API Keys"
    folder "Prompts"
    folder "Datasets"
    folder "Eval 配置"
    folder "元数据"
  }
  
  database "ClickHouse\n(OLAP - Kysely)" as CH {
    folder "Traces"
    folder "Observations"
    folder "Scores"
    folder "Events"
    folder "时序数据"
  }
  
  database "Redis / Valkey\n(Cache + Queue)" as Redis {
    folder "Session 缓存"
    folder "API Key 缓存"
    folder "BullMQ队列"
    folder "速率限制"
  }
  
  database "S3 / Blob Storage" as S3 {
    folder "原始事件 Buffer"
    folder "多媒体附件"
    folder "导出数据"
    folder "备份归档"
  }
}

' 第三方服务集成
cloud "认证服务" as AuthProviders {
  [NextAuth.js]
  [Google OAuth]
  [GitHub OAuth]
  [Azure AD]
  [Okta SAML]
}

cloud "监控与可观测性" as Monitoring {
  [OpenTelemetry]
  [Sentry\n(错误追踪)]
  [PostHog\n(产品分析)]
  [Winston\n(日志)]
}

cloud "消息与通知" as Messaging {
  [Slack]
  [Email\n(Resend)]
  [Webhook]
}

cloud "支付服务" as Payment {
  [Stripe]
}

' ======================================================
' 用户交互流
' ======================================================

User --> Pages : HTTP 请求
SDK --> TRPC : API 调用 (Ingestion)

' ======================================================
' 前端层 → API 层
' ======================================================

Pages -down-> TRPC : tRPC Client
StateManagement -down-> TRPC : React Query

' ======================================================
' API 层 → 业务层
' ======================================================

TRPC -down-> TracesFeature
TRPC -down-> PromptsFeature
TRPC -down-> DatasetsFeature
TRPC -down-> ScoresFeature
TRPC -down-> EvalsFeature
TRPC -down-> PlaygroundFeature
TRPC -down-> DashboardFeature
TRPC -down-> Auth
TRPC -down-> RBAC

Middleware -down-> Auth
Middleware -down-> RBAC

' ======================================================
' 业务层 → 数据访问层
' ======================================================

TracesFeature -down-> PrismaORM
TracesFeature -down-> KyselyQuery
ObservationsFeature -down-> PrismaORM
ObservationsFeature -down-> KyselyQuery
PromptsFeature -down-> PrismaORM
ScoresFeature -down-> PrismaORM
ScoresFeature -down-> KyselyQuery
DatasetsFeature -down-> PrismaORM
EvalsFeature -down-> PrismaORM
DashboardFeature -down-> KyselyQuery
AnalyticsFeature -down-> KyselyQuery
ExportFeature -down-> S3Client

Auth -down-> PrismaORM
Auth -down-> RedisClient
RBAC -down-> PrismaORM
Notifications -down-> BullMQClient
LLMKeyManagement -down-> PrismaORM
LLMKeyManagement -down-> Encryption

' ======================================================
' 业务层 → 共享包层
' ======================================================

TracesFeature -down-> Domain
PromptsFeature -down-> Domain
ScoresFeature -down-> Domain
DatasetsFeature -down-> Domain
EvalsFeature -down-> Domain
PlaygroundFeature -down-> Encryption
Auth -down-> ZodValidation

' ======================================================
' 数据访问层 → 数据库
' ======================================================

PrismaORM -down-> PG : 读写元数据
KyselyQuery -down-> CH : 读写分析数据
RedisClient -down-> Redis : 缓存/队列
S3Client -down-> S3 : 对象存储
BullMQClient -down-> Redis : 任务队列

' ======================================================
' Worker 层连接
' ======================================================

' Web 业务层推送任务到队列
TracesFeature -right-> IngestionQueue : 入队
EvalsFeature -right-> EvalQueue : 入队评估任务
DatasetsFeature -right-> DatasetQueue : 入队
ExportFeature -right-> ExportQueue : 入队导出
Notifications -right-> WebhookQueue : 入队通知

' Worker 服务访问数据
IngestionService -down-> PrismaORM
IngestionService -down-> S3Client
IngestionService -down-> SyncQueue : 触发同步

EvaluationService -down-> PrismaORM
EvaluationService -down-> KyselyQuery
EvaluationService -up-> LLM : LLM-as-a-Judge

DatasetService -down-> PrismaORM
ExportService -down-> KyselyQuery
ExportService -down-> S3Client
SyncService -down-> PrismaORM
SyncService -down-> KyselyQuery : PG → CH 同步

Migrations -down-> PrismaORM
Migrations -down-> KyselyQuery

' ======================================================
' 企业版集成
' ======================================================

Auth -down-> License : 许可证检查
Auth -down-> SSO : SSO 登录
RBAC -down-> AdvancedRBAC : 高级权限

' ======================================================
' 第三方服务集成
' ======================================================

Auth -up-> AuthProviders : OAuth/SAML
PlaygroundFeature -up-> LLM : 调用 LLM API
EvaluationService -up-> LLM : 自动评估
Pages -up-> Monitoring : 前端监控
TRPC -up-> Monitoring : 后端监控
IngestionService -up-> Monitoring : Worker 监控
Notifications -up-> Messaging : 推送通知
Auth -right-> Payment : 订阅管理

' ======================================================
' 注释说明
' ======================================================

note right of TRPC
  <b>tRPC API 层</b>
  • 60+ 类型安全路由器
  • 端到端类型推导
  • Zod Schema 验证
  • 认证与 RBAC 中间件
end note

note right of TracesFeature
  <b>核心追踪功能</b>
  • Trace 创建与查询
  • 树形结构可视化
  • 成本计算
  • 标签与过滤
end note

note right of EvalsFeature
  <b>评估系统</b>
  • LLM-as-a-Judge
  • 人工评估
  • 批量评估
  • 评估报告
end note

note right of PlaygroundFeature
  <b>LLM Playground</b>
  • 多模型对比
  • 实时测试
  • 提示词迭代
  • 支持 6+ LLM 提供商
end note

note bottom of IngestionQueue
  <b>BullMQ 异步处理</b>
  • 高并发数据摄取
  • 自动重试机制
  • 延迟队列
  • 优先级调度
end note

note bottom of PG
  <b>PostgreSQL (OLTP)</b>
  • 事务数据存储
  • ACID 保证
  • 50+ 数据表
  • Prisma ORM
end note

note bottom of CH
  <b>ClickHouse (OLAP)</b>
  • 列式存储
  • 高吞吐写入
  • 快速聚合查询
  • TB 级数据分析
end note

note bottom of Redis
  <b>Redis / Valkey</b>
  • BullMQ 任务队列
  • Session 缓存
  • API Key 缓存
  • 速率限制
end note

note bottom of S3
  <b>对象存储</b>
  • S3 / Azure Blob / GCS
  • 原始事件缓冲
  • 多媒体文件
  • 批量导出归档
end note

note top of LLM
  <b>通过 Langchain 统一接口</b>
  • OpenAI / Azure OpenAI
  • Anthropic Claude
  • Google (Vertex AI / Gemini)
  • AWS Bedrock
  • 自定义 Base URL
end note

note right of Monitoring
  <b>可观测性栈</b>
  • OpenTelemetry (追踪)
  • Sentry (错误监控)
  • PostHog (产品分析)
  • Winston (日志聚合)
end note

note left of Domain
  <b>领域驱动设计</b>
  • 领域实体
  • 业务规则封装
  • 类型安全
  • 不可变模式
end note

@enduml
