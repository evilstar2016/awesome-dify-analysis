# 可观测性集成

## 1. 集成概述

Langfuse 本身是 LLM 可观测性平台,同时也集成了多个可观测性工具来监控自身的运行状态、性能和用户行为。

### 1.1 可观测性策略

- **应用性能监控 (APM)**: OpenTelemetry 追踪
- **错误追踪**: Sentry 异常监控
- **产品分析**: PostHog 用户行为分析
- **日志管理**: Winston 结构化日志
- **可选支持**: Datadog APM

## 2. 支持的服务/产品

| 服务名称 | SDK | 状态 | 优先级 | 用途 |
|---------|-----|------|--------|------|
| **OpenTelemetry** | `@opentelemetry/sdk-node` | ✅ 已支持 | ⭐⭐⭐ 核心 | 分布式追踪、性能监控 |
| **Sentry** | `@sentry/nextjs` | ✅ 已支持 | ⭐⭐⭐ 核心 | 错误追踪、异常监控 |
| **PostHog** | `posthog-js`, `posthog-node` | ✅ 已支持 | ⭐⭐ 重要 | 产品分析、用户行为 |
| **Winston** | `winston` | ✅ 已支持 | ⭐⭐⭐ 核心 | 结构化日志 |
| **Datadog** | `dd-trace` | ✅ 已支持 | ⭐ 可选 | APM、日志、指标 |

### 2.1 版本信息

```json
{
  "@opentelemetry/api": "^1.9.0",
  "@opentelemetry/sdk-node": "^0.53.0",
  "@opentelemetry/instrumentation": "^0.53.0",
  "@opentelemetry/exporter-trace-otlp-proto": "^0.53.0",
  "@sentry/nextjs": "^10.30.0",
  "posthog-js": "^1.273.1",
  "posthog-node": "^5.8.4",
  "winston": "^3.15.0",
  "dd-trace": "^5.65.0"
}
```

## 3. OpenTelemetry 集成

### 3.1 架构设计

```
Application
    ↓
OpenTelemetry SDK
    ↓
OTLP Exporter
    ↓
Collector / Backend
(Jaeger, Tempo, Datadog, etc.)
```

### 3.2 配置实现

```typescript
// web/src/instrumentation.ts (Next.js Instrumentation)
import { NodeSDK } from "@opentelemetry/sdk-node";
import { getNodeAutoInstrumentations } from "@opentelemetry/auto-instrumentations-node";
import { OTLPTraceExporter } from "@opentelemetry/exporter-trace-otlp-proto";
import { Resource } from "@opentelemetry/resources";

const sdk = new NodeSDK({
  resource: new Resource({
    "service.name": env.OTEL_SERVICE_NAME || "langfuse-web",
    "service.version": env.NEXT_PUBLIC_VERSION || "unknown",
    "deployment.environment": env.NODE_ENV,
  }),
  traceExporter: new OTLPTraceExporter({
    url: env.OTEL_EXPORTER_OTLP_ENDPOINT,
  }),
  instrumentations: [
    getNodeAutoInstrumentations({
      "@opentelemetry/instrumentation-http": {},
      "@opentelemetry/instrumentation-prisma": {},
      "@opentelemetry/instrumentation-ioredis": {},
    }),
  ],
});

sdk.start();
```

### 3.3 自定义追踪

```typescript
import { trace, SpanKind } from "@opentelemetry/api";

const tracer = trace.getTracer("langfuse-custom");

export async function processTrace(traceId: string) {
  const span = tracer.startSpan("process-trace", {
    kind: SpanKind.INTERNAL,
    attributes: {
      "trace.id": traceId,
    },
  });

  try {
    // 业务逻辑
    const result = await doWork(traceId);
    
    span.setAttribute("trace.observations.count", result.count);
    span.setStatus({ code: SpanStatusCode.OK });
    
    return result;
  } catch (error) {
    span.recordException(error);
    span.setStatus({ code: SpanStatusCode.ERROR });
    throw error;
  } finally {
    span.end();
  }
}
```

### 3.4 配置示例

```bash
OTEL_EXPORTER_OTLP_ENDPOINT="http://localhost:4318"
OTEL_SERVICE_NAME="langfuse-web"
```

## 4. Sentry 集成

### 4.1 配置实现

```typescript
// sentry.client.config.ts
import * as Sentry from "@sentry/nextjs";

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 0.1, // 10% 采样率
  replaysOnErrorSampleRate: 1.0,
  replaysSessionSampleRate: 0.1,
  
  beforeSend(event, hint) {
    // 过滤敏感信息
    if (event.request?.headers) {
      delete event.request.headers["authorization"];
    }
    return event;
  },
});
```

### 4.2 错误捕获

```typescript
try {
  await riskyOperation();
} catch (error) {
  Sentry.captureException(error, {
    tags: {
      component: "trace-processor",
    },
    extra: {
      traceId: trace.id,
      projectId: project.id,
    },
  });
  throw error;
}
```

### 4.3 配置示例

```bash
NEXT_PUBLIC_SENTRY_DSN="https://...@sentry.io/..."
SENTRY_ORG="langfuse"
SENTRY_PROJECT="langfuse-web"
```

## 5. PostHog 集成

### 5.1 客户端初始化

```typescript
// web/src/app/layout.tsx
import posthog from "posthog-js";

if (typeof window !== "undefined") {
  posthog.init(
    process.env.NEXT_PUBLIC_POSTHOG_KEY!,
    {
      api_host: process.env.NEXT_PUBLIC_POSTHOG_HOST,
      autocapture: false,
      capture_pageview: false,
    }
  );
}
```

### 5.2 事件追踪

```typescript
import { usePostHog } from "posthog-js/react";

function MyComponent() {
  const posthog = usePostHog();

  const handleClick = () => {
    posthog.capture("button_clicked", {
      button_name: "create_trace",
      project_id: projectId,
    });
  };

  return <button onClick={handleClick}>Create Trace</button>;
}
```

### 5.3 服务端追踪

```typescript
import { PostHog } from "posthog-node";

const posthog = new PostHog(
  process.env.NEXT_PUBLIC_POSTHOG_KEY!,
  { host: process.env.NEXT_PUBLIC_POSTHOG_HOST }
);

posthog.capture({
  distinctId: userId,
  event: "eval_job_completed",
  properties: {
    project_id: projectId,
    eval_count: evalCount,
  },
});
```

### 5.4 配置示例

```bash
NEXT_PUBLIC_POSTHOG_KEY="phc_..."
NEXT_PUBLIC_POSTHOG_HOST="https://app.posthog.com"
```

## 6. Winston 日志

### 6.1 日志配置

```typescript
// packages/shared/src/server/logger.ts
import winston from "winston";

export const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || "info",
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  defaultMeta: {
    service: process.env.SERVICE_NAME || "langfuse",
  },
  transports: [
    new winston.transports.Console({
      format: winston.format.combine(
        winston.format.colorize(),
        winston.format.simple()
      ),
    }),
  ],
});
```

### 6.2 使用示例

```typescript
import { logger } from "@langfuse/shared/src/server/logger";

logger.info("Trace processed", {
  traceId: trace.id,
  projectId: project.id,
  observationCount: observations.length,
});

logger.error("Failed to process trace", {
  traceId: trace.id,
  error: error.message,
  stack: error.stack,
});
```

## 7. Datadog APM (可选)

### 7.1 配置

```typescript
// web/src/instrumentation.ts
import tracer from "dd-trace";

if (process.env.DD_TRACE_ENABLED === "true") {
  tracer.init({
    service: "langfuse-web",
    env: process.env.NODE_ENV,
    version: process.env.NEXT_PUBLIC_VERSION,
  });
}
```

### 7.2 配置示例

```bash
DD_TRACE_ENABLED="true"
DD_AGENT_HOST="localhost"
DD_TRACE_AGENT_PORT="8126"
```

## 8. 监控指标

### 8.1 应用性能指标

- **请求延迟**: P50, P95, P99
- **错误率**: 4xx, 5xx 错误百分比
- **吞吐量**: 请求 / 秒

### 8.2 业务指标

- **Trace 摄取速率**: Traces / 秒
- **观测数据量**: Observations / 秒
- **评估执行**: Evaluations / 分钟

### 8.3 基础设施指标

- **数据库连接数**: PostgreSQL, ClickHouse
- **Redis 队列长度**: BullMQ 队列积压
- **存储使用**: S3 存储大小

## 9. 告警配置

### 9.1 错误率告警

```typescript
if (errorRate > 0.05) {
  alert({
    severity: "high",
    message: "Error rate exceeded 5%",
    metric: "error_rate",
    value: errorRate,
  });
}
```

### 9.2 性能告警

```typescript
if (p95Latency > 5000) {
  alert({
    severity: "medium",
    message: "P95 latency exceeded 5 seconds",
    metric: "p95_latency",
    value: p95Latency,
  });
}
```

## 10. 最佳实践

1. **采样率**: 生产环境使用合理的采样率降低成本
2. **敏感信息**: 过滤日志和追踪中的敏感信息
3. **结构化日志**: 使用 JSON 格式便于解析和搜索
4. **关联追踪**: 在日志中包含 Trace ID 和 Span ID

---

**更新日期**: 2025-12-17  
**维护者**: Langfuse Engineering Team
