# 支付集成

## 1. 集成概述

Langfuse Cloud (企业版) 集成 **Stripe** 作为支付处理平台,提供订阅管理、计量计费和发票功能。

### 1.1 使用场景

- **订阅管理**: 创建、更新、取消订阅
- **计量计费**: 基于使用量的动态计费
- **发票管理**: 自动生成和发送发票
- **支付方式**: 信用卡、银行转账
- **Webhook 通知**: 订阅状态变更通知

## 2. Stripe 集成

### 2.1 版本信息

```json
{
  "stripe": "^17.4.0 (worker) / ^18.5.0 (web)"
}
```

### 2.2 核心代码路径

```
web/src/ee/features/billing/
├── server/
│   ├── stripeBillingService.ts        # Stripe 服务
│   └── stripeWebhookHandler.ts        # Webhook 处理
├── utils/
│   ├── stripeClientReference.ts       # 客户端引用
│   ├── stripeIdempotencyKey.ts        # 幂等性密钥
│   └── stripeSubscriptionMetadata.ts  # 订阅元数据
└── components/
    └── BillingSettings.tsx            # 计费 UI

worker/src/features/billing/
├── handleCloudUsageMetering.ts        # 使用量计费
└── handleCloudSpendAlert.ts           # 费用告警
```

### 2.3 Stripe 客户端初始化

```typescript
// web/src/ee/features/billing/server/stripeBillingService.ts
import Stripe from "stripe";

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: "2024-11-20.acacia",
  typescript: true,
});

export class StripeBillingService {
  /**
   * 创建订阅
   */
  async createSubscription(params: {
    orgId: string;
    priceId: string;
    customerId?: string;
  }) {
    // 创建或获取客户
    const customer = params.customerId
      ? params.customerId
      : await this.createCustomer(params.orgId);

    // 创建订阅
    const subscription = await stripe.subscriptions.create({
      customer: customer,
      items: [{ price: params.priceId }],
      payment_behavior: "default_incomplete",
      expand: ["latest_invoice.payment_intent"],
      metadata: {
        orgId: params.orgId,
        environment: env.NEXT_PUBLIC_LANGFUSE_CLOUD_REGION,
      },
    });

    return subscription;
  }

  /**
   * 取消订阅
   */
  async cancelSubscription(subscriptionId: string) {
    return await stripe.subscriptions.cancel(subscriptionId, {
      invoice_now: true,
      prorate: true,
    });
  }

  /**
   * 更新订阅
   */
  async updateSubscription(params: {
    subscriptionId: string;
    priceId: string;
  }) {
    const subscription = await stripe.subscriptions.retrieve(
      params.subscriptionId
    );

    return await stripe.subscriptions.update(params.subscriptionId, {
      items: [
        {
          id: subscription.items.data[0].id,
          price: params.priceId,
        },
      ],
      proration_behavior: "create_prorations",
    });
  }
}
```

### 2.4 计量计费

```typescript
// worker/src/features/billing/handleCloudUsageMetering.ts
import Stripe from "stripe";

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!);

export async function reportUsageToStripe(params: {
  subscriptionItemId: string;
  quantity: number;
  timestamp: number;
}) {
  await stripe.subscriptionItems.createUsageRecord(
    params.subscriptionItemId,
    {
      quantity: params.quantity,
      timestamp: params.timestamp,
      action: "increment",
    },
    {
      idempotencyKey: generateIdempotencyKey({
        type: "usage-metering",
        subscriptionItemId: params.subscriptionItemId,
        timestamp: params.timestamp,
      }),
    }
  );

  logger.info("Usage reported to Stripe", {
    subscriptionItemId: params.subscriptionItemId,
    quantity: params.quantity,
  });
}
```

### 2.5 Webhook 处理

```typescript
// web/src/pages/api/stripe/webhook.ts
import { buffer } from "micro";
import Stripe from "stripe";

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!);

export const config = {
  api: {
    bodyParser: false,
  },
};

export default async function handler(req, res) {
  if (req.method !== "POST") {
    return res.status(405).end();
  }

  const buf = await buffer(req);
  const sig = req.headers["stripe-signature"];

  let event: Stripe.Event;

  try {
    event = stripe.webhooks.constructEvent(
      buf,
      sig!,
      process.env.STRIPE_WEBHOOK_SIGNING_SECRET!
    );
  } catch (err) {
    return res.status(400).send(`Webhook Error: ${err.message}`);
  }

  // 处理事件
  switch (event.type) {
    case "customer.subscription.created":
      await handleSubscriptionCreated(event.data.object);
      break;
    case "customer.subscription.updated":
      await handleSubscriptionUpdated(event.data.object);
      break;
    case "customer.subscription.deleted":
      await handleSubscriptionDeleted(event.data.object);
      break;
    case "invoice.payment_succeeded":
      await handleInvoicePaymentSucceeded(event.data.object);
      break;
    case "invoice.payment_failed":
      await handleInvoicePaymentFailed(event.data.object);
      break;
    default:
      console.log(`Unhandled event type: ${event.type}`);
  }

  res.json({ received: true });
}
```

## 3. 配置示例

```bash
# Stripe Keys
STRIPE_SECRET_KEY="sk_test_..."  # 或 sk_live_...
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="pk_test_..."  # 或 pk_live_...
STRIPE_WEBHOOK_SIGNING_SECRET="whsec_..."

# Stripe Price IDs (产品定价)
STRIPE_PRICE_ID_STARTER="price_..."
STRIPE_PRICE_ID_PRO="price_..."
STRIPE_PRICE_ID_ENTERPRISE="price_..."
```

## 4. 使用示例

### 4.1 创建 Checkout Session

```typescript
// tRPC API
export const billingRouter = createTRPCRouter({
  createCheckoutSession: protectedOrgProcedure
    .input(
      z.object({
        priceId: z.string(),
        successUrl: z.string(),
        cancelUrl: z.string(),
      })
    )
    .mutation(async ({ input, ctx }) => {
      const session = await stripe.checkout.sessions.create({
        customer: ctx.organization.stripeCustomerId,
        mode: "subscription",
        line_items: [{ price: input.priceId, quantity: 1 }],
        success_url: input.successUrl,
        cancel_url: input.cancelUrl,
        metadata: {
          orgId: ctx.organization.id,
        },
      });

      return { sessionId: session.id };
    }),
});
```

### 4.2 客户端集成

```typescript
// React Component
import { loadStripe } from "@stripe/stripe-js";

const stripePromise = loadStripe(
  process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY!
);

function BillingPage() {
  const handleSubscribe = async () => {
    const { sessionId } = await trpc.billing.createCheckoutSession.mutate({
      priceId: "price_...",
      successUrl: window.location.origin + "/billing/success",
      cancelUrl: window.location.origin + "/billing",
    });

    const stripe = await stripePromise;
    await stripe?.redirectToCheckout({ sessionId });
  };

  return <button onClick={handleSubscribe}>Subscribe</button>;
}
```

## 5. 最佳实践

### 5.1 幂等性

```typescript
// 使用 Idempotency Keys 防止重复操作
await stripe.subscriptions.create(
  { /* params */ },
  {
    idempotencyKey: `sub-create-${orgId}-${timestamp}`,
  }
);
```

### 5.2 错误处理

```typescript
try {
  await stripe.subscriptions.create(params);
} catch (error) {
  if (error instanceof Stripe.errors.StripeError) {
    // 处理 Stripe 特定错误
    logger.error("Stripe error", {
      type: error.type,
      code: error.code,
      message: error.message,
    });
  }
  throw error;
}
```

### 5.3 Webhook 安全

- 验证 Webhook 签名
- 使用 HTTPS
- 记录所有 Webhook 事件

---

**更新日期**: 2025-12-17  
**维护者**: Langfuse Engineering Team
