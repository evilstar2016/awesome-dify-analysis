@startuml
!theme plain
skinparam componentStyle rectangle
skinparam backgroundColor white
skinparam Package { 
  BackgroundColor LightGray
  FontColor Blue
}
skinparam component {
  BackgroundColor LightBlue
  BorderColor Black
  ArrowColor Black
  FontColor DarkBlue
}
skinparam database {
  BackgroundColor LightYellow
  BorderColor Black
}
skinparam storage {
  BackgroundColor LightGreen
  BorderColor Black
}
skinparam note {
  backgroundColor LightYellow
}

title Langfuse 数据架构组件图

package "应用层" {
  [Web UI\n(Next.js)] as WebUI
  [API Routes\n(tRPC + REST)] as API
  [Worker Service\n(Background Jobs)] as Worker
}

package "数据访问层" {
  [Prisma Client\n(ORM)] as Prisma
  [ClickHouse Client\n(SQL Driver)] as CHClient
  [Redis Client\n(ioredis)] as RedisClient
  [S3 Client\n(AWS SDK)] as S3Client
  [BullMQ\n(Task Queue)] as BullMQ
}

package "数据持久化层" {
  database "PostgreSQL\n主数据库" as PostgreSQL {
    collections "users"
    collections "organizations"
    collections "projects"
    collections "api_keys"
    collections "prompts"
    collections "datasets"
    collections "models"
    collections "配置和元数据\n(50+ 表)"
  }
  
  database "ClickHouse\n分析数据库" as ClickHouse {
    collections "traces\n(追踪主表)"
    collections "observations\n(LLM 调用)"
    collections "scores\n(评分数据)"
    collections "events\n(事件日志)"
    collections "dataset_run_items\n(数据集运行)"
  }
  
  database "Redis\n缓存 & 队列" as Redis {
    frame "缓存" {
      [API Key Cache]
      [Config Cache]
      [Session Cache]
    }
    frame "任务队列\n(20+ 队列)" {
      [Ingestion Queue]
      [Eval Queue]
      [Export Queue]
      [Webhook Queue]
      [Delete Queues]
    }
  }
  
  storage "S3 对象存储" as S3 {
    folder "media/\n(媒体文件)"
    folder "exports/\n(批量导出)"
    folder "backups/\n(数据备份)"
  }
}

' 应用层连接
WebUI --> API : HTTP/WebSocket
Worker --> API : Internal API

' 数据访问层连接
API --> Prisma : 元数据读写
API --> CHClient : 追踪数据查询
API --> RedisClient : 缓存读写
API --> S3Client : 文件上传下载
API --> BullMQ : 任务入队

Worker --> Prisma : 元数据更新
Worker --> CHClient : 批量写入追踪
Worker --> BullMQ : 任务消费
Worker --> S3Client : 文件处理

' 数据持久化层连接
Prisma --> PostgreSQL : SQL
CHClient --> ClickHouse : HTTP/Native Protocol
RedisClient --> Redis : Redis Protocol
BullMQ --> Redis : 队列操作
S3Client --> S3 : HTTPS

note right of PostgreSQL
  **主数据库 (OLTP)**
  - 强一致性
  - 事务支持
  - 存储元数据和配置
  - 数据量: 10-100GB
end note

note right of ClickHouse
  **分析数据库 (OLAP)**
  - 列式存储
  - 高压缩率
  - 海量追踪数据
  - 数据量: 1TB - PB 级
end note

note right of Redis
  **缓存与队列**
  - 内存数据库
  - 毫秒级响应
  - API 密钥缓存
  - 异步任务处理
end note

note right of S3
  **对象存储**
  - 无限容量
  - 低成本
  - 媒体文件
  - 批量导出文件
end note

' 数据流向注释
note bottom of API
  **读写分离**
  - 元数据: PostgreSQL (读写)
  - 追踪数据: ClickHouse (主要读)
  - 追踪写入: 异步队列 → ClickHouse
end note

note bottom of Worker
  **异步处理**
  - 追踪数据摄取
  - 批量导出
  - 评估任务
  - 数据删除
  - 集成同步
end note

@enduml
