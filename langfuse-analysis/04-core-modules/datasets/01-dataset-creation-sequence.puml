@startuml
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding 6
skinparam ParticipantPadding 30

title Dataset 创建流程（带 Schema 验证）

actor "用户" as User
participant "Frontend\n(Dataset Editor)" as Frontend
participant "tRPC Client" as TRPCClient
participant "tRPC Router\n(datasets)" as Router
participant "RBAC Check" as RBAC
participant "Dataset Service" as Service
participant "Schema Validator\n(Ajv)" as Validator
participant "Prisma ORM" as Prisma
database "PostgreSQL" as PG
participant "Audit Log" as Audit

== 用户创建 Dataset ==

User -> Frontend: 填写 Dataset 表单\n- name: "customer-support/greeting"\n- description: "Greeting test cases"\n- inputSchema: {...}\n- expectedOutputSchema: {...}
activate Frontend

Frontend -> Frontend: 编辑 JSON Schema\n(使用 Schema Editor)

note right of Frontend
  Schema Editor 功能:
  - 可视化编辑 JSON Schema
  - 实时预览验证规则
  - 支持嵌套对象和数组
end note

Frontend -> TRPCClient: datasets.createDataset({\n  name,\n  description,\n  inputSchema,\n  expectedOutputSchema,\n  metadata\n})
activate TRPCClient

TRPCClient -> Router: createDataset()
activate Router

== 权限检查 ==

Router -> RBAC: throwIfNoProjectAccess(\n  scope: "datasets:CUD"\n)
activate RBAC
RBAC --> Router: 权限验证通过
deactivate RBAC

== 验证 Schema ==

Router -> Service: createDataset(input)
activate Service

alt inputSchema 提供
  Service -> Validator: compile(inputSchema)
  activate Validator
  
  Validator -> Validator: 验证 JSON Schema 语法
  
  alt Schema 无效
    Validator --> Service: ValidationError
    Service --> Router: Error: Invalid JSON Schema
    Router --> TRPCClient: 400 Bad Request
    TRPCClient --> Frontend: 显示错误
    Frontend --> User: "Schema 语法错误"
  end
  
  Validator --> Service: compiled schema
  deactivate Validator
  
  note right of Validator
    Ajv JSON Schema 验证:
    - 检查 type, properties
    - 检查 required, additionalProperties
    - 验证嵌套结构
  end note
end

alt expectedOutputSchema 提供
  Service -> Validator: compile(expectedOutputSchema)
  activate Validator
  Validator -> Validator: 验证 JSON Schema 语法
  Validator --> Service: compiled schema
  deactivate Validator
end

== 检查名称唯一性 ==

Service -> Prisma: findUnique({\n  where: {\n    projectId_name: {\n      projectId,\n      name: "customer-support/greeting"\n    }\n  }\n})
activate Prisma

Prisma -> PG: SELECT * FROM datasets\nWHERE project_id = ?\n  AND name = ?
activate PG

alt Dataset 已存在
  PG --> Prisma: existing dataset
  Prisma --> Service: conflict
  Service --> Router: LangfuseConflictError
  Router --> TRPCClient: 409 Conflict
  TRPCClient --> Frontend: 显示错误
  Frontend --> User: "Dataset name already exists"
end

PG --> Prisma: null (不存在)
deactivate PG
Prisma --> Service: 名称可用
deactivate Prisma

== 解析 Metadata ==

Service -> Service: resolveMetadata(metadata)

note right of Service
  Metadata 处理:
  - 空字符串 → DbNull
  - JSON 字符串 → 解析为对象
  - 无效 JSON → undefined
end note

== 写入数据库 ==

Service -> Prisma: create({\n  data: {\n    id: uuid(),\n    projectId,\n    name: "customer-support/greeting",\n    description,\n    metadata: resolvedMetadata,\n    inputSchema,\n    expectedOutputSchema,\n    createdAt: now(),\n    updatedAt: now()\n  }\n})
activate Prisma

Prisma -> PG: INSERT INTO datasets\n(\n  id, project_id, name,\n  description, metadata,\n  input_schema,\n  expected_output_schema,\n  created_at, updated_at\n)\nVALUES (?, ?, ?, ...)
activate PG

note right of PG
  唯一性约束:
  UNIQUE (project_id, name)
  确保同一项目下名称唯一
end note

PG --> Prisma: dataset record
deactivate PG

Prisma --> Service: created dataset
deactivate Prisma

Service --> Router: {\n  success: true,\n  dataset: {...}\n}
deactivate Service

== 记录审计日志 ==

Router -> Audit: auditLog({\n  session: ctx.session,\n  resourceType: "dataset",\n  resourceId: dataset.id,\n  action: "create",\n  after: dataset\n})
activate Audit

Audit -> PG: INSERT INTO audit_logs\n(\n  user_id,\n  resource_type,\n  resource_id,\n  action,\n  after_value\n)
activate PG
PG --> Audit: logged
deactivate PG

Audit --> Router: 审计完成
deactivate Audit

== 返回结果 ==

Router --> TRPCClient: {\n  id: "ds-123",\n  name: "customer-support/greeting",\n  description,\n  inputSchema,\n  expectedOutputSchema,\n  metadata,\n  createdAt,\n  updatedAt\n}
deactivate Router

TRPCClient --> Frontend: created dataset
deactivate TRPCClient

Frontend -> Frontend: 刷新 datasets 列表
Frontend -> Frontend: 导航到新 dataset 页面
Frontend --> User: "Dataset created successfully"
deactivate Frontend

note right of User
  创建成功:
  - Dataset 已创建
  - Schema 将用于验证后续的 items
  - 可开始添加 dataset items
end note

@enduml
