@startuml Score Config Management Flow

title Score Config 创建与验证流程

actor "管理员\n(Admin)" as Admin
participant "Web\nUI" as WebUI
participant "tRPC\nRouter" as TRPC
participant "Domain\nValidation" as Domain
participant "PostgreSQL" as PG
participant "Audit\nLog" as Audit

== 准备创建 Config ==

Admin -> WebUI: 访问 Score Configs 页面\n(/settings/scores)
activate WebUI

WebUI -> TRPC: scoreConfigs.all(projectId)
activate TRPC

TRPC -> PG: SELECT * FROM score_configs\nWHERE project_id = ?\nORDER BY created_at DESC
activate PG
PG --> TRPC: existing configs
deactivate PG
deactivate TRPC

WebUI <-- TRPC: configs 列表
deactivate WebUI

Admin <-- WebUI: 显示 configs 列表

Admin -> WebUI: 点击"创建新 Config"
activate WebUI

WebUI -> WebUI: 显示创建表单

note right of WebUI
  表单字段：
  - Name: 评分名称
  - Data Type: NUMERIC | CATEGORICAL | BOOLEAN
  - Description: 描述
  
  根据 Data Type 动态显示：
  - NUMERIC: minValue, maxValue
  - CATEGORICAL: categories (label, value)
  - BOOLEAN: 自动设置固定 categories
end note

== 创建 NUMERIC Config ==

Admin -> WebUI: 选择 NUMERIC\n输入：\n  name: "accuracy"\n  minValue: 0\n  maxValue: 1\n  description: "准确度评分"
deactivate WebUI

Admin -> WebUI: 提交表单
activate WebUI

WebUI -> TRPC: scoreConfigs.create({\n  projectId,\n  name: "accuracy",\n  dataType: "NUMERIC",\n  minValue: 0,\n  maxValue: 1,\n  description: "准确度评分"\n})
activate TRPC

== 验证 NUMERIC Config ==

note right of TRPC
  验证在 Prisma create 时通过
  validateDbScoreConfig() 自动触发
  
  Domain 层验证逻辑：
  packages/shared/src/domain/score-configs.ts
end note

TRPC -> Domain: validateNumericRangeFields()\n(通过 ScoreConfigSchema.refine)
activate Domain

alt minValue 和 maxValue 都存在

  Domain -> Domain: 检查 maxValue > minValue
  
  alt maxValue <= minValue
    Domain --> TRPC: ZodError:\n"Maximum value must be greater than Minimum value"
    TRPC --> WebUI: 错误信息
    deactivate Domain
    WebUI --> Admin: 显示错误提示
    [<-- Admin
  end

end

Domain --> TRPC: validation success
deactivate Domain

TRPC -> PG: 检查名称唯一性\nSELECT COUNT(*)\nFROM score_configs\nWHERE project_id = ?\n  AND name = ?\n  AND is_archived = false
activate PG

alt 名称已存在
  PG --> TRPC: count > 0
  deactivate PG
  TRPC --> WebUI: 错误："Config 名称已存在"
  deactivate TRPC
  WebUI --> Admin: 显示错误提示
  deactivate WebUI
  [<-- Admin
end

PG --> TRPC: count = 0
deactivate PG

TRPC -> PG: INSERT INTO score_configs(\n  id, project_id, name,\n  data_type, min_value, max_value,\n  description, is_archived,\n  created_at, updated_at\n) VALUES (...)
activate PG

note right of PG
  写入数据：
  - id: 生成的 UUID
  - project_id: 项目 ID
  - name: "accuracy"
  - data_type: "NUMERIC"
  - min_value: 0
  - max_value: 1
  - categories: NULL (NUMERIC 不需要)
  - description: "准确度评分"
  - is_archived: false
  - created_at: NOW()
  - updated_at: NOW()
end note

PG --> TRPC: config ID
deactivate PG
deactivate TRPC

WebUI <-- TRPC: 创建成功
deactivate WebUI

Admin <-- WebUI: 显示成功\n刷新列表

== 创建 CATEGORICAL Config ==

Admin -> WebUI: 点击"创建新 Config"
activate WebUI

Admin -> WebUI: 选择 CATEGORICAL\n输入：\n  name: "quality"\n  categories: [\n    {label: "Excellent", value: 5},\n    {label: "Good", value: 4},\n    {label: "Fair", value: 3},\n    {label: "Poor", value: 2}\n  ]
deactivate WebUI

Admin -> WebUI: 提交表单
activate WebUI

WebUI -> TRPC: scoreConfigs.create({\n  projectId,\n  name: "quality",\n  dataType: "CATEGORICAL",\n  categories: [...]\n})
activate TRPC

== 验证 CATEGORICAL Config ==

note right of TRPC
  验证在 Prisma create 时通过
  validateDbScoreConfig() 自动触发
end note

TRPC -> Domain: validateCategories()\n(通过 ScoreConfigSchema.refine)
activate Domain

Domain -> Domain: 检查 categories 不为空
alt categories 为空或长度为 0
  Domain --> TRPC: ZodError:\n"Categories required for CATEGORICAL type"
  TRPC --> WebUI: 错误信息
  deactivate Domain
  WebUI --> Admin: 显示错误提示
  [<-- Admin
end

Validation -> Validation: 提取所有 labels
note right of Validation
  labels = ["Excellent", "Good", "Fair", "Poor"]
end note

Validation -> Validation: 检查 labels 唯一性
note right of Validation
  uniqueLabels = Set(labels)
  
  if uniqueLabels.size !== labels.length:
    → 存在重复 label
end note

alt 存在重复 label
  Validation --> TRPC: throw InvalidRequestError(\n  "Category labels must be unique"\n)
  TRPC --> WebUI: 错误信息
  deactivate Validation
  WebUI --> Admin: 显示错误提示
  [<-- Admin
end

Validation -> Validation: 提取所有 values
note right of Validation
  values = [5, 4, 3, 2]
end note

Validation -> Validation: 检查 values 唯一性
note right of Validation
  uniqueValues = Set(values)
  
  if uniqueValues.size !== values.length:
    → 存在重复 value
end note

alt 存在重复 value
  Validation --> TRPC: throw InvalidRequestError(\n  "Category values must be unique"\n)
  TRPC --> WebUI: 错误信息
  deactivate Validation
  WebUI --> Admin: 显示错误提示
  [<-- Admin
end

Validation --> TRPC: validation success
deactivate Validation

TRPC -> PG: 检查名称唯一性
activate PG
PG --> TRPC: count = 0
deactivate PG

TRPC -> PG: INSERT INTO score_configs(\n  ...\n  data_type: "CATEGORICAL",\n  categories: JSON.stringify([...])\n)
activate PG

note right of PG
  categories 字段存储为 JSONB：
  [
    {"label": "Excellent", "value": 5},
    {"label": "Good", "value": 4},
    {"label": "Fair", "value": 3},
    {"label": "Poor", "value": 2}
  ]
end note

PG --> TRPC: config ID
deactivate PG
deactivate TRPC

WebUI <-- TRPC: 创建成功
deactivate WebUI

Admin <-- WebUI: 显示成功\n刷新列表

== 创建 BOOLEAN Config ==

Admin -> WebUI: 点击"创建新 Config"
activate WebUI

Admin -> WebUI: 选择 BOOLEAN\n输入：\n  name: "is_correct"\n  description: "答案正确性"

note right of WebUI
  BOOLEAN 类型：
  - 自动设置固定 categories
  - 用户不可修改
  
  categories = [
    { label: "True", value: 1 },
    { label: "False", value: 0 }
  ]
end note

deactivate WebUI

Admin -> WebUI: 提交表单
activate WebUI

WebUI -> TRPC: scoreConfigs.create({\n  projectId,\n  name: "is_correct",\n  dataType: "BOOLEAN",\n  categories: [\n    {label: "True", value: 1},\n    {label: "False", value: 0}\n  ],\n  description: "答案正确性"\n})
activate TRPC

== 验证 BOOLEAN Config ==

TRPC -> Validation: validateBooleanConfigFields(\n  categories\n)
activate Validation

Validation -> Validation: 检查 categories 长度 = 2
alt categories.length !== 2
  Validation --> TRPC: throw InvalidRequestError(\n  "Boolean must have exactly 2 categories"\n)
  TRPC --> WebUI: 错误信息
  deactivate Validation
  WebUI --> Admin: 显示错误提示
  [<-- Admin
end

Validation -> Validation: 检查 categories 内容
note right of Validation
  期望的 categories：
  [
    { label: "True", value: 1 },
    { label: "False", value: 0 }
  ]
  
  或
  
  [
    { label: "False", value: 0 },
    { label: "True", value: 1 }
  ]
  
  (顺序无关，但内容必须完全匹配)
end note

alt categories 内容不匹配
  Validation --> TRPC: throw InvalidRequestError(\n  "Boolean categories must be True=1 and False=0"\n)
  TRPC --> WebUI: 错误信息
  deactivate Validation
  WebUI --> Admin: 显示错误提示
  [<-- Admin
end

Validation --> TRPC: validation success
deactivate Validation

TRPC -> PG: 检查名称唯一性
activate PG
PG --> TRPC: count = 0
deactivate PG

TRPC -> PG: INSERT INTO score_configs(\n  ...\n  data_type: "BOOLEAN",\n  categories: JSON.stringify([...])\n)
activate PG
PG --> TRPC: config ID
deactivate PG
deactivate TRPC

WebUI <-- TRPC: 创建成功
deactivate WebUI

Admin <-- WebUI: 显示成功\n刷新列表

== 归档 Config ==

Admin -> WebUI: 对某个 config 选择"归档"
activate WebUI

WebUI -> TRPC: scoreConfigs.archive({\n  projectId,\n  configId,\n  isArchived: true\n})
activate TRPC

TRPC -> PG: 检查 config 是否存在
activate PG
PG --> TRPC: config
deactivate PG

TRPC -> PG: UPDATE score_configs\nSET is_archived = true,\n    updated_at = NOW()\nWHERE id = ?\n  AND project_id = ?
activate PG

note right of PG
  归档而非删除：
  - 历史 scores 仍保留 config_id 引用
  - 可以"取消归档"恢复使用
  - 归档后的 config 不可用于新 scores
end note

PG --> TRPC: success
deactivate PG

TRPC -> Audit: recordAuditLog(\n  action: "score-config.archive",\n  before: {isArchived: false},\n  after: {isArchived: true}\n)
activate Audit
Audit -> PG: INSERT INTO audit_logs
activate PG
PG --> Audit: success
deactivate PG
deactivate Audit
deactivate TRPC

WebUI <-- TRPC: 归档成功
deactivate WebUI

Admin <-- WebUI: 显示成功\n刷新列表

note right of WebUI
  归档后：
  - 列表中标记为"已归档"
  - 创建 score 时不显示在下拉列表
  - 历史 scores 仍显示此 config 名称
  - 可点击"取消归档"恢复
end note

@enduml
