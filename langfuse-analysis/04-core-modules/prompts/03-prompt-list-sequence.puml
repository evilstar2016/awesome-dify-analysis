@startuml
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding 6
skinparam ParticipantPadding 30

title Prompt æŸ¥è¯¢æµç¨‹ï¼ˆUIï¼‰- æ–‡ä»¶å¤¹è§†å›¾

actor "ç”¨æˆ·" as User
participant "Frontend\n(Prompts Page)" as Frontend
participant "tRPC Client" as TRPCClient
participant "tRPC Router\n(prompts)" as Router
participant "Prisma ORM" as Prisma
database "PostgreSQL" as PG
participant "Metrics Service" as MetricsService
database "ClickHouse" as CH

== ç”¨æˆ·è®¿é—® Prompts åˆ—è¡¨ ==

User -> Frontend: è®¿é—® /project/[id]/prompts\nå½“å‰æ–‡ä»¶å¤¹: "customer-service"
activate Frontend

Frontend -> TRPCClient: useInfiniteQuery(\n  prompts.all, {\n    projectId,\n    pathPrefix: "customer-service",\n    filter, orderBy,\n    page, limit\n  })
activate TRPCClient

TRPCClient -> Router: prompts.all()
activate Router

== è®¤è¯å’Œæƒé™ ==

Router -> Router: éªŒè¯ç”¨æˆ· session
Router -> Router: æ£€æŸ¥ prompts:read æƒé™

note right of Router
  protectedProjectProcedure
  è‡ªåŠ¨æ³¨å…¥ session å’Œ projectId
end note

== æž„å»º SQL æŸ¥è¯¢ ==

Router -> Router: æž„å»ºæŸ¥è¯¢æ¡ä»¶

note right of Router
  æŸ¥è¯¢æ¡ä»¶:
  1. pathPrefix: "customer-service"
     â†’ WHERE name LIKE 'customer-service/%'
     OR name = 'customer-service'
  
  2. filter: æŒ‰æ ‡ç­¾ã€åˆ›å»ºè€…ç­‰è¿‡æ»¤
  
  3. orderBy: æŽ’åºï¼ˆname, version, createdAtï¼‰
  
  4. searchQuery: å…¨æ–‡æœç´¢
end note

== æŸ¥è¯¢ Promptsï¼ˆå«æ–‡ä»¶å¤¹ï¼‰ ==

Router -> Prisma: $queryRaw(generatePromptQuery(...))
activate Prisma

Prisma -> PG: WITH folders AS (\n  -- æå–ä¸‹ä¸€çº§æ–‡ä»¶å¤¹\n  SELECT DISTINCT\n    split_part(\n      substring(name FROM length('customer-service/') + 1),\n      '/', 1\n    ) as segment,\n    'folder' as row_type,\n    NULL as version,\n    NULL as labels,\n    MAX(updated_at) as updated_at\n  FROM prompts\n  WHERE project_id = ?\n    AND name LIKE 'customer-service/%'\n    AND name != 'customer-service'\n  GROUP BY segment\n),\nprompts_direct AS (\n  -- å½“å‰æ–‡ä»¶å¤¹ä¸‹çš„ç›´æŽ¥ prompts\n  SELECT\n    name,\n    'prompt' as row_type,\n    version,\n    labels,\n    updated_at\n  FROM prompts\n  WHERE project_id = ?\n    AND name NOT LIKE 'customer-service/%/%'\n    AND (name LIKE 'customer-service/%'\n         OR name = 'customer-service')\n)\nSELECT * FROM folders\nUNION ALL\nSELECT * FROM prompts_direct\nORDER BY row_type DESC, name
activate PG

note right of PG
  æŸ¥è¯¢ç­–ç•¥:
  1. åˆ†ç¦»æ–‡ä»¶å¤¹å’Œ prompts
  2. æ–‡ä»¶å¤¹åªæ˜¾ç¤ºä¸‹ä¸€çº§
  3. Prompts æ˜¾ç¤ºå½“å‰å±‚çº§
  4. æŒ‰ç±»åž‹å’Œåç§°æŽ’åº
end note

PG --> Prisma: mixed results:\n[\n  { name: "greeting", row_type: "folder" },\n  { name: "customer-service/support", row_type: "prompt", version: 3 },\n  { name: "customer-service/escalation", row_type: "prompt", version: 2 }\n]
deactivate PG

Prisma --> Router: prompts and folders
deactivate Prisma

== ç»Ÿè®¡æ€»æ•° ==

Router -> Prisma: $queryRaw(count query)
activate Prisma

Prisma -> PG: SELECT count(*) AS "totalCount"\nFROM (\n  -- åŒæ ·çš„æŸ¥è¯¢é€»è¾‘\n) AS subquery
activate PG
PG --> Prisma: totalCount = 15
deactivate PG

Prisma --> Router: { totalCount: 15 }
deactivate Prisma

== èŽ·å–ä½¿ç”¨ç»Ÿè®¡ï¼ˆå¯é€‰ï¼‰ ==

alt éœ€è¦æ˜¾ç¤ºä½¿ç”¨ç»Ÿè®¡
  
  Router -> Router: æå–æ‰€æœ‰ prompt names
  
  Router -> MetricsService: getObservationsWithPromptName(\n  projectId,\n  promptNames\n)
  activate MetricsService
  
  MetricsService -> CH: SELECT\n  prompt_name,\n  count(*) as count\nFROM observations\nWHERE project_id = ?\n  AND prompt_name IN (?)\nGROUP BY prompt_name
  activate CH
  
  note right of CH
    ç»Ÿè®¡ä½¿ç”¨è¯¥ prompt çš„
    observations æ•°é‡
  end note
  
  CH --> MetricsService: [\n  { promptName: "support", count: 1250 },\n  { promptName: "escalation", count: 89 }\n]
  deactivate CH
  
  MetricsService --> Router: usage metrics
  deactivate MetricsService
  
  Router -> Router: åˆå¹¶ metrics åˆ° prompts

end

== è¿”å›žç»“æžœ ==

Router --> TRPCClient: {\n  prompts: [\n    {\n      name: "greeting",\n      row_type: "folder",\n      itemCount: 5\n    },\n    {\n      name: "customer-service/support",\n      row_type: "prompt",\n      version: 3,\n      labels: ["production", "latest"],\n      observationCount: 1250\n    },\n    {\n      name: "customer-service/escalation",\n      row_type: "prompt",\n      version: 2,\n      labels: ["staging"],\n      observationCount: 89\n    }\n  ],\n  totalCount: 15\n}
deactivate Router

TRPCClient --> Frontend: prompts data
deactivate TRPCClient

== å‰ç«¯æ¸²æŸ“ ==

Frontend -> Frontend: æ¸²æŸ“è¡¨æ ¼/åˆ—è¡¨

note right of Frontend
  æ˜¾ç¤ºå†…å®¹:
  
  æ–‡ä»¶å¤¹å›¾æ ‡ ðŸ“ greeting/ (5 items)
  
  ðŸ“„ support
     Version: 3
     Labels: production, latest
     Usage: 1,250 observations
  
  ðŸ“„ escalation
     Version: 2
     Labels: staging
     Usage: 89 observations
end note

Frontend --> User: æ˜¾ç¤º Prompts åˆ—è¡¨
deactivate Frontend

== ç”¨æˆ·äº¤äº’ ==

alt ç”¨æˆ·ç‚¹å‡»æ–‡ä»¶å¤¹
  User -> Frontend: ç‚¹å‡» "greeting" æ–‡ä»¶å¤¹
  activate Frontend
  Frontend -> Frontend: æ›´æ–° pathPrefix\n= "customer-service/greeting"
  Frontend -> TRPCClient: refetch with new pathPrefix
  note right of Frontend
    é€’å½’è¿›å…¥å­æ–‡ä»¶å¤¹
  end note
  deactivate Frontend
  
else ç”¨æˆ·ç‚¹å‡» prompt
  User -> Frontend: ç‚¹å‡» "support" prompt
  activate Frontend
  Frontend -> Frontend: navigate to\n/prompts/customer-service/support
  note right of Frontend
    è¿›å…¥ prompt è¯¦æƒ…é¡µ
    æ˜¾ç¤ºæ‰€æœ‰ç‰ˆæœ¬
  end note
  deactivate Frontend
end

@enduml
