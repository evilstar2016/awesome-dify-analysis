@startuml
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding 6
skinparam ParticipantPadding 30

title Prompt 获取流程（SDK）- 带 Redis 缓存

actor "用户应用" as App
participant "Langfuse SDK" as SDK
participant "Public API\n(/api/public/prompts)" as API
participant "Auth Middleware" as Auth
participant "Prompt Service" as Service
participant "Redis Lock" as RedisLock
database "Redis Cache" as Redis
participant "Prisma ORM" as Prisma
database "PostgreSQL" as PG

== SDK 获取 Prompt ==

App -> SDK: langfuse.getPrompt(\n  "chat-greeting",\n  { label: "production" }\n)
activate SDK

note right of SDK
  SDK 参数:
  - name: 必需
  - version: 可选（版本号）
  - label: 可选（默认 "latest"）
end note

SDK -> API: GET /api/public/prompts/:name\n?label=production
activate API

== 认证 ==

API -> Auth: verifyApiKey(publicKey)
activate Auth

Auth -> PG: 查询 api_keys\nWHERE public_key = ?
activate PG
PG --> Auth: api_key record
deactivate PG

Auth -> Auth: 验证签名和权限
Auth --> API: { projectId, scope }
deactivate Auth

note right of Auth
  API Key 验证:
  - Public Key (pk-...)
  - Secret Key (sk-...) 用于签名
  - 检查 prompts:read 权限
end note

== 检查 Redis 锁 ==

API -> Service: getPrompt(\n  projectId,\n  name: "chat-greeting",\n  label: "production"\n)
activate Service

Service -> RedisLock: exists(\n  "lock:prompt:proj:chat-greeting"\n)
activate RedisLock

RedisLock -> Redis: EXISTS lock:prompt:proj:chat-greeting
activate Redis
Redis --> RedisLock: 0 (锁不存在)
deactivate Redis

RedisLock --> Service: no lock
deactivate RedisLock

note right of Service
  如果锁存在（正在写入）:
  - 等待锁释放
  - 或直接查询数据库
end note

== 尝试从缓存读取 ==

Service -> Redis: GET prompt:proj:chat-greeting:production
activate Redis

alt 缓存命中
  Redis --> Service: cached prompt data (JSON)
  
  note right of Redis
    缓存命中 (~95%):
    - 响应时间 < 1ms
    - 无需查询数据库
  end note
  
  Service -> Redis: EXPIRE\n  prompt:proj:chat-greeting:production\n  3600
  note right of Service
    刷新 TTL 到 1 小时
    保持热点数据在缓存中
  end note
  
  Redis --> Service: TTL refreshed
  
  Service -> Service: parse JSON to PromptDomain
  Service --> API: prompt (from cache)
  
else 缓存未命中

  Redis --> Service: null
  deactivate Redis

  note right of Service
    缓存未命中 (~5%):
    - 首次访问
    - 缓存过期
    - 缓存被清除
  end note

== 从数据库查询 ==

  Service -> Prisma: findFirst({\n  where: {\n    projectId,\n    name: "chat-greeting",\n    labels: { has: "production" }\n  }\n})
  activate Prisma

  Prisma -> PG: SELECT *\nFROM prompts\nWHERE project_id = ?\n  AND name = ?\n  AND 'production' = ANY(labels)\nORDER BY version DESC\nLIMIT 1
  activate PG
  
  note right of PG
    查询逻辑:
    - labels 字段是数组类型
    - 使用 ANY 操作符查找标签
    - ORDER BY version DESC 获取最新版本
  end note
  
  PG --> Prisma: prompt record
  deactivate PG

  Prisma --> Service: prompt
  deactivate Prisma

  alt prompt found
  
    Service -> Service: convert to PromptDomain
    
== 写入缓存 ==

    Service -> Redis: SETEX\n  prompt:proj:chat-greeting:production\n  3600\n  JSON.stringify(prompt)
    activate Redis
    
    note right of Redis
      写入缓存:
      - TTL: 3600 秒 (1 小时)
      - 多个标签会有多个缓存 key
      - 如: production, staging, latest
    end note
    
    Redis --> Service: OK
    deactivate Redis
    
    Service --> API: prompt (from database)
    
  else prompt not found
    Service --> API: null
  end

end

deactivate Service

alt prompt found

== 返回给 SDK ==

  API --> SDK: 200 OK\n{\n  id, name, version,\n  prompt, config,\n  labels, tags\n}
  deactivate API

  SDK -> SDK: 创建 Prompt 对象
  SDK -> SDK: 添加 compile() 方法
  
  note right of SDK
    SDK Prompt 对象:
    - prompt.compile(variables)
    - prompt.version
    - prompt.config
  end note
  
  SDK --> App: PromptClient 对象
  deactivate SDK

== 使用 Prompt ==

  App -> App: rendered = prompt.compile({\n  userName: "Alice"\n})
  
  note right of App
    Mustache 模板渲染:
    "Hello {{userName}}!"
    → "Hello Alice!"
  end note
  
  App -> App: 调用 LLM API\n(使用渲染后的 prompt)

else prompt not found

  API --> SDK: 404 Not Found\n{\n  error: "Prompt not found"\n}
  deactivate API
  
  SDK --> App: throw PromptNotFoundError
  deactivate SDK
  
  note right of App
    可能原因:
    - name 错误
    - label 不存在
    - 权限不足
  end note

end

@enduml
