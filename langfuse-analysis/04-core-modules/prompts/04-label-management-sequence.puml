@startuml
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding 6
skinparam ParticipantPadding 30

title Prompt 标签管理流程

actor "用户" as User
participant "Frontend\n(Labels Panel)" as Frontend
participant "tRPC Client" as TRPCClient
participant "tRPC Router\n(prompts)" as Router
participant "RBAC Check" as RBAC
participant "Prompt Service" as Service
participant "Redis Lock" as RedisLock
database "Redis Cache" as Redis
participant "Prisma ORM" as Prisma
database "PostgreSQL" as PG

== Scenario 1: 添加标签到版本 ==

User -> Frontend: 为 version 3 添加 "production" 标签
activate Frontend

Frontend -> TRPCClient: prompts.addLabel({\n  promptId: "uuid-v3",\n  label: "production"\n})
activate TRPCClient

TRPCClient -> Router: addLabel()
activate Router

== 权限检查（受保护标签） ==

Router -> RBAC: checkHasProtectedLabels(["production"])
activate RBAC

RBAC -> PG: 查询 protectedPromptLabels
activate PG
PG --> RBAC: ["production", "prod"]
deactivate PG

RBAC -> RBAC: "production" in protected?\n→ Yes
RBAC -> RBAC: throwIfNoProjectAccess(\n  scope: "prompts:protected_label"\n)

RBAC --> Router: 权限验证通过
deactivate RBAC

note right of RBAC
  受保护标签检查:
  - 查询项目配置
  - 验证用户权限
  - 防止未授权修改
end note

== 获取锁 ==

Router -> Service: addLabelToPrompt(promptId, label)
activate Service

Service -> Prisma: findUnique({ where: { id: promptId } })
activate Prisma
Prisma -> PG: SELECT * FROM prompts WHERE id = ?
activate PG
PG --> Prisma: prompt (name: "chat-greeting")
deactivate PG
Prisma --> Service: prompt
deactivate Prisma

Service -> RedisLock: acquireLock(\n  projectId,\n  "chat-greeting"\n)
activate RedisLock
RedisLock -> Redis: SET lock:prompt:proj:chat-greeting NX EX 5
activate Redis
Redis --> RedisLock: OK
deactivate Redis
RedisLock --> Service: lock acquired
deactivate RedisLock

== 清除缓存 ==

Service -> Redis: DEL prompt:proj:chat-greeting:*
activate Redis
note right of Redis
  删除所有相关缓存:
  - 所有版本的缓存
  - 所有标签的缓存
end note
Redis --> Service: caches deleted
deactivate Redis

== 更新数据库 ==

Service -> Prisma: update({\n  where: { id: promptId },\n  data: {\n    labels: {\n      push: "production"\n    }\n  }\n})
activate Prisma

Prisma -> PG: UPDATE prompts\nSET labels = array_append(labels, 'production')\nWHERE id = ?
activate PG

note right of PG
  PostgreSQL 数组操作:
  - array_append: 添加元素
  - 自动去重由应用层处理
end note

PG --> Prisma: updated prompt
deactivate PG

Prisma --> Service: prompt with new label
deactivate Prisma

== 释放锁 ==

Service -> RedisLock: releaseLock(projectId, name)
activate RedisLock
RedisLock -> Redis: DEL lock:prompt:proj:chat-greeting
activate Redis
Redis --> RedisLock: OK
deactivate Redis
RedisLock --> Service: lock released
deactivate RedisLock

Service --> Router: updated prompt
deactivate Service

Router --> TRPCClient: success
deactivate Router

TRPCClient --> Frontend: label added
deactivate TRPCClient

Frontend --> User: "Label 'production' added"
deactivate Frontend

note right of User
  Version 3 现在有标签:
  ["latest", "staging", "production"]
end note

|||

== Scenario 2: 转移标签到新版本 ==

User -> Frontend: 将 "production" 从 v3 转移到 v4
activate Frontend

Frontend -> TRPCClient: prompts.setLabels({\n  promptId: "uuid-v4",\n  labels: ["production", "latest"]\n})
activate TRPCClient

note right of Frontend
  setLabels 操作:
  - 为目标版本设置标签
  - 自动从其他版本移除
end note

TRPCClient -> Router: setLabels()
activate Router

== 权限检查 ==

Router -> RBAC: checkHasProtectedLabels(\n  ["production", "latest"]\n)
activate RBAC
RBAC -> RBAC: 验证 "production" 权限
RBAC --> Router: 权限通过
deactivate RBAC

== 获取锁并清除缓存 ==

Router -> Service: setLabelsForPrompt(\n  promptId: "uuid-v4",\n  labels: ["production", "latest"]\n)
activate Service

Service -> Prisma: findUnique({ where: { id } })
activate Prisma
Prisma -> PG: SELECT * FROM prompts WHERE id = 'uuid-v4'
activate PG
PG --> Prisma: prompt v4 (name: "chat-greeting")
deactivate PG
Prisma --> Service: prompt
deactivate Prisma

Service -> RedisLock: acquireLock(projectId, name)
activate RedisLock
RedisLock -> Redis: SET lock:... NX EX 5
activate Redis
Redis --> RedisLock: OK
deactivate Redis
RedisLock --> Service: acquired
deactivate RedisLock

Service -> Redis: DEL prompt:proj:chat-greeting:*
activate Redis
Redis --> Service: deleted
deactivate Redis

== 事务更新多个版本 ==

Service -> Prisma: $transaction([...])
activate Prisma

Prisma -> PG: BEGIN TRANSACTION
activate PG

note right of PG
  事务包含:
  1. 移除其他版本的标签
  2. 设置目标版本的标签
end note

Prisma -> PG: -- Step 1: 移除其他版本的标签\nUPDATE prompts\nSET labels = array_remove(\n  array_remove(labels, 'production'),\n  'latest'\n)\nWHERE project_id = ?\n  AND name = 'chat-greeting'\n  AND id != 'uuid-v4'

PG --> Prisma: 2 rows updated (v1, v2, v3)

Prisma -> PG: -- Step 2: 设置目标版本的标签\nUPDATE prompts\nSET labels = ?\nWHERE id = 'uuid-v4'

PG --> Prisma: 1 row updated (v4)

Prisma -> PG: COMMIT TRANSACTION
PG --> Prisma: transaction committed
deactivate PG

Prisma --> Service: all prompts updated
deactivate Prisma

== 释放锁 ==

Service -> RedisLock: releaseLock(projectId, name)
activate RedisLock
RedisLock -> Redis: DEL lock:...
activate Redis
Redis --> RedisLock: OK
deactivate Redis
RedisLock --> Service: released
deactivate RedisLock

Service --> Router: operation complete
deactivate Service

Router --> TRPCClient: success
deactivate Router

TRPCClient --> Frontend: labels transferred
deactivate TRPCClient

Frontend -> Frontend: 刷新版本列表
Frontend --> User: "Labels transferred to v4"
deactivate Frontend

note right of User
  标签转移结果:
  - Version 4: ["production", "latest"]
  - Version 3: ["staging"]
  - Version 2: []
  - Version 1: []
end note

|||

== Scenario 3: 移除标签 ==

User -> Frontend: 从 v4 移除 "staging" 标签
activate Frontend

Frontend -> TRPCClient: prompts.removeLabel({\n  promptId: "uuid-v4",\n  label: "staging"\n})
activate TRPCClient

TRPCClient -> Router: removeLabel()
activate Router

Router -> RBAC: checkHasProtectedLabels(["staging"])
activate RBAC
RBAC -> RBAC: "staging" not protected
RBAC --> Router: no special permission needed
deactivate RBAC

Router -> Service: removeLabelFromPrompt(\n  promptId, "staging"\n)
activate Service

Service -> Prisma: findUnique({ where: { id } })
activate Prisma
Prisma -> PG: SELECT * FROM prompts WHERE id = ?
activate PG
PG --> Prisma: prompt v4
deactivate PG
Prisma --> Service: prompt
deactivate Prisma

Service -> RedisLock: acquireLock(...)
activate RedisLock
RedisLock -> Redis: SET lock:... NX EX 5
activate Redis
Redis --> RedisLock: OK
deactivate Redis
RedisLock --> Service: acquired
deactivate RedisLock

Service -> Redis: DEL prompt:proj:chat-greeting:*
activate Redis
Redis --> Service: deleted
deactivate Redis

Service -> Prisma: update({\n  where: { id },\n  data: {\n    labels: {\n      set: labels.filter(l => l !== "staging")\n    }\n  }\n})
activate Prisma

Prisma -> PG: UPDATE prompts\nSET labels = array_remove(labels, 'staging')\nWHERE id = ?
activate PG
PG --> Prisma: updated
deactivate PG

Prisma --> Service: prompt
deactivate Prisma

Service -> RedisLock: releaseLock(...)
activate RedisLock
RedisLock -> Redis: DEL lock:...
activate Redis
Redis --> RedisLock: OK
deactivate Redis
RedisLock --> Service: released
deactivate RedisLock

Service --> Router: success
deactivate Service

Router --> TRPCClient: label removed
deactivate Router

TRPCClient --> Frontend: success
deactivate TRPCClient

Frontend --> User: "Label 'staging' removed"
deactivate Frontend

@enduml
