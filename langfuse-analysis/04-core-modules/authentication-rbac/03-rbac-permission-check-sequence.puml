@startuml
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding 6
skinparam ParticipantPadding 30

title RBAC 权限检查流程

actor 用户
participant "前端组件" as Frontend
participant "tRPC Router" as TRPC
participant "checkProjectAccess" as ProjectCheck
participant "checkOrganizationAccess" as OrgCheck
participant "Session" as Session
database "projectRoleAccessRights" as ProjectRBAC
database "organizationRoleAccessRights" as OrgRBAC

== 项目级权限检查 ==
用户 -> Frontend: 执行项目操作\n(如删除 Trace)
activate Frontend

Frontend -> Frontend: useHasProjectAccess({\n  projectId,\n  scope: "traces:delete"\n})

Frontend -> Session: 获取当前 Session
activate Session
Session --> Frontend: {user: {admin, organizations}}
deactivate Session

alt 用户是超级管理员
  Frontend -> Frontend: return true
  Frontend --> 用户: 允许操作
  deactivate Frontend
else 检查项目角色权限
  Frontend -> Frontend: 查找用户在项目中的角色\nproject = user.organizations\n  .flatMap(org => org.projects)\n  .find(p => p.id === projectId)
  
  Frontend -> ProjectRBAC: 获取角色权限列表\nprojectRoleAccessRights[role]
  activate ProjectRBAC
  ProjectRBAC --> Frontend: ["traces:delete", ...]
  deactivate ProjectRBAC
  
  Frontend -> Frontend: 检查 scope 是否在权限列表中\nrights.includes("traces:delete")
  
  alt 有权限
    Frontend --> 用户: 显示操作按钮/允许操作
    deactivate Frontend
    
    用户 -> Frontend: 点击确认操作
    activate Frontend
    
    Frontend -> TRPC: mutation deleteTrace({\n  projectId, traceId\n})
    activate TRPC
    
    TRPC -> ProjectCheck: throwIfNoProjectAccess({\n  session,\n  projectId,\n  scope: "traces:delete"\n})
    activate ProjectCheck
    
    ProjectCheck -> Session: 获取 Session
    activate Session
    Session --> ProjectCheck: {user}
    deactivate Session
    
    ProjectCheck -> ProjectCheck: hasProjectAccess()\n重新验证权限
    
    ProjectCheck -> ProjectRBAC: 查询角色权限
    activate ProjectRBAC
    ProjectRBAC --> ProjectCheck: 权限列表
    deactivate ProjectRBAC
    
    alt 验证通过
      ProjectCheck --> TRPC: 继续执行
      deactivate ProjectCheck
      
      TRPC -> TRPC: 执行业务逻辑\ndelete trace
      TRPC --> Frontend: {success: true}
      deactivate TRPC
      
      Frontend --> 用户: 操作成功
      deactivate Frontend
    else 验证失败
      ProjectCheck -> ProjectCheck: throw TRPCError("FORBIDDEN")
      deactivate ProjectCheck
      TRPC --> Frontend: 403 Forbidden
      deactivate TRPC
      Frontend --> 用户: 显示错误：权限不足
      deactivate Frontend
    end
  else 无权限
    Frontend --> 用户: 隐藏操作按钮/禁用功能
    deactivate Frontend
  end
end

== 组织级权限检查 ==
用户 -> Frontend: 尝试创建新项目
activate Frontend

Frontend -> Frontend: useHasOrganizationAccess({\n  organizationId,\n  scope: "projects:create"\n})

Frontend -> Session: 获取 Session
activate Session
Session --> Frontend: {user: {admin, organizations}}
deactivate Session

alt 用户是超级管理员
  Frontend --> 用户: 显示创建按钮
  deactivate Frontend
else 检查组织角色
  Frontend -> Frontend: 查找用户在组织中的角色\norg = user.organizations\n  .find(o => o.id === organizationId)

  Frontend -> OrgRBAC: organizationRoleAccessRights[role]
  activate OrgRBAC
  OrgRBAC --> Frontend: ["projects:create", ...]
  deactivate OrgRBAC
  
  alt 用户是 OWNER 或 ADMIN
    Frontend --> 用户: 显示创建项目按钮
    deactivate Frontend
    
    用户 -> Frontend: 点击创建项目
    activate Frontend
    
    Frontend -> TRPC: mutation createProject({\n  organizationId, name\n})
    activate TRPC
    
    TRPC -> OrgCheck: throwIfNoOrganizationAccess({\n  session,\n  organizationId,\n  scope: "projects:create"\n})
    activate OrgCheck
    
    OrgCheck -> OrgCheck: hasOrganizationAccess()\n验证权限
    
    OrgCheck -> OrgRBAC: 查询权限
    activate OrgRBAC
    OrgRBAC --> OrgCheck: 权限列表
    deactivate OrgRBAC
    
    OrgCheck --> TRPC: 验证通过
    deactivate OrgCheck
    
    TRPC -> TRPC: 创建项目\n分配用户为 OWNER
    
    TRPC --> Frontend: {project}
    deactivate TRPC
    
    Frontend --> 用户: 项目创建成功
    deactivate Frontend
  else 用户是 MEMBER/VIEWER/NONE
    Frontend --> 用户: 隐藏创建按钮
    deactivate Frontend
  end
end

note over 用户, OrgRBAC
  **权限检查要点：**
  
  1. **双重验证**：前端 UI 检查 + 后端 API 验证
  2. **超级管理员**：user.admin 绕过所有权限检查
  3. **角色继承**：高级角色包含低级角色的所有权限
  4. **范围分离**：项目级和组织级权限独立管理
  5. **细粒度控制**：每个操作对应特定的 scope
  
  **常见 Scope 示例：**
  - projectMembers:CUD (创建/更新/删除成员)
  - apiKeys:read (查看 API 密钥)
  - traces:delete (删除追踪)
  - prompts:CUD (管理提示词)
  - organization:update (更新组织信息)
end note

== 角色权限矩阵 ==
note left of ProjectRBAC
  **项目角色权限（部分示例）：**
  
  OWNER: 所有权限 (70+ scopes)
  - project:delete
  - projectMembers:CUD
  - apiKeys:CUD
  - traces:delete
  - ...所有资源的完全控制
  
  ADMIN: 管理权限（除 project:delete）
  - projectMembers:CUD
  - apiKeys:CUD
  - 所有资源的 CRUD
  
  MEMBER: 标准权限
  - 可创建和编辑资源
  - 不能管理成员和密钥
  - 不能删除项目
  
  VIEWER: 只读权限
  - project:read
  - 仅查看资源
  - 不能修改任何内容
end note

note right of OrgRBAC
  **组织角色权限：**
  
  OWNER: 完全控制
  - projects:create
  - projects:transfer_org
  - organization:CRUD_apiKeys
  - organization:delete
  - organizationMembers:CUD
  - langfuseCloudBilling:CRUD
  
  ADMIN: 管理权限
  - projects:create
  - projects:transfer_org
  - organization:CRUD_apiKeys
  - organizationMembers:CUD
  
  MEMBER: 基础权限
  - organizationMembers:read
  
  VIEWER/NONE: 无组织级权限
end note

@enduml
