@startuml
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding 6
skinparam ParticipantPadding 30

title 用户登录认证流程

actor 用户
participant "前端页面" as Frontend
participant "NextAuth API" as NextAuth
participant "CredentialsProvider" as Credentials
participant "Auth Service" as AuthService
database "Prisma/DB" as DB

== 用户名密码登录 ==
用户 -> Frontend: 输入邮箱和密码
activate Frontend

Frontend -> NextAuth: POST /api/auth/signin\n{email, password}
activate NextAuth

NextAuth -> Credentials: authorize(credentials)
activate Credentials

note right of Credentials
  检查配置
  - AUTH_DISABLE_USERNAME_PASSWORD
  - SSO 域名限制
  - 多租户 SSO 强制
end note

Credentials -> DB: 查询用户\nfindUnique({email})
activate DB
DB --> Credentials: 返回用户数据
deactivate DB

Credentials -> Credentials: verifyPassword()\n验证密码哈希

alt 密码验证成功
  Credentials -> Credentials: 构建 User 对象\n{id, email, name, image, \nfeatureFlags, canCreateOrganizations}
  Credentials --> NextAuth: 返回 User
  deactivate Credentials
  
  NextAuth -> NextAuth: 创建 JWT Token
  NextAuth -> NextAuth: 设置 Session Cookie
  
  NextAuth --> Frontend: 返回认证成功\n{session, token}
  deactivate NextAuth
  
  Frontend -> Frontend: 加载用户组织和项目
  Frontend --> 用户: 跳转到仪表板
  deactivate Frontend
else 密码验证失败
  Credentials --> NextAuth: throw Error("Invalid credentials")
  deactivate Credentials
  NextAuth --> Frontend: 返回错误
  deactivate NextAuth
  Frontend --> 用户: 显示错误信息
  deactivate Frontend
end

== OAuth 登录（Google/GitHub 等）==
用户 -> Frontend: 点击 OAuth 登录按钮
activate Frontend

Frontend -> NextAuth: GET /api/auth/signin/[provider]
activate NextAuth

NextAuth -> NextAuth: 生成 OAuth state\n和 redirect_uri

NextAuth --> Frontend: 302 重定向到 OAuth 提供商
deactivate NextAuth

Frontend --> 用户: 跳转到 OAuth 登录页面
deactivate Frontend

用户 -> Frontend: 在 OAuth 页面授权
activate Frontend

Frontend -> NextAuth: GET /api/auth/callback/[provider]\n?code=xxx&state=xxx
activate NextAuth

NextAuth -> NextAuth: 验证 state 参数

NextAuth -> "OAuth Provider" as OAuth: POST /token\n交换 access_token
activate OAuth
OAuth --> NextAuth: {access_token, id_token}
deactivate OAuth

NextAuth -> OAuth: GET /userinfo\n获取用户信息
activate OAuth
OAuth --> NextAuth: {email, name, image}
deactivate OAuth

NextAuth -> DB: 查找或创建用户\nfindOrCreate({email})
activate DB
DB --> NextAuth: 用户数据
deactivate DB

alt 新用户首次登录
  NextAuth -> AuthService: createProjectMembershipsOnSignup()
  activate AuthService
  AuthService -> DB: 创建默认项目关联
  activate DB
  DB --> AuthService: 完成
  deactivate DB
  deactivate AuthService
end

NextAuth -> NextAuth: 创建 Session
NextAuth --> Frontend: 返回认证成功
deactivate NextAuth

Frontend --> 用户: 登录成功，显示仪表板
deactivate Frontend

note over 用户, DB
  **登录后 Session 包含：**
  - user.id
  - user.email
  - user.name
  - user.admin (超级管理员标识)
  - user.organizations[] (组织和项目角色)
  - user.featureFlags
  - user.canCreateOrganizations
end note

@enduml
