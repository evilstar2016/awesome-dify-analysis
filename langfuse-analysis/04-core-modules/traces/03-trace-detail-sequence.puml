@startuml
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding 6
skinparam ParticipantPadding 30

title Trace 详情加载流程

actor "用户" as User
participant "Frontend\n(Trace Detail Page)" as Frontend
participant "tRPC Client" as TRPCClient
participant "tRPC Router\n(traces)" as Router
participant "Traces Service" as TracesService
database "ClickHouse" as CH
database "PostgreSQL" as PG
participant "Scores Service" as ScoresService
participant "Sessions Service" as SessionsService

== 用户访问 Trace 详情 ==

User -> Frontend: 访问 /project/[id]/traces/[traceId]
activate Frontend

Frontend -> TRPCClient: useQuery(\n  traces.byIdWithObservationsAndScores,\n  { traceId, projectId }\n)
activate TRPCClient

TRPCClient -> Router: byIdWithObservationsAndScores({ traceId })
activate Router

== 认证和权限 ==

Router -> Router: 验证用户 session
Router -> Router: 检查 trace 访问权限

note right of Router
  protectedGetTraceProcedure
  确保用户有权访问该 trace
end note

== 查询 Trace 基础信息 ==

Router -> TracesService: getTraceById(traceId, projectId)
activate TracesService

TracesService -> CH: SELECT *\nFROM traces FINAL\nWHERE id = ?\n  AND project_id = ?\n  AND is_deleted = 0
activate CH
CH --> TracesService: trace data
deactivate CH

alt trace not found
  TracesService --> Router: null
  Router --> TRPCClient: TRPCError(NOT_FOUND)
  TRPCClient --> Frontend: Error
  Frontend --> User: 显示 "Trace 不存在"
  [<-- User
else trace found

TracesService --> Router: trace
deactivate TracesService

== 查询 Observations (嵌套结构) ==

Router -> TracesService: getObservationsForTrace(traceId)
activate TracesService

TracesService -> CH: SELECT\n  id, parent_observation_id,\n  type, name,\n  provided_model_name,\n  start_time, end_time,\n  usage_details,\n  cost_details,\n  total_cost,\n  level, status_message,\n  input, output, metadata\nFROM observations FINAL\nWHERE trace_id = ?\n  AND is_deleted = 0\nORDER BY start_time ASC
activate CH
CH --> TracesService: observations (flat list)
deactivate CH

TracesService -> TracesService: buildObservationTree()
note right of TracesService
  构建嵌套结构:
  1. 找到根 observations (parent_id = null)
  2. 递归查找子 observations
  3. 构建树形结构
end note

TracesService --> Router: observations (tree structure)
deactivate TracesService

== 查询 Scores ==

Router -> ScoresService: getScoresForTrace(traceId)
activate ScoresService

ScoresService -> CH: SELECT\n  id, name, value,\n  data_type, comment,\n  observation_id,\n  timestamp\nFROM scores FINAL\nWHERE trace_id = ?\n  AND is_deleted = 0\nORDER BY timestamp DESC
activate CH
CH --> ScoresService: scores
deactivate CH

ScoresService -> ScoresService: 按 observation_id 分组
ScoresService --> Router: scores (grouped)
deactivate ScoresService

== 查询 Session 信息 (如果有) ==

alt trace.session_id != null
  Router -> SessionsService: getSessionById(sessionId)
  activate SessionsService
  
  SessionsService -> CH: SELECT *\nFROM trace_sessions FINAL\nWHERE id = ?\n  AND is_deleted = 0
  activate CH
  CH --> SessionsService: session
  deactivate CH
  
  SessionsService --> Router: session
  deactivate SessionsService
end

== 计算聚合指标 ==

Router -> Router: calculateAggregatedMetrics()
note right of Router
  聚合计算:
  - 总 Observations 数量
  - 按类型分组的 Observations
  - 总 Token 使用量
  - 总成本
  - 平均评分
  - 执行时长
end note

== 组装返回数据 ==

Router -> Router: 组装完整响应

Router --> TRPCClient: {\n  trace: {\n    id, name, timestamp,\n    userId, sessionId,\n    input, output, metadata,\n    tags, environment,\n    ...\n  },\n  observations: [\n    {\n      id, type, name,\n      children: [...],\n      scores: [...],\n      ...\n    },\n    ...\n  ],\n  scores: [...],\n  session: {...},\n  metrics: {\n    observationCount,\n    totalTokens,\n    totalCost,\n    duration\n  }\n}
deactivate Router

TRPCClient --> Frontend: 完整 trace 数据
deactivate TRPCClient

== 前端渲染 ==

Frontend -> Frontend: 渲染 Trace 概览
Frontend -> Frontend: 递归渲染 Observations 树
Frontend -> Frontend: 显示 Scores 列表
Frontend -> Frontend: 显示 Session 信息
Frontend -> Frontend: 显示聚合指标

Frontend --> User: 完整的 Trace 详情页面
deactivate Frontend

note right of User
  显示内容:
  - Trace 元信息
  - Input/Output
  - Observations 树形结构
  - 每个 Observation 的详细信息
  - Scores 列表
  - Session 关联
  - 成本和 Token 统计
  - Timeline 可视化
end note

end

@enduml
