@startuml
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding 6
skinparam ParticipantPadding 30

title Trace 查询流程 (UI 表格)

actor "用户" as User
participant "Frontend\n(Next.js)" as Frontend
participant "tRPC Client" as TRPCClient
participant "tRPC Router\n(traces)" as Router
participant "Comment Filter" as CommentFilter
participant "Traces Service" as Service
database "ClickHouse" as CH
database "PostgreSQL" as PG
participant "Score Service" as ScoreService

== 用户查询 ==

User -> Frontend: 访问 /project/[id]/traces
activate Frontend

Frontend -> Frontend: 加载 Traces 页面 (traces.tsx)
Frontend -> TRPCClient: useInfiniteQuery(\n  traces.all, {\n    projectId,\n    filter, orderBy,\n    page, limit\n  })
activate TRPCClient

TRPCClient -> Router: traces.all()
activate Router

== 认证和权限 ==

Router -> Router: 验证用户 session
Router -> Router: 检查项目访问权限

note right of Router
  protectedProjectProcedure
  自动注入 session 和 projectId
end note

== 应用评论过滤 ==

Router -> CommentFilter: applyCommentFilters({\n  filterState,\n  projectId,\n  objectType: "TRACE"\n})
activate CommentFilter

CommentFilter -> PG: 查询符合评论条件的 trace IDs
activate PG
PG --> CommentFilter: matching trace IDs
deactivate PG

CommentFilter --> Router: { filterState, hasNoMatches }
deactivate CommentFilter

alt hasNoMatches == true
  Router --> TRPCClient: { traces: [] }
  TRPCClient --> Frontend: 空结果
  Frontend --> User: 显示 "无数据"
else 继续查询

== 查询 Traces 表格数据 ==

Router -> Service: getTracesTable({\n  projectId,\n  filter,\n  searchQuery,\n  orderBy,\n  limit,\n  page\n})
activate Service

Service -> Service: 构建 ClickHouse 查询
Service -> Service: 应用过滤条件
Service -> Service: 应用排序

Service -> CH: SELECT\n  id, name, timestamp,\n  user_id, session_id,\n  tags, environment\nFROM traces FINAL\nWHERE project_id = ?\n  AND is_deleted = 0\n  AND ...\nORDER BY timestamp DESC\nLIMIT ? OFFSET ?
activate CH

CH --> Service: traces rows
deactivate CH

note right of CH
  ClickHouse 优化:
  - 列式存储
  - 高效聚合
  - 分区表
end note

== 补充 Observations 数据 ==

Service -> Service: 为每个 trace 查询 observations

loop 每个 trace
  Service -> CH: SELECT\n  type,\n  provided_model_name,\n  usage_details,\n  cost_details,\n  total_cost\nFROM observations FINAL\nWHERE trace_id = ?\n  AND is_deleted = 0
  activate CH
  CH --> Service: observations
  deactivate CH
  
  Service -> Service: 聚合计算:\n- 总 Token 数\n- 总成本\n- Observation 数量
end

Service --> Router: traces with metrics
deactivate Service

== 获取关联 Scores ==

Router -> ScoreService: getScoresForTraces(traceIds)
activate ScoreService

ScoreService -> CH: SELECT\n  trace_id, name, value,\n  data_type, comment\nFROM scores\nWHERE trace_id IN (?)
activate CH
CH --> ScoreService: scores
deactivate CH

ScoreService -> ScoreService: 按 trace_id 分组
ScoreService --> Router: scores grouped by trace
deactivate ScoreService

== 组装返回数据 ==

Router -> Router: 合并 traces 和 scores
Router -> Router: 格式化响应

Router --> TRPCClient: {\n  traces: [\n    {\n      id, name, timestamp,\n      observationCount,\n      totalCost,\n      scores: [...]\n    },\n    ...\n  ]\n}
deactivate Router

TRPCClient --> Frontend: traces data
deactivate TRPCClient

Frontend -> Frontend: 渲染表格
Frontend -> Frontend: 显示 Trace 列表
Frontend --> User: 显示结果
deactivate Frontend

note right of User
  表格显示:
  - Trace ID, Name
  - Timestamp
  - User, Session
  - Observations 数量
  - Token 使用
  - 成本
  - 评分
end note

@enduml
