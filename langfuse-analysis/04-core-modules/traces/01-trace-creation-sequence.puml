@startuml
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding 6
skinparam ParticipantPadding 30

title Trace 创建流程

actor "用户应用" as App
participant "Langfuse SDK" as SDK
participant "Ingestion API" as API
participant "Event Processing" as Processing
participant "Ingestion Queue" as Queue
participant "Worker" as Worker
participant "Ingestion Service" as Service
database "ClickHouse" as CH

== Trace 创建 ==

App -> SDK: trace = langfuse.trace()
activate SDK
SDK -> SDK: 生成 trace ID
SDK -> SDK: 记录到本地队列
SDK --> App: 返回 trace 对象
deactivate SDK

note right of SDK
  SDK 支持批量提交
  默认每 1 秒或 50 个事件
  刷新一次
end note

== SDK 批量提交 ==

SDK -> API: POST /api/public/ingestion\n{batch: [{type: "trace-create", body: {...}}]}
activate API

API -> API: 验证 API Key
API -> API: 检查项目权限和速率限制

API -> Processing: processEventBatch(events)
activate Processing

Processing -> Processing: Zod schema 验证
Processing -> Processing: 检查必填字段

== 加入队列 ==

Processing -> Queue: add to IngestionQueue
activate Queue

Queue --> Processing: job queued
deactivate Queue

Processing --> API: { success: true, results: [...] }
deactivate Processing

API --> SDK: 207 Multi-Status
deactivate API

SDK --> App: 提交完成
note right of App
  同步返回，快速响应
  Worker 异步处理写入 ClickHouse
  最终一致性保证
end note

== Worker 异步处理 ==

Worker -> Queue: 消费 ingestion 任务
activate Worker

Worker -> Service: processTraceEventList(events)
activate Service

Service -> Service: 合并和排序事件
Service -> Service: 构建 trace 对象

Service -> CH: INSERT/UPSERT traces\nVALUES (...)
activate CH
CH --> Service: 写入成功
deactivate CH

Service --> Worker: 处理完成
deactivate Service

Worker -> Queue: 标记任务完成
deactivate Worker

note right of CH
  ClickHouse 表使用
  ReplacingMergeTree 引擎
  按 project_id, timestamp 排序
  支持高效查询和聚合
  自动去重和更新
end note

@enduml
