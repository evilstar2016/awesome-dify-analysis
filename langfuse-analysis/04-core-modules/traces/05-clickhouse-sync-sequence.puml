@startuml
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding 6
skinparam ParticipantPadding 30

title ClickHouse 数据写入流程

participant "Ingestion API" as API
participant "Ingestion Queue" as Queue
participant "Worker" as Worker
participant "Ingestion Service" as Service
participant "ClickHouse Writer" as CHWriter
database "ClickHouse" as CH

== 事件入队 ==

API -> Queue: 提交事件到 IngestionQueue
activate Queue

note right of Queue
  事件类型:
  - trace-create/update
  - observation-create/update
  - generation-create/update
  - span-create/update
  - event-create
  - score-create/update
end note

Queue --> API: 返回 job ID
deactivate Queue

== Worker 处理 ==

Worker -> Queue: 消费队列任务
activate Worker
activate Queue

Queue --> Worker: 批量事件数据
deactivate Queue

Worker -> Service: 根据事件类型路由:\n- processTraceEventList()\n- processObservationEventList()\n- processScoreEventList()
activate Service

== 数据处理与合并 ==

Service -> Service: 按 ID 分组事件

loop 每个实体 ID
  Service -> Service: 按时间排序事件
  Service -> Service: toTimeSortedEventList()
  
  note right of Service
    将同一实体的多次更新
    按时间戳排序
  end note
  
  == 查询现有数据 ==
  
  Service -> CH: 查询现有记录 (如果存在)
  activate CH
  
  note right of CH
    SELECT * FROM {table} FINAL
    WHERE id = ? 
      AND project_id = ?
      AND is_deleted = 0
  end note
  
  CH --> Service: 现有记录 (可能为空)
  deactivate CH
  
  == 数据合并 ==
  
  Service -> Service: mapEventsToRecords(events)
  Service -> Service: mergeRecords(\n  newRecords,\n  existingRecord\n)
  
  note right of Service
    合并策略:
    - 非 null 值覆盖
    - 保留最新时间戳
    - 累加数值字段
    - 使用 provided_* 优先
  end note
  
  == 特殊处理 ==
  
  alt 是 Observation/Generation
    Service -> Service: getGenerationUsage()
    Service -> Service: 计算 token 和成本
    note right of Service
      详见 04-cost-calculation-sequence.puml
    end note
  end
  
  Service -> Service: 构建最终的 ClickHouse 记录
end

== 批量写入 ClickHouse ==

Service -> CHWriter: addToQueue(tableName, record)
activate CHWriter

CHWriter -> CHWriter: 加入内存队列
CHWriter -> CHWriter: queue[tableName].push(record)

note right of CHWriter
  ClickHouse Writer 维护
  多个表的内存队列:
  - traces
  - observations
  - scores
  - trace_sessions
  等
end note

alt 队列达到批量大小
  CHWriter -> CHWriter: 触发 flush(tableName)
  
  note right of CHWriter
    批量大小配置:
    默认 1000 条记录
  end note
end

CHWriter --> Service: 已加入队列
deactivate CHWriter

Service --> Worker: 处理完成
deactivate Service

== 定时批量刷新 ==

loop 每 N 秒 (默认 5 秒)
  CHWriter -> CHWriter: 定时器触发 flush()
  activate CHWriter
  
  loop 每个表的队列
    alt 队列非空
      CHWriter -> CHWriter: 取出队列中的所有记录
      
      CHWriter -> CH: client.insert({\n  table,\n  format: "JSONEachRow",\n  values: records\n})
      activate CH
      
      note right of CH
        INSERT INTO {table}
        VALUES (...)
        
        使用 ReplacingMergeTree:
        - 按 event_ts 去重
        - 保留最新版本
        - is_deleted 标记删除
      end note
      
      alt 写入成功
        CH --> CHWriter: 成功
        CHWriter -> CHWriter: 清空队列
        
      else 写入失败
        CH --> CHWriter: 错误
        
        alt 可重试错误
          CHWriter -> CHWriter: 增加 attempts 计数
          CHWriter -> CHWriter: 放回队列
          
          note right of CHWriter
            可重试错误:
            - 网络超时
            - 连接失败
            - 临时过载
            
            最多重试 3 次
          end note
          
        else 不可重试错误
          CHWriter -> CHWriter: 记录到 DLQ (死信队列)
          
          note right of CHWriter
            不可重试错误:
            - 数据格式错误
            - 字段过长
            - Schema 不匹配
          end note
        end
      end
      
      deactivate CH
    end
  end
  
  deactivate CHWriter
end

== 优雅关闭 ==

Worker -> CHWriter: shutdown()
activate CHWriter

CHWriter -> CHWriter: 停止定时器
CHWriter -> CHWriter: flushAll() - 刷新所有队列

loop 所有表
  CHWriter -> CH: 批量写入剩余数据
  activate CH
  CH --> CHWriter: 完成
  deactivate CH
end

CHWriter --> Worker: 关闭完成
deactivate CHWriter

deactivate Worker

note right of CH
  最终一致性保证:
  - API 立即返回
  - 异步写入 ClickHouse
  - 批量写入提高性能
  - 失败重试机制
  - 数据不会丢失
end note

@enduml
