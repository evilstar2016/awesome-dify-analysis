@startuml Widget Query Execution Flow

title Dashboard Widget 查询执行流程

actor "用户\n(User)" as User
participant "Dashboard\nPage" as Page
participant "Dashboard\nWidget" as Widget
participant "tRPC\nClient" as TRPC
participant "dashboard\nRouter" as Router
participant "Query\nBuilder" as QueryBuilder
participant "ClickHouse" as CH
participant "PostgreSQL" as PG

== 初始化阶段 ==

User -> Page: 访问 Dashboard\n/project/{id}/dashboards/{dashboardId}
activate Page

Page -> PG: 查询 Dashboard 配置\napi.dashboard.getDashboard()
activate PG
PG -> PG: SELECT * FROM dashboards\nWHERE id = ?
PG --> Page: Dashboard 数据\n{ id, name, definition }
deactivate PG

note right of Page
  definition: {
    widgets: [
      {
        type: "widget",
        id: "placement-1",
        widgetId: "widget-123",
        x: 0, y: 0,
        x_size: 6, y_size: 4
      }
    ]
  }
end note

Page -> Page: 渲染 DashboardGrid\n（react-grid-layout）

loop 每个 WidgetPlacement

  Page -> Widget: 创建 DashboardWidget 组件\n({ placement, dateRange, filterState })
  activate Widget
  
  Widget -> TRPC: 查询 Widget 配置\napi.dashboardWidgets.get.useQuery()
  activate TRPC
  
  TRPC -> PG: SELECT * FROM dashboard_widgets\nWHERE id = ?
  activate PG
  PG --> TRPC: Widget 记录
  deactivate PG
  
  TRPC --> Widget: Widget 数据
  deactivate TRPC
  
  note right of Widget
    Widget 配置：
    {
      id: "widget-123",
      name: "Token Usage",
      view: "observations",
      dimensions: [{ field: "model" }],
      metrics: [
        { measure: "totalTokens", agg: "sum" }
      ],
      filters: [
        { column: "type", value: ["GENERATION"] }
      ],
      chartType: "LINE_TIME_SERIES"
    }
  end note
  
  deactivate Widget

end

deactivate Page

== 查询执行阶段 ==

User -> Page: 设置日期范围\n(Last 7 Days)
activate Page

Page -> Page: 更新 dateRange state\n{ from: Date, to: Date }

Page -> Widget: 触发重新查询\n（React Query refetch）
activate Widget

Widget -> Widget: 构建 QueryType 对象

note right of Widget
  QueryType 构建：
  {
    view: "observations",
    dimensions: [{ field: "model" }],
    metrics: [
      { measure: "totalTokens", aggregation: "sum" }
    ],
    filters: [
      // Widget 静态过滤
      { column: "type", value: ["GENERATION"] },
      // 全局过滤（合并）
      ...mapLegacyUiTableFilterToView(view, filterState)
    ],
    timeDimension: { granularity: "day" },
    fromTimestamp: "2024-12-10T00:00:00Z",
    toTimestamp: "2024-12-17T23:59:59Z",
    orderBy: null
  }
end note

Widget -> TRPC: api.dashboard.executeQuery.useQuery()
activate TRPC

note right of TRPC
  Query Input:
  {
    projectId: "proj-123",
    query: { ... }
  }
  
  Options:
  {
    trpc: {
      context: { skipBatch: true }
    }
  }
end note

TRPC -> Router: dashboard.executeQuery(input)
activate Router

note right of Router
  protectedProjectProcedure 中间件
  自动进行权限校验和身份验证
end note

alt 无权限
  Router -> TRPC: throw UnauthorizedError
  TRPC -> Widget: 401 Unauthorized
  Widget -> Page: showErrorToast("No access")
  activate Page
  Page -> User: 显示错误
  deactivate Page
  [<-- User
end

Router -> Router: 调用 executeQuery()

note right of Router
  executeQuery 函数：
  1. 创建 QueryBuilder 实例
     const queryBuilder = new QueryBuilder(chartConfig, version)
  
  2. 调用 queryBuilder.build(query, projectId)
     - 解析 View → ViewDeclaration
     - 映射 dimensions 和 metrics
     - 验证和转换 filters
     - 构建SELECT、GROUP BY、WHERE、ORDER BY 子句
     - 生成最终 SQL 和参数
  
  3. 返回 { query: compiledQuery, parameters }
end note

Router -> Router: 生成 ClickHouse SQL

note right of Router
  生成的 SQL（简化）：
  
  SELECT
    model,
    toStartOfDay(startTime) as time_dimension,
    SUM(totalTokens) as sum_totalTokens
  FROM observations
  WHERE
    project_id = {projectId: String}
    AND type IN {types: Array(String)}
    AND startTime >= {fromTimestamp: DateTime}
    AND startTime <= {toTimestamp: DateTime}
  GROUP BY model, time_dimension
  ORDER BY time_dimension ASC
  
  使用参数化查询防止 SQL 注入
end note

Router -> CH: 执行 OLAP 查询
activate CH

CH -> CH: 列式扫描\n（按 project_id 分区）

CH -> CH: 聚合计算\nSUM(totalTokens) GROUP BY model

CH --> Router: 查询结果（DatabaseRow[]）
deactivate CH

note right of Router
  查询结果：
  [
    {
      model: "gpt-4",
      time_dimension: "2024-12-10T00:00:00Z",
      sum_totalTokens: 50000
    },
    {
      model: "gpt-4",
      time_dimension: "2024-12-11T00:00:00Z",
      sum_totalTokens: 55000
    },
    {
      model: "gpt-3.5-turbo",
      time_dimension: "2024-12-10T00:00:00Z",
      sum_totalTokens: 120000
    },
    // ...
  ]
end note

Router --> TRPC: 200 OK\n{ data: DatabaseRow[] }
deactivate Router

TRPC --> Widget: 返回查询结果
deactivate TRPC

== 数据转换与渲染阶段 ==

Widget -> Widget: transformedData = useMemo()\n转换为图表数据格式

note right of Widget
  数据转换逻辑：
  
  queryResult.data.map((item) => ({
    ts: new Date(item.time_dimension).getTime(),
    values: [
      {
        label: item.model,  // 维度值
        value: Number(item.sum_totalTokens)  // 指标值
      }
    ]
  }))
  
  转换后格式：
  [
    {
      ts: 1702166400000,  // 2024-12-10 00:00:00
      values: [
        { label: "gpt-4", value: 50000 },
        { label: "gpt-3.5-turbo", value: 120000 }
      ]
    },
    // ...
  ]
end note

Widget -> Widget: 根据 chartType 选择组件\nchartType === "LINE_TIME_SERIES"

Widget -> Widget: 渲染 BaseTimeSeriesChart
activate Widget

Widget -> Widget: Recharts 渲染折线图\n<LineChart data={transformedData}>

note right of Widget
  图表配置：
  - X 轴：时间（ts）
  - Y 轴：Token 数量（value）
  - 图例：模型名称（label）
  - 颜色：getColorsForCategories(models)
  - Tooltip：自定义 Tooltip 组件
end note

Widget --> Page: 图表渲染完成
deactivate Widget
deactivate Widget

Page -> User: 显示图表
deactivate Page

== 用户交互阶段 ==

User -> Page: 悬停查看数据点
activate Page

Page -> Widget: Tooltip 显示
activate Widget

Widget -> User: 显示详细数据\n"gpt-4: 50,000 tokens\n2024-12-10"
deactivate Widget
deactivate Page

User -> Page: 添加全局过滤器\n(model = "gpt-4")
activate Page

Page -> Page: setFilterState([\n  { column: "model", value: "gpt-4" }\n])

Page -> Widget: 触发所有 Widget 重新查询
activate Widget

note right of Widget
  新的 filters：
  [
    { column: "type", value: ["GENERATION"] },  // Widget 过滤
    { column: "model", value: "gpt-4" }         // 全局过滤
  ]
end note

Widget -> TRPC: 重新执行查询
activate TRPC
TRPC -> Router: executeQuery (新过滤条件)
activate Router
Router -> CH: 执行新查询
activate CH
CH --> Router: 过滤后结果
deactivate CH
Router --> TRPC: 返回结果
deactivate Router
TRPC --> Widget: 新数据
deactivate TRPC

Widget -> Widget: 重新转换和渲染

Widget --> Page: 更新图表
deactivate Widget

Page -> User: 显示过滤后图表
deactivate Page

== 错误处理 ==

alt 查询超时
  CH -> Router: QueryTimeoutError
  Router -> TRPC: 500 Internal Server Error
  TRPC -> Widget: Error response
  Widget -> Widget: queryResult.isError = true
  Widget -> Page: 显示错误状态\n"Query timeout, please reduce date range"
  activate Page
  Page -> User: 显示错误提示
  deactivate Page
end

alt 数据为空
  CH --> Router: [] (空结果)
  Router --> TRPC: 200 OK { data: [] }
  TRPC --> Widget: 空数据
  Widget -> Widget: transformedData = []
  Widget -> Page: 渲染 NoDataOrLoading 组件
  activate Page
  Page -> User: 显示 "No data available"
  deactivate Page
end

@enduml
