@startuml Dashboard Creation and Widget Management Flow

title Dashboard 创建和 Widget 管理流程

actor "用户\n(User)" as User
participant "Dashboard\nList Page" as ListPage
participant "Dashboard\nPage" as DashPage
participant "Widget\nForm" as WidgetForm
participant "tRPC\nClient" as TRPC
participant "dashboard\nRouter" as DashRouter
participant "dashboard\nWidgets\nRouter" as WidgetRouter
participant "Dashboard\nService" as DashService
participant "PostgreSQL" as PG
participant "PostHog" as Analytics

== 创建 Dashboard ==

User -> ListPage: 点击 "New Dashboard" 按钮
activate ListPage

ListPage -> ListPage: 打开创建对话框\n(EditDashboardDialog)

User -> ListPage: 填写信息\nname: "Model Performance"\ndescription: "Track model metrics"

ListPage -> TRPC: POST /api/trpc/dashboard.createDashboard
activate TRPC

note right of TRPC
  Request:
  {
    projectId: "proj-123",
    name: "Model Performance",
    description: "Track model metrics"
  }
end note

TRPC -> DashRouter: createDashboard.mutation(input)
activate DashRouter

DashRouter -> DashRouter: 权限校验\nthrowIfNoProjectAccess(\n  scope: "dashboards:CUD"\n)

alt 无权限
  DashRouter -> TRPC: throw UnauthorizedError
  TRPC -> ListPage: 401 Unauthorized
  ListPage -> User: showErrorToast("No access")
  [<-- User
end

DashRouter -> DashService: createDashboard(\n  projectId,\n  name,\n  description,\n  userId\n)
activate DashService

DashService -> PG: INSERT INTO dashboards
activate PG

note right of PG
  INSERT INTO dashboards (
    id,
    name,
    description,
    project_id,
    definition,
    created_by,
    updated_by,
    created_at,
    updated_at
  ) VALUES (
    'dash-new-uuid',
    'Model Performance',
    'Track model metrics',
    'proj-123',
    '{"widgets": []}',  -- 初始空布局
    'user-123',
    'user-123',
    NOW(),
    NOW()
  )
end note

PG --> DashService: Dashboard 记录
deactivate PG

DashService --> DashRouter: DashboardDomain
deactivate DashService

note right of DashRouter
  返回数据：
  {
    id: "dash-new-uuid",
    name: "Model Performance",
    description: "Track model metrics",
    projectId: "proj-123",
    owner: "PROJECT",
    definition: { widgets: [] },
    createdAt: "2024-12-17T10:00:00Z",
    updatedAt: "2024-12-17T10:00:00Z"
  }
end note

DashRouter --> TRPC: 200 OK\n{ data: DashboardDomain }
deactivate DashRouter

TRPC --> ListPage: Dashboard 创建成功
deactivate TRPC

ListPage -> Analytics: capture(\n  "dashboard:new_dashboard_form_open"\n)
activate Analytics
Analytics -> Analytics: 异步发送到 PostHog
deactivate Analytics

ListPage -> ListPage: utils.dashboard.invalidate()\n刷新列表

ListPage -> User: 跳转到新 Dashboard\n/dashboards/{dash-new-uuid}
deactivate ListPage

User -> DashPage: 访问新 Dashboard 页面
activate DashPage

DashPage -> PG: 查询 Dashboard\napi.dashboard.getDashboard()
activate PG
PG --> DashPage: Dashboard 数据\n(definition.widgets = [])
deactivate PG

DashPage -> User: 显示空 Dashboard\n（无 Widget）
deactivate DashPage

== 创建 Widget ==

User -> DashPage: 点击 "Add Widget" 按钮
activate DashPage

DashPage -> DashPage: 打开 Widget 选择对话框\n(SelectWidgetDialog)

User -> DashPage: 点击 "Create New Widget"

DashPage -> User: 跳转到 Widget 创建页面\n/widgets/new?dashboardId={id}
deactivate DashPage

User -> WidgetForm: 访问 Widget 创建表单
activate WidgetForm

WidgetForm -> WidgetForm: 初始化表单状态\n{ view, dimensions, metrics, filters }

== Widget 配置阶段 ==

User -> WidgetForm: 选择 View\nview = "observations"
WidgetForm -> WidgetForm: 更新可用 dimensions 和 metrics

User -> WidgetForm: 添加 Dimension\ndimension = "model"

User -> WidgetForm: 添加 Metric\nmetric = { measure: "totalTokens", agg: "sum" }

User -> WidgetForm: 添加 Filter\nfilter = { column: "type", value: ["GENERATION"] }

User -> WidgetForm: 选择图表类型\nchartType = "LINE_TIME_SERIES"

WidgetForm -> WidgetForm: 实时预览查询结果\napi.dashboard.executeQuery()

note right of WidgetForm
  预览查询：
  使用当前配置执行 executeQuery
  展示数据预览和图表效果
  帮助用户验证配置正确性
end note

User -> WidgetForm: 点击 "Save Widget"

== 保存 Widget ==

WidgetForm -> TRPC: POST /api/trpc/dashboardWidgets.create
activate TRPC

note right of TRPC
  Request:
  {
    projectId: "proj-123",
    name: "Token Usage by Model",
    view: "observations",
    dimensions: [{ field: "model" }],
    metrics: [
      { measure: "totalTokens", agg: "sum" }
    ],
    filters: [
      { column: "type", value: ["GENERATION"] }
    ],
    chartType: "LINE_TIME_SERIES",
    chartConfig: { type: "LINE_TIME_SERIES" }
  }
end note

TRPC -> WidgetRouter: create.mutation(input)
activate WidgetRouter

WidgetRouter -> WidgetRouter: 权限校验\nthrowIfNoProjectAccess(\n  scope: "dashboards:CUD"\n)

WidgetRouter -> DashService: DashboardService.createWidget(\n  projectId,\n  input,\n  userId\n)
activate DashService

DashService -> PG: INSERT INTO dashboard_widgets
activate PG

note right of PG
  INSERT INTO dashboard_widgets (
    id,
    name,
    project_id,
    view,
    dimensions,
    metrics,
    filters,
    chart_type,
    chart_config,
    created_by,
    updated_by,
    created_at,
    updated_at
  ) VALUES (
    'widget-new-uuid',
    'Token Usage by Model',
    'proj-123',
    'observations',
    '[{"field":"model"}]',
    '[{"measure":"totalTokens","agg":"sum"}]',
    '[{"column":"type","value":["GENERATION"]}]',
    'LINE_TIME_SERIES',
    '{"type":"LINE_TIME_SERIES"}',
    'user-123',
    'user-123',
    NOW(),
    NOW()
  )
end note

PG --> DashService: Widget 记录
deactivate PG

DashService --> WidgetRouter: WidgetDomain
deactivate DashService

WidgetRouter --> TRPC: 200 OK\n{ data: WidgetDomain }
deactivate WidgetRouter

TRPC --> WidgetForm: Widget 创建成功\n{ widgetId: "widget-new-uuid" }
deactivate TRPC

== 添加 Widget 到 Dashboard ==

WidgetForm -> WidgetForm: 生成 WidgetPlacement

note right of WidgetForm
  生成 Placement：
  {
    type: "widget",
    id: uuidv4(),  // "placement-uuid-1"
    widgetId: "widget-new-uuid",
    x: 0,
    y: 0,
    x_size: 12,  // 全宽
    y_size: 4    // 4 行高
  }
end note

WidgetForm -> TRPC: POST /api/trpc/dashboard.updateDashboardDefinition
activate TRPC

note right of TRPC
  Request:
  {
    dashboardId: "dash-new-uuid",
    projectId: "proj-123",
    definition: {
      widgets: [
        {
          type: "widget",
          id: "placement-uuid-1",
          widgetId: "widget-new-uuid",
          x: 0, y: 0,
          x_size: 12, y_size: 4
        }
      ]
    }
  }
end note

TRPC -> DashRouter: updateDashboardDefinition.mutation(input)
activate DashRouter

DashRouter -> DashService: updateDashboardDefinition(\n  dashboardId,\n  projectId,\n  definition,\n  userId\n)
activate DashService

DashService -> PG: 验证 Dashboard 所有权
activate PG
PG -> PG: SELECT * FROM dashboards\nWHERE id = ? AND project_id = ?
PG --> DashService: Dashboard 记录
deactivate PG

alt Dashboard 不存在或无权限
  DashService -> DashRouter: throw LangfuseNotFoundError
  DashRouter -> TRPC: 404 Not Found
  TRPC -> WidgetForm: Error
  WidgetForm -> User: showErrorToast("Dashboard not found")
  [<-- User
end

DashService -> PG: UPDATE dashboards\nSET definition = ?, updated_by = ?, updated_at = NOW()
activate PG
PG --> DashService: 更新成功
deactivate PG

DashService --> DashRouter: DashboardDomain
deactivate DashService

DashRouter --> TRPC: 200 OK
deactivate DashRouter

TRPC --> WidgetForm: 更新成功
deactivate TRPC

WidgetForm -> WidgetForm: utils.dashboard.invalidate()\n刷新 Dashboard 数据

WidgetForm -> User: 跳转回 Dashboard\n/dashboards/{dash-new-uuid}
deactivate WidgetForm

User -> DashPage: 查看 Dashboard
activate DashPage

DashPage -> PG: 查询 Dashboard\n(包含新 Widget)
activate PG
PG --> DashPage: Dashboard + Widget Placement
deactivate PG

DashPage -> DashPage: 渲染 DashboardGrid\n包含新添加的 Widget

DashPage -> User: 显示 Widget 图表
deactivate DashPage

== 拖拽调整布局 ==

User -> DashPage: 拖拽 Widget 改变位置\n从 (0,0) 拖到 (6,0)
activate DashPage

DashPage -> DashPage: onLayoutChange 回调触发

note right of DashPage
  新的 layout：
  {
    i: "placement-uuid-1",
    x: 6,  // 从 0 变为 6
    y: 0,
    w: 6,  // 从 12 变为 6（自动调整）
    h: 4
  }
end note

DashPage -> DashPage: 更新 widgets 数组

DashPage -> TRPC: POST /api/trpc/dashboard.updateDashboardDefinition
activate TRPC

note right of TRPC
  Request:
  {
    dashboardId: "dash-new-uuid",
    definition: {
      widgets: [
        {
          type: "widget",
          id: "placement-uuid-1",
          widgetId: "widget-new-uuid",
          x: 6,  // 新位置
          y: 0,
          x_size: 6,  // 新尺寸
          y_size: 4
        }
      ]
    }
  }
end note

TRPC -> DashRouter: updateDashboardDefinition
activate DashRouter
DashRouter -> DashService: updateDashboardDefinition
activate DashService
DashService -> PG: UPDATE dashboards
activate PG
PG --> DashService: 成功
deactivate PG
DashService --> DashRouter: 成功
deactivate DashService
DashRouter --> TRPC: 200 OK
deactivate DashRouter
TRPC --> DashPage: 布局已保存
deactivate TRPC

DashPage -> User: 显示新布局
deactivate DashPage

== 克隆 Dashboard ==

User -> DashPage: 点击 "Clone Dashboard" 按钮
activate DashPage

DashPage -> DashPage: 确认对话框\n"Clone this dashboard?"

User -> DashPage: 确认克隆

DashPage -> TRPC: POST /api/trpc/dashboard.cloneDashboard
activate TRPC

note right of TRPC
  Request:
  {
    dashboardId: "dash-new-uuid",
    projectId: "proj-123"
  }
end note

TRPC -> DashRouter: cloneDashboard.mutation(input)
activate DashRouter

DashRouter -> DashService: getDashboard(\n  dashboardId,\n  projectId\n)
activate DashService

DashService -> PG: SELECT * FROM dashboards\nWHERE id = ?
activate PG
PG --> DashService: 源 Dashboard 数据
deactivate PG

DashService --> DashRouter: sourceDashboard
deactivate DashService

alt Dashboard 不存在
  DashRouter -> TRPC: throw NotFoundError
  TRPC -> DashPage: 404 Not Found
  DashPage -> User: showErrorToast("Dashboard not found")
  [<-- User
end

DashRouter -> DashService: createDashboard(\n  projectId,\n  name + " (Clone)",\n  description,\n  userId,\n  definition  // 复制布局\n)
activate DashService

DashService -> PG: INSERT INTO dashboards
activate PG

note right of PG
  复制源 Dashboard 的 definition：
  {
    name: "Model Performance (Clone)",
    definition: {
      widgets: [
        // 完全相同的 Placement
        {
          type: "widget",
          id: "placement-uuid-1",
          widgetId: "widget-new-uuid",  // 引用同一个 Widget
          x: 6, y: 0,
          x_size: 6, y_size: 4
        }
      ]
    }
  }
end note

PG --> DashService: 新 Dashboard 记录
deactivate PG

DashService --> DashRouter: clonedDashboard\n{ id: "dash-clone-uuid" }
deactivate DashService

DashRouter --> TRPC: 200 OK\n{ data: clonedDashboard }
deactivate DashRouter

TRPC --> DashPage: 克隆成功
deactivate TRPC

DashPage -> Analytics: capture("dashboard:clone_dashboard")
activate Analytics
Analytics -> Analytics: 异步发送
deactivate Analytics

DashPage -> User: 跳转到新 Dashboard\n/dashboards/{dash-clone-uuid}
deactivate DashPage

@enduml
