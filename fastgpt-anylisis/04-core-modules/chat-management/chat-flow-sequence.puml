@startuml FastGPT Chat Flow Sequence

!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding 6
skinparam ParticipantPadding 30

title FastGPT 对话流程时序图

actor 用户 as User
participant "前端\nFrontend" as FE
participant "API路由\n/api/v1/chat/completions" as API
participant "权限验证\nAuth" as Auth
participant "应用管理\nApp Service" as App
participant "工作流引擎\nWorkflow" as WF
participant "对话管理\nChat Service" as Chat
database "MongoDB" as DB

== 发起对话 ==

User -> FE: 发送消息
activate FE

FE -> API: POST /api/v1/chat/completions
activate API

API -> Auth: 验证API Key/Token
activate Auth
Auth --> API: 验证通过
deactivate Auth

API -> App: 获取应用配置
activate App
App -> DB: 查询应用信息
DB --> App: 应用数据
App --> API: 应用配置
deactivate App

== 会话管理 ==

API -> Chat: 获取/创建会话
activate Chat

alt 新对话
  Chat -> DB: 创建Chat记录
  DB --> Chat: chatId
else 继续对话
  Chat -> DB: 查询已有Chat
  DB --> Chat: Chat信息
end

Chat --> API: 会话信息
deactivate Chat

== 工作流执行 ==

API -> WF: 调度工作流执行
activate WF

WF -> WF: 解析节点图

loop 节点执行
  WF -> WF: 执行当前节点
  
  alt AI对话节点
    WF -> WF: 调用LLM
  else 知识库节点
    WF -> WF: 向量检索
  else 工具节点
    WF -> WF: 工具调用
  end
  
  WF --> API: SSE流式响应
  API --> FE: 流式数据
  FE --> User: 实时显示
end

WF --> API: 执行完成
deactivate WF

== 保存记录 ==

API -> Chat: 保存对话记录
activate Chat

Chat -> DB: 创建用户消息ChatItem
DB --> Chat: dataId

Chat -> DB: 创建AI回复ChatItem
DB --> Chat: dataId

Chat -> DB: 更新Chat时间
DB --> Chat: 完成

Chat --> API: 保存完成
deactivate Chat

API --> FE: 响应完成
deactivate API

FE --> User: 显示完整回复
deactivate FE

== 历史记录查询 ==

User -> FE: 查看历史
activate FE

FE -> API: GET /api/core/chat/getHistory
activate API

API -> Chat: 查询历史
activate Chat
Chat -> DB: 按tmbId+appId查询
DB --> Chat: 对话列表
Chat --> API: 历史记录
deactivate Chat

API --> FE: 对话列表
deactivate API

FE --> User: 显示历史
deactivate FE

@enduml
