@startuml FastGPT Chat Management Architecture

!theme plain
skinparam componentStyle rectangle
skinparam backgroundColor white
skinparam Package { 
  BackgroundColor LightGray
  FontColor Blue
}
skinparam component {
  BackgroundColor LightBlue
  BorderColor Black
  ArrowColor Black
  FontColor DarkBlue
}
skinparam note {
  backgroundColor LightYellow
}

title FastGPT 对话管理模块架构图

' 对话入口层
package "对话入口 (Chat Sources)" {
  [在线对话\nonline] as Online
  [API调用\napi] as API
  [分享链接\nshare] as Share
  [第三方集成\n飞书/企微/公众号] as ThirdParty
  [MCP调用\nmcp] as MCP
}

' 对话管理层
package "对话管理层 (Chat Management)" {
  [会话管理\nChat] as ChatMgmt
  [消息管理\nChatItem] as ItemMgmt
  [反馈管理\nFeedback] as FeedbackMgmt
  [历史管理\nHistory] as HistoryMgmt
}

' 数据存储层
package "数据存储 (Data Storage)" {
  database "MongoDB" {
    [chats 表\n会话数据] as ChatsDB
    [chat_items 表\n消息数据] as ItemsDB
    [chat_item_responses\n响应详情] as ResponseDB
  }
}

' 工作流层
package "工作流引擎 (Workflow Engine)" {
  [对话处理\nChat Dispatch] as ChatDispatch
  [流式响应\nSSE Stream] as SSE
  [消息保存\nSave Chat] as SaveChat
}

' API 层
package "API 层" {
  [/api/v1/chat/completions\nOpenAI兼容] as V1API
  [/api/v2/chat/completions\n增强版本] as V2API
  [/api/core/chat/*\n对话管理API] as ChatAPI
}

' 关联模块
package "关联模块" {
  [应用模块\nApp] as App
  [知识库模块\n引用追踪] as Dataset
  [外链模块\nOutLink] as OutLink
}

' 关系连接
Online --> V1API
API --> V1API
Share --> V2API
ThirdParty --> V2API
MCP --> V2API

V1API --> ChatDispatch
V2API --> ChatDispatch

ChatDispatch --> SSE
ChatDispatch --> SaveChat

SaveChat --> ChatMgmt
SaveChat --> ItemMgmt

ChatMgmt --> ChatsDB
ItemMgmt --> ItemsDB
ItemMgmt --> ResponseDB

ChatAPI --> ChatMgmt
ChatAPI --> ItemMgmt
ChatAPI --> FeedbackMgmt
ChatAPI --> HistoryMgmt

ChatMgmt --> App : 关联应用
ItemMgmt --> Dataset : 引用关联
Share --> OutLink : 分享链接

FeedbackMgmt --> Dataset : 反馈入库

note right of Online
  主要对话入口
  用户直接使用
end note

note right of API
  程序调用
  OpenAI格式兼容
end note

note right of FeedbackMgmt
  用户反馈收集
  管理员处理闭环
end note

@enduml
