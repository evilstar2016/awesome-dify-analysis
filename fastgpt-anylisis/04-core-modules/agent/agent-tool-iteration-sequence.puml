@startuml agent-tool-iteration-sequence

!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding 6
skinparam ParticipantPadding 30

title Agent多轮工具调用迭代流程

actor 用户 as User
participant "Agent节点" as Agent
participant "runToolCall" as ToolCall
participant "LLM" as LLM
participant "数据集搜索" as Dataset
participant "HTTP工具" as HTTP

User -> Agent: "查询北京天气，\n然后推荐旅游景点"
activate Agent

Agent -> ToolCall: 开始工具调用流程
activate ToolCall

== 第1轮：LLM决策调用天气API ==

ToolCall -> LLM: 调用LLM\n(tools: [weatherAPI, datasetSearch])
activate LLM
LLM -> LLM: 分析：需要先查天气
LLM --> ToolCall: function_call: weatherAPI
deactivate LLM
note right
  {
    name: "weatherAPI",
    arguments: {
      city: "北京"
    }
  }
end note

ToolCall -> HTTP: 执行HTTP工具
activate HTTP
HTTP -> HTTP: 调用天气API
HTTP --> ToolCall: 返回天气数据
deactivate HTTP
note left
  {
    weather: "晴",
    temp: "20-28℃"
  }
end note

== 第2轮：LLM决策搜索旅游攻略 ==

ToolCall -> ToolCall: 更新上下文\n(添加天气结果)
note right
  messages += 工具调用记录
end note

ToolCall -> LLM: 再次调用LLM\n(带天气结果)
activate LLM
LLM -> LLM: 分析：已有天气，\n需要旅游攻略
LLM --> ToolCall: function_call: datasetSearch
deactivate LLM
note right
  {
    name: "datasetSearch",
    arguments: {
      query: "北京旅游景点推荐"
    }
  }
end note

ToolCall -> Dataset: 执行数据集搜索
activate Dataset
Dataset -> Dataset: 向量搜索
Dataset --> ToolCall: 返回景点攻略
deactivate Dataset
note left
  [
    "故宫 - 必去景点",
    "长城 - 世界奇迹",
    ...
  ]
end note

== 第3轮：生成最终回复 ==

ToolCall -> ToolCall: 更新上下文\n(添加景点攻略)
note right
  messages += 工具调用记录
  已收集完所有信息
end note

ToolCall -> LLM: 最后一次调用LLM\n(tools: []) 不再提供工具
activate LLM
LLM -> LLM: 综合所有工具结果\n生成自然语言回复
LLM --> ToolCall: 返回最终文本响应
deactivate LLM
note left
  "北京今天天气很好，
  晴天，气温20-28℃。
  推荐您今天游览：
  1. 故宫 - 必去景点
  2. 长城 - 世界奇迹
  ..."
end note

ToolCall --> Agent: 返回结果\n(answerText + toolDetail)
deactivate ToolCall

Agent --> User: 显示最终回复
deactivate Agent

note over User, HTTP
  本次对话:
  - 工具调用次数: 2次
  - LLM调用次数: 3次
  - 消耗token: ~2000
end note

@enduml
