@startuml agent-architecture

!theme plain
skinparam componentStyle rectangle
skinparam backgroundColor white
skinparam Package { 
  BackgroundColor LightGray
  FontColor Blue
}
skinparam component {
  BackgroundColor LightBlue
  BorderColor Black
  ArrowColor Black
  FontColor DarkBlue
}
skinparam note {
  backgroundColor LightYellow
}

title FastGPT Agent智能体架构图

package "应用层 (Application Layer)" {
  [Agent应用] as AgentApp
  [Simple应用] as SimpleApp
  [Workflow应用] as WorkflowApp
  
  note right of AgentApp
    AppTypeEnum.agent
    具备工具调用能力的智能应用
  end note
}

package "工作流层 (Workflow Layer)" {
  [工作流开始节点] as StartNode
  [Agent节点\n(FlowNodeTypeEnum.agent)] as AgentNode
  [AI对话节点] as ChatNode
  [问题分类节点] as ClassifyNode
  
  note right of AgentNode
    核心节点
    - 工具调用决策
    - LLM推理
    - 迭代执行
  end note
}

package "执行层 (Dispatch Layer)" {
  [dispatchRunTools] as DispatchTools
  [runToolCall] as RunToolCall
  [工具执行器] as ToolExecutor
  
  note right of DispatchTools
    执行入口
    - 初始化上下文
    - 收集工具节点
    - 构建Prompt
  end note
}

package "工具层 (Tool Layer)" {
  [数据集搜索] as DatasetSearch
  [HTTP请求] as HttpRequest
  [文件读取] as ReadFiles
  [代码执行] as Sandbox
  [MCP工具集] as MCPTools
  [工作流工具] as WorkflowTool
  
  note bottom of MCPTools
    Model Context Protocol
    动态工具发现和调用
  end note
}

package "基础服务层 (Service Layer)" {
  [LLM服务] as LLMService
  [向量数据库] as VectorDB
  [文件存储] as FileStorage
  [代码沙箱] as CodeSandbox
}

' 应用层关系
AgentApp --> AgentNode : 包含
WorkflowApp --> AgentNode : 可包含
WorkflowApp --> ChatNode : 包含
WorkflowApp --> ClassifyNode : 包含

' 工作流层到执行层
AgentNode --> DispatchTools : 执行
DispatchTools --> RunToolCall : 调用
RunToolCall --> ToolExecutor : 执行工具

' 执行层到工具层
ToolExecutor --> DatasetSearch : 调用
ToolExecutor --> HttpRequest : 调用
ToolExecutor --> ReadFiles : 调用
ToolExecutor --> Sandbox : 调用
ToolExecutor --> MCPTools : 调用
ToolExecutor --> WorkflowTool : 调用

' 工具层到基础服务层
DatasetSearch --> VectorDB : 查询
DatasetSearch --> LLMService : Rerank
ReadFiles --> FileStorage : 读取
Sandbox --> CodeSandbox : 执行
HttpRequest ..> LLMService : 使用

' RunToolCall到LLM
RunToolCall --> LLMService : Function Calling

' 数据流
AgentApp -[#red,dashed,thickness=2]-> LLMService : <font color=red>**用户输入**
LLMService -[#green,dashed,thickness=2]-> AgentApp : <font color=green>**AI响应**

@enduml
