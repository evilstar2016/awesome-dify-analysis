@startuml MCP完整调用流程时序图
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding 6
skinparam ParticipantPadding 30

title MCP 工具完整生命周期流程

actor "用户/外部系统" as User
participant "FastGPT\n工作流引擎" as Workflow
participant "工具分发器\ndispatchRunTool" as Dispatcher
participant "MCP Client\n(客户端)" as FGClient
participant "外部MCP服务" as ExternalMCP
participant "MCP Server\n(服务端)" as FGServer
participant "工具调用处理\ncallMcpServerTool" as ServerHandler
database "MongoDB" as DB

== 第一部分: FastGPT 调用外部 MCP 工具 ==

User -> Workflow: 执行包含MCP工具的工作流
activate Workflow

Workflow -> Workflow: 初始化执行上下文
note right
  创建 mcpClientMemory = {}
  用于缓存 MCP 连接
end note

Workflow -> Dispatcher: 执行到MCP工具节点
activate Dispatcher

Dispatcher -> Dispatcher: 识别 toolConfig.mcpTool
note right
  工具ID: mcp-{parentId}/{toolName}
end note

Dispatcher -> DB: 获取工具集配置
activate DB
DB --> Dispatcher: 返回 MCP 服务 URL 和认证信息
deactivate DB

Dispatcher -> Dispatcher: 检查连接缓存
alt 缓存命中
  Dispatcher -> Dispatcher: 复用已有连接
  note right
    从 mcpClientMemory[url] 获取
  end note
else 缓存未命中
  Dispatcher -> FGClient: new MCPClient(url, headers)
  activate FGClient
  note right
    创建新的 MCP 客户端
  end note
  
  Dispatcher -> Dispatcher: 缓存连接
  note right
    mcpClientMemory[url] = mcpClient
  end note
end

Dispatcher -> FGClient: toolCall(toolName, params, closeConnection=false)

FGClient -> FGClient: getConnection()
note right
  尝试连接顺序:
  1. StreamableHTTPClientTransport
  2. SSEClientTransport (fallback)
end note

FGClient -> ExternalMCP: 建立连接
activate ExternalMCP
ExternalMCP --> FGClient: 连接建立

FGClient -> ExternalMCP: CallTool Request
note right
  {
    name: toolName,
    arguments: params
  }
end note

ExternalMCP -> ExternalMCP: 执行工具逻辑
ExternalMCP --> FGClient: 返回执行结果
note left
  保持连接打开
  供后续调用复用
end note

FGClient --> Dispatcher: 返回工具结果
deactivate FGClient

Dispatcher -> Dispatcher: 构建节点输出
note right
  {
    data: { rawResponse: result },
    nodeResponse: { toolRes: result },
    toolResponses: result
  }
end note

Dispatcher --> Workflow: 返回节点执行结果
deactivate Dispatcher

Workflow -> Workflow: 继续执行后续节点
note right
  可能还会调用更多MCP工具
  所有工具共享连接缓存
end note

Workflow -> Workflow: 工作流执行完成

loop 清理所有MCP连接
  Workflow -> FGClient: closeConnection()
  activate FGClient
  FGClient -> ExternalMCP: 关闭连接
  ExternalMCP --> FGClient: 确认关闭
  deactivate ExternalMCP
  deactivate FGClient
end

Workflow --> User: 返回工作流执行结果
deactivate Workflow

== 第二部分: 外部系统调用 FastGPT MCP 服务 ==

User -> FGServer: 连接 FastGPT MCP Server
activate FGServer
note right
  GET /:key/sse
  或
  POST /mcp/app/:key/mcp
end note

FGServer -> FGServer: 创建 MCP Server 实例
note right
  注册 ListTools 和 CallTool 处理器
end note

FGServer --> User: 连接建立成功

User -> FGServer: ListTools Request
note right
  获取可用工具列表
end note

FGServer -> DB: 验证 MCP Key
activate DB
DB --> FGServer: 返回关联的应用列表
deactivate DB

FGServer -> DB: 获取应用详情和权限
activate DB
DB --> FGServer: 返回有权限的应用
deactivate DB

FGServer -> FGServer: 转换为 MCP Tool Schema
note right
  基于应用类型选择转换方式:
  - Plugin: pluginNodes2InputSchema
  - Workflow: workflow2InputSchema
end note

FGServer --> User: 返回 Tool[] 列表
note left
  [
    {
      name: "toolName",
      description: "...",
      inputSchema: {...}
    },
    ...
  ]
end note

User -> FGServer: CallTool Request
note right
  {
    name: "appName",
    arguments: {
      question: "用户问题",
      ...其他参数
    }
  }
end note

FGServer -> ServerHandler: callMcpServerTool(key, toolName, inputs)
activate ServerHandler

ServerHandler -> DB: 查找对应的应用
activate DB
DB --> ServerHandler: 返回应用配置
deactivate DB

ServerHandler -> DB: 获取最新版本
activate DB
DB --> ServerHandler: 返回 nodes, edges, chatConfig
deactivate DB

ServerHandler -> ServerHandler: 构建用户查询
note right
  if (Plugin):
    将 inputs 注入到 pluginInput 节点
  else (Workflow):
    构建对话消息 { question, variables }
end note

ServerHandler -> Workflow: dispatchWorkFlow(config)
activate Workflow

note right of Workflow
  运行配置:
  - mode: 'chat'
  - usageSource: UsageSourceEnum.mcp
  - runtimeNodes (运行时节点)
  - runtimeEdges (运行时边)
  - variables (变量)
  - query (用户查询)
  - stream: false
end note

Workflow -> Workflow: 执行节点链
note right
  按照工作流拓扑顺序执行:
  1. 输入节点
  2. 条件判断
  3. AI 对话
  4. 工具调用
  5. 数据处理
  6. 输出节点
end note

alt 工作流中包含 MCP 工具
  note over Workflow, ExternalMCP
    此时 FastGPT 同时扮演
    MCP Server 和 MCP Client 角色
  end note
  
  Workflow -> FGClient: 调用外部 MCP 工具
  activate FGClient
  FGClient -> ExternalMCP: 工具调用
  activate ExternalMCP
  ExternalMCP --> FGClient: 返回结果
  deactivate ExternalMCP
  FGClient --> Workflow: 返回工具输出
  deactivate FGClient
end

Workflow --> ServerHandler: 返回执行结果
deactivate Workflow

note right
  {
    flowResponses: [...],
    assistantResponses: [...],
    newVariables: {...},
    durationSeconds: 1.23
  }
end note

ServerHandler -> ServerHandler: 提取输出
note right
  if (Plugin):
    找到 pluginOutput 节点
    返回 JSON.stringify(output)
  else (Workflow):
    合并 assistantResponses
    返回文本内容
end note

ServerHandler -> DB: 保存聊天记录
activate DB
note right
  {
    source: ChatSourceEnum.mcp,
    userContent: userQuestion,
    aiContent: aiResponse,
    variables: newVariables
  }
end note
DB --> ServerHandler: 保存成功
deactivate DB

ServerHandler --> FGServer: 返回格式化结果
deactivate ServerHandler

FGServer --> User: CallTool Response
deactivate FGServer
note left
  {
    content: [{
      type: 'text',
      text: responseContent
    }],
    isError: false
  }
end note

== 第三部分: 工具生命周期管理 ==

note over User, DB
  MCP 工具的完整生命周期
end note

User -> FGServer: 创建 MCP Key
activate FGServer

FGServer -> DB: 保存 MCP 配置
activate DB
note right
  {
    key: "generated_key",
    teamId: "...",
    tmbId: "...",
    apps: [
      { appId, toolName, description },
      ...
    ]
  }
end note
DB --> FGServer: 保存成功
deactivate DB

FGServer --> User: 返回 MCP Key

User -> User: 配置外部系统
note right
  将 MCP Key 配置到
  外部系统的 MCP Client
end note

User -> FGServer: 更新工具关联
note right
  添加/移除关联的应用
  修改工具名称和描述
end note

FGServer -> DB: 更新 MCP 配置
activate DB
DB --> FGServer: 更新成功
deactivate DB

FGServer --> User: 更新完成

User -> FGServer: 删除 MCP Key
FGServer -> DB: 删除配置
activate DB
DB --> FGServer: 删除成功
deactivate DB

FGServer --> User: 删除完成
deactivate FGServer

@enduml
