@startuml prompt-architecture
!theme plain
skinparam componentStyle rectangle
skinparam backgroundColor white
skinparam Package { 
  BackgroundColor LightGray
  FontColor Blue
}
skinparam component {
  BackgroundColor LightBlue
  BorderColor Black
  ArrowColor Black
  FontColor DarkBlue
}
skinparam note {
  backgroundColor LightYellow
}

title FastGPT Prompt管理架构图

package "Prompt代码层" as PromptCode {
  component "agent.ts" as AgentPrompt {
    [getExtractJsonPrompt]
    [getExtractJsonToolPrompt]
    [getCQSystemPrompt]
    [QuestionGuidePrompt]
  }
  
  component "AIChat.ts" as ChatPrompt {
    [Prompt_userQuotePromptList]
    [Prompt_systemQuotePromptList]
    [Prompt_QuoteTemplateList]
    [getQuotePrompt]
    [getDocumentQuotePrompt]
  }
  
  component "dataset.ts" as DatasetPrompt {
    [getDatasetSearchToolResponsePrompt]
  }
  
  component "utils.ts" as PromptUtils {
    [getPromptByVersion]
  }
}

package "工作流配置层" as WorkflowConfig {
  component "AiChat节点配置" as AiChatConfig {
    [AiChatQuoteRole]
    [AiChatQuoteTemplate]
    [AiChatQuotePrompt]
  }
  
  component "应用配置" as AppConfig {
    [questionGuide.customPrompt]
  }
}

package "UI组件层" as UILayer {
  component "PromptTemplate组件" as PromptTemplateComp {
    [模板列表展示]
    [模板选择]
  }
  
  component "PromptEditor组件" as PromptEditorComp {
    [多行编辑]
    [变量插入]
    [语法高亮]
  }
  
  component "SettingQuotePrompt" as SettingQuote {
    [角色选择]
    [引用模板编辑]
    [引用Prompt编辑]
  }
}

package "运行时处理层" as RuntimeLayer {
  component "工作流调度" as WorkflowDispatch {
    [filterDatasetQuote]
    [getChatMessages]
    [replaceVariable]
  }
  
  component "LLM调用" as LLMCall {
    [createLLMResponse]
    [构建messages]
  }
}

package "版本管理" as VersionMgmt {
  component "版本选择器" as VersionSelector {
    [语义化版本排序]
    [版本回退机制]
    [多版本并存]
  }
}

' 关系连接
PromptTemplateComp --> ChatPrompt : 读取模板列表
SettingQuote --> PromptEditorComp : 使用编辑器
SettingQuote --> PromptTemplateComp : 选择模板
SettingQuote --> AiChatConfig : 保存配置

AiChatConfig --> WorkflowDispatch : 传入配置
WorkflowDispatch --> ChatPrompt : 获取默认prompt
WorkflowDispatch --> PromptUtils : 版本处理
WorkflowDispatch --> LLMCall : 组装消息

ChatPrompt --> VersionSelector : 使用版本管理
AgentPrompt --> VersionSelector : 使用版本管理
DatasetPrompt --> VersionSelector : 使用版本管理

WorkflowDispatch --> AgentPrompt : 工具调用场景
WorkflowDispatch --> DatasetPrompt : 数据集搜索场景

note right of PromptCode
  所有Prompt以代码形式定义
  通过Git进行版本控制
  支持TypeScript类型检查
end note

note right of WorkflowConfig
  用户自定义的Prompt
  存储在工作流节点配置中
  支持变量替换
end note

note bottom of RuntimeLayer
  运行时动态组装Prompt
  替换变量值
  根据角色注入到不同位置
end note

@enduml
