@startuml 05-embedding-generation-sequence
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding 6
skinparam ParticipantPadding 30

title 文本嵌入生成时序图

participant "应用层" as App
participant "Embedding 服务" as EmbService
participant "AI API" as AI
participant "向量处理器" as VectorProc

App -> EmbService: getVectorsByText(model, input, type)
activate EmbService

EmbService -> EmbService: 格式化输入\n(string → string[])

note right of EmbService
  type 类型:
  - 'db': 数据库存储 (dbConfig)
  - 'query': 用户查询 (queryConfig)
  - undefined: 默认配置
end note

EmbService -> EmbService: 计算批次\nchunkSize = model.batchSize

loop 遍历每个批次
    EmbService -> AI: embeddings.create({\n  model, input: chunk\n})
    activate AI
    
    note right of AI
      支持的 API:
      - OpenAI API
      - Azure OpenAI
      - 自定义 Embedding 服务
      
      配置:
      - requestUrl: 自定义地址
      - requestAuth: 认证密钥
    end note
    
    AI -> AI: 生成向量嵌入
    
    AI --> EmbService: {\n  data: [{ embedding: [...] }],\n  usage: { total_tokens }\n}
    deactivate AI
    
    EmbService -> EmbService: 计算 Token 数\n(API 返回或 tiktoken)
    
    EmbService -> VectorProc: formatVectors(embedding, normalization)
    activate VectorProc
    
    alt 向量维度 > 1536
        VectorProc -> VectorProc: 截断到 1536 维\nvector.slice(0, 1536)
        VectorProc -> VectorProc: 强制 L2 归一化
        
        note right of VectorProc
          截断公式:
          v' = vector[0:1536]
          
          L2 归一化:
          norm = √(Σ v_i²)
          v_normalized = v' / norm
        end note
        
    else 向量维度 < 1536
        VectorProc -> VectorProc: 零填充到 1536 维\nvector.concat([0, 0, ...])
        
        note right of VectorProc
          零填充公式:
          v' = [v_1, v_2, ..., v_n, 0, ..., 0]
          补充 (1536 - n) 个零
        end note
        
    else 向量维度 = 1536
        VectorProc -> VectorProc: 维度正确
    end
    
    alt normalization = true
        VectorProc -> VectorProc: L2 归一化\nnorm = √(Σ v_i²)\nv' = v / norm
    end
    
    VectorProc --> EmbService: 处理后的向量
    deactivate VectorProc
    
    EmbService -> EmbService: 累计 Tokens\n累计 Vectors
end

EmbService --> App: {\n  tokens: totalTokens,\n  vectors: allVectors\n}
deactivate EmbService

note over App, VectorProc
  输出:
  - tokens: 总 Token 数 (计费)
  - vectors: 1536 维向量数组
  
  批处理优势:
  - 提高 API 调用效率
  - 减少请求次数
  - 降低成本
  
  向量规范化:
  - 统一向量尺度
  - 提高相似度计算稳定性
  - 避免向量长度影响
end note

@enduml
