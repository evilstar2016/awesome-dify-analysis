@startuml 文档上传与训练流程
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding 6
skinparam ParticipantPadding 30

actor 用户 as User
participant "API\n/create/localFile" as API
participant "权限验证" as Auth
participant "文件处理" as File
participant "S3" as S3
participant "MongoDB" as Mongo
participant "文本分块" as Chunk
participant "训练队列" as Queue
participant "Worker" as Worker
participant "向量数据库" as Vector

User -> API: POST 上传文件\nmultipart/form-data
activate API

API -> File: multer.resolveFormData()
activate File
File -> File: 解析文件数据\n保存到临时目录
File --> API: {fileMetadata, data}
deactivate File

API -> Auth: authDataset()\n验证知识库写权限
activate Auth
Auth --> API: {teamId, tmbId, dataset}
deactivate Auth

API -> S3: upload()\n上传文件到对象存储
activate S3
S3 --> API: fileId
deactivate S3
note right: 路径: dataset/{datasetId}/{fileId}

API -> API: createCollectionAndInsertData()
activate API

API -> Mongo: MongoDatasetCollection.create()\n创建集合记录
activate Mongo
note right
{
  datasetId, name, teamId, tmbId,
  type: 'file',
  fileId,
  trainingType: 'chunk',
  chunkSize: 512,
  metadata: {...}
}
end note
Mongo --> API: {collectionId}

API -> Chunk: rawText2Chunks()\n文本分块
activate Chunk
Chunk -> Chunk: 1. 按段落分割
Chunk -> Chunk: 2. 合并小段落
Chunk -> Chunk: 3. 添加重叠内容
note right
chunkSize: 512 tokens
overlapRatio: 0.2
minChunkSize: 100
end note
Chunk --> API: chunks[]
deactivate Chunk

API -> Queue: pushDataListToTrainingQueue()
activate Queue

Queue -> Mongo: MongoDatasetTraining.insertMany()\n批量插入训练任务
note right
每批500条记录
{
  teamId, tmbId,
  datasetId, collectionId,
  mode: 'chunk',
  q: chunk,
  chunkIndex: i,
  retryCount: 5
}
end note

Queue -> Queue: 创建 BullMQ Job
Mongo --> Queue: insertLen
deactivate Queue

Mongo -> Mongo: 提交事务
Mongo --> API: {collectionId, insertResults}
deactivate Mongo
deactivate API

API -> File: clearDiskTempFiles()\n清理临时文件
API --> User: {collectionId, results}
deactivate API

... 异步训练处理 ...

Worker -> Queue: 监听训练队列\nBullMQ Worker
activate Worker

Queue --> Worker: 获取训练任务\n{trainingId, q, a, ...}

Worker -> Worker: getVectorsByText()\n调用 Embedding API
note right
POST /v1/embeddings
{
  model: "text-embedding-ada-002",
  input: "chunk text"
}
end note
Worker -> Worker: 生成向量\nvector[1536]

Worker -> Vector: insertDataToVectorDB()\n存储向量
activate Vector
note right
PGVector:
INSERT INTO dataset_vector
(dataset_id, collection_id,
 data_id, vector)
VALUES (...)

Milvus:
collection.insert({
  vector: [...],
  data_id: "..."
})
end note
Vector --> Worker: dataId
deactivate Vector

Worker -> Mongo: MongoDatasetData.create()\n创建数据块记录
activate Mongo
note right
{
  teamId, datasetId, collectionId,
  q: chunk,
  a: "",
  chunkIndex,
  indexes: [{
    dataId,
    type: 'embedding',
    defaultIndex: true
  }]
}
end note
Mongo --> Worker: 创建成功
deactivate Mongo

Worker -> Mongo: MongoDatasetDataText.create()\n创建全文索引
activate Mongo
note right
{
  datasetId, collectionId,
  dataId,
  text: chunk
}
end note
Mongo --> Worker: 创建成功
deactivate Mongo

Worker -> Mongo: MongoDatasetTraining.deleteOne()\n删除训练任务
Worker -> Mongo: createTrainingUsage()\n记录计费

Worker --> Queue: 任务完成
deactivate Worker

@enduml
