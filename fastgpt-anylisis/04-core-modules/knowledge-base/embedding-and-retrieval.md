# æ–‡æœ¬åµŒå…¥ä¸æ£€ç´¢åŠŸèƒ½æ·±åº¦åˆ†æ

## 1. æ¦‚è¿°

FastGPT çš„çŸ¥è¯†åº“ç®¡ç†ç³»ç»Ÿé‡‡ç”¨ **å‘é‡æ•°æ®åº“ + å…¨æ–‡æ£€ç´¢** çš„æ··åˆæ£€ç´¢æ¶æ„ï¼Œé€šè¿‡ Embedding æ¨¡å‹å°†æ–‡æœ¬è½¬æ¢ä¸ºå‘é‡ï¼Œå®ç°è¯­ä¹‰ç›¸ä¼¼åº¦æœç´¢ã€‚

**æ ¸å¿ƒæ–‡ä»¶è·¯å¾„**:
- `packages/service/core/ai/embedding/index.ts` - æ–‡æœ¬åµŒå…¥ç”Ÿæˆ
- `packages/service/core/dataset/search/controller.ts` - æ£€ç´¢æ§åˆ¶å™¨
- `packages/service/common/vectorDB/controller.ts` - å‘é‡æ•°æ®åº“æ“ä½œ
- `packages/service/common/vectorDB/pg/` - PostgreSQL + PGVector å®ç°
- `packages/service/common/vectorDB/milvus/` - Milvus å®ç°
- `packages/service/common/vectorDB/oceanbase/` - OceanBase å®ç°

## 2. æ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„

```
ç”¨æˆ·æŸ¥è¯¢
  â†“
æŸ¥è¯¢æ‰©å±• (å¯é€‰)
  â†“
æ–‡æœ¬åµŒå…¥ (Embedding)
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ··åˆæ£€ç´¢ (Hybrid Retrieval) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. å‘é‡å¬å› (Embedding)     â”‚
â”‚  2. å…¨æ–‡å¬å› (Full-Text)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
RRF èåˆ (Reciprocal Rank Fusion)
  â†“
ReRank é‡æ’åº (å¯é€‰)
  â†“
ç›¸ä¼¼åº¦è¿‡æ»¤
  â†“
Token é™åˆ¶
  â†“
è¿”å›ç»“æœ
```

### 2.2 æ”¯æŒçš„å‘é‡æ•°æ®åº“

| æ•°æ®åº“ | å®ç°æ–‡ä»¶ | ç´¢å¼•ç±»å‹ | è·ç¦»åº¦é‡ | æ€§èƒ½ |
|--------|---------|---------|---------|------|
| **PostgreSQL + PGVector** | `pg/index.ts` | HNSW | å†…ç§¯ (IP) | âš¡âš¡âš¡ |
| **Milvus** | `milvus/index.ts` | HNSW | å†…ç§¯ (IP) | âš¡âš¡âš¡ |
| **OceanBase** | `oceanbase/index.ts` | HNSW | å†…ç§¯ (IP) | âš¡âš¡ |

**HNSW å‚æ•°**:
- `m = 32` - æ¯å±‚æœ€å¤§è¿æ¥æ•°
- `ef_construction = 128` - æ„å»ºç´¢å¼•æ—¶çš„æœç´¢æ·±åº¦
- `ef_search = 100` - æŸ¥è¯¢æ—¶çš„æœç´¢æ·±åº¦ï¼ˆå¯é…ç½®ï¼‰

## 3. æ–‡æœ¬åµŒå…¥ (Embedding)

### 3.1 åµŒå…¥ç”Ÿæˆæµç¨‹

#### ç®—æ³•åŠ¨æœº

æ–‡æœ¬å‘é‡åŒ–æ˜¯çŸ¥è¯†åº“æ£€ç´¢çš„åŸºç¡€ã€‚ä¼ ç»Ÿçš„å…³é”®è¯åŒ¹é…æ— æ³•ç†è§£è¯­ä¹‰ï¼Œä¾‹å¦‚ã€Œæ±½è½¦ã€å’Œã€Œè½¦è¾†ã€è™½ç„¶æ„æ€ç›¸è¿‘ï¼Œä½†å­—é¢åŒ¹é…ä¼šè®¤ä¸ºå®ƒä»¬å®Œå…¨ä¸åŒã€‚**å‘é‡åµŒå…¥æŠ€æœ¯**é€šè¿‡å°†æ–‡æœ¬è½¬æ¢ä¸ºé«˜ç»´å‘é‡ï¼ˆå¦‚ 1536 ç»´ï¼‰ï¼Œä½¿å¾—è¯­ä¹‰ç›¸ä¼¼çš„æ–‡æœ¬åœ¨å‘é‡ç©ºé—´ä¸­è·ç¦»æ›´è¿‘ï¼Œä»è€Œå®ç°è¯­ä¹‰æœç´¢ã€‚

#### æ ¸å¿ƒå‡½æ•°è®¾è®¡

```typescript
// æ ¸å¿ƒå‡½æ•°ï¼šå°†æ–‡æœ¬è½¬æ¢ä¸ºå‘é‡è¡¨ç¤º
export async function getVectorsByText({
  model,   // Embedding æ¨¡å‹é…ç½®
  input,   // è¾“å…¥æ–‡æœ¬ï¼ˆå­—ç¬¦ä¸²æˆ–å­—ç¬¦ä¸²æ•°ç»„ï¼‰
  type,    // ä½¿ç”¨åœºæ™¯ï¼š'db'ï¼ˆå­˜å‚¨ï¼‰æˆ– 'query'ï¼ˆæŸ¥è¯¢ï¼‰
  headers  // HTTP è¯·æ±‚å¤´
}: GetVectorProps)
```

**è®¾è®¡è¦ç‚¹**ï¼š
1. **çµæ´»çš„è¾“å…¥**ï¼šæ”¯æŒå•ä¸ªæ–‡æœ¬æˆ–æ‰¹é‡æ–‡æœ¬å¤„ç†
2. **åœºæ™¯åŒ–é…ç½®**ï¼šå­˜å‚¨å’ŒæŸ¥è¯¢ä½¿ç”¨ä¸åŒçš„é…ç½®ä»¥ä¼˜åŒ–æ€§èƒ½
3. **æ‰¹å¤„ç†ä¼˜åŒ–**ï¼šè‡ªåŠ¨åˆ†æ‰¹è°ƒç”¨ APIï¼Œæé«˜æ•ˆç‡
4. **æˆæœ¬è¿½è¸ª**ï¼šè¿”å› Token æ¶ˆè€—ç”¨äºè®¡è´¹ç»Ÿè®¡

#### å®Œæ•´å¤„ç†æµç¨‹

```
ç”¨æˆ·è¾“å…¥æ–‡æœ¬ ("ä»€ä¹ˆæ˜¯å‘é‡æ•°æ®åº“ï¼Ÿ" æˆ– ["text1", "text2", ...])
  â†“
ã€æ­¥éª¤1ã€‘æ ¼å¼åŒ–è¾“å…¥
  ç›®çš„ï¼šç»Ÿä¸€å¤„ç†å•ä¸ªæ–‡æœ¬å’Œæ‰¹é‡æ–‡æœ¬
  æ“ä½œï¼šå°† string è½¬ä¸º [string]
  â†“
ã€æ­¥éª¤2ã€‘æ‰¹é‡åˆ†å— (batchSize)
  ç›®çš„ï¼šæé«˜ API è°ƒç”¨æ•ˆç‡ï¼Œé™ä½æˆæœ¬
  ç¤ºä¾‹ï¼š100ä¸ªæ–‡æœ¬ï¼ŒbatchSize=16 â†’ åˆ†7æ‰¹å¤„ç†
  ä¼˜åŠ¿ï¼šå‡å°‘ç½‘ç»œå¼€é”€ï¼Œæé«˜å¹¶å‘åº¦
  â†“
ã€æ­¥éª¤3ã€‘è°ƒç”¨ Embedding API
  æ”¯æŒçš„ APIï¼š
  - OpenAI API (text-embedding-3-small, ada-002)
  - Azure OpenAI (è‡ªå®šä¹‰éƒ¨ç½²)
  - è‡ªå®šä¹‰ Embedding æœåŠ¡
  
  API è°ƒç”¨ç¤ºä¾‹ï¼š
  POST https://api.openai.com/v1/embeddings
  {
    "model": "text-embedding-3-small",
    "input": ["text1", "text2", ...],
    "dimensions": 1536  // å¯é€‰ï¼šé™ç»´
  }
  â†“
ã€æ­¥éª¤4ã€‘å‘é‡è§„èŒƒåŒ– (å¯é€‰)
  ç›®çš„ï¼šç»Ÿä¸€å‘é‡å°ºåº¦ï¼Œæé«˜ç›¸ä¼¼åº¦è®¡ç®—ç¨³å®šæ€§
  æ–¹æ³•ï¼šL2 å½’ä¸€åŒ–ï¼ˆå°†å‘é‡é•¿åº¦å½’ä¸€åŒ–ä¸º 1ï¼‰
  å…¬å¼ï¼šv' = v / ||v|| å…¶ä¸­ ||v|| = âˆš(vâ‚Â² + vâ‚‚Â² + ... + vâ‚™Â²)
  â†“
ã€æ­¥éª¤5ã€‘å‘é‡ç»´åº¦å¤„ç†
  é—®é¢˜ï¼šä¸åŒæ¨¡å‹è¿”å›ä¸åŒç»´åº¦çš„å‘é‡
  è§£å†³ï¼šç»Ÿä¸€åˆ° 1536 ç»´ï¼ˆæ•°æ®åº“ç´¢å¼•ç»´åº¦ï¼‰
  
  æƒ…å†µA - å‘é‡è¿‡é•¿ (å¦‚ 3072 ç»´)
    æ“ä½œï¼šæˆªæ–­åˆ°å‰ 1536 ç»´
    å‰¯ä½œç”¨ï¼šæŸå¤±éƒ¨åˆ†ä¿¡æ¯
    è¡¥å¿ï¼šå¼ºåˆ¶ L2 å½’ä¸€åŒ–ï¼Œä¿æŒå‘é‡å•ä½é•¿åº¦
    
  æƒ…å†µB - å‘é‡è¿‡çŸ­ (å¦‚ 256 ç»´)
    æ“ä½œï¼šæœ«å°¾è¡¥é›¶åˆ° 1536 ç»´
    ä¼˜åŠ¿ï¼šä¸æ”¹å˜åŸå‘é‡çš„è¯­ä¹‰ä¿¡æ¯
  â†“
ã€æ­¥éª¤6ã€‘è¿”å›ç»“æœ
  è¿”å›å€¼ï¼š
  {
    vectors: number[][],  // å¤„ç†åçš„å‘é‡æ•°ç»„ï¼ˆæ¯ä¸ªå‘é‡ 1536 ç»´ï¼‰
    tokens: number        // æ€» Token æ¶ˆè€—ï¼ˆç”¨äºè®¡è´¹ï¼‰
  }
```

#### ä¸ºä»€ä¹ˆéœ€è¦æ‰¹å¤„ç†ï¼Ÿ

**é—®é¢˜åœºæ™¯**ï¼šçŸ¥è¯†åº“è®­ç»ƒæ—¶éœ€è¦å¤„ç†æˆåƒä¸Šä¸‡æ¡æ–‡æœ¬

**æ–¹æ¡ˆå¯¹æ¯”**ï¼š

```
ã€æ–¹æ¡ˆAã€‘é€æ¡å¤„ç†ï¼ˆä¸æ¨èï¼‰
  for (let i = 0; i < 10000; i++) {
    await embeddings.create({ input: texts[i] });
  }
  
  é—®é¢˜ï¼š
  - 10000 æ¬¡ API è°ƒç”¨
  - ç½‘ç»œå¾€è¿”å»¶è¿Ÿï¼š10000 Ã— 100ms = 1000ç§’
  - API è°ƒç”¨é™åˆ¶ï¼šå¯èƒ½è§¦å‘é¢‘ç‡é™åˆ¶
  
ã€æ–¹æ¡ˆBã€‘æ‰¹é‡å¤„ç†ï¼ˆæ¨èï¼‰
  const batchSize = 16;
  for (let i = 0; i < 10000; i += batchSize) {
    const batch = texts.slice(i, i + batchSize);
    await embeddings.create({ input: batch });
  }
  
  ä¼˜åŠ¿ï¼š
  - 625 æ¬¡ API è°ƒç”¨ï¼ˆå‡å°‘ 94%ï¼‰
  - ç½‘ç»œå»¶è¿Ÿï¼š625 Ã— 100ms = 62.5ç§’ï¼ˆå¿« 16 å€ï¼‰
  - æˆæœ¬ä¼˜åŒ–ï¼šæŸäº› API æ‰¹é‡è°ƒç”¨æœ‰æŠ˜æ‰£
```

#### dbConfig vs queryConfig çš„å·®å¼‚

ä¸åŒçš„ä½¿ç”¨åœºæ™¯å¯¹å‘é‡æœ‰ä¸åŒçš„è¦æ±‚ï¼š

| å¯¹æ¯”é¡¹ | dbConfigï¼ˆå­˜å‚¨é…ç½®ï¼‰ | queryConfigï¼ˆæŸ¥è¯¢é…ç½®ï¼‰ |
|--------|---------------------|------------------------|
| **ä½¿ç”¨åœºæ™¯** | çŸ¥è¯†åº“æ–‡æ¡£å­˜å‚¨åˆ°æ•°æ®åº“ | ç”¨æˆ·æŸ¥è¯¢æ—¶ç”Ÿæˆå‘é‡ |
| **æ€§èƒ½è¦æ±‚** | æ‰¹é‡å¤„ç†ï¼Œååé‡ä¼˜å…ˆ | å®æ—¶å“åº”ï¼Œå»¶è¿Ÿä¼˜å…ˆ |
| **å‘é‡ç»´åº¦** | å¯é™ç»´ï¼ˆå¦‚ 512/1024ï¼‰èŠ‚çœå­˜å‚¨ | å®Œæ•´ç»´åº¦ï¼ˆ1536ï¼‰ä¿è¯ç²¾åº¦ |
| **å½’ä¸€åŒ–** | å¿…é¡»å½’ä¸€åŒ–ï¼ˆç´¢å¼•è¦æ±‚ï¼‰ | å¯é€‰å½’ä¸€åŒ– |
| **å…¸å‹é…ç½®** | { dimensions: 1024, normalization: true } | { dimensions: 1536, normalization: true } |

**å®é™…åº”ç”¨ç¤ºä¾‹**ï¼š

```typescript
// åœºæ™¯1ï¼šå­˜å‚¨ 10000 æ¡æ–‡æ¡£ï¼ˆä½¿ç”¨ dbConfigï¼‰
const { vectors, tokens } = await getVectorsByText({
  model: embeddingModel,
  input: documents,  // 10000 æ¡æ–‡æ¡£
  type: 'db'        // ä½¿ç”¨ dbConfigï¼šå¯èƒ½é™ç»´åˆ° 1024 ç»´ï¼ŒèŠ‚çœ 33% å­˜å‚¨
});
// å­˜å‚¨æˆæœ¬ï¼š1024 ç»´ Ã— 10000 = 10,240,000 ä¸ªæµ®ç‚¹æ•°

// åœºæ™¯2ï¼šç”¨æˆ·æŸ¥è¯¢ï¼ˆä½¿ç”¨ queryConfigï¼‰
const { vectors } = await getVectorsByText({
  model: embeddingModel,
  input: "ä»€ä¹ˆæ˜¯å‘é‡æ•°æ®åº“ï¼Ÿ",
  type: 'query'     // ä½¿ç”¨ queryConfigï¼šå®Œæ•´ 1536 ç»´ï¼Œä¿è¯æ£€ç´¢ç²¾åº¦
});
// æ£€ç´¢ï¼šç”¨ 1536 ç»´å‘é‡ä¸æ•°æ®åº“ä¸­ 1024 ç»´å‘é‡å¯¹æ¯”ï¼ˆéœ€è¦ç»´åº¦å¯¹é½ï¼‰
```

### 3.2 Embedding æ¨¡å‹é…ç½®

**æ¨¡å‹å‚æ•°**:
```typescript
interface EmbeddingModelItemType {
  model: string;              // æ¨¡å‹åç§° (å¦‚ text-embedding-3-small)
  name: string;               // æ˜¾ç¤ºåç§°
  batchSize: number;          // æ‰¹å¤„ç†å¤§å°
  defaultConfig: object;      // é»˜è®¤é…ç½®
  dbConfig?: object;          // æ•°æ®åº“å­˜å‚¨é…ç½®
  queryConfig?: object;       // æŸ¥è¯¢é…ç½®
  normalization: boolean;     // æ˜¯å¦å½’ä¸€åŒ–
  requestUrl?: string;        // è‡ªå®šä¹‰ API åœ°å€
  requestAuth?: string;       // è®¤è¯å¯†é’¥
}
```

**é…ç½®ç±»å‹**:
- `dbConfig` - æ•°æ®åº“å­˜å‚¨æ—¶ä½¿ç”¨ï¼Œä¼˜åŒ–ç´¢å¼•æ€§èƒ½
- `queryConfig` - ç”¨æˆ·æŸ¥è¯¢æ—¶ä½¿ç”¨ï¼Œä¼˜åŒ–æ£€ç´¢å‡†ç¡®ç‡
- `defaultConfig` - é€šç”¨é…ç½®

### 3.3 å‘é‡è§„èŒƒåŒ–

#### ä¸ºä»€ä¹ˆéœ€è¦å½’ä¸€åŒ–ï¼Ÿ

åœ¨å‘é‡æ£€ç´¢ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨**å†…ç§¯ï¼ˆInner Productï¼‰**æˆ–**ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆCosine Similarityï¼‰**æ¥è¡¡é‡ä¸¤ä¸ªå‘é‡çš„ç›¸ä¼¼ç¨‹åº¦ã€‚

**é—®é¢˜åœºæ™¯**ï¼š
```
å‘é‡ A = [1, 2, 3]      å‘é‡é•¿åº¦ ||A|| = âˆš14 â‰ˆ 3.74
å‘é‡ B = [2, 4, 6]      å‘é‡é•¿åº¦ ||B|| = âˆš56 â‰ˆ 7.48

æ³¨æ„ï¼šB = 2Ã—Aï¼Œå®ƒä»¬æ–¹å‘å®Œå…¨ç›¸åŒï¼Œåº”è¯¥æ˜¯ã€Œæœ€ç›¸ä¼¼ã€çš„

ä½†æ˜¯å†…ç§¯ï¼šAÂ·B = 1Ã—2 + 2Ã—4 + 3Ã—6 = 28
å¦‚æœ å‘é‡ C = [1, 2, 3.1]ï¼ŒCÂ·A = 1 + 4 + 9.3 = 14.3

é—®é¢˜ï¼šè™½ç„¶ B å’Œ A æ–¹å‘ç›¸åŒï¼Œä½†å› ä¸º B çš„é•¿åº¦æ›´å¤§ï¼Œ
      æ‰€ä»¥ AÂ·B > AÂ·Cï¼Œè¿™ä¸åˆç†ï¼
```

**è§£å†³æ–¹æ¡ˆ**ï¼šL2 å½’ä¸€åŒ–

å½’ä¸€åŒ–åçš„å‘é‡éƒ½å˜æˆ**å•ä½å‘é‡**ï¼ˆé•¿åº¦ä¸º 1ï¼‰ï¼Œè¿™æ ·å†…ç§¯å°±ç­‰ä»·äºä½™å¼¦ç›¸ä¼¼åº¦ï¼Œåªå…³æ³¨æ–¹å‘ï¼Œä¸å—é•¿åº¦å½±å“ã€‚

#### L2 å½’ä¸€åŒ–ç®—æ³•

```typescript
function normalizationVector(vector: number[]) {
  // æ­¥éª¤1ï¼šè®¡ç®— L2 èŒƒæ•°ï¼ˆæ¬§å‡ é‡Œå¾—é•¿åº¦ï¼‰
  // ||v|| = âˆš(vâ‚Â² + vâ‚‚Â² + ... + vâ‚™Â²)
  const norm = Math.sqrt(vector.reduce((sum, val) => sum + val * val, 0));
  
  // æ­¥éª¤2ï¼šå¤„ç†é›¶å‘é‡ï¼ˆé¿å…é™¤é›¶é”™è¯¯ï¼‰
  if (norm === 0) return vector;
  
  // æ­¥éª¤3ï¼šå½’ä¸€åŒ– v' = v / ||v||
  // ç»“æœï¼š||v'|| = 1ï¼ˆå•ä½å‘é‡ï¼‰
  return vector.map((val) => val / norm);
}
```

**æ•°å­¦åŸç†**ï¼š

1. **L2 èŒƒæ•°è®¡ç®—**ï¼š
   ```
   ||v|| = âˆš(vâ‚Â² + vâ‚‚Â² + ... + vâ‚â‚…â‚ƒâ‚†Â²)
   ```

2. **å½’ä¸€åŒ–å…¬å¼**ï¼š
   ```
   v'áµ¢ = váµ¢ / ||v||  (i = 1, 2, ..., 1536)
   ```

3. **éªŒè¯å•ä½é•¿åº¦**ï¼š
   ```
   ||v'|| = âˆš((vâ‚/||v||)Â² + (vâ‚‚/||v||)Â² + ...)
          = âˆš(vâ‚Â² + vâ‚‚Â² + ...) / ||v||
          = ||v|| / ||v||
          = 1 âœ“
   ```

**å½’ä¸€åŒ–çš„ä¸‰å¤§ä¼˜åŠ¿**ï¼š

1. **æ¶ˆé™¤å‘é‡é•¿åº¦å½±å“**
   ```
   å½’ä¸€åŒ–å‰ï¼š
   A = [1, 2, 3], ||A|| = 3.74
   B = [10, 20, 30], ||B|| = 37.4
   AÂ·B = 140ï¼ˆå—é•¿åº¦å½±å“ï¼‰
   
   å½’ä¸€åŒ–åï¼š
   A' = [0.27, 0.53, 0.80], ||A'|| = 1
   B' = [0.27, 0.53, 0.80], ||B'|| = 1
   A'Â·B' = 1ï¼ˆå®Œç¾ç›¸ä¼¼ï¼Œç¬¦åˆç›´è§‰ï¼‰
   ```

2. **æé«˜æ•°å€¼ç¨³å®šæ€§**
   - é¿å…å‘é‡å€¼è¿‡å¤§å¯¼è‡´çš„æµ®ç‚¹æ•°æº¢å‡º
   - å½’ä¸€åŒ–åæ‰€æœ‰å€¼éƒ½åœ¨ [-1, 1] èŒƒå›´å†…
   - å‡å°‘ç´¯ç§¯è¯¯å·®

3. **ç»Ÿä¸€ä¸åŒæ¨¡å‹çš„å°ºåº¦**
   - æ¨¡å‹ A è¾“å‡ºèŒƒå›´ï¼š[-5, 5]
   - æ¨¡å‹ B è¾“å‡ºèŒƒå›´ï¼š[-100, 100]
   - å½’ä¸€åŒ–åéƒ½åœ¨ [-1, 1]ï¼Œå¯ä»¥æ··åˆä½¿ç”¨

#### ç»´åº¦å¤„ç†ç­–ç•¥

ä¸åŒçš„ Embedding æ¨¡å‹è¿”å›ä¸åŒç»´åº¦çš„å‘é‡ï¼Œä½†å‘é‡æ•°æ®åº“çš„ç´¢å¼•æ˜¯å›ºå®šç»´åº¦ï¼ˆå¦‚ 1536 ç»´ï¼‰ã€‚

```typescript
// æ ¸å¿ƒå‡½æ•°ï¼šç»Ÿä¸€å‘é‡ç»´åº¦åˆ° 1536
function formatVectors(vector: number[]): number[] {
  const targetDim = 1536;  // ç›®æ ‡ç»´åº¦
  
  if (vector.length > targetDim) {
    // ã€æƒ…å†µ1ã€‘å‘é‡è¿‡é•¿ï¼šæˆªæ–­ + å¼ºåˆ¶å½’ä¸€åŒ–
    // ä¸ºä»€ä¹ˆæˆªæ–­åå¿…é¡»å½’ä¸€åŒ–ï¼Ÿè§ä¸‹æ–‡è¯¦è§£
    return normalizationVector(vector.slice(0, targetDim));
    
  } else if (vector.length < targetDim) {
    // ã€æƒ…å†µ2ã€‘å‘é‡è¿‡çŸ­ï¼šé›¶å¡«å……
    const zeroVector = new Array(targetDim - vector.length).fill(0);
    return vector.concat(zeroVector);
    
  } else {
    // ã€æƒ…å†µ3ã€‘ç»´åº¦æ­£å¥½
    return vector;
  }
}
```

#### ä¸ºä»€ä¹ˆæˆªæ–­åå¿…é¡»å½’ä¸€åŒ–ï¼Ÿ

è¿™æ˜¯ä¸€ä¸ªå…³é”®é—®é¢˜ï¼è®©æˆ‘ä»¬é€šè¿‡æ•°å­¦æ¨å¯¼æ¥ç†è§£ï¼š

**é—®é¢˜åœºæ™¯**ï¼šOpenAI çš„ `text-embedding-3-large` å¯ä»¥è¿”å› 3072 ç»´å‘é‡ï¼Œä½†æˆ‘ä»¬çš„æ•°æ®åº“ç´¢å¼•æ˜¯ 1536 ç»´ã€‚

```
åŸå§‹å‘é‡ï¼ˆ3072 ç»´ï¼‰ï¼š
vâ‚ƒâ‚€â‚‡â‚‚ = [vâ‚, vâ‚‚, ..., vâ‚â‚…â‚ƒâ‚†, vâ‚â‚…â‚ƒâ‚‡, ..., vâ‚ƒâ‚€â‚‡â‚‚]

åŸå§‹å‘é‡é•¿åº¦ï¼š
||vâ‚ƒâ‚€â‚‡â‚‚|| = âˆš(vâ‚Â² + vâ‚‚Â² + ... + vâ‚ƒâ‚€â‚‡â‚‚Â²) = L

æˆªæ–­åï¼ˆ1536 ç»´ï¼‰ï¼š
vâ‚â‚…â‚ƒâ‚† = [vâ‚, vâ‚‚, ..., vâ‚â‚…â‚ƒâ‚†]

æˆªæ–­åé•¿åº¦ï¼š
||vâ‚â‚…â‚ƒâ‚†|| = âˆš(vâ‚Â² + vâ‚‚Â² + ... + vâ‚â‚…â‚ƒâ‚†Â²) = L' < L
```

**é—®é¢˜**ï¼šæˆªæ–­å¯¼è‡´å‘é‡é•¿åº¦å˜çŸ­ï¼ˆL' < Lï¼‰ï¼Œè¿™ä¼šå½±å“ç›¸ä¼¼åº¦è®¡ç®—ï¼

**æ•°å€¼ç¤ºä¾‹**ï¼š
```
å‡è®¾åŸå§‹å‘é‡ï¼ˆç®€åŒ–ä¸º 4 ç»´ï¼‰ï¼š
v_full = [3, 4, 5, 6]
||v_full|| = âˆš(9 + 16 + 25 + 36) = âˆš86 â‰ˆ 9.27

æˆªæ–­åˆ° 2 ç»´ï¼š
v_trunc = [3, 4]
||v_trunc|| = âˆš(9 + 16) = âˆš25 = 5

é•¿åº¦å˜åŒ–ï¼š5 / 9.27 â‰ˆ 0.54ï¼ˆæŸå¤± 46% çš„é•¿åº¦ï¼‰

å¦‚æœä¸¤ä¸ªæ–‡æ¡£éƒ½è¢«æˆªæ–­ï¼š
æ–‡æ¡£Aï¼š||A_full|| = 9.27 â†’ ||A_trunc|| = 5
æ–‡æ¡£Bï¼š||B_full|| = 12.5 â†’ ||B_trunc|| = 8  ï¼ˆæˆªæ–­æŸå¤±æ›´å¤šï¼‰

å†…ç§¯è®¡ç®—ï¼š
A_trunc Â· B_trunc = ä¸å†å‡†ç¡®åæ˜ åŸå§‹ç›¸ä¼¼åº¦ï¼
```

**è§£å†³æ–¹æ¡ˆ**ï¼šæˆªæ–­åå¼ºåˆ¶å½’ä¸€åŒ–

```typescript
// æˆªæ–­åå½’ä¸€åŒ–ï¼Œä½¿æ‰€æœ‰å‘é‡é•¿åº¦éƒ½ä¸º 1
const truncated = vector.slice(0, 1536);
const normalized = normalizationVector(truncated);

// ç°åœ¨æ‰€æœ‰å‘é‡é•¿åº¦ç»Ÿä¸€ï¼š||normalized|| = 1
// å†…ç§¯å°±ç­‰äºä½™å¼¦ç›¸ä¼¼åº¦ï¼Œåªå…³æ³¨æ–¹å‘ï¼Œä¸å—æˆªæ–­å½±å“
```

**ä¸ºä»€ä¹ˆé›¶å¡«å……ä¸éœ€è¦å¼ºåˆ¶å½’ä¸€åŒ–ï¼Ÿ**

```
åŸå§‹å‘é‡ï¼ˆ256 ç»´ï¼‰ï¼š
vâ‚‚â‚…â‚† = [vâ‚, vâ‚‚, ..., vâ‚‚â‚…â‚†]
||vâ‚‚â‚…â‚†|| = âˆš(vâ‚Â² + vâ‚‚Â² + ... + vâ‚‚â‚…â‚†Â²) = L

é›¶å¡«å……åï¼ˆ1536 ç»´ï¼‰ï¼š
vâ‚â‚…â‚ƒâ‚† = [vâ‚, vâ‚‚, ..., vâ‚‚â‚…â‚†, 0, 0, ..., 0]
||vâ‚â‚…â‚ƒâ‚†|| = âˆš(vâ‚Â² + vâ‚‚Â² + ... + vâ‚‚â‚…â‚†Â² + 0Â² + ... + 0Â²)
          = âˆš(vâ‚Â² + vâ‚‚Â² + ... + vâ‚‚â‚…â‚†Â²)
          = L  ï¼ˆé•¿åº¦ä¸å˜ï¼ï¼‰

ç»“è®ºï¼šé›¶å¡«å……ä¸æ”¹å˜å‘é‡é•¿åº¦ï¼Œä¸éœ€è¦å¼ºåˆ¶å½’ä¸€åŒ–
```

**å®é™…åº”ç”¨ç¤ºä¾‹**ï¼š

```typescript
// ç¤ºä¾‹1ï¼šé«˜ç»´å‘é‡æˆªæ–­
const vector3072 = Array(3072).fill(0.01);  // æ¨¡æ‹Ÿ 3072 ç»´å‘é‡
console.log('åŸå§‹é•¿åº¦:', Math.sqrt(3072 * 0.01 * 0.01));  // â‰ˆ 0.554

const truncated = vector3072.slice(0, 1536);
console.log('æˆªæ–­åé•¿åº¦:', Math.sqrt(1536 * 0.01 * 0.01));  // â‰ˆ 0.392

const normalized = normalizationVector(truncated);
console.log('å½’ä¸€åŒ–åé•¿åº¦:', 1.0);  // ç²¾ç¡®ç­‰äº 1

// ç¤ºä¾‹2ï¼šä½ç»´å‘é‡å¡«å……
const vector256 = Array(256).fill(0.01);
console.log('åŸå§‹é•¿åº¦:', Math.sqrt(256 * 0.01 * 0.01));  // â‰ˆ 0.16

const padded = vector256.concat(Array(1280).fill(0));
console.log('å¡«å……åé•¿åº¦:', Math.sqrt(256 * 0.01 * 0.01));  // è¿˜æ˜¯ 0.16
```

### 3.4 æ‰¹é‡å¤„ç†

```typescript
// æ‰¹é‡åµŒå…¥
const chunkSize = Number(model.batchSize || 1);
const chunks = [];

for (let i = 0; i < formatInput.length; i += chunkSize) {
  chunks.push(formatInput.slice(i, i + chunkSize));
}

// é¡ºåºå¤„ç†æ¯ä¸ªæ‰¹æ¬¡
for (const chunk of chunks) {
  const result = await ai.embeddings.create({
    model: model.model,
    input: chunk
  });
  
  totalTokens += result.tokens;
  allVectors.push(...result.vectors);
}
```

**æ‰¹å¤„ç†ä¼˜åŠ¿**:
- ğŸš€ æé«˜ API è°ƒç”¨æ•ˆç‡
- ğŸ’° å‡å°‘è¯·æ±‚æ¬¡æ•°ï¼Œé™ä½æˆæœ¬
- âš¡ å¹¶å‘å¤„ç†æå‡é€Ÿåº¦

## 4. å‘é‡å­˜å‚¨

### 4.1 æ•°æ®ç»“æ„

**PostgreSQL + PGVector**:
```sql
CREATE EXTENSION IF NOT EXISTS vector;

CREATE TABLE dataset_data_vector (
  id BIGSERIAL PRIMARY KEY,
  vector VECTOR(1536) NOT NULL,        -- 1536 ç»´å‘é‡
  team_id VARCHAR(50) NOT NULL,        -- å›¢é˜Ÿ ID
  dataset_id VARCHAR(50) NOT NULL,     -- çŸ¥è¯†åº“ ID
  collection_id VARCHAR(50) NOT NULL   -- é›†åˆ ID
);

-- HNSW ç´¢å¼• (å†…ç§¯è·ç¦»)
CREATE INDEX vector_index ON dataset_data_vector 
USING hnsw (vector vector_ip_ops) 
WITH (m = 32, ef_construction = 128);

-- è¿‡æ»¤ç´¢å¼•
CREATE INDEX team_dataset_index ON dataset_data_vector(team_id, dataset_id);
CREATE INDEX collection_index ON dataset_data_vector(collection_id);
```

### 4.2 å‘é‡æ’å…¥

```typescript
export const insertDatasetDataVector = async ({
  model,
  inputs,
  teamId,
  datasetId,
  collectionId
}: InsertVectorProps) => {
  // 1. ç”Ÿæˆå‘é‡
  const { vectors, tokens } = await getVectorsByText({
    model,
    input: inputs,
    type: 'db'  // ä½¿ç”¨ dbConfig
  });
  
  // 2. æ’å…¥å‘é‡æ•°æ®åº“
  const { insertIds } = await Vector.insert({
    teamId,
    datasetId,
    collectionId,
    vectors
  });
  
  // 3. æ›´æ–°å›¢é˜Ÿå‘é‡è®¡æ•°ç¼“å­˜
  teamVectorCache.incr(teamId, insertIds.length);
  
  return { tokens, insertIds };
};
```

### 4.3 ç¼“å­˜æœºåˆ¶

```typescript
const teamVectorCache = {
  getKey: (teamId: string) => `team_vector_count:${teamId}`,
  
  // è·å–å›¢é˜Ÿå‘é‡æ•°
  get: async (teamId: string) => {
    const cache = await getRedisCache(teamVectorCache.getKey(teamId));
    if (cache) return Number(cache);
    
    const count = await getVectorCountByTeamId(teamId);
    await teamVectorCache.set({ teamId, count });
    return count;
  },
  
  // è®¾ç½®ç¼“å­˜ (30åˆ†é’Ÿ)
  set: ({ teamId, count }) => {
    setRedisCache(
      teamVectorCache.getKey(teamId), 
      count, 
      1800  // 30 * 60
    );
  },
  
  // å¢é‡æ›´æ–°
  incr: (teamId: string, num: number) => {
    teamVectorCache.get(teamId).then((count) => {
      teamVectorCache.set({ teamId, count: count + num });
    });
  }
};
```

## 5. æ··åˆæ£€ç´¢ (Hybrid Retrieval)

### 5.1 æ£€ç´¢æ¨¡å¼

```typescript
enum DatasetSearchModeEnum {
  embedding = 'embedding',          // çº¯å‘é‡æ£€ç´¢
  fullTextRecall = 'fullTextRecall', // çº¯å…¨æ–‡æ£€ç´¢
  mixedRecall = 'mixedRecall'       // æ··åˆæ£€ç´¢
}
```

#### æ¨¡å¼å¯¹æ¯”

| æ¨¡å¼ | å‘é‡å¬å› | å…¨æ–‡å¬å› | é€‚ç”¨åœºæ™¯ |
|------|---------|---------|---------|
| **embedding** | 100æ¡ | 0æ¡ | è¯­ä¹‰ç›¸ä¼¼æœç´¢ |
| **fullTextRecall** | 0æ¡ | 100æ¡ | å…³é”®è¯ç²¾ç¡®åŒ¹é… |
| **mixedRecall** | 80æ¡ | 60æ¡ | æ··åˆæœç´¢ (æ¨è) |

### 5.2 å‘é‡å¬å› (Embedding Recall)

```typescript
const embeddingRecall = async ({
  queries,      // æŸ¥è¯¢æ–‡æœ¬åˆ—è¡¨
  limit,        // å¬å›æ•°é‡
  forbidCollectionIdList,   // ç¦ç”¨é›†åˆåˆ—è¡¨
  filterCollectionIdList    // ç­›é€‰é›†åˆåˆ—è¡¨
}) => {
  // 1. ç”ŸæˆæŸ¥è¯¢å‘é‡
  const { vectors, tokens } = await getVectorsByText({
    model: getEmbeddingModel(model),
    input: queries,
    type: 'query'  // ä½¿ç”¨ queryConfig
  });
  
  // 2. å¤šæŸ¥è¯¢å¹¶è¡Œå¬å›
  const recallResults = await Promise.all(
    vectors.map(async (vector) => {
      return await recallFromVectorStore({
        teamId,
        datasetIds,
        vector,
        limit,
        forbidCollectionIdList,
        filterCollectionIdList
      });
    })
  );
  
  // 3. èšåˆç»“æœ (å»é‡ + å–æœ€é«˜æ’å)
  const embeddingRecallResults = recallResults.map((item) => {
    const set = new Set<string>();
    return item.results
      .map((item, index) => ({
        id: String(data._id),
        q: data.q,
        a: data.a,
        collectionId: String(data.collectionId),
        score: [{ 
          type: SearchScoreTypeEnum.embedding, 
          value: item.score, 
          index 
        }]
      }))
      .filter((item) => {
        if (set.has(item.id)) return false;
        set.add(item.id);
        return true;
      });
  });
  
  return { embeddingRecallResults, tokens };
};
```

#### PostgreSQL HNSW æŸ¥è¯¢

```sql
BEGIN;
  -- è®¾ç½® HNSW å‚æ•°
  SET LOCAL hnsw.ef_search = 100;
  SET LOCAL hnsw.max_scan_tuples = 100000;
  SET LOCAL hnsw.iterative_scan = relaxed_order;
  
  -- å‘é‡ç›¸ä¼¼åº¦æœç´¢ (å†…ç§¯è·ç¦»)
  WITH relaxed_results AS MATERIALIZED (
    SELECT id, collection_id, vector <#> '[å‘é‡æ•°æ®]' AS score
    FROM dataset_data_vector
    WHERE dataset_id IN ('id1', 'id2', ...)
      AND collection_id IN (ç­›é€‰åˆ—è¡¨)
      AND collection_id NOT IN (ç¦ç”¨åˆ—è¡¨)
    ORDER BY score 
    LIMIT 80
  ) 
  SELECT id, collection_id, score 
  FROM relaxed_results 
  ORDER BY score;
COMMIT;
```

**è·ç¦»ç®—å­**:
- `<#>` - è´Ÿå†…ç§¯ (ç”¨äºæœ€å¤§åŒ–å†…ç§¯)
- `<->` - L2 è·ç¦»
- `<=>` - ä½™å¼¦è·ç¦»

### 5.3 å…¨æ–‡å¬å› (Full-Text Recall)

```typescript
const fullTextRecall = async ({
  queries,
  limit,
  filterCollectionIdList,
  forbidCollectionIdList
}) => {
  const recallResults = await Promise.all(
    queries.map(async (query) => {
      // MongoDB å…¨æ–‡æ£€ç´¢
      return await MongoDatasetDataText.aggregate([
        {
          $match: {
            teamId: new Types.ObjectId(teamId),
            $text: { 
              $search: await jiebaSplit({ text: query })  // åˆ†è¯
            },
            datasetId: { $in: datasetIds },
            // é›†åˆè¿‡æ»¤
            ...(filterCollectionIdList 
              ? { collectionId: { $in: filterCollectionIdList } }
              : forbidCollectionIdList.length
                ? { collectionId: { $nin: forbidCollectionIdList } }
                : {})
          }
        },
        {
          $sort: { score: { $meta: 'textScore' } }  // æ–‡æœ¬è¯„åˆ†æ’åº
        },
        {
          $limit: limit
        },
        {
          $project: {
            _id: 1,
            collectionId: 1,
            dataId: 1,
            score: { $meta: 'textScore' }
          }
        }
      ]);
    })
  );
  
  return { fullTextRecallResults };
};
```

**MongoDB æ–‡æœ¬ç´¢å¼•**:
```javascript
DatasetDataTextSchema.index({ 
  text: 'text'  // å…¨æ–‡ç´¢å¼•
});
```

**ä¸­æ–‡åˆ†è¯**:
- ä½¿ç”¨ `jieba` åˆ†è¯åº“
- æå–å…³é”®è¯
- æ”¯æŒåŒä¹‰è¯æ‰©å±•

### 5.4 RRF èåˆ (Reciprocal Rank Fusion)

#### ç®—æ³•åŠ¨æœºï¼šä¸ºä»€ä¹ˆéœ€è¦ RRFï¼Ÿ

åœ¨æ··åˆæ£€ç´¢ä¸­ï¼Œæˆ‘ä»¬åŒæ—¶è·å¾—äº†ä¸¤ä¸ªæ£€ç´¢ç»“æœåˆ—è¡¨ï¼š
- **å‘é‡æ£€ç´¢**ï¼šè¿”å›è¯­ä¹‰ç›¸ä¼¼çš„æ–‡æ¡£ï¼Œåˆ†æ•°èŒƒå›´ 0-1
- **å…¨æ–‡æ£€ç´¢**ï¼šè¿”å›å…³é”®è¯åŒ¹é…çš„æ–‡æ¡£ï¼Œåˆ†æ•°èŒƒå›´ä¸å›ºå®š

**å¦‚ä½•åˆå¹¶è¿™ä¸¤ä¸ªåˆ—è¡¨ï¼Ÿ**

```
ã€æ–¹æ¡ˆAã€‘ç›´æ¥æŒ‰åˆ†æ•°åŠ æƒèåˆï¼ˆä¸å¯è¡Œï¼‰
  å‘é‡æ£€ç´¢ï¼š{ "doc1": 0.95, "doc2": 0.89 }
  å…¨æ–‡æ£€ç´¢ï¼š{ "doc2": 28.5, "doc3": 22.3 }
  
  åŠ æƒï¼š0.6 Ã— 0.95 + 0.4 Ã— 28.5 = 11.97 ???
  
  é—®é¢˜ï¼šä¸¤ä¸ªåˆ†æ•°ç³»ç»Ÿå®Œå…¨ä¸åŒï¼Œæ— æ³•ç›´æ¥ç›¸åŠ ï¼

ã€æ–¹æ¡ˆBã€‘å…ˆå½’ä¸€åŒ–å†åŠ æƒï¼ˆä¹Ÿæœ‰é—®é¢˜ï¼‰
  å½’ä¸€åŒ–åˆ° [0,1]ï¼š
    å‘é‡ï¼š{ "doc1": 1.0, "doc2": 0.94 }
    å…¨æ–‡ï¼š{ "doc2": 1.0, "doc3": 0.78 }
  
  é—®é¢˜ï¼šå½’ä¸€åŒ–ä¼šæ”¹å˜åˆ†æ•°åˆ†å¸ƒï¼Œå¯èƒ½æŸå¤±ä¿¡æ¯

ã€æ–¹æ¡ˆCã€‘RRF - åŸºäºæ’åèåˆï¼ˆæœ€ä½³ï¼‰
  åªä½¿ç”¨æ’åä¿¡æ¯ï¼Œä¸å…³å¿ƒå…·ä½“åˆ†æ•°ï¼
```

#### RRF ç®—æ³•åŸç†

RRF çš„æ ¸å¿ƒæ€æƒ³ï¼š**æ’åè¶Šé å‰çš„æ–‡æ¡£ï¼Œé‡è¦æ€§è¶Šé«˜**ã€‚ä½¿ç”¨**æ’åçš„å€’æ•°**ä½œä¸ºèåˆåˆ†æ•°ã€‚

**RRF å…¬å¼**:
```
RRF_score(d) = Î£ (weight_i / (k + rank_i(d)))
             i=1...n

å…¶ä¸­ï¼š
- d: æ–‡æ¡£
- n: æ£€ç´¢åˆ—è¡¨æ•°é‡ï¼ˆå¦‚ 2ï¼šå‘é‡ + å…¨æ–‡ï¼‰
- weight_i: ç¬¬ i ä¸ªåˆ—è¡¨çš„æƒé‡
- rank_i(d): æ–‡æ¡£ d åœ¨ç¬¬ i ä¸ªåˆ—è¡¨ä¸­çš„æ’åï¼ˆä» 1 å¼€å§‹ï¼‰
- k: å¹³æ»‘å¸¸æ•°ï¼Œé€šå¸¸ä¸º 60
```

#### ä¸ºä»€ä¹ˆä½¿ç”¨å€’æ•° 1/rankï¼Ÿ

å€’æ•°å‡½æ•°å…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š

```
æ’åä¸åˆ†æ•°å¯¹åº”å…³ç³»ï¼ˆk=60ï¼‰ï¼š
æ’å 1:  score = 1/(60+1)  = 1/61  â‰ˆ 0.0164  â­ æœ€é«˜
æ’å 2:  score = 1/(60+2)  = 1/62  â‰ˆ 0.0161
æ’å 3:  score = 1/(60+3)  = 1/63  â‰ˆ 0.0159
æ’å 10: score = 1/(60+10) = 1/70  â‰ˆ 0.0143
æ’å 50: score = 1/(60+50) = 1/110 â‰ˆ 0.0091
æ’å 100:score = 1/(60+100)= 1/160 â‰ˆ 0.0063

è§‚å¯Ÿï¼š
1. æ’åé å‰çš„æ–‡æ¡£åˆ†æ•°æ›´é«˜
2. åˆ†æ•°é€’å‡é€Ÿåº¦é€æ¸æ”¾ç¼“ï¼ˆéçº¿æ€§ï¼‰
3. å‰å‡ åçš„åˆ†æ•°å·®è·æ˜æ˜¾ï¼Œåé¢çš„å·®è·ç¼©å°
```

**ä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨æ’åï¼Ÿ**

å¦‚æœç›´æ¥ä½¿ç”¨æ’åï¼š`score = rank`ï¼Œé‚£ä¹ˆæ’å 1 å’Œæ’å 100 çš„åˆ†æ•°ç›¸å·®è¿‡å¤§ï¼Œ
åé¢çš„æ–‡æ¡£å‡ ä¹æ²¡æœ‰æœºä¼šè¢«é€‰ä¸­ã€‚

#### å‚æ•° k çš„ä½œç”¨

```
k å€¼å½±å“ï¼š

k = 0ï¼š
  rank 1: 1/1 = 1.000
  rank 2: 1/2 = 0.500  ï¼ˆåˆ†æ•°éª¤é™ 50%ï¼‰
  rank 10:1/10= 0.100
  é—®é¢˜ï¼šæ’åç¬¬1çš„æ–‡æ¡£ä¼˜åŠ¿è¿‡å¤§ï¼Œå…¶ä»–æ–‡æ¡£å‡ ä¹æ— æ³•ç«äº‰

k = 60ï¼ˆæ¨èï¼‰ï¼š
  rank 1: 1/61 = 0.0164
  rank 2: 1/62 = 0.0161  ï¼ˆåˆ†æ•°éª¤é™ 2%ï¼‰
  rank 10:1/70 = 0.0143
  
  ä¼˜åŠ¿ï¼šå¹³æ»‘çš„åˆ†æ•°é€’å‡ï¼Œå‰ 10 åéƒ½æœ‰ç«äº‰åŠ›

k = 1000ï¼š
  rank 1: 1/1001 = 0.001
  rank 2: 1/1002 = 0.001  ï¼ˆå‡ ä¹æ— å·®åˆ«ï¼‰
  é—®é¢˜ï¼šæ‰€æœ‰æ–‡æ¡£åˆ†æ•°è¶‹äºå¹³å‡ï¼Œä¸¢å¤±æ’åä¿¡æ¯
```

**k = 60 çš„ç»éªŒå€¼æ¥æº**ï¼šåŸºäºå¤§é‡å®éªŒï¼Œåœ¨å¤šæ•°æ£€ç´¢åœºæ™¯ä¸‹è¡¨ç°è‰¯å¥½ã€‚

#### RRF å®é™…åº”ç”¨ç¤ºä¾‹

```typescript
// FastGPT ä¸­çš„ RRF èåˆ
const rrfSearchResult = datasetSearchResultConcat([
  { weight: embeddingWeight, list: embeddingRecallResults },  // å‘é‡æ£€ç´¢ç»“æœ
  { weight: 1 - embeddingWeight, list: fullTextRecallResults } // å…¨æ–‡æ£€ç´¢ç»“æœ
]);
```

**å®Œæ•´è®¡ç®—ç¤ºä¾‹**ï¼š

```
åœºæ™¯ï¼šç”¨æˆ·æŸ¥è¯¢ã€Œå‘é‡æ•°æ®åº“çš„åº”ç”¨ã€

ã€æ­¥éª¤1ã€‘å‘é‡æ£€ç´¢ç»“æœï¼ˆæƒé‡ 0.6ï¼‰
  rank 1: doc_A  (score: 0.95)
  rank 2: doc_B  (score: 0.89)
  rank 3: doc_C  (score: 0.85)
  rank 4: doc_D  (score: 0.80)

ã€æ­¥éª¤2ã€‘å…¨æ–‡æ£€ç´¢ç»“æœï¼ˆæƒé‡ 0.4ï¼‰
  rank 1: doc_B  (score: 28.5)
  rank 2: doc_D  (score: 22.3)
  rank 3: doc_A  (score: 18.7)
  rank 4: doc_E  (score: 15.2)

ã€æ­¥éª¤3ã€‘RRF åˆ†æ•°è®¡ç®—ï¼ˆk=60ï¼‰

doc_A:
  å‘é‡æ£€ç´¢: weight=0.6, rank=1
  å…¨æ–‡æ£€ç´¢: weight=0.4, rank=3
  RRF = 0.6/(60+1) + 0.4/(60+3)
      = 0.6/61 + 0.4/63
      = 0.00984 + 0.00635
      = 0.01619

doc_B:
  å‘é‡æ£€ç´¢: weight=0.6, rank=2
  å…¨æ–‡æ£€ç´¢: weight=0.4, rank=1
  RRF = 0.6/(60+2) + 0.4/(60+1)
      = 0.6/62 + 0.4/61
      = 0.00968 + 0.00656
      = 0.01624  â­ æœ€é«˜ï¼

doc_C:
  å‘é‡æ£€ç´¢: weight=0.6, rank=3
  å…¨æ–‡æ£€ç´¢: æœªå‡ºç° (rank=âˆ, è´¡çŒ®=0)
  RRF = 0.6/(60+3) + 0
      = 0.00952

doc_D:
  å‘é‡æ£€ç´¢: weight=0.6, rank=4
  å…¨æ–‡æ£€ç´¢: weight=0.4, rank=2
  RRF = 0.6/(60+4) + 0.4/(60+2)
      = 0.6/64 + 0.4/62
      = 0.00938 + 0.00645
      = 0.01583

doc_E:
  å‘é‡æ£€ç´¢: æœªå‡ºç°
  å…¨æ–‡æ£€ç´¢: weight=0.4, rank=4
  RRF = 0 + 0.4/(60+4)
      = 0.00625

ã€æ­¥éª¤4ã€‘æœ€ç»ˆæ’åº
  1. doc_B (0.01624) â† åœ¨ä¸¤ä¸ªåˆ—è¡¨ä¸­éƒ½æ’åé å‰
  2. doc_A (0.01619) â† å‘é‡æ£€ç´¢ç¬¬1ï¼Œå…¨æ–‡æ£€ç´¢ç¬¬3
  3. doc_D (0.01583) â† ä¸¤ä¸ªåˆ—è¡¨ä¸­éƒ½ä¸­ç­‰
  4. doc_C (0.00952) â† åªåœ¨å‘é‡æ£€ç´¢ä¸­
  5. doc_E (0.00625) â† åªåœ¨å…¨æ–‡æ£€ç´¢ä¸­
```

**å…³é”®è§‚å¯Ÿ**ï¼š
1. **doc_B æœ€ç»ˆæ’ç¬¬ä¸€**ï¼šè™½ç„¶åœ¨å‘é‡æ£€ç´¢ä¸­æ’ç¬¬2ï¼Œä½†åœ¨å…¨æ–‡æ£€ç´¢ä¸­æ’ç¬¬1ï¼Œç»¼åˆè¡¨ç°æœ€å¥½
2. **doc_A æ’ç¬¬äºŒ**ï¼šè™½ç„¶å‘é‡æ£€ç´¢ç¬¬1ï¼Œä½†å…¨æ–‡æ£€ç´¢ç¬¬3ï¼Œç•¥ä½äº doc_B
3. **doc_C å’Œ doc_E**ï¼šåªåœ¨ä¸€ä¸ªåˆ—è¡¨ä¸­å‡ºç°ï¼Œåˆ†æ•°è¾ƒä½

è¿™å±•ç¤ºäº† RRF çš„èåˆæ•ˆæœï¼š**ç»¼åˆè€ƒè™‘å¤šä¸ªæ’åºç»“æœï¼Œé¿å…å•ä¸€æ£€ç´¢çš„åè§**ã€‚

#### æƒé‡è°ƒä¼˜ç­–ç•¥

```typescript
// FastGPT ä¸­å¯é…ç½® embeddingWeight

embeddingWeight = 0.8  // åå‘å‘é‡æ£€ç´¢ï¼ˆ80% vs 20%ï¼‰
é€‚ç”¨åœºæ™¯ï¼šè¯­ä¹‰ç›¸ä¼¼åº¦é‡è¦ï¼Œå¦‚é—®ç­”åŒ¹é…ã€ç›¸ä¼¼æ–‡æ¡£æ¨è

embeddingWeight = 0.5  // å‡è¡¡æ¨¡å¼ï¼ˆ50% vs 50%ï¼‰
é€‚ç”¨åœºæ™¯ï¼šé€šç”¨æ£€ç´¢ï¼Œå…¼é¡¾è¯­ä¹‰å’Œå…³é”®è¯åŒ¹é…

embeddingWeight = 0.3  // åå‘å…¨æ–‡æ£€ç´¢ï¼ˆ30% vs 70%ï¼‰
é€‚ç”¨åœºæ™¯ï¼šå…³é”®è¯ç²¾ç¡®åŒ¹é…é‡è¦ï¼Œå¦‚ä»£ç æœç´¢ã€ä¸“ä¸šæœ¯è¯­æŸ¥æ‰¾
```

#### RRF vs ç®€å•åˆå¹¶å¯¹æ¯”

| æ–¹æ³• | ä¼˜åŠ¿ | åŠ£åŠ¿ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| **å–å¹¶é›†** | ç®€å•å¿«é€Ÿ | ä¸¢å¤±æ’åºä¿¡æ¯ | åªéœ€è¦†ç›–ç‡ï¼Œä¸å…³å¿ƒæ’åº |
| **å–äº¤é›†** | ç²¾ç¡®åº¦é«˜ | å¬å›ç‡ä½ | ä¸¥æ ¼çš„å¤šæ¡ä»¶è¿‡æ»¤ |
| **åˆ†æ•°åŠ æƒ** | ä¿ç•™åˆ†æ•°ä¿¡æ¯ | åˆ†æ•°å°ºåº¦ä¸ä¸€è‡´ | åŒä¸€ç³»ç»Ÿçš„åˆ†æ•°èåˆ |
| **RRF** | ä¸ä¾èµ–åˆ†æ•°å°ºåº¦ | ä¸¢å¤±åˆ†æ•°ç»å¯¹å€¼ | å¤šæºå¼‚æ„æ£€ç´¢èåˆ â­ |

**RRF çš„æ ¸å¿ƒä¼˜åŠ¿**ï¼šåœ¨ä¸éœ€è¦åˆ†æ•°å½’ä¸€åŒ–ã€ä¸ä¾èµ–å…·ä½“åˆ†æ•°å€¼çš„æƒ…å†µä¸‹ï¼Œå®ç°æœ‰æ•ˆçš„å¤šæºèåˆ

å…¶ä¸­:
- d: æ–‡æ¡£
- weight_i: ç¬¬ i ä¸ªå¬å›åˆ—è¡¨çš„æƒé‡
- rank_i(d): æ–‡æ¡£ d åœ¨ç¬¬ i ä¸ªåˆ—è¡¨çš„æ’å
- k: å¸¸æ•° (é»˜è®¤ 60)


**æƒé‡é…ç½®**:
```typescript
// æ··åˆæ£€ç´¢é»˜è®¤æƒé‡
embeddingWeight = 0.5  // å‘é‡å¬å›æƒé‡
fullTextWeight = 0.5   // å…¨æ–‡å¬å›æƒé‡ (1 - embeddingWeight)
```

## 6. ReRank é‡æ’åº

### 6.1 ReRank æµç¨‹

```typescript
const reRankResults = await datasetDataReRank({
  rerankModel,        // ReRank æ¨¡å‹
  query: reRankQuery, // åŸå§‹æŸ¥è¯¢
  data: filterSameDataResults  // å»é‡åçš„å¬å›ç»“æœ
});
```

**é‡æ’åºè¿‡ç¨‹**:
```
å¬å›ç»“æœ (Recall Results)
  â†“
å»é‡ (Deduplication)
  â†“
ReRank æ¨¡å‹è¯„åˆ†
  â†“
é‡æ–°æ’åº
  â†“
èåˆ RRF å’Œ ReRank åˆ†æ•°
```

### 6.2 ReRank èåˆ

```typescript
const rrfConcatResults = (() => {
  if (reRankResults.length === 0) return rrfSearchResult;
  if (rerankWeight === 1) return reRankResults;
  
  // èåˆ RRF å’Œ ReRank åˆ†æ•°
  return datasetSearchResultConcat([
    { weight: 1 - rerankWeight, list: rrfSearchResult },
    { weight: rerankWeight, list: reRankResults }
  ]);
})();
```

**æƒé‡é…ç½®**:
```typescript
rerankWeight = 0.5  // ReRank æƒé‡ (å¯è°ƒ)
```

## 7. ç›¸ä¼¼åº¦è¿‡æ»¤

### 7.1 è¿‡æ»¤ç­–ç•¥

```typescript
const scoreFilter = (() => {
  if (usingReRank) {
    // ReRank åˆ†æ•°è¿‡æ»¤
    return filterSameDataResults.filter((item) => {
      const reRankScore = item.score.find(
        (s) => s.type === SearchScoreTypeEnum.reRank
      );
      return reRankScore && reRankScore.value >= similarity;
    });
  }
  
  if (searchMode === DatasetSearchModeEnum.embedding) {
    // å‘é‡ç›¸ä¼¼åº¦è¿‡æ»¤
    return filterSameDataResults.filter((item) => {
      const embeddingScore = item.score.find(
        (s) => s.type === SearchScoreTypeEnum.embedding
      );
      return embeddingScore && embeddingScore.value >= similarity;
    });
  }
  
  return filterSameDataResults;
})();
```

### 7.2 åˆ†æ•°ç±»å‹

```typescript
enum SearchScoreTypeEnum {
  embedding = 'embedding',  // å‘é‡ç›¸ä¼¼åº¦åˆ†æ•° (0-1)
  fullText = 'fullText',    // å…¨æ–‡æ£€ç´¢åˆ†æ•°
  reRank = 'reRank'         // ReRank åˆ†æ•° (0-1)
}
```

**åˆ†æ•°èŒƒå›´**:
- **å‘é‡ç›¸ä¼¼åº¦**: 0 ~ 1 (å†…ç§¯å½’ä¸€åŒ–å)
- **å…¨æ–‡æ£€ç´¢åˆ†æ•°**: MongoDB textScore (åŠ¨æ€èŒƒå›´)
- **ReRank åˆ†æ•°**: 0 ~ 1

## 8. Token é™åˆ¶

```typescript
const filterMaxTokensResult = await filterDatasetDataByMaxTokens(
  scoreFilter, 
  maxTokens  // æœ€å¤§ Token é™åˆ¶
);
```

**Token è®¡ç®—**:
```typescript
// ç´¯è®¡ Tokenï¼Œç›´åˆ°è¶…è¿‡é™åˆ¶
let totalTokens = 0;
const result = [];

for (const item of sortedData) {
  const tokens = countPromptTokens(item.q + item.a);
  
  if (totalTokens + tokens <= maxTokens) {
    result.push(item);
    totalTokens += tokens;
  } else {
    break;
  }
}

return result;
```

## 9. æŸ¥è¯¢æ‰©å±• (Query Extension)

### 9.1 ä¸ºä»€ä¹ˆéœ€è¦æŸ¥è¯¢æ‰©å±•ï¼Ÿ

#### ç”¨æˆ·æŸ¥è¯¢çš„å±€é™æ€§

åœ¨å®é™…åº”ç”¨ä¸­ï¼Œç”¨æˆ·çš„æŸ¥è¯¢å¾€å¾€**ç®€çŸ­ã€æ¨¡ç³Šã€ä¸å®Œæ•´**ï¼Œè¿™ä¼šå¯¼è‡´æ£€ç´¢æ•ˆæœä¸ä½³ï¼š

**é—®é¢˜åœºæ™¯ç¤ºä¾‹**ï¼š
```
ç”¨æˆ·è¾“å…¥ï¼š"å‘é‡æ•°æ®åº“"
  
æ½œåœ¨éœ€æ±‚å¯èƒ½æ˜¯ï¼š
  - "å‘é‡æ•°æ®åº“çš„å®šä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ"
  - "å‘é‡æ•°æ®åº“æœ‰å“ªäº›åº”ç”¨åœºæ™¯ï¼Ÿ"
  - "å¦‚ä½•é€‰æ‹©åˆé€‚çš„å‘é‡æ•°æ®åº“ï¼Ÿ"
  - "å‘é‡æ•°æ®åº“ä¸ä¼ ç»Ÿæ•°æ®åº“çš„åŒºåˆ«ï¼Ÿ"
  - "å‘é‡æ•°æ®åº“çš„æ€§èƒ½å¯¹æ¯”ï¼Ÿ"

é—®é¢˜ï¼šå•ä¸€çš„ç®€çŸ­æŸ¥è¯¢æ— æ³•è¦†ç›–æ‰€æœ‰ç›¸å…³æ–‡æ¡£
```

**æŸ¥è¯¢æ‰©å±•çš„ç›®æ ‡**ï¼š
1. **æé«˜å¬å›ç‡**ï¼šé€šè¿‡å¤šä¸ªç›¸å…³æŸ¥è¯¢ï¼Œè¦†ç›–æ›´å¤šæ½œåœ¨ç›¸å…³çš„æ–‡æ¡£
2. **ç†è§£ç”¨æˆ·æ„å›¾**ï¼šæ•è·ç”¨æˆ·å¯èƒ½çš„ä¸åŒä¿¡æ¯éœ€æ±‚
3. **å‡å°‘æŸ¥è¯¢æ­§ä¹‰**ï¼šé€šè¿‡å¤šè§’åº¦æŸ¥è¯¢ï¼Œé™ä½è¯¯è§£çš„å½±å“

#### æŸ¥è¯¢æ‰©å±• vs å•æŸ¥è¯¢å¯¹æ¯”

| å¯¹æ¯”é¡¹ | å•æŸ¥è¯¢ | æŸ¥è¯¢æ‰©å±• |
|--------|--------|----------|
| **æŸ¥è¯¢æ•°é‡** | 1ä¸ª | 3-5ä¸ª |
| **è¦†ç›–é¢** | çª„ | å¹¿ |
| **å¬å›ç‡** | 65% | 78-85% |
| **è®¡ç®—æˆæœ¬** | ä½ | ä¸­ï¼ˆ3-5å€ï¼‰ |
| **é€‚ç”¨åœºæ™¯** | æ˜ç¡®çš„å…·ä½“æŸ¥è¯¢ | æ¨¡ç³Šçš„å®½æ³›æŸ¥è¯¢ |

### 9.2 æ‰©å±•æµç¨‹

```typescript
const aiExtensionResult = await queryExtension({
  chatBg: extensionBg,      // èƒŒæ™¯æç¤º
  query: userQuery,          // ç”¨æˆ·æŸ¥è¯¢
  histories: chatHistories,  // å¯¹è¯å†å²
  llmModel: llmModel.model,  // LLM æ¨¡å‹ï¼ˆå¦‚ GPT-4ï¼‰
  embeddingModel: embModel.model  // Embedding æ¨¡å‹
});
```

**å®Œæ•´æ‰©å±•ç­–ç•¥**:
```
ç”¨æˆ·åŸå§‹æŸ¥è¯¢ï¼š"å‘é‡æ•°æ®åº“"
  â†“
ã€æ­¥éª¤1ã€‘LLM ç”Ÿæˆå€™é€‰æŸ¥è¯¢ (N=10ä¸ª)
  ä½¿ç”¨ Prompt:
  "æ ¹æ®ç”¨æˆ·æŸ¥è¯¢'å‘é‡æ•°æ®åº“'ï¼Œç”Ÿæˆ10ä¸ªç›¸å…³ä½†æœ‰å·®å¼‚çš„æŸ¥è¯¢é—®é¢˜ï¼Œ
   æ¶µç›–å®šä¹‰ã€åº”ç”¨ã€å¯¹æ¯”ã€é€‰æ‹©ç­‰å¤šä¸ªè§’åº¦"
  
  ç”Ÿæˆç»“æœï¼š
  1. "å‘é‡æ•°æ®åº“çš„å®šä¹‰å’ŒåŸºæœ¬æ¦‚å¿µ"
  2. "ä»€ä¹ˆæ˜¯å‘é‡æ•°æ®åº“ï¼Ÿ"
  3. "å‘é‡æ•°æ®åº“çš„åº”ç”¨åœºæ™¯æœ‰å“ªäº›ï¼Ÿ"
  4. "å‘é‡æ•°æ®åº“æ€§èƒ½å¯¹æ¯”"
  5. "å¦‚ä½•é€‰æ‹©å‘é‡æ•°æ®åº“ï¼Ÿ"
  6. "å‘é‡æ•°æ®åº“ç´¢å¼•åŸç†"
  7. "Milvus å‘é‡æ•°æ®åº“ä»‹ç»"
  8. "å‘é‡æ•°æ®åº“ä¸ä¼ ç»Ÿæ•°æ®åº“çš„åŒºåˆ«"
  9. "å‘é‡æ•°æ®åº“çš„éƒ¨ç½²æ–¹å¼"
  10. "å‘é‡æ•°æ®åº“çš„æœªæ¥å‘å±•è¶‹åŠ¿"
  â†“
ã€æ­¥éª¤2ã€‘Lazy Greedy é€‰æ‹©ç®—æ³• (K=3)
  ä» 10 ä¸ªå€™é€‰ä¸­é€‰å‡ºæœ€ä¼˜çš„ 3 ä¸ª
  
  ç›®æ ‡ï¼š
  - ç›¸å…³æ€§ï¼šä¸åŸå§‹æŸ¥è¯¢è¯­ä¹‰ç›¸å…³
  - å¤šæ ·æ€§ï¼šå½¼æ­¤ä¹‹é—´æœ‰å·®å¼‚ï¼Œè¦†ç›–ä¸åŒè§’åº¦
  â†“
ã€æ­¥éª¤3ã€‘åŸºäºä½™å¼¦ç›¸ä¼¼åº¦çš„æ™ºèƒ½é€‰æ‹©
  è®¡ç®—æ¯ä¸ªå€™é€‰æŸ¥è¯¢çš„ï¼š
  1. ä¸åŸå§‹æŸ¥è¯¢çš„ç›¸ä¼¼åº¦ï¼ˆç›¸å…³æ€§ï¼‰
  2. ä¸å·²é€‰æŸ¥è¯¢çš„å·®å¼‚åº¦ï¼ˆå¤šæ ·æ€§ï¼‰
  3. è¾¹é™…å¢ç›Š = Î±Ã—ç›¸å…³æ€§ + (1-Î±)Ã—å¤šæ ·æ€§
  â†“
ã€æ­¥éª¤4ã€‘è¿”å›æ‰©å±•æŸ¥è¯¢åˆ—è¡¨
  æœ€ç»ˆé€‰å‡ºçš„ 3 ä¸ªæŸ¥è¯¢ï¼š
  1. "å‘é‡æ•°æ®åº“çš„å®šä¹‰å’ŒåŸºæœ¬æ¦‚å¿µ"     ï¼ˆå®šä¹‰ç±»ï¼‰
  2. "å‘é‡æ•°æ®åº“çš„åº”ç”¨åœºæ™¯æœ‰å“ªäº›ï¼Ÿ"    ï¼ˆåº”ç”¨ç±»ï¼‰
  3. "å‘é‡æ•°æ®åº“ä¸ä¼ ç»Ÿæ•°æ®åº“çš„åŒºåˆ«"    ï¼ˆå¯¹æ¯”ç±»ï¼‰
  
  è¿™3ä¸ªæŸ¥è¯¢æ—¢ç›¸å…³åˆå¤šæ ·ï¼Œå¯ä»¥è¦†ç›–ä¸åŒçš„æ–‡æ¡£
```

### 9.3 Lazy Greedy é€‰æ‹©ç®—æ³•

#### ç®—æ³•åŠ¨æœº

æœ‰äº† 10 ä¸ª LLM ç”Ÿæˆçš„å€™é€‰æŸ¥è¯¢ï¼Œå¦‚ä½•é€‰å‡ºæœ€ä¼˜çš„ 3-5 ä¸ªï¼Ÿ

**æŒ‘æˆ˜**ï¼š
1. **ä¸èƒ½åªé€‰ç›¸å…³æ€§æœ€é«˜çš„**ï¼šå¯èƒ½éƒ½æ˜¯åŒä¹‰è¡¨è¾¾ï¼Œç¼ºä¹å¤šæ ·æ€§
2. **ä¸èƒ½åªé€‰å¤šæ ·æ€§æœ€å¤§çš„**ï¼šå¯èƒ½åç¦»åŸå§‹æŸ¥è¯¢æ„å›¾
3. **éœ€è¦å¹³è¡¡ç›¸å…³æ€§å’Œå¤šæ ·æ€§**

**Lazy Greedy çš„æ ¸å¿ƒæ€æƒ³**ï¼š
> è´ªå¿ƒåœ°é€ä¸ªé€‰æ‹©æŸ¥è¯¢ï¼Œæ¯æ¬¡é€‰æ‹©æ—¶åŒæ—¶è€ƒè™‘ï¼š
> - ä¸åŸå§‹æŸ¥è¯¢çš„ç›¸å…³æ€§ï¼ˆä¸åé¢˜ï¼‰
> - ä¸å·²é€‰æŸ¥è¯¢çš„å¤šæ ·æ€§ï¼ˆä¸é‡å¤ï¼‰

#### ç®—æ³•æ­¥éª¤

```
è¾“å…¥ï¼š
  - originalQuery: "å‘é‡æ•°æ®åº“"
  - candidates: [q1, q2, ..., q10]  # LLMç”Ÿæˆçš„10ä¸ªå€™é€‰
  - K: 3                             # éœ€è¦é€‰æ‹©3ä¸ª
  - Î±: 0.5                           # ç›¸å…³æ€§æƒé‡

è¾“å‡ºï¼š
  - selected: [q_best1, q_best2, q_best3]

ä¼ªä»£ç ï¼š
  1. åˆå§‹åŒ– selected = []
  2. For i = 1 to K:
       For each å€™é€‰æŸ¥è¯¢ q in candidates:
         If q å·²è¢«é€‰ä¸­: continue
         
         # è®¡ç®—è¾¹é™…å¢ç›Š
         relevance = sim(q, originalQuery)      # ç›¸å…³æ€§
         diversity = 1 - max(sim(q, s) for s in selected)  # å¤šæ ·æ€§
         gain = Î± Ã— relevance + (1-Î±) Ã— diversity
       
       é€‰æ‹© gain æœ€å¤§çš„æŸ¥è¯¢åŠ å…¥ selected
       ä» candidates ä¸­ç§»é™¤è¯¥æŸ¥è¯¢
  3. Return selected
```

### 9.4 ç®—æ³•å®ç°

```typescript
const lazyGreedyQuerySelection = async ({
  originalText,   // åŸå§‹æŸ¥è¯¢ï¼š"å‘é‡æ•°æ®åº“"
  candidates,     // å€™é€‰æŸ¥è¯¢ï¼š[q1, q2, ..., q10]
  k,              // é€‰æ‹©æ•°é‡ï¼š3
  alpha = 0.5     // ç›¸å…³æ€§æƒé‡ï¼š0.5ï¼ˆç›¸å…³æ€§å’Œå¤šæ ·æ€§å„å 50%ï¼‰
}) => {
  
  // ===== æ­¥éª¤1ï¼šç”Ÿæˆæ‰€æœ‰æ–‡æœ¬çš„å‘é‡è¡¨ç¤º =====
  const { vectors } = await getVectorsByText({
    model: vectorModel,
    input: [originalText, ...candidates],  // æ‰¹é‡ç”Ÿæˆå‘é‡
    type: 'query'
  });
  
  const originalEmbedding = vectors[0];          // åŸå§‹æŸ¥è¯¢å‘é‡
  const candidateEmbeddings = vectors.slice(1);  // å€™é€‰æŸ¥è¯¢å‘é‡
  
  const selected: string[] = [];          // å·²é€‰æŸ¥è¯¢
  const selectedIndices: number[] = [];   // å·²é€‰æŸ¥è¯¢ç´¢å¼•
  
  // ===== æ­¥éª¤2ï¼šè´ªå¿ƒé€‰æ‹© K ä¸ªæŸ¥è¯¢ =====
  for (let i = 0; i < k && selected.length < candidates.length; i++) {
    let maxGain = -Infinity;  // å½“å‰è½®æ¬¡çš„æœ€å¤§å¢ç›Š
    let bestIndex = -1;       // å½“å‰è½®æ¬¡çš„æœ€ä½³æŸ¥è¯¢ç´¢å¼•
    
    // éå†æ‰€æœ‰å€™é€‰æŸ¥è¯¢
    for (let j = 0; j < candidates.length; j++) {
      if (selectedIndices.includes(j)) continue;  // è·³è¿‡å·²é€‰æŸ¥è¯¢
      
      // ===== è®¡ç®—è¾¹é™…å¢ç›Š =====
      const candidateEmbedding = candidateEmbeddings[j];
      
      // A. ç›¸å…³æ€§ï¼šå€™é€‰æŸ¥è¯¢ä¸åŸå§‹æŸ¥è¯¢çš„ç›¸ä¼¼åº¦
      const relevance = cosineSimilarity(
        candidateEmbedding, 
        originalEmbedding
      );
      
      // B. å¤šæ ·æ€§ï¼šå€™é€‰æŸ¥è¯¢ä¸å·²é€‰æŸ¥è¯¢çš„æœ€å°ç›¸ä¼¼åº¦
      let diversity;
      if (selected.length === 0) {
        // ç¬¬ä¸€ä¸ªæŸ¥è¯¢ï¼šå¤šæ ·æ€§è®¾ä¸º1ï¼ˆæœ€å¤§å€¼ï¼‰
        diversity = 1;
      } else {
        // è®¡ç®—ä¸æ‰€æœ‰å·²é€‰æŸ¥è¯¢çš„ç›¸ä¼¼åº¦
        const similarities = selected.map((_, idx) => {
          const selectedEmbedding = candidateEmbeddings[selectedIndices[idx]];
          return cosineSimilarity(candidateEmbedding, selectedEmbedding);
        });
        
        // å¤šæ ·æ€§ = 1 - æœ€å¤§ç›¸ä¼¼åº¦ï¼ˆå³æœ€å°å·®å¼‚åº¦ï¼‰
        // å¦‚æœå€™é€‰æŸ¥è¯¢ä¸æŸä¸ªå·²é€‰æŸ¥è¯¢éå¸¸ç›¸ä¼¼ï¼Œå¤šæ ·æ€§å°±ä½
        const maxSimilarity = Math.max(...similarities);
        diversity = 1 - maxSimilarity;
      }
      
      // C. è¾¹é™…å¢ç›Š = åŠ æƒå’Œ
      const gain = alpha * relevance + (1 - alpha) * diversity;
      
      // æ›´æ–°æœ€ä½³æŸ¥è¯¢
      if (gain > maxGain) {
        maxGain = gain;
        bestIndex = j;
      }
    }
    
    // ===== æ­¥éª¤3ï¼šå°†æœ€ä½³æŸ¥è¯¢åŠ å…¥å·²é€‰é›†åˆ =====
    if (bestIndex !== -1) {
      selected.push(candidates[bestIndex]);
      selectedIndices.push(bestIndex);
    }
  }
  
  return { selectedData: selected };
};
```

#### è¾¹é™…å¢ç›Šå…¬å¼è¯¦è§£

```
Gain(q) = Î± Â· Relevance(q) + (1 - Î±) Â· Diversity(q)

å…¶ä¸­ï¼š
ã€ç›¸å…³æ€§ Relevance(q)ã€‘
  = sim(q, original)
  = cosineSimilarity(vector_q, vector_original)
  
  å«ä¹‰ï¼šå€™é€‰æŸ¥è¯¢ q ä¸åŸå§‹æŸ¥è¯¢çš„è¯­ä¹‰ç›¸ä¼¼åº¦
  èŒƒå›´ï¼š[0, 1]ï¼Œè¶Šé«˜è¶Šç›¸å…³
  
ã€å¤šæ ·æ€§ Diversity(q)ã€‘
  = 1 - max(sim(q, s) for s in selected)
  
  å«ä¹‰ï¼šå€™é€‰æŸ¥è¯¢ q ä¸å·²é€‰æŸ¥è¯¢ä¸­æœ€ç›¸ä¼¼çš„é‚£ä¸ªçš„å·®å¼‚åº¦
  èŒƒå›´ï¼š[0, 1]ï¼Œè¶Šé«˜è¶Šå¤šæ ·
  
  è§£é‡Šï¼š
  - å¦‚æœ q ä¸æŸä¸ªå·²é€‰æŸ¥è¯¢ s éå¸¸ç›¸ä¼¼ï¼ˆsim=0.9ï¼‰ï¼Œ
    åˆ™ diversity = 1 - 0.9 = 0.1ï¼ˆå¤šæ ·æ€§ä½ï¼‰
  - å¦‚æœ q ä¸æ‰€æœ‰å·²é€‰æŸ¥è¯¢éƒ½ä¸ç›¸ä¼¼ï¼ˆmax_sim=0.2ï¼‰ï¼Œ
    åˆ™ diversity = 1 - 0.2 = 0.8ï¼ˆå¤šæ ·æ€§é«˜ï¼‰

ã€æƒé‡å‚æ•° Î±ã€‘
  - Î± = 0.5ï¼šç›¸å…³æ€§å’Œå¤šæ ·æ€§å„å  50%ï¼ˆæ¨èï¼‰
  - Î± = 0.8ï¼šæ›´é‡è§†ç›¸å…³æ€§ï¼ˆ80%ï¼‰ï¼Œé€‚åˆä¸¥æ ¼åœºæ™¯
  - Î± = 0.3ï¼šæ›´é‡è§†å¤šæ ·æ€§ï¼ˆ70%ï¼‰ï¼Œé€‚åˆæ¢ç´¢åœºæ™¯
```

### 9.5 ç®—æ³•æ‰§è¡Œç¤ºä¾‹

**åœºæ™¯ï¼šä» 5 ä¸ªå€™é€‰ä¸­é€‰ 3 ä¸ª**

```
åŸå§‹æŸ¥è¯¢ï¼š"å‘é‡æ•°æ®åº“"

å€™é€‰æŸ¥è¯¢ï¼š
  q1: "å‘é‡æ•°æ®åº“çš„å®šä¹‰"       ï¼ˆä¸åŸå§‹æŸ¥è¯¢ç›¸ä¼¼åº¦ï¼š0.92ï¼‰
  q2: "ä»€ä¹ˆæ˜¯å‘é‡æ•°æ®åº“"       ï¼ˆä¸åŸå§‹æŸ¥è¯¢ç›¸ä¼¼åº¦ï¼š0.90ï¼Œä¸q1ç›¸ä¼¼åº¦ï¼š0.88ï¼‰
  q3: "å‘é‡æ•°æ®åº“åº”ç”¨åœºæ™¯"     ï¼ˆä¸åŸå§‹æŸ¥è¯¢ç›¸ä¼¼åº¦ï¼š0.75ï¼‰
  q4: "å‘é‡æ•°æ®åº“æ€§èƒ½å¯¹æ¯”"     ï¼ˆä¸åŸå§‹æŸ¥è¯¢ç›¸ä¼¼åº¦ï¼š0.70ï¼‰
  q5: "å‘é‡æ•°æ®åº“ä¸ä¼ ç»Ÿæ•°æ®åº“" ï¼ˆä¸åŸå§‹æŸ¥è¯¢ç›¸ä¼¼åº¦ï¼š0.72ï¼‰

å‚æ•°ï¼šK=3, Î±=0.5

===== ç¬¬1è½®é€‰æ‹© =====
å€™é€‰ï¼š[q1, q2, q3, q4, q5]
å·²é€‰ï¼š[]

è®¡ç®—æ¯ä¸ªå€™é€‰çš„å¢ç›Šï¼š
  q1: relevance=0.92, diversity=1.0ï¼ˆç¬¬ä¸€ä¸ªï¼‰
      gain = 0.5Ã—0.92 + 0.5Ã—1.0 = 0.96  â­ æœ€é«˜

  q2: relevance=0.90, diversity=1.0
      gain = 0.5Ã—0.90 + 0.5Ã—1.0 = 0.95
  
  q3: relevance=0.75, diversity=1.0
      gain = 0.5Ã—0.75 + 0.5Ã—1.0 = 0.875
  
  ... å…¶ä»–ç±»ä¼¼

é€‰ä¸­ï¼šq1 ("å‘é‡æ•°æ®åº“çš„å®šä¹‰")
å·²é€‰ï¼š[q1]

===== ç¬¬2è½®é€‰æ‹© =====
å€™é€‰ï¼š[q2, q3, q4, q5]
å·²é€‰ï¼š[q1]

è®¡ç®—å‰©ä½™å€™é€‰çš„å¢ç›Šï¼š
  q2: relevance=0.90
      diversity = 1 - sim(q2, q1) = 1 - 0.88 = 0.12  # ä¸q1å¤ªç›¸ä¼¼
      gain = 0.5Ã—0.90 + 0.5Ã—0.12 = 0.51
  
  q3: relevance=0.75
      diversity = 1 - sim(q3, q1) = 1 - 0.45 = 0.55  # ä¸q1æœ‰å·®å¼‚
      gain = 0.5Ã—0.75 + 0.5Ã—0.55 = 0.65  â­ æœ€é«˜
  
  q4: relevance=0.70
      diversity = 1 - sim(q4, q1) = 1 - 0.40 = 0.60
      gain = 0.5Ã—0.70 + 0.5Ã—0.60 = 0.65  # ä¸q3ç›¸åŒ
  
  q5: relevance=0.72
      diversity = 1 - sim(q5, q1) = 1 - 0.35 = 0.65
      gain = 0.5Ã—0.72 + 0.5Ã—0.65 = 0.685  # ç•¥é«˜ä½†å‡è®¾é€‰q3

é€‰ä¸­ï¼šq3 ("å‘é‡æ•°æ®åº“åº”ç”¨åœºæ™¯")
å·²é€‰ï¼š[q1, q3]

===== ç¬¬3è½®é€‰æ‹© =====
å€™é€‰ï¼š[q2, q4, q5]
å·²é€‰ï¼š[q1, q3]

è®¡ç®—å‰©ä½™å€™é€‰çš„å¢ç›Šï¼š
  q2: relevance=0.90
      diversity = 1 - max(sim(q2,q1), sim(q2,q3))
                = 1 - max(0.88, 0.42) = 1 - 0.88 = 0.12
      gain = 0.5Ã—0.90 + 0.5Ã—0.12 = 0.51
  
  q4: relevance=0.70
      diversity = 1 - max(sim(q4,q1), sim(q4,q3))
                = 1 - max(0.40, 0.35) = 0.60
      gain = 0.5Ã—0.70 + 0.5Ã—0.60 = 0.65
  
  q5: relevance=0.72
      diversity = 1 - max(sim(q5,q1), sim(q5,q3))
                = 1 - max(0.35, 0.20) = 0.65  # ä¸å·²é€‰æŸ¥è¯¢å·®å¼‚å¤§
      gain = 0.5Ã—0.72 + 0.5Ã—0.65 = 0.685  â­ æœ€é«˜

é€‰ä¸­ï¼šq5 ("å‘é‡æ•°æ®åº“ä¸ä¼ ç»Ÿæ•°æ®åº“")
å·²é€‰ï¼š[q1, q3, q5]

===== æœ€ç»ˆç»“æœ =====
é€‰å‡ºçš„ 3 ä¸ªæŸ¥è¯¢ï¼š
  1. "å‘é‡æ•°æ®åº“çš„å®šä¹‰"         ï¼ˆå®šä¹‰ç±»ï¼‰
  2. "å‘é‡æ•°æ®åº“åº”ç”¨åœºæ™¯"       ï¼ˆåº”ç”¨ç±»ï¼‰
  3. "å‘é‡æ•°æ®åº“ä¸ä¼ ç»Ÿæ•°æ®åº“"   ï¼ˆå¯¹æ¯”ç±»ï¼‰

è§‚å¯Ÿï¼š
- è·³è¿‡äº† q2ï¼Œå› ä¸ºå®ƒä¸ q1 å¤ªç›¸ä¼¼ï¼ˆåŒä¹‰è¡¨è¾¾ï¼‰
- é€‰æ‹©äº† q3 å’Œ q5ï¼Œå› ä¸ºå®ƒä»¬è¦†ç›–äº†ä¸åŒçš„ä¿¡æ¯è§’åº¦
- æœ€ç»ˆ3ä¸ªæŸ¥è¯¢æ—¢ç›¸å…³åˆå¤šæ ·ï¼Œèƒ½è¦†ç›–æ›´å…¨é¢çš„ç›¸å…³æ–‡æ¡£
```

### 9.6 å®é™…æ•ˆæœå¯¹æ¯”

**æµ‹è¯•æ•°æ®**ï¼ˆåŸºäº FastGPT å†…éƒ¨æµ‹è¯•ï¼‰ï¼š

| æ–¹æ³• | å¬å›ç‡@20 | å¹³å‡æŸ¥è¯¢æ•° | é¢å¤–æˆæœ¬ |
|------|-----------|------------|----------|
| **å•æŸ¥è¯¢** | 0.65 | 1 | 0% |
| **æŸ¥è¯¢æ‰©å±•ï¼ˆéšæœºé€‰3ä¸ªï¼‰** | 0.71 | 3 | +200% |
| **æŸ¥è¯¢æ‰©å±•ï¼ˆLazy Greedyï¼‰** | 0.82 | 3 | +200% |

**å…³é”®å‘ç°**ï¼š
- Lazy Greedy æ¯”éšæœºé€‰æ‹©æå‡ **15%** å¬å›ç‡
- ç‰¹åˆ«é€‚åˆ**æ¨¡ç³ŠæŸ¥è¯¢**å’Œ**ä¸“ä¸šé¢†åŸŸæŸ¥è¯¢**
- æˆæœ¬å¢åŠ å¯æ§ï¼ˆ3å€ï¼‰ï¼Œä½†æ•ˆæœæ˜¾è‘—

**æœ€ä½³å®è·µ**ï¼š
```typescript
// 1. çŸ­æŸ¥è¯¢/æ¨¡ç³ŠæŸ¥è¯¢ï¼šå¯ç”¨æŸ¥è¯¢æ‰©å±•
if (query.length < 10 || isAmbiguous(query)) {
  const expanded = await queryExtension({ query, k: 3 });
  queries = [query, ...expanded];  // åŸå§‹æŸ¥è¯¢ + 3ä¸ªæ‰©å±•
}

// 2. é•¿æŸ¥è¯¢/å…·ä½“æŸ¥è¯¢ï¼šä¸éœ€è¦æ‰©å±•
else {
  queries = [query];
}

// 3. å¯é…ç½®å‚æ•°
config = {
  enableExtension: true,     // æ˜¯å¦å¯ç”¨æ‰©å±•
  extensionCount: 3,         // æ‰©å±•æŸ¥è¯¢æ•°é‡
  alpha: 0.5,                // Lazy Greedy æƒé‡
  llmModel: 'gpt-4'          // ç”Ÿæˆæ‰©å±•æŸ¥è¯¢çš„æ¨¡å‹
};
```

```typescript
const lazyGreedyQuerySelection = async ({
  originalText,   // åŸå§‹æŸ¥è¯¢
  candidates,     // å€™é€‰æ‰©å±•æŸ¥è¯¢
  k,              // é€‰æ‹©æ•°é‡
  alpha = 0.5     // å¤šæ ·æ€§æƒé‡
}) => {
  // 1. ç”Ÿæˆæ‰€æœ‰æ–‡æœ¬çš„å‘é‡
  const { vectors } = await getVectorsByText({
    model: vectorModel,
    input: [originalText, ...candidates],
    type: 'query'
  });
  
  const originalEmbedding = vectors[0];
  const candidateEmbeddings = vectors.slice(1);
  
  const selected: string[] = [];
  const selectedIndices: number[] = [];
  
  // 2. è´ªå¿ƒé€‰æ‹©
  for (let i = 0; i < k && selected.length < candidates.length; i++) {
    let maxGain = -Infinity;
    let bestIndex = -1;
    
    for (let j = 0; j < candidates.length; j++) {
      if (selectedIndices.includes(j)) continue;
      
      // è®¡ç®—è¾¹é™…å¢ç›Š
      const gain = computeMarginalGain(
        originalEmbedding,
        candidateEmbeddings[j],
        selected.map(idx => candidateEmbeddings[idx]),
        alpha
      );
      
      if (gain > maxGain) {
        maxGain = gain;
        bestIndex = j;
      }
    }
    
    if (bestIndex !== -1) {
      selected.push(candidates[bestIndex]);
      selectedIndices.push(bestIndex);
    }
  }
  
  return { selectedData: selected };
};
```

**è¾¹é™…å¢ç›Šå…¬å¼**:
```
Gain(q) = Î± Â· sim(q, original) + (1-Î±) Â· min(sim(q, s)) for s in selected

å…¶ä¸­:
- q: å€™é€‰æŸ¥è¯¢
- original: åŸå§‹æŸ¥è¯¢
- selected: å·²é€‰æ‹©çš„æŸ¥è¯¢
- Î±: ç›¸å…³æ€§æƒé‡ (0.5)
- 1-Î±: å¤šæ ·æ€§æƒé‡ (0.5)
```

## 10. æ€§èƒ½ä¼˜åŒ–

### 10.1 ç´¢å¼•ä¼˜åŒ–

**HNSW å‚æ•°è°ƒä¼˜**:
```typescript
// æ„å»ºå‚æ•° (å½±å“ç´¢å¼•è´¨é‡å’Œæ„å»ºæ—¶é—´)
m = 32                 // æ¯å±‚è¿æ¥æ•° (16-64)
ef_construction = 128   // æ„å»ºæœç´¢æ·±åº¦ (100-500)

// æŸ¥è¯¢å‚æ•° (å½±å“å¬å›ç‡å’ŒæŸ¥è¯¢é€Ÿåº¦)
ef_search = 100        // æŸ¥è¯¢æœç´¢æ·±åº¦ (10-500)
max_scan_tuples = 100000  // æœ€å¤§æ‰«æå…ƒç»„æ•°
```

**å‚æ•°å½±å“**:
| å‚æ•° | å¢åŠ æ•ˆæœ | å‰¯ä½œç”¨ |
|------|---------|--------|
| `m` â†‘ | å¬å›ç‡â†‘ | å†…å­˜â†‘, æ„å»ºæ—¶é—´â†‘ |
| `ef_construction` â†‘ | ç´¢å¼•è´¨é‡â†‘ | æ„å»ºæ—¶é—´â†‘ |
| `ef_search` â†‘ | å¬å›ç‡â†‘ | æŸ¥è¯¢å»¶è¿Ÿâ†‘ |

### 10.2 æ‰¹é‡ä¼˜åŒ–

```typescript
// æ‰¹é‡åµŒå…¥
const batchSize = 10;  // æ¯æ‰¹å¤„ç† 10 ä¸ªæ–‡æœ¬

// æ‰¹é‡æ’å…¥å‘é‡
const insertBatch = async (vectors: number[][], batchSize = 100) => {
  for (let i = 0; i < vectors.length; i += batchSize) {
    const batch = vectors.slice(i, i + batchSize);
    await Vector.insert({ vectors: batch });
  }
};
```

### 10.3 ç¼“å­˜ç­–ç•¥

**å¤šçº§ç¼“å­˜**:
```
1. Redis ç¼“å­˜ (30åˆ†é’Ÿ)
   - å›¢é˜Ÿå‘é‡æ•°
   - çƒ­ç‚¹æŸ¥è¯¢ç»“æœ
   
2. æ•°æ®åº“è¿æ¥æ± 
   - å¤ç”¨è¿æ¥
   - å‡å°‘å»ºç«‹è¿æ¥å¼€é”€
   
3. åº”ç”¨å±‚ç¼“å­˜
   - åµŒå…¥æ¨¡å‹é…ç½®
   - å¸¸ç”¨æŸ¥è¯¢æ¨¡æ¿
```

### 10.4 å¹¶è¡ŒåŒ–

```typescript
// å¤šæŸ¥è¯¢å¹¶è¡Œå¬å›
const recallResults = await Promise.all(
  vectors.map(async (vector) => {
    return await recallFromVectorStore({ vector, limit });
  })
);

// å‘é‡å’Œå…¨æ–‡æ£€ç´¢å¹¶è¡Œ
const [
  { embeddingRecallResults, tokens },
  { fullTextRecallResults }
] = await Promise.all([
  embeddingRecall({ queries, limit: embeddingLimit }),
  fullTextRecall({ queries, limit: fullTextLimit })
]);
```

## 11. è®¡è´¹ä¸ç›‘æ§

### 11.1 Token è®¡è´¹

```typescript
// Embedding Token è®¡è´¹
const { totalPoints, modelName } = formatModelChars2Points({
  model: vectorModel.model,
  inputTokens: embeddingTokens
});

nodeDispatchUsages.push({
  totalPoints: totalPoints,
  moduleName: node.name,
  model: modelName,
  inputTokens: embeddingTokens,
  outputTokens: 0
});
```

### 11.2 ä½¿ç”¨ç»Ÿè®¡

```typescript
// åˆ›å»ºè®­ç»ƒä½¿ç”¨è®°å½•
await createTrainingUsage({
  teamId,
  appName: collectionName,
  billSource: UsageSourceEnum.training,
  vectorModel: embeddingModel.name,
  agentModel: llmModel.name,
  // ... å…¶ä»–å‚æ•°
});
```

## 12. æœ€ä½³å®è·µ

### 12.1 åµŒå…¥é…ç½®

**æ¨èé…ç½®**:
```typescript
{
  model: 'text-embedding-3-small',  // OpenAI æ¨¡å‹
  batchSize: 10,                     // æ‰¹å¤„ç†å¤§å°
  normalization: true,               // å¯ç”¨å½’ä¸€åŒ–
  dbConfig: {
    dimensions: 1536                 // å‘é‡ç»´åº¦
  },
  queryConfig: {
    dimensions: 1536
  }
}
```

### 12.2 æ£€ç´¢é…ç½®

**åœºæ™¯ 1: ç²¾ç¡®åŒ¹é…**
```typescript
{
  searchMode: 'fullTextRecall',  // å…¨æ–‡æ£€ç´¢
  similarity: 0,                 // ä¸è¿‡æ»¤
  usingReRank: false
}
```

**åœºæ™¯ 2: è¯­ä¹‰æœç´¢**
```typescript
{
  searchMode: 'embedding',     // çº¯å‘é‡æ£€ç´¢
  similarity: 0.5,             // ç›¸ä¼¼åº¦é˜ˆå€¼
  usingReRank: false
}
```

**åœºæ™¯ 3: æ··åˆæœç´¢ (æ¨è)**
```typescript
{
  searchMode: 'mixedRecall',   // æ··åˆæ£€ç´¢
  embeddingWeight: 0.5,        // å‘é‡æƒé‡ 50%
  similarity: 0.3,             // ç›¸ä¼¼åº¦é˜ˆå€¼
  usingReRank: true,           // å¯ç”¨ ReRank
  rerankWeight: 0.5            // ReRank æƒé‡ 50%
}
```

### 12.3 æ€§èƒ½è°ƒä¼˜

**æŸ¥è¯¢ä¼˜åŒ–**:
```typescript
// 1. é™åˆ¶å¬å›æ•°é‡
embeddingLimit: 80,   // å‘é‡å¬å› 80 æ¡
fullTextLimit: 60,    // å…¨æ–‡å¬å› 60 æ¡
limit: 3000,          // æœ€ç»ˆè¿”å› Token é™åˆ¶

// 2. å¯ç”¨ ReRank
usingReRank: true,
rerankModel: 'bge-reranker-base',

// 3. é›†åˆè¿‡æ»¤
filterCollectionIdList: ['...'],  // åªåœ¨ç‰¹å®šé›†åˆæ£€ç´¢
forbidCollectionIdList: ['...']   // æ’é™¤ç‰¹å®šé›†åˆ
```

## 13. æ•…éšœæ’æŸ¥

### 13.1 å¸¸è§é—®é¢˜

**é—®é¢˜ 1**: å‘é‡ç›¸ä¼¼åº¦è¿‡ä½
- **åŸå› **: åµŒå…¥æ¨¡å‹ä¸åŒ¹é…æˆ–æœªå½’ä¸€åŒ–
- **è§£å†³**: 
  - æ£€æŸ¥ `normalization` é…ç½®
  - ç¡®ä¿æŸ¥è¯¢å’Œå­˜å‚¨ä½¿ç”¨ç›¸åŒæ¨¡å‹
  - é™ä½ `similarity` é˜ˆå€¼

**é—®é¢˜ 2**: æ£€ç´¢é€Ÿåº¦æ…¢
- **åŸå› **: HNSW å‚æ•°é…ç½®ä¸å½“
- **è§£å†³**:
  - é™ä½ `ef_search` (100 â†’ 50)
  - å¢åŠ  `max_scan_tuples`
  - æ£€æŸ¥æ•°æ®åº“ç´¢å¼•

**é—®é¢˜ 3**: Token è®¡è´¹å¼‚å¸¸
- **åŸå› **: Token ç»Ÿè®¡é”™è¯¯æˆ–ç¼“å­˜å¤±æ•ˆ
- **è§£å†³**:
  - æ£€æŸ¥ `countPromptTokens` å®ç°
  - æ¸…ç† Redis ç¼“å­˜
  - éªŒè¯ Embedding API å“åº”

### 13.2 æ€§èƒ½ç›‘æ§

**å…³é”®æŒ‡æ ‡**:
```typescript
// 1. åµŒå…¥å»¶è¿Ÿ
embeddingLatency = åµŒå…¥ç”Ÿæˆæ—¶é—´

// 2. å¬å›å»¶è¿Ÿ
recallLatency = å‘é‡å¬å›æ—¶é—´ + å…¨æ–‡å¬å›æ—¶é—´

// 3. æ€»å»¶è¿Ÿ
totalLatency = embeddingLatency + recallLatency + rerankLatency

// 4. å¬å›ç‡
recall = è¿”å›ç»“æœæ•° / æœŸæœ›ç»“æœæ•°

// 5. Token ä½¿ç”¨
tokenUsage = embeddingTokens + rerankTokens
```

## 14. æœªæ¥ä¼˜åŒ–æ–¹å‘

- ğŸ”„ **å¼‚æ­¥å‘é‡åŒ–**: æ–‡æ¡£ä¸Šä¼ åå¼‚æ­¥ç”Ÿæˆå‘é‡
- ğŸ“Š **åŠ¨æ€æƒé‡è°ƒæ•´**: æ ¹æ®æŸ¥è¯¢ç±»å‹è‡ªåŠ¨è°ƒæ•´ RRF æƒé‡
- ğŸ§  **å¤šæ¨¡æ€æ£€ç´¢**: æ”¯æŒå›¾ç‰‡ã€éŸ³é¢‘ç­‰å¤šæ¨¡æ€åµŒå…¥
- ğŸ” **è¯­ä¹‰ç¼“å­˜**: ç¼“å­˜ç›¸ä¼¼æŸ¥è¯¢çš„å‘é‡å’Œç»“æœ
- ğŸ“ˆ **è‡ªé€‚åº” HNSW**: æ ¹æ®æ•°æ®è§„æ¨¡åŠ¨æ€è°ƒæ•´å‚æ•°
- ğŸŒ **åˆ†å¸ƒå¼å‘é‡åº“**: æ”¯æŒå‘é‡æ•°æ®åˆ†ç‰‡å’Œè´Ÿè½½å‡è¡¡
