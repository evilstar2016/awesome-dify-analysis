@startuml 02-html-sequence
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding 6
skinparam ParticipantPadding 30

title HTML 文档解析时序图

participant "Worker 线程" as Worker
participant "HTML 解析器" as Parser
participant "rawText 解析器" as RawText
participant "html2md 工具" as Html2Md
participant "Turndown" as Turndown

Worker -> Parser: readHtmlRawText(buffer, encoding)
activate Parser

Parser -> RawText: readFileRawText(buffer, encoding)
activate RawText
RawText --> Parser: {rawText: htmlContent}
deactivate RawText

Parser -> Html2Md: html2md(htmlContent)
activate Html2Md

Html2Md -> Html2Md: 提取 Base64 图片
note right of Html2Md
  正则匹配：
  src="data:image/png;base64,..."
  
  替换为 UUID：
  src="IMAGE_abc123_IMAGE"
end note

Html2Md -> Html2Md: 检查 HTML 大小

alt HTML 大小 > 100KB
    Html2Md --> Parser: {rawText: html, imageList: []}
    note right: 降级：返回原始 HTML
else HTML 大小 <= 100KB
    Html2Md -> Turndown: 配置 Turndown
    activate Turndown
    
    note right of Turndown
      配置：
      - headingStyle: 'atx'
      - bulletListMarker: '-'
      - codeBlockStyle: 'fenced'
      - 移除: script, style, iframe
      - GFM 插件：表格、删除线
    end note
    
    Turndown -> Turndown: 移除无用标签
    Turndown -> Turndown: 自定义媒体标签处理\n(video, audio)
    Turndown -> Turndown: HTML → Markdown
    
    Turndown --> Html2Md: Markdown 文本
    deactivate Turndown
    
    Html2Md --> Parser: {rawText: md, imageList}
end

deactivate Html2Md

Parser --> Worker: {rawText, imageList}
deactivate Parser

note over Worker, Turndown
  输出：
  - rawText: Markdown 格式文本
  - imageList: [{uuid, base64, mime}]
  
  性能优化：
  - 超过 100KB 直接返回原始 HTML
  - Base64 图片替换为 UUID
  - 移除无用标签减少内存
end note

@enduml
