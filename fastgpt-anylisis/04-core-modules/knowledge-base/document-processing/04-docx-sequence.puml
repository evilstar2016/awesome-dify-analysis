@startuml 04-docx-sequence
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding 6
skinparam ParticipantPadding 30

title DOCX 文档解析时序图

participant "Worker 线程" as Worker
participant "DOCX 解析器" as Parser
participant "Mammoth" as Mammoth
participant "html2md 工具" as Html2Md

Worker -> Parser: readDocxRawText(buffer, encoding)
activate Parser

Parser -> Mammoth: convertToHtml(buffer, options)
activate Mammoth

note right of Mammoth
  Mammoth 配置：
  convertImage: 自定义图片处理
end note

Mammoth -> Mammoth: 解析 DOCX 结构

loop 遍历文档内容
    Mammoth -> Mammoth: 转换文本为 HTML
    Mammoth -> Mammoth: 转换标题/列表/表格
    
    alt 遇到图片
        Mammoth -> Mammoth: 读取图片 Binary
        Mammoth -> Mammoth: 转换为 Base64
        Mammoth -> Mammoth: 生成 UUID
        
        note right of Mammoth
          UUID 格式：
          IMAGE_abc123xyz_IMAGE
        end note
        
        Mammoth -> Mammoth: 保存图片信息\n{uuid, base64, mime}
        Mammoth -> Mammoth: HTML 中使用 UUID
    end
end

Mammoth --> Parser: {value: htmlContent, messages}
deactivate Mammoth

Parser -> Html2Md: html2md(htmlContent)
activate Html2Md

Html2Md -> Html2Md: 提取 HTML 中的 Base64 图片
Html2Md -> Html2Md: HTML → Markdown

Html2Md --> Parser: {rawText: md, imageList}
deactivate Html2Md

Parser -> Parser: 合并图片列表\n(Mammoth + html2md)

Parser --> Worker: {rawText, imageList}
deactivate Parser

note over Worker, Html2Md
  输出：
  - rawText: Markdown 格式文本
  - imageList: [{uuid, base64, mime}]
  
  支持特性：
  - 标题、粗体、斜体 → Markdown
  - 列表 → Markdown 列表
  - 表格 → Markdown 表格
  - 图片 → Base64 + UUID
  - 超链接 → [text](url)
  
  不支持：
  - 页眉页脚
  - 批注
  - 修订记录
end note

@enduml
