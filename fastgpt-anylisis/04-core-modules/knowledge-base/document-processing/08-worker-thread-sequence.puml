@startuml
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding 6
skinparam ParticipantPadding 30

title Worker 线程文档解析架构时序图

actor 用户 as User
participant "API 层" as API
participant "Service 层" as Service
participant "主线程" as MainThread
participant "SharedArrayBuffer" as SAB
participant "Worker 线程" as Worker
participant "文件解析器" as Parser
database "向量数据库" as VectorDB

User -> API: 上传文档
activate API

API -> Service: 调用文件处理服务
activate Service

Service -> Service: 确定文件类型\n(基于扩展名)

Service -> MainThread: 创建 Worker 线程
activate MainThread

MainThread -> SAB: 分配共享内存\n(零拷贝)
activate SAB

MainThread -> SAB: 写入文件 Buffer
SAB --> Worker: 共享内存访问

activate Worker
Worker -> Worker: 读取文件 Buffer
Worker -> Worker: 路由到对应解析器\n(pdf/docx/xlsx...)

Worker -> Parser: 调用解析器
activate Parser

Parser -> Parser: 提取文本内容
Parser -> Parser: 提取图片/表格

note right of Parser
  不同解析器：
  - PDF: pdfjs-dist
  - DOCX: mammoth
  - XLSX: node-xlsx
  - HTML: turndown
  - CSV: papaparse
  - PPTX: xmldom
end note

Parser --> Worker: 返回解析结果\n{rawText, formatText?, imageList?}
deactivate Parser

Worker -> SAB: 写入结果到共享内存
SAB --> MainThread: 共享内存访问
deactivate Worker

MainThread --> Service: 返回解析结果
deactivate MainThread
deactivate SAB

Service -> Service: 文本分块\n(Chunking)

note right of Service
  分块策略：
  - chunk: 固定大小
  - qa: 问答对
  - imageParse: 图片识别
end note

Service -> Service: 向量化处理

Service -> VectorDB: 存储向量
activate VectorDB
VectorDB --> Service: 存储成功
deactivate VectorDB

Service --> API: 返回处理结果
deactivate Service

API --> User: 上传成功
deactivate API

note over User, VectorDB
  优势：
  1. 零拷贝传输 (SharedArrayBuffer)
  2. 主线程不阻塞
  3. 并发处理能力强
  4. Worker 崩溃不影响主进程
end note

@enduml
