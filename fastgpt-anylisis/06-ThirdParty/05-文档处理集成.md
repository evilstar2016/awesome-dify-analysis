# 文档处理服务集成

FastGPT 支持多种文档处理服务，用于解析 PDF、Office 文档等格式。

## 一、支持的文档处理服务

| 服务 | 状态 | 功能 |
|------|------|------|
| **Doc2X** | ✅ 推荐 | 高质量 PDF 解析、表格识别、公式识别 |
| **自定义解析服务** | ✅ | 企业级自部署解析 API |
| **系统内置解析** | ✅ | 基础文档解析能力 |
| **插件式解析器** | ✅ | PDF Marker、MinerU、Mistral 等 |

## 二、Doc2X 集成

### 2.1 环境配置

```typescript
// packages/global/common/system/types/index.d.ts
export type customPdfParseType = {
  url?: string;        // 自定义解析服务 URL
  key?: string;        // 自定义服务 API Key
  doc2xKey?: string;   // Doc2X API Key
  price?: number;      // 解析价格（点数）
};

export type SystemEnvType = {
  customPdfParse?: customPdfParseType;
};
```

### 2.2 核心实现（`packages/service/thirdProvider/doc2x/index.ts`）

```typescript
import axios from 'axios';

export const useDoc2xServer = ({ apiKey }: { apiKey: string }) => {
  // 初始化请求客户端
  const instance = axios.create({
    baseURL: 'https://v2.doc2x.noedgeai.com/api',
    timeout: 60000,
    headers: {
      Authorization: `Bearer ${apiKey}`
    }
  });
  
  // 响应检查
  const checkRes = (data: ApiResponseDataType) => {
    if (data === undefined) {
      console.log('[Doc2x] Server data is empty');
      return Promise.reject('服务器异常');
    }
    return data;
  };
  
  return {
    // 解析 PDF
    async parsePDF(buffer: Buffer): Promise<{
      pages: number;
      text: string;
      imageList: ImageType[];
    }> {
      // 1. 上传文件
      const uploadRes = await instance.post('/upload', buffer, {
        headers: { 'Content-Type': 'application/pdf' }
      });
      
      const { uuid } = uploadRes.data.data;
      
      // 2. 开始解析
      await instance.post('/parse', { uuid });
      
      // 3. 轮询获取结果
      let parseResult;
      for (let i = 0; i < 60; i++) {
        await delay(2000);
        const statusRes = await instance.get(`/status/${uuid}`);
        
        if (statusRes.data.data.status === 'success') {
          parseResult = statusRes.data.data;
          break;
        }
        if (statusRes.data.data.status === 'failed') {
          throw new Error('Parse failed');
        }
      }
      
      if (!parseResult) {
        throw new Error('Parse timeout');
      }
      
      // 4. 获取解析内容
      const contentRes = await instance.get(`/result/${uuid}`);
      
      return {
        pages: parseResult.pages,
        text: contentRes.data.data.text,
        imageList: contentRes.data.data.images || []
      };
    }
  };
};
```

### 2.3 解析流程选择（`packages/service/common/file/read/utils.ts`）

```typescript
export const readRawTextByLocalFile = async (params: ReadRawTextParams) => {
  const { buffer, extension, teamId, tmbId } = params;
  
  // 系统内置解析
  const systemParse = async (): Promise<ReadFileResponse> => {
    const { rawText } = await readS3FileContentByBuffer({
      teamId,
      tmbId,
      extension,
      buffer,
      isQAImport: false
    });
    return { rawText };
  };
  
  // 自定义解析服务
  const parsePdfFromCustomService = async (): Promise<ReadFileResponse> => {
    const customPdfParse = global.systemEnv.customPdfParse;
    if (!customPdfParse?.url || !customPdfParse?.key) {
      return systemParse();
    }
    
    const response = await axios.post(
      customPdfParse.url,
      buffer,
      {
        headers: {
          'Authorization': `Bearer ${customPdfParse.key}`,
          'Content-Type': 'application/pdf'
        }
      }
    );
    
    return {
      rawText: response.data.text,
      imageList: response.data.images
    };
  };
  
  // Doc2x 解析
  const parsePdfFromDoc2x = async (): Promise<ReadFileResponse> => {
    const doc2xKey = global.systemEnv.customPdfParse?.doc2xKey;
    if (!doc2xKey) return systemParse();
    
    const { pages, text, imageList } = await useDoc2xServer({ apiKey: doc2xKey }).parsePDF(buffer);
    
    // 创建使用记录
    createPdfParseUsage({
      teamId,
      tmbId,
      pages
    });
    
    return {
      rawText: text,
      imageList
    };
  };
  
  // 解析策略选择
  if (extension === '.pdf') {
    const customPdfParse = global.systemEnv.customPdfParse;
    if (!customPdfParse) return systemParse();
    if (global.systemEnv.customPdfParse?.url) return parsePdfFromCustomService();
    if (global.systemEnv.customPdfParse?.doc2xKey) return parsePdfFromDoc2x();
    
    return systemParse();
  }
  
  // 其他格式使用系统解析
  return systemParse();
};
```

### 2.4 特性配置

```typescript
// packages/service/common/system/tools.ts
config.feConfigs.showCustomPdfParse =
  !!config.systemEnv.customPdfParse?.url || !!config.systemEnv.customPdfParse?.doc2xKey;
  
config.feConfigs.customPdfParsePrice = config.systemEnv.customPdfParse?.price || 0;
```

## 三、插件式解析器

### 3.1 支持的插件

```
plugins/model/
├── pdf-marker/         # PDF Marker 解析器
├── pdf-mineru/         # MinerU 文档解析
├── pdf-mistral/        # Mistral PDF 解析
└── ocr-surya/          # Surya OCR 识别
```

### 3.2 OCR 集成

**Surya OCR 插件**：
- 多语言 OCR 识别
- 表格结构识别
- 布局分析

## 四、语雀集成

### 4.1 语雀数据集

```typescript
// packages/service/core/dataset/apiDataset/yuqueDataset/api.ts
export const useYuqueDatasetRequest = ({ yuqueServer }: { yuqueServer: YuqueServer }) => {
  const instance = axios.create({
    baseURL: 'https://www.yuque.com/api/v2',
    headers: {
      'X-Auth-Token': yuqueServer.token
    }
  });
  
  return {
    async getRepos() {
      return await instance.get('/repos');
    },
    async getDocs(repoId: string) {
      return await instance.get(`/repos/${repoId}/docs`);
    },
    async getDoc(repoId: string, slug: string) {
      return await instance.get(`/repos/${repoId}/docs/${slug}`);
    }
  };
};
```

### 4.2 数据集类型

```typescript
export enum DatasetTypeEnum {
  yuque = 'yuque',  // 语雀知识库
  // ...
}
```

### 4.3 特性配置

```typescript
export type FastGPTFeConfigsType = {
  show_dataset_yuque?: boolean;   // 是否显示语雀数据集
};
```

## 五、API 数据集集成

### 5.1 统一接口（`packages/service/core/dataset/apiDataset/index.ts`）

```typescript
export const getApiDatasetRequest = async (apiDatasetServer?: ApiDatasetServerType) => {
  const { apiServer, yuqueServer, feishuServer } = apiDatasetServer || {};
  
  if (apiServer) {
    return useApiDatasetRequest({ apiServer });
  }
  if (yuqueServer) {
    return useYuqueDatasetRequest({ yuqueServer });
  }
  if (feishuServer) {
    return useFeishuDatasetRequest({ feishuServer });
  }
  
  return Promise.reject('Can not find api dataset server');
};
```

### 5.2 Schema 定义（`packages/service/core/dataset/schema.ts`）

```typescript
const DatasetSchema = new Schema({
  // ...
  apiServer: Object,      // 自定义 API
  feishuServer: Object,   // 飞书云文档
  yuqueServer: Object     // 语雀知识库
});
```

## 六、文档解析能力对比

| 解析方式 | 准确率 | 速度 | 成本 | 适用场景 |
|---------|--------|------|------|---------|
| **Doc2X** | ⭐⭐⭐⭐⭐ | 中 | 按页计费 | 学术论文、复杂表格、数学公式 |
| **自定义服务** | 可定制 | 可定制 | 自行部署 | 企业级、私有化部署 |
| **系统内置** | ⭐⭐⭐ | 快 | 免费 | 简单文档、纯文本 PDF |
| **PDF Marker** | ⭐⭐⭐⭐ | 快 | 免费 | 开源方案、一般文档 |
| **MinerU** | ⭐⭐⭐⭐ | 中 | 免费 | 学术文档、结构化内容 |

## 七、配置示例

### 7.1 使用 Doc2X

```json
{
  "systemEnv": {
    "customPdfParse": {
      "doc2xKey": "your-doc2x-api-key",
      "price": 0.1
    }
  }
}
```

### 7.2 使用自定义解析服务

```json
{
  "systemEnv": {
    "customPdfParse": {
      "url": "https://your-parse-service.com/parse",
      "key": "your-api-key",
      "price": 0.05
    }
  }
}
```

### 7.3 配置语雀数据集

```typescript
{
  yuqueServer: {
    token: "your-yuque-token",
    repoId: "repo-id"
  }
}
```

## 八、计费与使用统计

### 8.1 PDF 解析计费

```typescript
// packages/service/support/wallet/usage/controller.ts
export const createPdfParseUsage = async ({
  teamId,
  tmbId,
  pages
}: {
  teamId: string;
  tmbId: string;
  pages: number;
}) => {
  const price = global.systemEnv.customPdfParse?.price || 0;
  const totalPrice = pages * price;
  
  await MongoUsage.create({
    teamId,
    tmbId,
    type: UsageSourceEnum.pdfParse,
    totalPoints: totalPrice,
    metadata: { pages }
  });
};
```

## 九、最佳实践

1. **解析方式选择**
   - 简单文档：使用系统内置解析
   - 复杂文档：使用 Doc2X
   - 私有化需求：部署自定义解析服务
   - 开源方案：使用 PDF Marker 或 MinerU 插件

2. **成本优化**
   - 缓存解析结果
   - 支持预览前部分页面
   - 文件去重避免重复解析

3. **解析质量优化**
   - OCR 识别扫描版 PDF
   - 表格结构化提取
   - 公式识别与转换
   - 图片提取与存储

4. **知识库同步**
   - 定期同步飞书/语雀文档
   - 支持增量更新
   - 自动处理文档权限

## 十、相关文件清单

### Doc2X 集成
- `packages/service/thirdProvider/doc2x/index.ts` - Doc2X 客户端
- `packages/service/common/file/read/utils.ts` - 文档解析调度

### API 数据集
- `packages/service/core/dataset/apiDataset/index.ts` - 统一接口
- `packages/service/core/dataset/apiDataset/custom/api.ts` - 自定义 API
- `packages/service/core/dataset/apiDataset/yuqueDataset/api.ts` - 语雀集成
- `packages/service/core/dataset/apiDataset/feishuDataset/api.ts` - 飞书集成

### Schema
- `packages/service/core/dataset/schema.ts` - 数据集 Schema

### 插件
- `plugins/model/pdf-marker/` - PDF Marker 插件
- `plugins/model/pdf-mineru/` - MinerU 插件
- `plugins/model/pdf-mistral/` - Mistral PDF 插件
- `plugins/model/ocr-surya/` - Surya OCR 插件
