# 消息平台集成

FastGPT 支持多种即时通讯平台的集成，允许用户通过第三方消息平台与 AI 应用交互。

## 一、支持的平台

| 平台 | 状态 | 功能 |
|------|------|------|
| **飞书（Feishu/Lark）** | ✅ | 机器人对话、知识库同步 |
| **企业微信（WeCom）** | ✅ | 机器人对话 |
| **钉钉（DingTalk）** | ✅ | 机器人对话 |
| **微信公众号** | ✅ | 公众号对话 |

## 二、飞书集成

### 2.1 环境配置

```bash
# 飞书 API 端点（可选，默认为官方地址）
FEISHU_BASE_URL=https://open.feishu.cn
```

### 2.2 机器人配置

飞书机器人支持在 FastGPT 应用发布设置中配置：
- App ID
- App Secret
- Verification Token
- Encrypt Key

### 2.3 知识库同步

飞书云文档可以作为 API 数据集来源：

```typescript
// packages/service/core/dataset/apiDataset/feishuDataset/api.ts
export const useFeishuDatasetRequest = ({ feishuServer }: { feishuServer: FeishuServer }) => {
  const instance = axios.create({
    baseURL: feishuBaseUrl,
    timeout: 60000
  });
  
  // 自动获取 tenant_access_token
  instance.interceptors.request.use(async (config) => {
    if (!config.headers.Authorization) {
      const { data } = await axios.post(
        `${feishuBaseUrl}/open-apis/auth/v3/tenant_access_token/internal`,
        {
          app_id: feishuServer.appId,
          app_secret: feishuServer.appSecret
        }
      );
      config.headers.Authorization = `Bearer ${data.tenant_access_token}`;
    }
    return config;
  });
  
  return {
    // 获取文件列表
    async getFiles(parentId?: string, pageToken?: string) {
      return await instance.get('/open-apis/drive/v1/files', {
        params: {
          folder_token: parentId || feishuServer.folderToken,
          page_size: 200,
          page_token: pageToken
        }
      });
    },
    // 其他 API...
  };
};
```

### 2.4 数据集类型

```typescript
// packages/global/core/dataset/constants.ts
export enum DatasetTypeEnum {
  feishu = 'feishu',  // 飞书云文档数据集
  // ...
}
```

### 2.5 特性配置

```typescript
// packages/global/common/system/types/index.d.ts
export type FastGPTFeConfigsType = {
  show_dataset_feishu?: boolean;   // 是否显示飞书数据集
  show_publish_feishu?: boolean;   // 是否显示飞书发布渠道
  // ...
};
```

## 三、企业微信集成

### 3.1 发布配置

```typescript
export type FastGPTFeConfigsType = {
  show_publish_wecom?: boolean;  // 是否显示企业微信发布渠道
};
```

### 3.2 图标支持

```
packages/web/components/common/Icon/icons/common/wecom.svg
packages/web/components/common/Icon/icons/core/app/publish/wecom.svg
```

## 四、钉钉集成

### 4.1 发布配置

```typescript
export type FastGPTFeConfigsType = {
  show_publish_dingtalk?: boolean;  // 是否显示钉钉发布渠道
};
```

### 4.2 图标支持

```
packages/web/components/common/Icon/icons/common/dingtalkFill.svg
```

## 五、微信公众号集成

### 5.1 发布配置

```typescript
export type FastGPTFeConfigsType = {
  show_publish_offiaccount?: boolean;  // 是否显示公众号发布渠道
};
```

### 5.2 日志类型

```typescript
// packages/service/common/system/log.ts
export enum EventTypeEnum {
  feishuBot = '[Feishu bot]',
  wxOffiaccount = '[Offiaccount bot]'
}
```

## 六、配置示例

### 6.1 系统配置

```json
{
  "feConfigs": {
    "show_dataset_feishu": true,
    "show_publish_feishu": true,
    "show_publish_dingtalk": true,
    "show_publish_wecom": true,
    "show_publish_offiaccount": true
  }
}
```

### 6.2 飞书数据集配置

```typescript
// 数据集 Schema
{
  feishuServer: {
    appId: string,
    appSecret: string,
    folderToken: string  // 云文档文件夹 Token
  }
}
```

## 七、审计日志

```typescript
// packages/service/support/user/audit/util.ts
if (type === DatasetTypeEnum.feishu) 
  return i18nT('account_team:dataset.feishu_dataset');
```

## 八、最佳实践

1. **飞书知识库同步**
   - 定期同步云文档内容
   - 支持增量更新
   - 自动处理文档权限

2. **机器人配置**
   - 使用 Webhook 接收消息
   - 配置事件订阅
   - 设置消息加密

3. **多平台支持**
   - 统一的消息处理接口
   - 平台特定的消息格式转换
   - 统一的日志记录

## 九、相关文件

### 飞书集成
- `packages/service/core/dataset/apiDataset/feishuDataset/api.ts`
- `packages/service/core/dataset/schema.ts`
- `packages/service/common/system/log.ts`

### 图标资源
- `packages/web/components/common/Icon/icons/core/app/templates/plugin-feishu.svg`
- `packages/web/components/common/Icon/icons/core/dataset/feishuDatasetColor.svg`
- `packages/web/components/common/Icon/icons/common/wecom.svg`
- `packages/web/components/common/Icon/icons/common/dingtalkFill.svg`
