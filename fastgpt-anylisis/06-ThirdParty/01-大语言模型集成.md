# 大语言模型（LLM）集成

FastGPT 支持多种 LLM 提供商的集成，为应用提供强大的自然语言处理能力。

## 一、支持的 LLM 提供商

### 1. OpenAI
FastGPT 原生支持 OpenAI 的各种模型，包括：
- GPT-3.5
- GPT-4
- GPT-4 Turbo
- Function Calling 能力

### 2. OneAPI（统一 API 网关）
通过 OneAPI 可以接入多种 LLM 提供商：
- Anthropic Claude
- Azure OpenAI
- Google Gemini
- 百度文心一言
- 智谱 AI (ChatGLM)
- 阿里通义千问 (Qwen)
- Minimax
- DeepSeek
- 其他兼容 OpenAI API 格式的模型

### 3. 自部署模型（插件方式）
在 `plugins/model/` 目录下支持：
- `llm-Baichuan2` - 百川大模型
- `llm-ChatGLM2` - 智谱 ChatGLM

## 二、集成架构

### 2.1 核心配置文件

#### 环境变量配置（`packages/service/core/ai/config.ts`）

```typescript
// OpenAI 配置
OPENAI_BASE_URL        // OpenAI API 端点
CHAT_API_KEY           // API 密钥
AIPROXY_API_ENDPOINT   // AIProxy 端点（可选）

// OneAPI 配置（通过系统环境）
oneapiUrl              // OneAPI 统一网关地址
chatApiKey             // OneAPI 密钥
```

#### 系统环境类型定义（`packages/global/common/system/types/index.d.ts`）

```typescript
export type SystemEnvType = {
  oneapiUrl?: string;
  chatApiKey?: string;
  // ... 其他配置
};
```

### 2.2 外部提供商机制（ExternalProvider）

FastGPT 支持三种级别的 API 密钥配置：

#### 1. 团队级别配置

```typescript
// packages/service/support/user/team/teamSchema.ts
openaiAccount?: {
  key: string;      // OpenAI API Key
  baseUrl: string;  // API 端点
}
```

**特性**：
- 团队管理员可配置自己的 OpenAI 账号
- 使用自定义 API Key 时，消耗点数为 0（免费）
- 配置路径：`packages/service/support/user/team/controller.ts::updateTeam()`

#### 2. 工作流级别配置

通过 `externalProviderWorkflowVariables` 传递 API 配置：

```typescript
externalProvider: {
  openaiAccount?: {
    key: string;
    baseUrl: string;
  }
}
```

#### 3. 全局系统配置

通过环境变量配置默认的 API 密钥和端点。

### 2.3 AI 调度集成点

所有 AI 相关的工作流节点都支持 ExternalProvider：

| 文件路径 | 功能 | 支持 ExternalProvider |
|---------|------|----------------------|
| `packages/service/core/workflow/dispatch/ai/chat.ts` | 对话生成 | ✅ |
| `packages/service/core/workflow/dispatch/ai/classifyQuestion.ts` | 问题分类 | ✅ |
| `packages/service/core/workflow/dispatch/ai/extract.ts` | 信息提取 | ✅ |
| `packages/service/core/workflow/dispatch/ai/tool/index.ts` | 工具调用（Function Calling） | ✅ |

**核心逻辑**：

```typescript
// packages/service/core/ai/config.ts
export const getAIApi = ({
  userKey,
  timeout = 60000
}: {
  userKey?: UserKeyType;
  timeout?: number;
} = {}) => {
  const baseURL = userKey?.baseUrl || process.env.OPENAI_BASE_URL;
  const key = userKey?.key || process.env.CHAT_API_KEY;
  
  return new OpenAI({
    apiKey: key,
    baseURL: baseURL,
    timeout: timeout,
    httpAgent: getAxiosConfig()
  });
};
```

### 2.4 模型管理系统

#### 模型映射表（`packages/service/core/ai/type.d.ts`）

```typescript
declare global {
  var chatModelMap: Map<string, LLMModelItemType>;
  var functionModelMap: Map<string, FunctionModelItemType>;
  var embeddingModelMap: Map<string, EmbeddingModelItemType>;
  var ttsModelMap: Map<string, TTSModelType>;
  var sttModelMap: Map<string, STTModelType>;
  var reRankModelMap: Map<string, RerankModelItemType>;
}
```

#### 模型配置加载（`packages/service/core/ai/config/utils.ts`）

系统启动时从配置文件加载所有模型定义，构建模型映射表。

#### 模型提供商格式化（`packages/global/core/ai/provider.ts`）

```typescript
export const formatModelProviders = (
  models: LLMModelItemType[]
): ModelProviderItemType[] => {
  // 按提供商分组模型
  // 返回结构化的提供商列表
};
```

## 三、API 密钥权限管理

### 3.1 API Key 类型

FastGPT 支持创建 API Key 用于外部调用：

```typescript
// packages/global/support/permission/type.d.ts
TeamPerList.apikeyCreate    // 创建 API Key 权限
TeamRoleList.apikeyCreate   // 角色级别权限
```

### 3.2 API Key 审计事件

```typescript
// packages/global/support/permission/auditEvent/constants.ts
CREATE_API_KEY    // 创建 API Key
UPDATE_API_KEY    // 更新 API Key  
DELETE_API_KEY    // 删除 API Key
```

### 3.3 发布渠道

```typescript
// packages/global/core/app/constants.ts
PublishChannelEnum.apikey   // 通过 API Key 访问应用
```

## 四、计费与使用统计

### 4.1 计费规则

```typescript
// packages/service/core/workflow/dispatch/ai/chat.ts
if (externalProvider?.openaiAccount?.key) {
  // 使用自定义 API Key，不消耗系统点数
  points = 0;
} else {
  // 使用系统 API，按配置计费
  points = calculateTokenCost(tokens, model);
}
```

### 4.2 使用来源跟踪

```typescript
UsageSourceEnum.api    // 通过 API 调用
UsageSourceEnum.share  // 分享页面调用
UsageSourceEnum.trial  // 试用调用
```

## 五、错误处理

### 5.1 OpenAPI 错误码（`packages/global/common/error/code/openapi.ts`）

```typescript
export enum OpenApiErrEnum {
  apiKeyInvalid = 'apiKeyInvalid',
  apiKeyExpired = 'apiKeyExpired',
  rateLimitExceeded = 'rateLimitExceeded',
  // ... 其他错误
}
```

### 5.2 重试机制

AI 调用支持自动重试，配置在 `@fastgpt/global/common/system/utils::retryFn()`。

## 六、配置示例

### 6.1 使用系统默认配置

```bash
# config.json
{
  "systemEnv": {
    "oneapiUrl": "https://api.oneapi.com",
    "chatApiKey": "sk-xxxx"
  }
}
```

### 6.2 使用团队自定义配置

```typescript
// 团队设置
await updateTeam({
  teamId: "xxx",
  openaiAccount: {
    key: "sk-team-custom-key",
    baseUrl: "https://api.openai.com/v1"
  }
});
```

### 6.3 工作流级别配置

```typescript
// 工作流变量
{
  "externalProvider": {
    "openaiAccount": {
      "key": "sk-workflow-key",
      "baseUrl": "https://custom-endpoint.com"
    }
  }
}
```

## 七、模型选择优先级

1. **工作流级别** ExternalProvider（最高优先级）
2. **团队级别** OpenAI Account
3. **系统级别** 默认配置

## 八、OpenAPI Schema 支持

### 8.1 HTTP 工具集成

FastGPT 支持通过 OpenAPI Schema 定义 HTTP 工具：

```typescript
// packages/global/support/openapi/utils/jsonschema.ts
import SwaggerParser from '@apidevtools/swagger-parser';

// 解析 OpenAPI Schema
const api = await SwaggerParser.parse(apiSchemaStr);
```

### 8.2 HTTP 节点配置

```typescript
// HTTP 工具配置
{
  apiSchemaStr: string;  // OpenAPI Schema JSON
  // 自动生成工具调用配置
}
```

## 九、监控与日志

### 9.1 模型调用日志

所有 AI 调用都会记录到 MongoDB Log 数据库：
- 请求参数
- 响应内容
- Token 消耗
- 耗时统计
- 错误信息

### 9.2 性能指标

- Token 使用量统计
- API 调用延迟
- 错误率监控
- 成本分析

## 十、最佳实践

1. **使用 OneAPI 统一管理多个模型提供商**
2. **为不同团队配置独立的 API Key**
3. **启用 API Key 审计日志**
4. **设置合理的速率限制**
5. **定期检查 Token 消耗和成本**
6. **配置错误告警机制**

## 十一、相关文件清单

### 核心配置
- `packages/service/core/ai/config.ts` - AI 配置和初始化
- `packages/service/core/ai/model.ts` - 模型获取方法
- `packages/global/core/ai/provider.ts` - 模型提供商格式化

### 工作流调度
- `packages/service/core/workflow/dispatch/ai/chat.ts` - 对话节点
- `packages/service/core/workflow/dispatch/ai/classifyQuestion.ts` - 分类节点
- `packages/service/core/workflow/dispatch/ai/extract.ts` - 提取节点
- `packages/service/core/workflow/dispatch/ai/tool/index.ts` - 工具节点

### 团队管理
- `packages/service/support/user/team/teamSchema.ts` - 团队 Schema
- `packages/service/support/user/team/controller.ts` - 团队控制器
- `packages/service/support/user/team/utils.ts` - 团队工具方法

### 权限与审计
- `packages/global/support/permission/type.d.ts` - 权限定义
- `packages/global/support/permission/auditEvent/constants.ts` - 审计事件

### 错误处理
- `packages/global/common/error/code/openapi.ts` - OpenAPI 错误码
