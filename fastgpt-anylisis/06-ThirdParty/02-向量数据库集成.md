# 向量数据库集成

FastGPT 支持多种向量数据库用于知识库的向量存储和相似度检索。

## 一、支持的向量数据库

| 数据库 | 状态 | 推荐场景 |
|--------|------|----------|
| **PostgreSQL + PGVector** | ✅ 生产推荐 | 中小型部署，统一数据管理 |
| **Milvus** | ✅ 生产推荐 | 大规模向量检索，高性能要求 |
| **OceanBase** | ✅ 支持 | 分布式场景，阿里云生态 |

## 二、PostgreSQL + PGVector 集成

### 2.1 环境配置

```bash
# 环境变量
PG_ADDRESS=postgres://username:password@host:5432/database

# 连接池配置
DB_MAX_LINK=20    # 最大连接数
```

### 2.2 核心实现

#### 连接管理（`packages/service/common/vectorDB/pg/controller.ts`）

```typescript
import { Pool } from 'pg';

declare global {
  var pgClient: Pool | null;
}

export const connectPg = async (): Promise<Pool> => {
  if (global.pgClient) return global.pgClient;
  
  global.pgClient = new Pool({
    connectionString: PG_ADDRESS,
    max: Number(process.env.DB_MAX_LINK || 20),
    idleTimeoutMillis: 30000,
    connectionTimeoutMillis: 5000,
  });
  
  await global.pgClient.connect();
  console.log('PostgreSQL connected');
  
  return global.pgClient;
};
```

#### 向量操作接口

```typescript
// 插入向量
async insertVector({
  collectionId: string;
  vectorData: {
    id: string;
    vector: number[];
    metadata: Record<string, any>;
  }[];
}): Promise<void>

// 向量检索
async recallVector({
  collectionId: string;
  vector: number[];
  limit: number;
  filterConditions?: Record<string, any>;
}): Promise<{
  id: string;
  score: number;
  metadata: Record<string, any>;
}[]>

// 删除向量
async deleteVector({
  collectionId: string;
  ids: string[];
}): Promise<void>
```

### 2.3 数据表结构

```sql
-- 向量数据表
CREATE TABLE dataset_vectors (
  id TEXT PRIMARY KEY,
  collection_id TEXT NOT NULL,
  vector vector(1536),  -- PGVector 扩展类型
  metadata JSONB,
  created_at TIMESTAMP DEFAULT NOW()
);

-- 创建向量索引
CREATE INDEX idx_vector_similarity 
ON dataset_vectors 
USING ivfflat (vector vector_cosine_ops)
WITH (lists = 100);
```

### 2.4 HNSW 参数配置

```typescript
// packages/global/common/system/types/index.d.ts
export type SystemEnvType = {
  hnswEfSearch: number;        // HNSW 搜索参数
  hnswMaxScanTuples: number;   // 最大扫描元组数
};
```

## 三、Milvus 集成

### 3.1 环境配置

```bash
# 环境变量
MILVUS_ADDRESS=http://milvus:19530
MILVUS_TOKEN=root:Milvus      # 可选，用于认证
```

### 3.2 核心实现

#### 连接管理（`packages/service/common/vectorDB/milvus/index.ts`）

```typescript
import { MilvusClient, DataType } from '@zilliz/milvus2-sdk-node';

declare global {
  var milvusClient: MilvusClient | null;
}

export class MilvusCtrl {
  getClient = async (): Promise<MilvusClient> => {
    if (!MILVUS_ADDRESS) {
      return Promise.reject('MILVUS_ADDRESS is not set');
    }
    
    if (global.milvusClient) return global.milvusClient;
    
    global.milvusClient = new MilvusClient({
      address: MILVUS_ADDRESS,
      token: MILVUS_TOKEN
    });
    
    await global.milvusClient.connectPromise;
    console.log('Milvus connected');
    
    return global.milvusClient;
  };
  
  init = async () => {
    const client = await this.getClient();
    
    // 检查集合是否存在
    const hasCollection = await client.hasCollection({
      collection_name: DatasetVectorTableName
    });
    
    if (!hasCollection) {
      // 创建集合
      await client.createCollection({
        collection_name: DatasetVectorTableName,
        fields: [
          {
            name: 'id',
            data_type: DataType.VarChar,
            is_primary_key: true,
            max_length: 128
          },
          {
            name: 'vector',
            data_type: DataType.FloatVector,
            dim: 1536
          },
          {
            name: 'metadata',
            data_type: DataType.JSON
          }
        ]
      });
      
      console.log('Create milvus collection:', DatasetVectorTableName);
    }
    
    // 加载集合到内存
    const { state } = await client.getLoadState({
      collection_name: DatasetVectorTableName
    });
    
    if (state !== LoadState.LoadStateLoaded) {
      await client.loadCollection({
        collection_name: DatasetVectorTableName
      });
    }
  };
}
```

### 3.3 向量操作

```typescript
// 插入向量
async insertData({
  data: {
    id: string;
    vector: number[];
    metadata: any;
  }[]
}): Promise<void> {
  await client.insert({
    collection_name: DatasetVectorTableName,
    data: data
  });
}

// 向量检索
async search({
  vector: number[];
  limit: number;
  filter?: string;
}): Promise<SearchResult[]> {
  const result = await client.search({
    collection_name: DatasetVectorTableName,
    vector: vector,
    limit: limit,
    filter: filter,
    output_fields: ['id', 'metadata']
  });
  
  return result;
}
```

## 四、OceanBase 集成

### 4.1 环境配置

```bash
OCEANBASE_ADDRESS=mysql://user:password@host:2881/database
```

### 4.2 核心实现（`packages/service/common/vectorDB/oceanbase/controller.ts`）

```typescript
import mysql, { Pool as MysqlPool } from 'mysql2/promise';

declare global {
  var obClient: MysqlPool | null;
}

export const connectOceanBase = async (): Promise<MysqlPool> => {
  if (global.obClient) return global.obClient;
  
  global.obClient = mysql.createPool({
    uri: OCEANBASE_ADDRESS,
    waitForConnections: true,
    connectionLimit: Number(process.env.DB_MAX_LINK || 20),
    queueLimit: 0
  });
  
  return global.obClient;
};
```

### 4.3 向量检索实现

OceanBase 使用 MySQL 兼容的向量函数进行相似度计算：

```typescript
async recallVector({
  collectionId,
  vector,
  limit
}: {
  collectionId: string;
  vector: number[];
  limit: number;
}): Promise<SearchResult[]> {
  const [rows] = await obClient.query<RowDataPacket[]>(
    `
    SELECT 
      id,
      metadata,
      1 - (vector <=> ?) as score
    FROM dataset_vectors
    WHERE collection_id = ?
    ORDER BY vector <=> ?
    LIMIT ?
    `,
    [JSON.stringify(vector), collectionId, JSON.stringify(vector), limit]
  );
  
  return rows;
}
```

## 五、统一向量数据库接口

### 5.1 控制器选择（`packages/service/common/vectorDB/controller.ts`）

```typescript
import { MILVUS_ADDRESS, PG_ADDRESS, OCEANBASE_ADDRESS } from './constants';
import { MilvusCtrl } from './milvus';
import { PgCtrl } from './pg';
import { OceanBaseCtrl } from './oceanbase';

// 根据配置选择向量数据库
export const getVectorDB = () => {
  if (MILVUS_ADDRESS) {
    return new MilvusCtrl();
  }
  if (PG_ADDRESS) {
    return new PgCtrl();
  }
  if (OCEANBASE_ADDRESS) {
    return new OceanBaseCtrl();
  }
  
  throw new Error('No vector database configured');
};
```

### 5.2 统一接口定义

```typescript
export interface VectorDBInterface {
  // 初始化
  init(): Promise<void>;
  
  // 插入向量
  insertVector(params: InsertVectorParams): Promise<void>;
  
  // 向量检索（召回）
  recallVector(params: RecallVectorParams): Promise<RecallResult[]>;
  
  // 删除向量
  deleteVector(params: DeleteVectorParams): Promise<void>;
  
  // 更新向量
  updateVector(params: UpdateVectorParams): Promise<void>;
}
```

## 六、缓存机制

### 6.1 Redis 缓存集成

向量检索结果支持 Redis 缓存：

```typescript
// packages/service/common/vectorDB/controller.ts
import {
  setRedisCache,
  getRedisCache,
  delRedisCache,
  CacheKeyEnum
} from '../redis/cache';

// 缓存向量计数
export const cacheTeamVectorCount = async (teamId: string, count: number) => {
  await setRedisCache(
    `${CacheKeyEnum.team_vector_count}:${teamId}`,
    String(count),
    CacheKeyEnumTime.team_vector_count
  );
};

// 获取缓存的向量计数
export const getCachedTeamVectorCount = async (teamId: string) => {
  const cached = await getRedisCache(
    `${CacheKeyEnum.team_vector_count}:${teamId}`
  );
  return cached ? parseInt(cached) : null;
};
```

## 七、数据表结构

### 7.1 集合（Collection）定义

```typescript
// packages/service/common/vectorDB/constants.ts
export const DatasetVectorDbName = 'fastgpt_vectors';
export const DatasetVectorTableName = 'dataset_vectors';
```

### 7.2 向量数据结构

```typescript
export type EmbeddingRecallItemType = {
  id: string;                    // 向量唯一 ID
  collectionId: string;          // 集合 ID
  datasetId: string;             // 数据集 ID
  vector: number[];              // 向量数据
  score: number;                 // 相似度分数
  
  // 元数据
  q: string;                     // 问题文本
  a: string;                     // 答案文本
  indexes: DatasetIndexItemType[]; // 索引信息
};
```

## 八、向量检索流程

### 8.1 检索参数

```typescript
export type EmbeddingRecallCtrlProps = {
  collectionId: string;
  vector: number[];
  limit: number;
  minScore?: number;          // 最小相似度阈值
  filterConditions?: {
    datasetIds?: string[];    // 过滤数据集
    tags?: string[];          // 过滤标签
  };
};
```

### 8.2 检索优化

```typescript
// 1. 先从缓存获取
const cached = await getCachedVectorResult(cacheKey);
if (cached) return cached;

// 2. 向量数据库检索
const results = await vectorDB.recallVector({
  collectionId,
  vector,
  limit: limit * 2  // 预检索更多结果
});

// 3. 应用业务过滤和重排序
const filtered = results
  .filter(item => item.score >= minScore)
  .slice(0, limit);

// 4. 缓存结果
await setRedisCache(cacheKey, filtered, 300);

return filtered;
```

## 九、性能优化配置

### 9.1 连接池配置

```bash
DB_MAX_LINK=20              # 最大数据库连接数
```

### 9.2 并发控制

```typescript
// packages/global/common/system/types/index.d.ts
export type SystemEnvType = {
  vectorMaxProcess: number;   // 向量化最大并发数
};
```

### 9.3 索引优化

**PostgreSQL PGVector:**
```sql
-- IVFFlat 索引（适合大规模数据）
CREATE INDEX idx_vector_ivfflat 
ON dataset_vectors 
USING ivfflat (vector vector_cosine_ops)
WITH (lists = 100);

-- HNSW 索引（更高精度）
CREATE INDEX idx_vector_hnsw 
ON dataset_vectors 
USING hnsw (vector vector_cosine_ops)
WITH (m = 16, ef_construction = 64);
```

**Milvus:**
```typescript
// 创建 IVF_FLAT 索引
await client.createIndex({
  collection_name: DatasetVectorTableName,
  field_name: 'vector',
  index_type: 'IVF_FLAT',
  metric_type: 'COSINE',
  params: { nlist: 128 }
});
```

## 十、监控与维护

### 10.1 向量数据统计

```typescript
// 获取团队向量总数
export const getTeamVectorCount = async (teamId: string): Promise<number> => {
  // 尝试从缓存获取
  const cached = await getCachedTeamVectorCount(teamId);
  if (cached !== null) return cached;
  
  // 从数据库查询
  const count = await vectorDB.countVectors({ teamId });
  
  // 更新缓存
  await cacheTeamVectorCount(teamId, count);
  
  return count;
};
```

### 10.2 健康检查

```typescript
export const checkVectorDBHealth = async (): Promise<boolean> => {
  try {
    const vectorDB = getVectorDB();
    await vectorDB.init();
    return true;
  } catch (error) {
    console.error('Vector DB health check failed:', error);
    return false;
  }
};
```

## 十一、迁移与备份

### 11.1 数据迁移工具

FastGPT 支持在不同向量数据库之间迁移数据：

```bash
# 从 PostgreSQL 迁移到 Milvus
npm run migrate:vector -- --from=pg --to=milvus
```

### 11.2 备份策略

- **PostgreSQL**: 使用 pg_dump 备份
- **Milvus**: 使用 Milvus backup 工具
- **OceanBase**: 使用 mysqldump 兼容工具

## 十二、最佳实践

1. **中小型部署**：使用 PostgreSQL + PGVector
   - 简化架构，统一数据管理
   - 降低运维复杂度
   
2. **大规模部署**：使用 Milvus
   - 支持亿级向量检索
   - 提供更好的性能和扩展性

3. **向量维度选择**：
   - 1536 维：OpenAI text-embedding-ada-002
   - 768 维：BGE 等开源模型

4. **索引策略**：
   - 小于 100 万条：使用 HNSW 索引
   - 大于 100 万条：使用 IVF 索引

5. **缓存策略**：
   - 热点数据缓存到 Redis
   - 设置合理的 TTL（5-10 分钟）

## 十三、相关文件清单

### 核心接口
- `packages/service/common/vectorDB/controller.ts` - 统一控制器
- `packages/service/common/vectorDB/type.d.ts` - 类型定义
- `packages/service/common/vectorDB/constants.ts` - 常量配置

### PostgreSQL 实现
- `packages/service/common/vectorDB/pg/index.ts` - PG 实现
- `packages/service/common/vectorDB/pg/controller.ts` - 连接管理

### Milvus 实现
- `packages/service/common/vectorDB/milvus/index.ts` - Milvus 实现
- `packages/service/common/vectorDB/milvus/controller.ts` - 连接管理

### OceanBase 实现
- `packages/service/common/vectorDB/oceanbase/index.ts` - OB 实现
- `packages/service/common/vectorDB/oceanbase/controller.ts` - 连接管理

### 缓存集成
- `packages/service/common/redis/cache.ts` - Redis 缓存
