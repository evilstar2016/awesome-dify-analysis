# AI 增强服务集成

FastGPT 集成了多种 AI 增强服务，提供语音、OCR、重排序等能力。

## 一、支持的 AI 服务

| 服务类型 | 状态 | 用途 |
|---------|------|------|
| **TTS（文字转语音）** | ✅ | 语音合成 |
| **STT（语音转文字）** | ✅ | 语音识别 |
| **OCR** | ✅ | 文字识别 |
| **Rerank** | ✅ | 搜索结果重排序 |

## 二、TTS（Text-to-Speech）集成

### 2.1 模型管理

```typescript
// packages/service/core/ai/type.d.ts
declare global {
  var ttsModelMap: Map<string, TTSModelType>;
  var systemDefaultModel: {
    tts?: TTSModelType;
  };
}
```

### 2.2 核心实现（`packages/service/core/ai/audio/speech.ts`）

```typescript
export const audio2Text = async ({
  input,
  model,
  voice,
  speed = 1
}: {
  input: string;
  model: string;
  voice: string;
  speed?: number;
}) => {
  const ai = getAIApi();
  const response = await ai.audio.speech.create(
    {
      model,
      // @ts-ignore
      voice,
      input,
      response_format: 'mp3',
      speed
    }
  );
  
  return response;
};
```

### 2.3 模型获取

```typescript
// packages/service/core/ai/model.ts
export const getDefaultTTSModel = () => global?.systemDefaultModel.tts!;

export function getTTSModel(model?: string) {
  if (!model) return getDefaultTTSModel();
  return global.ttsModelMap.get(model) || getDefaultTTSModel();
}
```

### 2.4 插件支持

```
plugins/model/
└── tts-cosevoice/    # CosyVoice TTS 插件
```

## 三、STT（Speech-to-Text）集成

### 3.1 模型管理

```typescript
declare global {
  var sttModelMap: Map<string, STTModelType>;
  var systemDefaultModel: {
    stt?: STTModelType;
  };
}
```

### 3.2 核心实现（`packages/service/core/ai/audio/transcriptions.ts`）

```typescript
export const audioTranscriptions = async ({
  file,
  model
}: {
  file: Buffer;
  model: string;
}): Promise<string> => {
  const aiAxiosConfig = getAIApi();
  
  const form = new FormData();
  form.append('file', new Blob([file]), 'audio.mp3');
  form.append('model', model);
  
  const response = await axios.post(
    aiAxiosConfig.baseUrl + '/audio/transcriptions',
    form,
    {
      headers: {
        'Authorization': `Bearer ${aiAxiosConfig.apiKey}`,
        ...form.getHeaders()
      }
    }
  );
  
  return response.data.text;
};
```

### 3.3 插件支持

```
plugins/model/
└── stt-sensevoice/   # SenseVoice STT 插件
```

## 四、OCR 集成

### 4.1 插件支持

```
plugins/model/
└── ocr-surya/        # Surya OCR 插件
    ├── Dockerfile
    ├── requirements.txt
    └── app.py
```

### 4.2 OCR 特性

- **多语言支持**：中文、英文、日文等
- **表格识别**：结构化表格提取
- **布局分析**：文档版面分析
- **手写识别**：手写文字识别

## 五、Rerank（重排序）集成

### 5.1 模型管理

```typescript
declare global {
  var reRankModelMap: Map<string, RerankModelItemType>;
  var systemDefaultModel: {
    rerank?: RerankModelItemType;
  };
}
```

### 5.2 Rerank 用途

在知识库检索中使用，对初步召回的结果进行重排序：

```typescript
// 1. 向量检索召回
const recallResults = await vectorDB.recallVector({
  vector: queryVector,
  limit: 100  // 召回更多候选
});

// 2. Rerank 重排序
const reranked = await rerankModel.rerank({
  query: userQuery,
  documents: recallResults.map(r => r.text),
  topK: 10  // 最终返回 top 10
});

return reranked;
```

### 5.3 插件支持

```
plugins/model/
└── rerank-bge/       # BGE Reranker 插件
```

## 六、模型配置系统

### 6.1 模型初始化（`packages/service/core/ai/config/utils.ts`）

```typescript
export const initAIModels = async () => {
  let _ttsModelMap = new Map<string, TTSModelType>();
  let _sttModelMap = new Map<string, STTModelType>();
  let _reRankModelMap = new Map<string, RerankModelItemType>();
  let _systemDefaultModel: SystemDefaultModelType = {};
  
  // 从配置文件加载模型
  const models = await loadModelsFromConfig();
  
  for (const model of models) {
    if (model.type === ModelTypeEnum.tts) {
      _ttsModelMap.set(model.model, model);
      _ttsModelMap.set(model.name, model);
      if (model.isDefault) {
        _systemDefaultModel.tts = model;
      }
    } else if (model.type === ModelTypeEnum.stt) {
      _sttModelMap.set(model.model, model);
      _sttModelMap.set(model.name, model);
      if (model.isDefault) {
        _systemDefaultModel.stt = model;
      }
    } else if (model.type === ModelTypeEnum.rerank) {
      _reRankModelMap.set(model.model, model);
      _reRankModelMap.set(model.name, model);
      if (model.isDefault) {
        _systemDefaultModel.rerank = model;
      }
    }
  }
  
  // 如果没有指定默认模型，使用第一个
  if (!_systemDefaultModel.tts) {
    _systemDefaultModel.tts = Array.from(_ttsModelMap.values())[0];
  }
  if (!_systemDefaultModel.stt) {
    _systemDefaultModel.stt = Array.from(_sttModelMap.values())[0];
  }
  if (!_systemDefaultModel.rerank) {
    _systemDefaultModel.rerank = Array.from(_reRankModelMap.values())[0];
  }
  
  // 设置全局变量
  global.ttsModelMap = _ttsModelMap;
  global.sttModelMap = _sttModelMap;
  global.reRankModelMap = _reRankModelMap;
  global.systemDefaultModel = _systemDefaultModel;
};
```

### 6.2 模型类型

```typescript
export enum ModelTypeEnum {
  llm = 'llm',           // 大语言模型
  embedding = 'embedding', // 向量模型
  tts = 'tts',           // 语音合成
  stt = 'stt',           // 语音识别
  rerank = 'rerank'      // 重排序
}
```

## 七、插件架构

### 7.1 插件目录结构

```
plugins/model/
├── tts-cosevoice/
│   ├── Dockerfile
│   ├── requirements.txt
│   ├── app.py
│   └── README.md
├── stt-sensevoice/
│   ├── Dockerfile
│   ├── requirements.txt
│   ├── app.py
│   └── README.md
├── ocr-surya/
│   ├── Dockerfile
│   ├── requirements.txt
│   ├── app.py
│   └── README.md
└── rerank-bge/
    ├── Dockerfile
    ├── requirements.txt
    ├── app.py
    └── README.md
```

### 7.2 插件集成方式

插件通过 HTTP API 方式与 FastGPT 集成：

```typescript
// 配置插件 API 端点
{
  "model": {
    "name": "custom-tts",
    "type": "tts",
    "baseUrl": "http://tts-plugin:8000",
    "apiKey": "plugin-api-key"
  }
}
```

## 八、使用场景

### 8.1 TTS 应用场景

- 对话应用语音播报
- 客服机器人语音回复
- 无障碍阅读支持

### 8.2 STT 应用场景

- 语音输入对话
- 语音命令控制
- 会议记录转写

### 8.3 OCR 应用场景

- 扫描文档识别
- 图片文字提取
- 表单自动化处理

### 8.4 Rerank 应用场景

- 知识库检索优化
- 文档相关性排序
- 搜索结果优化

## 九、配置示例

### 9.1 配置 TTS 模型

```json
{
  "models": [
    {
      "model": "tts-1",
      "name": "OpenAI TTS",
      "type": "tts",
      "baseUrl": "https://api.openai.com/v1",
      "apiKey": "sk-xxx",
      "isDefault": true,
      "voices": ["alloy", "echo", "fable", "onyx", "nova", "shimmer"]
    }
  ]
}
```

### 9.2 配置 STT 模型

```json
{
  "models": [
    {
      "model": "whisper-1",
      "name": "OpenAI Whisper",
      "type": "stt",
      "baseUrl": "https://api.openai.com/v1",
      "apiKey": "sk-xxx",
      "isDefault": true
    }
  ]
}
```

### 9.3 配置 Rerank 模型

```json
{
  "models": [
    {
      "model": "bge-reranker-v2-m3",
      "name": "BGE Reranker",
      "type": "rerank",
      "baseUrl": "http://rerank-service:8000",
      "isDefault": true
    }
  ]
}
```

## 十、最佳实践

1. **模型选择**
   - TTS: 根据语言和场景选择合适的音色
   - STT: 选择支持目标语言的模型
   - Rerank: 使用与 Embedding 模型匹配的 Rerank 模型

2. **性能优化**
   - TTS: 缓存常用语音
   - STT: 音频预处理和压缩
   - OCR: 图片预处理提高识别率
   - Rerank: 合理设置召回和重排序的数量

3. **成本优化**
   - 使用开源插件降低成本
   - 缓存重复请求结果
   - 按需启用服务

4. **质量优化**
   - TTS: 调整语速和音调
   - STT: 降噪和音频增强
   - OCR: 图片二值化和去噪
   - Rerank: A/B 测试不同模型

## 十一、相关文件清单

### 核心实现
- `packages/service/core/ai/model.ts` - 模型获取
- `packages/service/core/ai/type.d.ts` - 类型定义
- `packages/service/core/ai/config/utils.ts` - 模型初始化

### TTS
- `packages/service/core/ai/audio/speech.ts` - TTS 实现

### STT
- `packages/service/core/ai/audio/transcriptions.ts` - STT 实现

### 插件
- `plugins/model/tts-cosevoice/` - TTS 插件
- `plugins/model/stt-sensevoice/` - STT 插件
- `plugins/model/ocr-surya/` - OCR 插件
- `plugins/model/rerank-bge/` - Rerank 插件
