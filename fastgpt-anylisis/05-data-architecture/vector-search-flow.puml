@startuml FastGPT_Vector_Search_Flow

title FastGPT 向量检索数据流

skinparam ActivityBackgroundColor #E6F7FF
skinparam ActivityBorderColor #0066CC
skinparam NoteBackgroundColor #FFF9E6

|用户|
start
:输入查询问题;

|API层|
:接收查询请求;
:验证 teamId & datasetId;

|服务层|
partition "查询预处理" {
  :问题扩展(可选);
  note right
    使用LLM扩展查询
    生成多个查询变体
  end note
  
  :文本向量化;
  note right
    调用 Embedding API
    model: text-embedding-3-small
    生成 1536 维向量
  end note
}

|向量数据库|
partition "向量检索" {
  :余弦相似度搜索;
  note right
    SELECT data_id, 
           1 - (vector <=> query_vector) as score
    FROM dataset_vector
    WHERE dataset_id = ?
    ORDER BY vector <=> query_vector
    LIMIT ?
  end note
  
  :返回 Top-K 结果;
  note right
    返回格式:
    [
      {data_id: "xxx", score: 0.95},
      {data_id: "yyy", score: 0.88},
      ...
    ]
  end note
}

|MongoDB|
partition "获取原始数据" {
  :批量查询数据块;
  note right
    db.dataset_datas.find({
      'indexes.dataId': { $in: dataIds }
    })
  end note
  
  :返回数据块详情;
  note right
    包含:
    - q: 问题/标题
    - a: 答案/内容
    - collectionId
    - metadata
  end note
}

|服务层|
partition "结果处理" {
  :分数过滤;
  note right
    过滤掉低于阈值的结果
    默认: score >= 0.5
  end note
  
  :结果排序;
  
  if (启用重排序?) then (yes)
    partition "Rerank" {
      :调用 Rerank 模型;
      note right
        使用 BGE-Reranker 等
        重新计算相关性分数
      end note
      :按新分数排序;
    }
  endif
  
  :截断到 Top-N;
  note right
    取前 N 个结果
    用于后续 LLM 调用
  end note
}

|用户|
:返回检索结果;
stop

legend right
  **向量检索流程说明**
  1. 问题向量化使用相同的 Embedding 模型
  2. 向量检索使用余弦相似度
  3. 可选的 Rerank 步骤提升准确性
  4. 支持混合检索（向量+全文）
endlegend

@enduml
