@startuml FastGPT_Data_Architecture

!define MONGODB #FFE6E6
!define VECTORDB #E6F3FF
!define REDIS #FFE6CC
!define MINIO #E6FFE6

title FastGPT 数据架构图

skinparam componentStyle rectangle
skinparam linetype ortho

' 应用层
package "应用层" {
    [Web UI] as WebUI
    [API Routes] as API
    [Business Service] as Service
}

' 数据访问层
package "数据访问层" {
    [Mongoose ORM] as Mongoose
    [Vector Controller] as VectorCtrl
    [Redis Client] as RedisClient
    [S3 Client] as S3Client
}

' 数据持久化层
package "数据持久化层" {
    
    ' MongoDB
    package "MongoDB" MONGODB {
        database "主库" as MongoDB {
            collections "users" as Users
            collections "teams" as Teams
            collections "team_members" as TeamMembers
            collections "apps" as Apps
            collections "app_versions" as AppVersions
            collections "datasets" as Datasets
            collections "dataset_collections" as DatasetCollections
            collections "dataset_datas" as DatasetDatas
            collections "dataset_trainings" as DatasetTrainings
            collections "chats" as Chats
            collections "chat_items" as ChatItems
            collections "system_configs" as SystemConfigs
        }
        
        database "日志库" as MongoLog {
            collections "system_logs" as SystemLogs
            collections "chat_logs" as ChatLogs
        }
    }
    
    ' 向量数据库
    package "向量数据库" VECTORDB {
        database "PGVector/Milvus/OceanBase" as VectorDB {
            collections "dataset_vector" as Vectors
        }
    }
    
    ' Redis
    package "Redis" REDIS {
        database "缓存 & 队列" as Redis {
            frame "缓存" {
                [system_config]
                [models]
                [team_cache]
                [user_cache]
                [session]
            }
            frame "任务队列(BullMQ)" {
                queue "trainingQueue" as TrainQ
                queue "evalQueue" as EvalQ
            }
            frame "分布式锁" {
                [locks]
            }
        }
    }
    
    ' MinIO/S3
    package "对象存储" MINIO {
        storage "MinIO/S3" as S3 {
            folder "fastgpt-avatar" as AvatarBucket
            folder "fastgpt-chat" as ChatBucket
            folder "fastgpt-dataset" as DatasetBucket
            folder "fastgpt-temp" as TempBucket
            folder "fastgpt-plugin" as PluginBucket
        }
    }
}

' 应用层连接
WebUI --> API
API --> Service

' 数据访问层连接
Service --> Mongoose
Service --> VectorCtrl
Service --> RedisClient
Service --> S3Client

' 数据访问层到持久化层
Mongoose --> MongoDB
Mongoose --> MongoLog
VectorCtrl --> VectorDB
RedisClient --> Redis
S3Client --> S3

' MongoDB 内部关系
Users --> TeamMembers : "userId"
Teams --> TeamMembers : "teamId"
TeamMembers --> Apps : "tmbId"
TeamMembers --> Datasets : "tmbId"
Apps --> AppVersions : "appId"
Apps --> Chats : "appId"
Chats --> ChatItems : "chatId"
Datasets --> DatasetCollections : "datasetId"
DatasetCollections --> DatasetDatas : "collectionId"
Datasets --> DatasetTrainings : "datasetId"

' 跨数据库关系
DatasetDatas ..> Vectors : "indexes.dataId"
DatasetTrainings ..> TrainQ : "任务入队"
DatasetCollections ..> DatasetBucket : "fileId"
Chats ..> ChatBucket : "文件存储"
Users ..> AvatarBucket : "avatar"
Teams ..> AvatarBucket : "avatar"

' 缓存关系
SystemConfigs ..> system_config : "缓存"
Teams ..> team_cache : "缓存"
Users ..> user_cache : "缓存"

note right of MongoDB
  主数据库
  - 存储业务数据
  - 支持事务
  - 读写分离
end note

note right of VectorDB
  向量检索
  - 支持余弦相似度
  - HNSW索引
  - 高性能查询
end note

note right of Redis
  缓存 & 队列
  - 系统配置缓存
  - 用户会话
  - 任务队列
  - 分布式锁
end note

note right of S3
  对象存储
  - 文件存储
  - 图片存储
  - 预签名URL
  - 生命周期管理
end note

@enduml
