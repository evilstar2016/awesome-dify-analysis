@startuml FastGPT_Data_Flow

!define FLOW_COLOR #E6F7FF
!define PROCESS_COLOR #FFE6E6
!define STORAGE_COLOR #E6FFE6

title FastGPT 数据流图

skinparam linetype ortho
skinparam activityBackgroundColor FLOW_COLOR
skinparam activityBorderColor #0066CC

|用户操作|
start
:用户操作请求;

|API层|
:接收HTTP请求;
:身份验证;
:权限检查;

|服务层|

fork
  |知识库数据流|
  :上传文档;
  :文本提取;
  partition "文档处理" PROCESS_COLOR {
    :文本分块;
    :生成索引;
  }
  
  fork
    :保存到MongoDB;
    partition "MongoDB" STORAGE_COLOR {
      :dataset_collections;
      :dataset_datas;
    }
  fork again
    :生成向量;
    partition "训练队列" PROCESS_COLOR {
      :添加到 trainingQueue;
      :Worker 处理任务;
      :调用 Embedding API;
    }
    :存储向量;
    partition "VectorDB" STORAGE_COLOR {
      :dataset_vector;
    }
  fork again
    :上传文件;
    partition "MinIO/S3" STORAGE_COLOR {
      :fastgpt-dataset;
    }
  end fork
  
fork again
  |对话数据流|
  :发送消息;
  
  if (需要知识库检索?) then (yes)
    partition "检索流程" PROCESS_COLOR {
      :文本向量化;
      :向量检索;
      partition "VectorDB" STORAGE_COLOR {
        :相似度搜索;
      }
      :获取原始数据;
      partition "MongoDB" STORAGE_COLOR {
        :dataset_datas;
      }
    }
  endif
  
  partition "LLM调用" PROCESS_COLOR {
    :构建提示词;
    :调用大模型;
    :流式返回;
  }
  
  :保存对话;
  partition "MongoDB" STORAGE_COLOR {
    :chats;
    :chat_items;
  }
  
  if (有文件上传?) then (yes)
    partition "MinIO/S3" STORAGE_COLOR {
      :fastgpt-chat;
    }
  endif
  
fork again
  |应用数据流|
  :创建/编辑应用;
  
  :保存应用配置;
  partition "MongoDB" STORAGE_COLOR {
    :apps;
  }
  
  if (发布版本?) then (yes)
    :创建版本快照;
    partition "MongoDB" STORAGE_COLOR {
      :app_versions;
    }
  endif
  
  :清理缓存;
  partition "Redis" STORAGE_COLOR {
    :删除 cache:app;
  }
  
end fork

|缓存层|
partition "缓存读取" {
  if (缓存命中?) then (yes)
    :返回缓存数据;
    partition "Redis" STORAGE_COLOR {
      :cache:*;
    }
  else (no)
    :查询数据库;
    :写入缓存;
  endif
}

|响应|
:返回结果;
stop

@enduml
