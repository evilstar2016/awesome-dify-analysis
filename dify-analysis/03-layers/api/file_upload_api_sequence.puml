@startuml dify_file_upload_api_sequence
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding      6
skinparam ParticipantPadding    30

title Dify 文件上传 API 调用流程

actor "Client" as client
participant "API Gateway\n/v1/files/upload" as api
participant "validate_app_token\n装饰器" as auth
participant "FileApi\nResource" as resource
participant "FileService" as service
database "PostgreSQL" as db
participant "Storage\n(S3/Local)" as storage

== 认证阶段 ==

client -> api: POST /v1/files/upload\n(multipart/form-data)
api -> auth: 验证请求
auth -> db: 验证 ApiToken
db --> auth: token & app_model

auth -> db: 创建/获取 EndUser
db --> auth: end_user
auth --> resource: 注入依赖

== 文件验证 ==

resource -> resource: 检查请求中是否包含文件

alt 未上传文件
    resource --> client: 400 NoFileUploadedError
end

alt 上传多个文件
    resource --> client: 400 TooManyFilesError
end

resource -> resource: 验证文件名
alt 文件名不存在
    resource --> client: 400 FilenameNotExistsError
end

resource -> resource: 验证 MIME 类型
alt 不支持的文件类型
    resource --> client: 415 UnsupportedFileTypeError
end

== 文件上传处理 ==

resource -> service: upload_file(\n  filename, content,\n  mimetype, user)

service -> service: 验证文件大小
alt 文件过大
    service --> resource: FileTooLargeError
    resource --> client: 413 FileTooLargeError
end

service -> service: 生成唯一文件名
service -> service: 计算文件哈希

service -> storage: 上传文件到存储
storage --> service: 存储路径

service -> db: 创建 UploadFile 记录
db --> service: upload_file

service --> resource: upload_file 对象

== 返回响应 ==

resource --> client: 201 Created\n{\n  "id": "file_id",\n  "name": "filename.pdf",\n  "size": 1024,\n  "extension": "pdf",\n  "mime_type": "application/pdf",\n  "created_at": 1234567890\n}

== 文件在对话中使用 ==

client -> api: POST /v1/chat-messages\n{\n  "files": [{"id": "file_id"}],\n  "query": "请分析这个文件"\n}

note over api
  文件会在对话处理中
  被解析并提供给 LLM
end note

@enduml
