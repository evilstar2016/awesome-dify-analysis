@startuml dify_chat_api_sequence
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding      6
skinparam ParticipantPadding    30

title Dify Chat API 调用流程

actor "Client" as client
participant "API Gateway\n/v1/chat-messages" as api
participant "validate_app_token\n装饰器" as auth
participant "ChatApi\nResource" as chat
participant "AppGenerateService" as service
participant "AppQueueManager" as queue
database "PostgreSQL" as db
participant "LLM Provider" as llm

== 认证阶段 ==

client -> api: POST /v1/chat-messages\n(Authorization: Bearer {token})
api -> auth: 验证请求
auth -> db: 查询 ApiToken
db --> auth: token 信息

alt Token 无效
    auth --> client: 401 Unauthorized
else Token 有效
    auth -> db: 查询 App
    db --> auth: app_model
    auth -> db: 创建/更新 EndUser
    db --> auth: end_user
    auth --> chat: 注入 app_model, end_user
end

== 请求处理阶段 ==

chat -> chat: 解析请求参数\n(inputs, query, files, response_mode)
chat -> chat: 验证 app_mode\n(CHAT/AGENT_CHAT/ADVANCED_CHAT)

alt 非聊天应用
    chat --> client: 400 NotChatAppError
else 聊天应用
    chat -> service: generate(app_model, user, args, streaming)
end

== 生成阶段 ==

service -> db: 获取/创建 Conversation
db --> service: conversation

alt 阻塞模式 (blocking)
    service -> llm: 调用 LLM API
    llm --> service: 完整响应
    service -> db: 保存 Message
    service --> chat: response
    chat --> client: JSON 响应
else 流式模式 (streaming)
    service -> queue: 创建任务队列
    service -> llm: 流式调用 LLM
    
    loop 接收流式数据
        llm --> service: chunk
        service -> queue: 推送 chunk
        service --> client: SSE: data chunk
    end
    
    service -> db: 保存完整 Message
    service --> client: SSE: [DONE]
end

== 停止生成 (可选) ==

client -> api: POST /v1/chat-messages/{task_id}/stop
api -> auth: 验证请求
auth --> chat: 验证通过
chat -> queue: set_stop_flag(task_id)
queue --> chat: 标记成功
chat --> client: {"result": "success"}

@enduml
