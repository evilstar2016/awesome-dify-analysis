@startuml dify_dataset_api_sequence
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding      6
skinparam ParticipantPadding    30

title Dify Dataset/Knowledge Base API 调用流程

actor "Client" as client
participant "API Gateway\n/v1/datasets" as api
participant "validate_dataset_token\n装饰器" as auth
participant "DatasetApiResource" as resource
participant "DatasetService" as dataset_svc
participant "DocumentService" as doc_svc
participant "SegmentService" as seg_svc
database "PostgreSQL" as db
participant "Celery Worker" as celery
participant "Vector Store" as vector

== 认证阶段 ==

client -> api: POST /v1/datasets\n(Authorization: Bearer {dataset_token})
api -> auth: 验证请求
auth -> db: 验证 ApiToken (type=dataset)
db --> auth: token 信息
auth -> db: 获取租户和账户信息
db --> auth: tenant_account
auth --> resource: 注入 tenant_id

== 创建数据集 ==

client -> resource: POST /v1/datasets\n{name, description, indexing_technique}
resource -> resource: 解析并验证参数
resource -> dataset_svc: create_empty_dataset()
dataset_svc -> db: 插入 Dataset 记录
db --> dataset_svc: dataset
dataset_svc --> resource: dataset
resource --> client: 201 Created\n{dataset_detail}

== 创建文档 (通过文件) ==

client -> resource: POST /v1/datasets/{id}/document/create-by-file\n(multipart/form-data)
resource -> resource: 验证文件上传
resource -> doc_svc: upload_file()
doc_svc -> db: 创建 UploadFile 记录
doc_svc --> resource: upload_file

resource -> doc_svc: save_document_with_dataset_id()
doc_svc -> db: 创建 Document 记录
db --> doc_svc: document
doc_svc -> celery: 触发索引任务\ndocument_indexing_task.delay()
celery --> doc_svc: task_id

doc_svc --> resource: {document, batch}
resource --> client: 200 OK\n{document, batch}

== 异步索引处理 ==

celery -> celery: 文档解析\n(PDF/Word/etc.)
celery -> celery: 文本分割\n(Splitter)
celery -> celery: 生成嵌入向量
celery -> vector: 存储向量
vector --> celery: 存储成功
celery -> db: 更新 Document 状态\nindexing_status = completed

== 查询索引状态 ==

client -> resource: GET /v1/datasets/{id}/documents/{batch}/indexing-status
resource -> db: 查询 Document 和 Segment 状态
db --> resource: 状态信息
resource --> client: 200 OK\n{indexing_status, completed_segments, total_segments}

== 创建分段 ==

client -> resource: POST /v1/datasets/{id}/documents/{doc_id}/segments\n{segments: [...]}
resource -> seg_svc: multi_create_segment()
seg_svc -> db: 创建 DocumentSegment 记录

alt 高质量索引 (high_quality)
    seg_svc -> vector: 生成并存储向量
    vector --> seg_svc: 存储成功
end

seg_svc --> resource: segments
resource --> client: 200 OK\n{data: segments, doc_form}

== 检索测试 (Hit Testing) ==

client -> resource: POST /v1/datasets/{id}/hit-testing\n{query, retrieval_model}
resource -> resource: 验证数据集权限
resource -> dataset_svc: hit_testing()

alt 向量检索
    dataset_svc -> vector: 相似度搜索
    vector --> dataset_svc: 候选结果
end

alt 重排序启用
    dataset_svc -> llm: Rerank 模型调用
    llm --> dataset_svc: 重排序结果
end

dataset_svc --> resource: 检索结果
resource --> client: 200 OK\n{records: [...]}

== 删除数据集 ==

client -> resource: DELETE /v1/datasets/{id}
resource -> dataset_svc: delete_dataset()
dataset_svc -> db: 检查数据集是否被引用

alt 数据集正在使用
    dataset_svc --> resource: DatasetInUseError
    resource --> client: 409 Conflict
else 可以删除
    dataset_svc -> vector: 删除向量数据
    vector --> dataset_svc: 删除成功
    dataset_svc -> db: 删除 Dataset 及关联数据
    db --> dataset_svc: 删除成功
    dataset_svc --> resource: True
    resource --> client: 204 No Content
end

@enduml
