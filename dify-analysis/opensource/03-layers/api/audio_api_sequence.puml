@startuml dify_audio_api_sequence
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding      6
skinparam ParticipantPadding    30

title Dify 音频 API 调用流程

actor "Client" as client
participant "API Gateway" as api
participant "validate_app_token\n装饰器" as auth
participant "AudioApi\nTextApi" as resource
participant "AudioService" as service
database "PostgreSQL" as db
participant "Speech Provider\n(Whisper/Azure)" as speech

== 语音转文字 (ASR) ==

client -> api: POST /v1/audio-to-text\n(multipart/form-data: file)
api -> auth: 验证请求
auth -> db: 验证 ApiToken
db --> auth: app_model, end_user
auth --> resource: 注入依赖

resource -> service: transcript_asr(\n  app_model, file, end_user)

service -> service: 验证音频文件
alt 未上传音频
    service --> resource: NoAudioUploadedServiceError
    resource --> client: 400 NoAudioUploadedError
end

alt 音频过大
    service --> resource: AudioTooLargeServiceError
    resource --> client: 413 AudioTooLargeError
end

alt 不支持的音频格式
    service --> resource: UnsupportedAudioTypeServiceError
    resource --> client: 415 UnsupportedAudioTypeError
end

service -> db: 获取 App 配置的语音模型
db --> service: speech_config

alt 未配置语音模型
    service --> resource: ProviderNotSupportSpeechToTextServiceError
    resource --> client: 400 ProviderNotSupportSpeechToTextError
end

service -> speech: 调用 ASR 模型
speech --> service: 转录文本

service --> resource: {"text": "转录结果"}
resource --> client: 200 OK\n{"text": "转录结果"}

== 文字转语音 (TTS) ==

client -> api: POST /v1/text-to-audio\n{"text": "要转换的文本", "voice": "alloy"}
api -> auth: 验证请求
auth --> resource: 验证通过

resource -> resource: 解析参数\n(message_id, text, voice, streaming)

resource -> service: transcript_tts(\n  app_model, text, voice, end_user, message_id)

service -> db: 获取 App 配置的 TTS 模型
db --> service: tts_config

alt 流式模式
    service -> speech: 流式 TTS 调用
    loop 接收音频块
        speech --> service: audio_chunk
        service --> client: 音频流数据
    end
else 非流式模式
    service -> speech: TTS 调用
    speech --> service: 完整音频
    service --> resource: 音频数据
    resource --> client: 200 OK\n(audio/mpeg)
end

@enduml
