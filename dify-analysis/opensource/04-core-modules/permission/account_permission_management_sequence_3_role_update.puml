@startuml AccountPermission_RoleUpdate
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding 6
skinparam ParticipantPadding 30

title Dify 账号权限管理核心流程 - 3. 权限检查与角色更新

participant Operator as "操作者\n(OWNER)"
participant API as "角色更新API\n(/update-role)"
participant TenantService as "TenantService\n(权限检查)"
participant PermissionCheck as "权限验证引擎"
participant Database as "数据库"
participant Cache as "计费缓存"

autonumber

Operator ->> API: PUT /workspaces/current/members/{member_id}/update-role\n{role: "admin"}
activate API

note over API
  装饰器链：
  1. @setup_required
  2. @login_required
  3. @account_initialization_required
end note

API ->> API: current_user = current_account_with_tenant()

API ->> API: 验证 role 参数有效性\nTenantAccountRole.is_valid_role(role)

alt role 无效
  API -->> Operator: {code: "invalid-role", message: "Invalid role"}\n400 Bad Request
  deactivate API
else role 有效
  
  API ->> Database: SELECT * FROM accounts WHERE id = member_id
  activate Database
  Database -->> API: member_account | null
  deactivate Database
  
  alt 成员不存在
    API -->> Operator: 404 Not Found
    deactivate API
  else 成员存在
    
    API ->> TenantService: update_member_role(\n  current_tenant, member, new_role, current_user)
    activate TenantService
    
    note over TenantService
      权限检查三步：
      1. 检查操作者权限
      2. 检查目标成员
      3. 检查操作类型
    end note
    
    TenantService ->> PermissionCheck: check_member_permission(\n  tenant, operator, member, action="update")
    activate PermissionCheck
    
    note over PermissionCheck
      权限矩阵检查：
      - 操作：update
      - 允许角色：[OWNER]
      - 不允许：ADMIN, EDITOR, NORMAL, DATASET_OPERATOR
    end note
    
    PermissionCheck ->> Database: SELECT * FROM tenant_account_joins\nWHERE tenant_id = ? AND account_id = operator_id
    activate Database
    Database -->> PermissionCheck: join_record
    deactivate Database
    
    alt join_record 为空或角色不在 [OWNER]
      PermissionCheck -->> TenantService: NoPermissionError
      TenantService -->> API: NoPermissionError
      API -->> Operator: {code: "forbidden", message: "No permission to update member"}\n403 Forbidden
      deactivate PermissionCheck
      deactivate TenantService
      deactivate API
    else 操作者权限验证通过
      
      PermissionCheck -->> TenantService: permission verified
      deactivate PermissionCheck
      
      note over TenantService
        权限检查通过，执行角色更新
      end note
      
      TenantService ->> Database: SELECT * FROM tenant_account_joins\nWHERE tenant_id = ? AND account_id = member_id
      activate Database
      Database -->> TenantService: target_member_join
      deactivate Database
      
      alt target_member_join 不存在
        TenantService -->> API: MemberNotInTenantError
        API -->> Operator: {code: "member-not-found"}\n404 Not Found
        deactivate TenantService
        deactivate API
      else 成员关系存在
        
        alt new_role == current_role
          TenantService -->> API: RoleAlreadyAssignedError
          API -->> Operator: {code: "error"}\n400 Bad Request
          deactivate TenantService
          deactivate API
        else 角色不同，执行更新
          
          alt new_role == "owner"
            note over TenantService
              所有权转移流程：
              1. 找到当前的 OWNER
              2. 将其降级为 ADMIN
              3. 将目标成员升级为 OWNER
            end note
            
            TenantService ->> Database: SELECT * FROM tenant_account_joins\nWHERE tenant_id = ? AND role = "owner"
            activate Database
            Database -->> TenantService: current_owner_join
            deactivate Database
            
            alt 当前所有者存在
              TenantService ->> Database: UPDATE tenant_account_joins\nSET role = "admin" WHERE id = current_owner_join.id
              activate Database
              Database -->> TenantService: updated
              deactivate Database
            end
            
          end
          
          note over TenantService
            更新目标成员的角色
          end note
          
          TenantService ->> Database: UPDATE tenant_account_joins\nSET role = ?\nWHERE tenant_id = ? AND account_id = ?
          activate Database
          Database -->> TenantService: rows_updated = 1
          deactivate Database
          
          TenantService ->> Database: COMMIT transaction
          activate Database
          Database -->> TenantService: success
          deactivate Database
          
          TenantService ->> Cache: BillingService.clean_billing_info_cache(\n  tenant_id)
          activate Cache
          Cache -->> TenantService: cache cleared
          deactivate Cache
          
          TenantService -->> API: update completed
          deactivate TenantService
          
          API -->> Operator: {result: "success"}\n200 OK
          deactivate API
          
        end
        
      end
      
    end
    
  end
  
end

note over Operator
  角色更新完成：
  - 新权限立即生效
  - 计费缓存清除
  - 用户下次请求需重新获取令牌
end note

@enduml
