@startuml Notion集成处理详细时序图

!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #6C757D
skinparam sequenceParticipantBorderColor #6C757D
skinparam sequenceLifeLineBorderColor #E3F2FD
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00

title **Dify Notion集成处理详细时序图**

actor "用户" as User
participant "数据集服务" as DatasetService
participant "索引运行器" as IndexingRunner
participant "Notion提取器" as NotionExtractor
participant "Notion API" as NotionAPI
participant "凭证服务" as CredentialService
database "PostgreSQL" as Database

== 1. Notion集成配置 ==
User -> DatasetService: 配置Notion数据源
activate DatasetService
DatasetService -> CredentialService: 验证Notion访问令牌
activate CredentialService
CredentialService -> NotionAPI: 测试API连接
activate NotionAPI
NotionAPI --> CredentialService: 返回连接状态
deactivate NotionAPI
CredentialService --> DatasetService: 返回验证结果
deactivate CredentialService
DatasetService --> User: 返回配置状态
deactivate DatasetService

== 2. 创建Notion文档导入 ==
User -> DatasetService: POST /datasets/{id}/documents (Notion源)
activate DatasetService
DatasetService -> Database: 创建DatasetDocument记录
note right
数据源信息包含:
- notion_workspace_id
- notion_page_id
- credential_id
- 页面类型 (page/database)
end note

DatasetService -> IndexingRunner: 触发异步导入任务
DatasetService --> User: 返回任务ID
deactivate DatasetService

== 3. Notion内容提取 ==
activate IndexingRunner
IndexingRunner -> NotionExtractor: 创建Notion提取器
activate NotionExtractor
NotionExtractor -> CredentialService: 获取访问令牌
activate CredentialService
CredentialService -> Database: 查询数据源凭证
CredentialService --> NotionExtractor: 返回access_token
deactivate CredentialService

NotionExtractor -> NotionExtractor: update_last_edited_time()
NotionExtractor -> NotionAPI: 获取页面/数据库最后编辑时间
activate NotionAPI
NotionAPI --> NotionExtractor: 返回last_edited_time
NotionExtractor -> Database: 更新文档的last_edited_time
deactivate NotionAPI

alt Notion页面处理 (page)
    == 4a. 单页面内容提取 ==
    NotionExtractor -> NotionExtractor: _get_notion_block_data()
    
    loop 分页获取页面块
        NotionExtractor -> NotionAPI: GET /blocks/{page_id}/children
        activate NotionAPI
        note right: 使用Notion API v2022-06-28
        
        loop 处理每个块元素
            alt 表格块
                NotionExtractor -> NotionExtractor: _read_table_rows()
                NotionExtractor -> NotionAPI: 获取表格行数据
                NotionExtractor -> NotionExtractor: 转换为Markdown表格
                note right: | 表头 | 表头 |\n|---|---|\n| 数据 | 数据 |
            else 文本块
                NotionExtractor -> NotionAPI: 提取rich_text内容
                NotionExtractor -> NotionExtractor: 处理文本格式
            else 嵌套块
                NotionExtractor -> NotionExtractor: _read_block() 递归处理
                note right: 支持层级结构，使用缩进表示
            end
        end
        
        NotionAPI --> NotionExtractor: 返回块数据和分页信息
        deactivate NotionAPI
    end
    
    NotionExtractor -> NotionExtractor: 组装完整页面内容
    NotionExtractor -> NotionExtractor: 创建单个Document对象

else Notion数据库处理 (database)
    == 4b. 数据库内容提取 ==
    NotionExtractor -> NotionExtractor: _get_notion_database_data()
    
    loop 分页获取数据库记录
        NotionExtractor -> NotionAPI: POST /databases/{id}/query
        activate NotionAPI
        
        loop 处理每条记录
            NotionExtractor -> NotionAPI: 获取记录属性
            
            loop 处理每个属性
                alt multi_select类型
                    NotionExtractor -> NotionExtractor: 提取多选值数组
                else rich_text/title类型
                    NotionExtractor -> NotionExtractor: 提取纯文本内容
                else select/status类型
                    NotionExtractor -> NotionExtractor: 提取选择项名称
                else 其他类型
                    NotionExtractor -> NotionExtractor: 直接获取属性值
                end
            end
            
            NotionExtractor -> NotionExtractor: 格式化为键值对字符串
            note right: 格式: 属性名:值\n属性名:值\n...
            NotionExtractor -> NotionExtractor: 添加记录页面URL
        end
        
        NotionAPI --> NotionExtractor: 返回记录数据和分页信息
        deactivate NotionAPI
    end
    
    NotionExtractor -> NotionExtractor: 组装所有记录内容
    NotionExtractor -> NotionExtractor: 创建单个Document对象
end

== 5. 返回提取结果 ==
NotionExtractor --> IndexingRunner: 返回Document列表
deactivate NotionExtractor

note right of IndexingRunner
**Notion处理特点**:
- 实时API数据获取
- 支持层级结构保持
- 表格转Markdown格式
- 数据库记录结构化
- 增量更新支持
end note

== 6. 后续标准流程 ==
IndexingRunner -> IndexingRunner: 文本分割处理
note right: 根据内容长度分割

IndexingRunner -> IndexingRunner: 向量化处理
IndexingRunner -> Database: 存储DocumentSegment记录
IndexingRunner -> Database: 更新文档状态为COMPLETED
deactivate IndexingRunner

== 7. 增量更新检测 ==
note over User, Database
**增量更新机制**:
定期检查Notion页面的last_edited_time
如果发现更新，重新提取并更新向量索引
保持数据同步性
end note

User -> DatasetService: 触发增量更新检查
DatasetService -> NotionExtractor: 检查页面更新时间
NotionExtractor -> NotionAPI: 获取最新编辑时间
alt 内容已更新
    NotionExtractor -> NotionExtractor: 重新提取内容
    NotionExtractor -> IndexingRunner: 触发重新索引
else 内容无变化
    NotionExtractor -> NotionExtractor: 跳过处理
end

== 错误处理和重试 ==
note over NotionExtractor, NotionAPI
**Notion API错误处理**:
1. **认证错误**: 检查access_token有效性
2. **权限错误**: 验证页面访问权限
3. **速率限制**: 实现退避重试机制
4. **网络错误**: 自动重试和超时处理
5. **数据格式**: 兼容Notion API版本变化
end note

== Notion vs 文件上传对比 ==
note over User, Database
**Notion集成特殊之处**:
1. **外部数据源**: 通过API实时获取，非文件上传
2. **结构化内容**: 保持页面层级和数据库结构
3. **增量更新**: 支持内容变化检测和同步
4. **权限管理**: 基于Notion工作空间权限
5. **实时性**: 可以获取最新的页面内容

**与文件处理的差异**:
- **文件**: 静态内容，一次性处理
- **Notion**: 动态内容，支持实时同步
- **存储**: 文件需要本地存储，Notion直接从API获取
- **更新**: 文件重新上传，Notion增量检测
end note

== 配置要求 ==
note over CredentialService, NotionAPI
**Notion集成配置**:
- Integration Token或OAuth凭证
- 工作空间访问权限
- 页面/数据库共享设置
- API版本: 2022-06-28

**性能优化**:
- 分页处理大型数据库
- 缓存访问令牌
- 批量API调用
- 增量同步策略
end note

@enduml