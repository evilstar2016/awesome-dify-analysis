@startuml Dify Data Architecture
!theme plain
skinparam backgroundColor #FFFFFF
skinparam linetype ortho
skinparam roundcorner 5
skinparam class {
    BackgroundColor #F8F9FA
    BorderColor #1976D2
    ArrowColor #1976D2
    FontColor #212529
}
skinparam package {
    BackgroundColor #E3F2FD
    BorderColor #1976D2
    FontColor #1976D2
}
skinparam note {
    BackgroundColor #FFF3E0
    BorderColor #F57C00
}

title Dify 数据架构图 (Data Architecture)

' ========== Account & Tenant Domain ==========
package "账户与租户域 (Account & Tenant)" #E3F2FD {
    entity Account {
        * id : UUID <<PK>>
        --
        name : String(255)
        email : String(255) <<unique>>
        password : String(255)
        password_salt : String(255)
        avatar : String(255)
        interface_language : String(255)
        interface_theme : String(255)
        timezone : String(255)
        last_login_at : DateTime
        last_login_ip : String(255)
        last_active_at : DateTime
        status : AccountStatus
        initialized_at : DateTime
        created_at : DateTime
        updated_at : DateTime
    }
    
    entity Tenant {
        * id : UUID <<PK>>
        --
        name : String(255)
        encrypt_public_key : Text
        plan : String(255)
        status : TenantStatus
        custom_config : Text (JSON)
        created_at : DateTime
        updated_at : DateTime
    }
    
    entity TenantAccountJoin {
        * id : UUID <<PK>>
        --
        tenant_id : UUID <<FK>>
        account_id : UUID <<FK>>
        current : Boolean
        role : TenantAccountRole
        invited_by : UUID <<FK>>
        created_at : DateTime
        updated_at : DateTime
    }
    
    entity AccountIntegrate {
        * id : UUID <<PK>>
        --
        account_id : UUID <<FK>>
        provider : String(255)
        open_id : String(255)
        encrypted_token : Text
        created_at : DateTime
        updated_at : DateTime
    }
}

' ========== Application Domain ==========
package "应用域 (Application)" #E8F5E9 {
    entity App {
        * id : UUID <<PK>>
        --
        tenant_id : UUID <<FK>>
        name : String(255)
        description : Text
        mode : AppMode
        icon_type : IconType
        icon : String(255)
        icon_background : String(255)
        app_model_config_id : UUID <<FK>>
        workflow_id : UUID <<FK>>
        status : String(255)
        enable_site : Boolean
        enable_api : Boolean
        api_rpm : Integer
        api_rph : Integer
        is_demo : Boolean
        is_public : Boolean
        is_universal : Boolean
        tracing : Text
        max_active_requests : Integer
        use_icon_as_answer_icon : Boolean
        created_by : UUID <<FK>>
        created_at : DateTime
        updated_by : UUID
        updated_at : DateTime
    }
    
    entity AppModelConfig {
        * id : UUID <<PK>>
        --
        app_id : UUID <<FK>>
        provider : String(255)
        model_id : String(255)
        configs : JSON
        opening_statement : Text
        suggested_questions : Text
        suggested_questions_after_answer : Text
        speech_to_text : Text
        text_to_speech : Text
        more_like_this : Text
        model : Text
        user_input_form : Text
        dataset_query_variable : String(255)
        pre_prompt : Text
        agent_mode : Text (JSON)
        sensitive_word_avoidance : Text
        retriever_resource : Text
        prompt_type : String(255)
        chat_prompt_config : Text
        completion_prompt_config : Text
        dataset_configs : Text (JSON)
        file_upload : Text (JSON)
        created_by : UUID
        created_at : DateTime
        updated_by : UUID
        updated_at : DateTime
    }
    
    entity Site {
        * id : UUID <<PK>>
        --
        app_id : UUID <<FK>>
        title : String(255)
        icon : String(255)
        icon_background : String(255)
        description : Text
        default_language : String(255)
        copyright : String(255)
        privacy_policy : String(255)
        custom_disclaimer : Text
        customize_domain : String(255)
        customize_token_strategy : String(255)
        prompt_public : Boolean
        status : String(255)
        created_at : DateTime
        updated_at : DateTime
    }
    
    entity ApiToken {
        * id : UUID <<PK>>
        --
        app_id : UUID <<FK>>
        type : String(255)
        token : String(255) <<unique>>
        last_used_at : DateTime
        created_at : DateTime
    }
    
    entity InstalledApp {
        * id : UUID <<PK>>
        --
        tenant_id : UUID <<FK>>
        app_id : UUID <<FK>>
        app_owner_tenant_id : UUID
        position : Integer
        is_pinned : Boolean
        last_used_at : DateTime
        created_at : DateTime
    }
}

' ========== Conversation Domain ==========
package "对话域 (Conversation)" #FFF3E0 {
    entity Conversation {
        * id : UUID <<PK>>
        --
        app_id : UUID <<FK>>
        app_model_config_id : UUID <<FK>>
        model_provider : String(255)
        override_model_configs : Text
        model_id : String(255)
        mode : String(255)
        name : String(255)
        summary : Text
        inputs : JSON
        introduction : Text
        system_instruction : Text
        system_instruction_tokens : Integer
        status : String(255)
        invoke_from : String(255)
        from_source : String(255)
        from_end_user_id : UUID <<FK>>
        from_account_id : UUID <<FK>>
        read_at : DateTime
        read_account_id : UUID
        dialogue_count : Integer
        is_deleted : Boolean
        created_at : DateTime
        updated_at : DateTime
    }
    
    entity Message {
        * id : UUID <<PK>>
        --
        app_id : UUID <<FK>>
        model_provider : String(255)
        model_id : String(255)
        override_model_configs : Text
        conversation_id : UUID <<FK>>
        inputs : JSON
        query : Text
        message : JSON
        message_tokens : Integer
        message_unit_price : Decimal
        message_price_unit : Decimal
        answer : Text
        answer_tokens : Integer
        answer_unit_price : Decimal
        answer_price_unit : Decimal
        parent_message_id : UUID
        provider_response_latency : Float
        total_price : Decimal
        currency : String(255)
        status : String(255)
        error : Text
        message_metadata : Text
        invoke_from : String(255)
        from_source : String(255)
        from_end_user_id : UUID <<FK>>
        from_account_id : UUID <<FK>>
        agent_based : Boolean
        workflow_run_id : UUID <<FK>>
        app_mode : String(255)
        created_at : DateTime
        updated_at : DateTime
    }
    
    entity MessageFeedback {
        * id : UUID <<PK>>
        --
        app_id : UUID <<FK>>
        conversation_id : UUID <<FK>>
        message_id : UUID <<FK>>
        rating : String(255)
        content : Text
        from_source : String(255)
        from_end_user_id : UUID
        from_account_id : UUID
        created_at : DateTime
    }
    
    entity MessageAnnotation {
        * id : UUID <<PK>>
        --
        app_id : UUID <<FK>>
        conversation_id : UUID <<FK>>
        message_id : UUID <<FK>>
        content : Text
        question : Text
        account_id : UUID <<FK>>
        created_at : DateTime
        updated_at : DateTime
    }
    
    entity MessageAgentThought {
        * id : UUID <<PK>>
        --
        message_id : UUID <<FK>>
        message_chain_id : UUID <<FK>>
        position : Integer
        thought : Text
        tool : Text
        tool_labels_str : Text
        tool_meta_str : Text
        tool_input : Text
        observation : Text
        answer : Text
        message_token : Integer
        message_unit_price : Decimal
        answer_token : Integer
        answer_unit_price : Decimal
        tokens : Integer
        total_price : Decimal
        currency : String(255)
        latency : Float
        created_by_role : String(255)
        created_by : UUID
        created_at : DateTime
    }
    
    entity EndUser {
        * id : UUID <<PK>>
        --
        tenant_id : UUID <<FK>>
        app_id : UUID <<FK>>
        type : String(255)
        external_user_id : String(255)
        name : String(255)
        is_anonymous : Boolean
        session_id : String(255)
        created_at : DateTime
        updated_at : DateTime
    }
}

' ========== Dataset/Knowledge Domain ==========
package "知识库域 (Dataset/Knowledge)" #FCE4EC {
    entity Dataset {
        * id : UUID <<PK>>
        --
        tenant_id : UUID <<FK>>
        name : String(255)
        description : Text
        provider : String(255)
        permission : DatasetPermissionEnum
        data_source_type : String(255)
        indexing_technique : String(255)
        index_struct : Text
        embedding_model : String(255)
        embedding_model_provider : String(255)
        keyword_number : Integer
        collection_binding_id : UUID <<FK>>
        retrieval_model : JSONB
        built_in_field_enabled : Boolean
        icon_info : JSONB
        runtime_mode : String(255)
        pipeline_id : UUID <<FK>>
        chunk_structure : String(255)
        enable_api : Boolean
        created_by : UUID <<FK>>
        created_at : DateTime
        updated_by : UUID
        updated_at : DateTime
    }
    
    entity Document {
        * id : UUID <<PK>>
        --
        tenant_id : UUID <<FK>>
        dataset_id : UUID <<FK>>
        position : Integer
        data_source_type : String(255)
        data_source_info : Text (JSON)
        dataset_process_rule_id : UUID <<FK>>
        batch : String(255)
        name : String(255)
        created_from : String(255)
        created_by : UUID <<FK>>
        created_api_request_id : UUID
        created_at : DateTime
        processing_started_at : DateTime
        file_id : Text
        word_count : Integer
        parsing_completed_at : DateTime
        cleaning_completed_at : DateTime
        splitting_completed_at : DateTime
        tokens : Integer
        indexing_latency : Float
        completed_at : DateTime
        is_paused : Boolean
        paused_by : UUID
        paused_at : DateTime
        error : Text
        stopped_at : DateTime
        indexing_status : String(255)
        enabled : Boolean
        disabled_at : DateTime
        disabled_by : UUID
        archived : Boolean
        archived_reason : String(255)
        archived_by : UUID
        archived_at : DateTime
        updated_at : DateTime
        doc_type : String(40)
        doc_metadata : JSONB
        doc_form : String(255)
        doc_language : String(255)
    }
    
    entity DocumentSegment {
        * id : UUID <<PK>>
        --
        tenant_id : UUID <<FK>>
        dataset_id : UUID <<FK>>
        document_id : UUID <<FK>>
        position : Integer
        content : Text
        answer : Text
        word_count : Integer
        tokens : Integer
        keywords : JSON
        index_node_id : String(255)
        index_node_hash : String(255)
        hit_count : Integer
        enabled : Boolean
        disabled_at : DateTime
        disabled_by : UUID
        status : String(255)
        created_by : UUID <<FK>>
        created_at : DateTime
        updated_by : UUID
        updated_at : DateTime
        indexing_at : DateTime
        completed_at : DateTime
        error : Text
        stopped_at : DateTime
    }
    
    entity ChildChunk {
        * id : UUID <<PK>>
        --
        tenant_id : UUID <<FK>>
        dataset_id : UUID <<FK>>
        document_id : UUID <<FK>>
        segment_id : UUID <<FK>>
        position : Integer
        content : Text
        word_count : Integer
        tokens : Integer
        index_node_id : String(255)
        index_node_hash : String(255)
        type : String(255)
        created_by : UUID <<FK>>
        created_at : DateTime
    }
    
    entity DatasetProcessRule {
        * id : UUID <<PK>>
        --
        dataset_id : UUID <<FK>>
        mode : String(255)
        rules : Text (JSON)
        created_by : UUID <<FK>>
        created_at : DateTime
    }
    
    entity Embedding {
        * id : UUID <<PK>>
        --
        hash : String(64) <<unique>>
        embedding : Bytes
        model_name : String(255)
        provider_name : String(255)
        created_at : DateTime
    }
    
    entity DatasetCollectionBinding {
        * id : UUID <<PK>>
        --
        provider_name : String(40)
        model_name : String(255)
        type : String(40)
        collection_name : String(64)
        created_at : DateTime
    }
    
    entity DatasetKeywordTable {
        * id : UUID <<PK>>
        --
        dataset_id : UUID <<FK>>
        keyword_table : Text
        created_at : DateTime
    }
    
    entity DatasetQuery {
        * id : UUID <<PK>>
        --
        dataset_id : UUID <<FK>>
        content : Text
        source : String(255)
        created_by_role : String(255)
        created_by : UUID
        created_at : DateTime
    }
    
    entity AppDatasetJoin {
        * id : UUID <<PK>>
        --
        app_id : UUID <<FK>>
        dataset_id : UUID <<FK>>
        created_at : DateTime
    }
    
    entity DatasetPermission {
        * id : UUID <<PK>>
        --
        dataset_id : UUID <<FK>>
        account_id : UUID <<FK>>
        has_permission : Boolean
        created_at : DateTime
    }
    
    entity Pipeline {
        * id : UUID <<PK>>
        --
        tenant_id : UUID <<FK>>
        name : String(255)
        description : Text
        hash : String(64)
        icon_info : JSONB
        is_published : Boolean
        pipeline_graph : Text (JSON)
        created_by : UUID <<FK>>
        created_at : DateTime
        updated_by : UUID
        updated_at : DateTime
    }
    
    entity DatasetMetadata {
        * id : UUID <<PK>>
        --
        dataset_id : UUID <<FK>>
        tenant_id : UUID <<FK>>
        name : String(255)
        type : String(255)
        created_by : UUID <<FK>>
        created_at : DateTime
        updated_by : UUID
        updated_at : DateTime
    }
}

' ========== Workflow Domain ==========
package "工作流域 (Workflow)" #E1BEE7 {
    entity Workflow {
        * id : UUID <<PK>>
        --
        tenant_id : UUID <<FK>>
        app_id : UUID <<FK>>
        type : WorkflowType
        version : String(255)
        marked_name : String
        marked_comment : String
        graph : Text (JSON)
        features : Text (JSON)
        environment_variables : Text (JSON)
        conversation_variables : Text (JSON)
        rag_pipeline_variables : Text (JSON)
        created_by : UUID <<FK>>
        created_at : DateTime
        updated_by : UUID
        updated_at : DateTime
    }
    
    entity WorkflowRun {
        * id : UUID <<PK>>
        --
        tenant_id : UUID <<FK>>
        app_id : UUID <<FK>>
        workflow_id : UUID <<FK>>
        sequence_number : Integer
        triggered_from : String(255)
        version : String(255)
        graph : Text
        inputs : Text (JSON)
        status : WorkflowExecutionStatus
        outputs : Text (JSON)
        error : Text
        elapsed_time : Float
        total_tokens : Integer
        total_steps : Integer
        created_by_role : String(255)
        created_by : UUID
        created_at : DateTime
        finished_at : DateTime
    }
    
    entity WorkflowNodeExecutionModel {
        * id : UUID <<PK>>
        --
        tenant_id : UUID <<FK>>
        app_id : UUID <<FK>>
        workflow_id : UUID <<FK>>
        triggered_from : String(255)
        workflow_run_id : UUID <<FK>>
        predecessor_node_id : String(255)
        index : Integer
        node_id : String(255)
        node_type : NodeType
        title : String(255)
        inputs : Text (JSON)
        process_data : Text (JSON)
        outputs : Text (JSON)
        status : String(255)
        error : Text
        elapsed_time : Float
        execution_metadata : Text (JSON)
        created_at : DateTime
        created_by_role : String(255)
        created_by : UUID
        finished_at : DateTime
    }
    
    entity WorkflowAppLog {
        * id : UUID <<PK>>
        --
        tenant_id : UUID <<FK>>
        app_id : UUID <<FK>>
        workflow_id : UUID <<FK>>
        workflow_run_id : UUID <<FK>>
        created_from : String(255)
        created_by_role : String(255)
        created_by : UUID <<FK>>
        created_at : DateTime
    }
    
    entity ConversationVariable {
        * id : UUID <<PK>>
        --
        conversation_id : UUID <<FK>>
        app_id : UUID <<FK>>
        data : Text
        created_at : DateTime
        updated_at : DateTime
    }
}

' ========== Tools Domain ==========
package "工具域 (Tools)" #B2DFDB {
    entity BuiltinToolProvider {
        * id : UUID <<PK>>
        --
        tenant_id : UUID <<FK>>
        user_id : UUID <<FK>>
        provider : String(256)
        encrypted_credentials : Text
        created_at : DateTime
        updated_at : DateTime
    }
    
    entity ApiToolProvider {
        * id : UUID <<PK>>
        --
        tenant_id : UUID <<FK>>
        user_id : UUID <<FK>>
        name : String(255)
        icon : String(255)
        schema_type_str : String(40)
        schema : Text
        description : Text
        tools_str : Text (JSON)
        custom_disclaimer : String(255)
        privacy_policy : String(255)
        credentials_str : Text
        created_at : DateTime
        updated_at : DateTime
    }
    
    entity WorkflowToolProvider {
        * id : UUID <<PK>>
        --
        tenant_id : UUID <<FK>>
        user_id : UUID <<FK>>
        app_id : UUID <<FK>>
        name : String(255)
        icon : String(255)
        description : Text
        parameter_configuration : Text (JSON)
        version : String(255)
        created_at : DateTime
        updated_at : DateTime
    }
    
    entity MCPToolProvider {
        * id : UUID <<PK>>
        --
        tenant_id : UUID <<FK>>
        user_id : UUID <<FK>>
        name : String(255)
        server : Text (JSON)
        created_at : DateTime
        updated_at : DateTime
    }
    
    entity ToolFile {
        * id : UUID <<PK>>
        --
        user_id : UUID <<FK>>
        tenant_id : UUID <<FK>>
        conversation_id : UUID <<FK>>
        file_key : String(255)
        mimetype : String(255)
        original_url : String(2048)
        name : String(255)
        size : Integer
        created_at : DateTime
    }
}

' ========== Files Domain ==========
package "文件域 (Files)" #B3E5FC {
    entity UploadFile {
        * id : UUID <<PK>>
        --
        tenant_id : UUID <<FK>>
        storage_type : String(255)
        key : String(255)
        name : String(255)
        size : Integer
        extension : String(255)
        mime_type : String(255)
        hash : String(255)
        created_by_role : CreatorUserRole
        created_by : UUID
        created_at : DateTime
        used : Boolean
        used_by : UUID
        used_at : DateTime
        source_url : String(255)
    }
}

' ========== Tags Domain ==========
package "标签域 (Tags)" #DCEDC8 {
    entity Tag {
        * id : UUID <<PK>>
        --
        tenant_id : UUID <<FK>>
        type : String(255)
        name : String(255)
        created_by : UUID <<FK>>
        created_at : DateTime
    }
    
    entity TagBinding {
        * id : UUID <<PK>>
        --
        tenant_id : UUID <<FK>>
        tag_id : UUID <<FK>>
        target_id : UUID
        created_by : UUID <<FK>>
        created_at : DateTime
    }
}

' ========== Relationships ==========

' Account & Tenant relationships
Tenant ||--o{ TenantAccountJoin : "has members"
Account ||--o{ TenantAccountJoin : "belongs to tenants"
Account ||--o{ AccountIntegrate : "has integrations"

' Application relationships
Tenant ||--o{ App : "owns"
App ||--o| AppModelConfig : "configured by"
App ||--o| Site : "has site"
App ||--o{ ApiToken : "has tokens"
App ||--o{ InstalledApp : "installed in"
Account ||--o{ App : "created"

' Conversation relationships
App ||--o{ Conversation : "has conversations"
Conversation ||--o{ Message : "contains messages"
Message ||--o{ MessageFeedback : "has feedback"
Message ||--o{ MessageAnnotation : "has annotations"
Message ||--o{ MessageAgentThought : "has thoughts"
Conversation }o--o| EndUser : "from end user"
Conversation }o--o| Account : "from account"

' Dataset relationships
Tenant ||--o{ Dataset : "owns"
Dataset ||--o{ Document : "contains documents"
Document ||--o{ DocumentSegment : "splits into segments"
DocumentSegment ||--o{ ChildChunk : "has child chunks"
Dataset ||--o| DatasetProcessRule : "follows rules"
Dataset ||--o| DatasetKeywordTable : "has keyword table"
Dataset ||--o{ DatasetQuery : "receives queries"
Dataset ||--o{ DatasetPermission : "has permissions"
Dataset ||--o| Pipeline : "uses pipeline"
Dataset ||--o{ DatasetMetadata : "has metadata"
App }o--o{ Dataset : "joins (AppDatasetJoin)"
DatasetCollectionBinding ||--o{ Dataset : "binds collection"

' Workflow relationships
App ||--o{ Workflow : "implements"
Workflow ||--o{ WorkflowRun : "executed as"
WorkflowRun ||--o{ WorkflowNodeExecutionModel : "runs nodes"
Workflow ||--o{ WorkflowAppLog : "has logs"
Conversation ||--o{ ConversationVariable : "has variables"
Message }o--o| WorkflowRun : "triggered by"

' Tools relationships
Tenant ||--o{ BuiltinToolProvider : "has builtin tools"
Tenant ||--o{ ApiToolProvider : "has API tools"
Tenant ||--o{ WorkflowToolProvider : "has workflow tools"
Tenant ||--o{ MCPToolProvider : "has MCP tools"
Tenant ||--o{ ToolFile : "has tool files"

' Files relationships
Tenant ||--o{ UploadFile : "has uploaded files"

' Tags relationships
Tenant ||--o{ Tag : "has tags"
Tag ||--o{ TagBinding : "bound to targets"

' ========== Notes ==========
note right of Dataset
  <b>索引技术 (indexing_technique)</b>
  - high_quality: 高质量向量索引
  - economy: 经济型索引
  
  <b>检索模型 (retrieval_model)</b>
  - semantic_search: 语义搜索
  - keyword_search: 关键词搜索
  - hybrid_search: 混合搜索
end note

note right of App
  <b>应用模式 (AppMode)</b>
  - completion: 文本补全
  - chat: 对话
  - advanced-chat: 高级对话
  - agent-chat: 智能体对话
  - workflow: 工作流
  - channel: 渠道
  - rag-pipeline: RAG管道
end note

note right of Workflow
  <b>工作流类型 (WorkflowType)</b>
  - workflow: 标准工作流
  - chat: 对话工作流
  - rag-pipeline: RAG管道工作流
end note

note right of Document
  <b>索引状态 (indexing_status)</b>
  - waiting: 等待中
  - parsing: 解析中
  - cleaning: 清洗中
  - splitting: 分割中
  - indexing: 索引中
  - completed: 已完成
  - error: 错误
end note

note bottom of Account
  <b>账户角色 (TenantAccountRole)</b>
  - owner: 所有者
  - admin: 管理员
  - editor: 编辑者
  - normal: 普通用户
  - dataset_operator: 数据集操作员
end note

@enduml
