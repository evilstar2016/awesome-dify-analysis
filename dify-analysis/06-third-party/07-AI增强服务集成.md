# AI增强服务集成

## 1. 集成概述

Dify 集成多种 AI 增强服务，包括 Rerank 模型、语音识别、文本转语音等，提升 AI 应用的功能和性能。

## 2. 支持的服务/产品

| 服务类型 | 提供商 | 状态 | 说明 |
|---------|--------|------|------|
| Rerank | Cohere | ✅ 支持 | 重排序模型 |
| Rerank | Jina AI | ✅ 支持 | Rerank 服务 |
| Rerank | Mixedbread | ✅ 支持 | Rerank 服务 |
| Rerank | 模型提供商内置 | ✅ 支持 | 各 LLM 提供商的 Rerank |
| Speech-to-Text | OpenAI Whisper | ✅ 支持 | 语音识别 |
| Speech-to-Text | 各模型提供商 | ✅ 支持 | STT 服务 |
| Text-to-Speech | OpenAI TTS | ✅ 支持 | 文本转语音 |
| Text-to-Speech | 各模型提供商 | ✅ 支持 | TTS 服务 |
| Moderation | OpenAI | ✅ 支持 | 内容审核 |
| Moderation | 自定义 | ✅ 支持 | 自定义审核规则 |

## 3. Rerank 集成

### 3.1 架构设计

```
Query + Retrieved Documents
         ↓
    Rerank Model
         ↓
Reranked & Scored Documents
         ↓
    Top K Results
```

### 3.2 配置

```bash
# Rerank 模型配置
RERANK_MODEL_PROVIDER=cohere
RERANK_MODEL_NAME=rerank-english-v2.0
```

### 3.3 使用示例

```python
from core.rag.rerank import RerankFactory
from core.rag.rerank.rerank_type import RerankMode

# 创建 Rerank 实例
rerank = RerankFactory.create(
    rerank_mode=RerankMode.RERANKING_MODEL,
    rerank_model={
        'provider': 'cohere',
        'model': 'rerank-english-v2.0',
        'credentials': {
            'api_key': 'your_api_key'
        }
    }
)

# 重排序文档
query = "What is machine learning?"
documents = [
    Document(page_content="ML is..."),
    Document(page_content="AI includes..."),
    # ...
]

reranked_docs = rerank.rerank(
    query=query,
    documents=documents,
    top_n=5
)

for doc in reranked_docs:
    print(f"Score: {doc.metadata['score']}, Content: {doc.page_content}")
```

### 3.4 加权重排序

```python
from core.rag.rerank.weight_rerank import WeightRerank

# 基于关键词权重的重排序
weight_rerank = WeightRerank()

reranked = weight_rerank.rerank(
    query=query,
    documents=documents,
    weights={
        'vector_score': 0.7,
        'keyword_score': 0.3
    }
)
```

## 4. 语音识别 (STT) 集成

### 4.1 使用示例

```python
from core.model_manager import ModelManager

model_manager = ModelManager()

# 语音转文本
with open('audio.mp3', 'rb') as audio_file:
    result = model_manager.speech2text.invoke(
        tenant_id='tenant_id',
        provider='openai',
        model='whisper-1',
        credentials={'openai_api_key': 'sk-xxx'},
        file=audio_file,
        language='en'  # 可选
    )

print(result.text)
```

## 5. 文本转语音 (TTS) 集成

### 5.1 使用示例

```python
from core.model_manager import ModelManager

model_manager = ModelManager()

# 文本转语音
audio_data = model_manager.tts.invoke(
    tenant_id='tenant_id',
    provider='openai',
    model='tts-1',
    credentials={'openai_api_key': 'sk-xxx'},
    content='Hello, this is a test.',
    voice='alloy'  # 或 'echo', 'fable', 'onyx', 'nova', 'shimmer'
)

# 保存音频文件
with open('output.mp3', 'wb') as f:
    f.write(audio_data)
```

## 6. 内容审核 (Moderation) 集成

### 6.1 使用示例

```python
from core.moderation import Moderation

# 审核文本内容
moderation_result = Moderation.check_text(
    text="Check this content",
    tenant_id="tenant_id"
)

if moderation_result.flagged:
    print("Content flagged:")
    print(f"Categories: {moderation_result.categories}")
else:
    print("Content is safe")
```

### 6.2 自定义审核规则

```python
from core.moderation import CustomModeration

# 配置关键词过滤
custom_mod = CustomModeration(
    keywords=['badword1', 'badword2'],
    regex_patterns=[r'\d{11}'],  # 手机号等
)

if custom_mod.check("Some text with badword1"):
    print("Content violates custom rules")
```

## 7. 错误处理

```python
from core.model_runtime.errors.invoke import (
    InvokeAuthorizationError,
    InvokeRateLimitError
)

try:
    result = model_manager.speech2text.invoke(...)
except InvokeAuthorizationError:
    logger.error("API key invalid")
except InvokeRateLimitError:
    logger.error("Rate limit exceeded")
```

## 8. 性能优化

### 8.1 Rerank 缓存

```python
from extensions.ext_redis import redis_client
import hashlib

def rerank_with_cache(query, documents):
    # 生成缓存键
    doc_hash = hashlib.md5(
        str([d.page_content for d in documents]).encode()
    ).hexdigest()
    cache_key = f"rerank:{query}:{doc_hash}"
    
    # 检查缓存
    cached = redis_client.get(cache_key)
    if cached:
        return json.loads(cached)
    
    # 执行 Rerank
    reranked = rerank.rerank(query, documents)
    
    # 缓存结果
    redis_client.setex(cache_key, 3600, json.dumps(reranked))
    return reranked
```

### 8.2 批量处理

```python
# 批量语音转文本
audio_files = ['audio1.mp3', 'audio2.mp3', ...]

from concurrent.futures import ThreadPoolExecutor

def transcribe_audio(file_path):
    with open(file_path, 'rb') as f:
        return model_manager.speech2text.invoke(
            tenant_id='tenant_id',
            provider='openai',
            model='whisper-1',
            credentials={'openai_api_key': 'sk-xxx'},
            file=f
        )

with ThreadPoolExecutor(max_workers=5) as executor:
    results = list(executor.map(transcribe_audio, audio_files))
```

## 9. 监控与日志

```python
import logging

logger = logging.getLogger(__name__)

def rerank_with_monitoring(query, documents):
    start_time = time.time()
    
    try:
        result = rerank.rerank(query, documents)
        latency = time.time() - start_time
        
        logger.info(
            f"Rerank completed - "
            f"Query: {query[:50]}, "
            f"Documents: {len(documents)}, "
            f"Latency: {latency:.2f}s"
        )
        
        return result
    except Exception as e:
        logger.error(f"Rerank failed: {e}")
        raise
```

## 10. 测试

```python
import pytest
from unittest.mock import Mock, patch

@patch('requests.post')
def test_rerank(mock_post):
    mock_post.return_value.json.return_value = {
        'results': [
            {'index': 0, 'relevance_score': 0.9},
            {'index': 1, 'relevance_score': 0.7}
        ]
    }
    
    reranked = rerank.rerank(query="test", documents=documents)
    
    assert len(reranked) == 2
    assert reranked[0].metadata['score'] == 0.9
```

## 11. 最佳实践

### 11.1 Rerank

- 在向量检索后使用 Rerank 提升相关性
- 平衡性能和准确性，选择合适的 top_k
- 缓存 Rerank 结果

### 11.2 语音服务

- 压缩音频文件减少传输时间
- 选择合适的音频格式
- 处理长音频时分段处理

### 11.3 审核

- 结合多种审核方式
- 设置合理的审核阈值
- 记录审核日志便于分析

## 12. 参考资源

- [Cohere Rerank 文档](https://docs.cohere.com/docs/rerank)
- [OpenAI Whisper 文档](https://platform.openai.com/docs/guides/speech-to-text)
- [OpenAI TTS 文档](https://platform.openai.com/docs/guides/text-to-speech)
