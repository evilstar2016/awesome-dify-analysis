# 对象存储集成

## 1. 集成概述

Dify 支持 12+ 对象存储服务，用于存储上传的文件、生成的图片、音频等媒体资源。通过统一的存储接口，可以灵活切换不同的存储后端。

### 核心价值

- **多云支持**: 支持主流云服务商的对象存储
- **本地存储**: 支持本地文件系统存储
- **统一接口**: 提供一致的文件操作 API
- **灵活切换**: 可动态配置存储后端

## 2. 支持的服务/产品

| 服务名称 | 状态 | 说明 |
|---------|------|------|
| Amazon S3 | ✅ 支持 | AWS 对象存储服务 |
| 阿里云 OSS | ✅ 支持 | 阿里云对象存储 |
| 腾讯云 COS | ✅ 支持 | 腾讯云对象存储 |
| Azure Blob Storage | ✅ 支持 | Microsoft Azure 对象存储 |
| Google Cloud Storage | ✅ 支持 | Google Cloud 对象存储 |
| 华为云 OBS | ✅ 支持 | 华为云对象存储 |
| 百度云 BOS | ✅ 支持 | 百度云对象存储 |
| 火山引擎 TOS | ✅ 支持 | 字节跳动云对象存储 |
| Oracle OCI Storage | ✅ 支持 | Oracle 云对象存储 |
| Supabase Storage | ✅ 支持 | Supabase 存储服务 |
| OpenDAL | ✅ 支持 | 统一数据访问层，支持多种存储 |
| ClickZetta Volume | ✅ 支持 | ClickZetta 存储卷 |
| Local Storage | ✅ 支持 | 本地文件系统存储 |

## 3. 集成方式

### 3.1 架构设计

```
┌─────────────────────────────────────────────┐
│           Application Layer                  │
├─────────────────────────────────────────────┤
│          Storage Extension                   │
│  ┌───────────────────────────────────────┐  │
│  │     Storage Factory                   │  │
│  │  - 根据配置创建存储实例                │  │
│  │  - 管理存储连接                        │  │
│  └───────────────────────────────────────┘  │
├─────────────────────────────────────────────┤
│        Base Storage Interface                │
│  ┌───────────────────────────────────────┐  │
│  │  - save(filename, data)               │  │
│  │  - load(filename)                     │  │
│  │  - download(filename, target_path)    │  │
│  │  - exists(filename)                   │  │
│  │  - delete(filename)                   │  │
│  └───────────────────────────────────────┘  │
├─────────────────────────────────────────────┤
│       Storage Implementations                │
│  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐       │
│  │  S3  │ │ OSS  │ │Azure │ │Local │  ...  │
│  └──────┘ └──────┘ └──────┘ └──────┘       │
└─────────────────────────────────────────────┘
```

### 3.2 核心接口

```python
class BaseStorage:
    """Base class for storage"""
    
    def save(self, filename: str, data: bytes):
        """Save file"""
        raise NotImplementedError
    
    def load(self, filename: str) -> bytes:
        """Load file"""
        raise NotImplementedError
    
    def download(self, filename: str, target_filepath: str):
        """Download file to local path"""
        raise NotImplementedError
    
    def exists(self, filename: str) -> bool:
        """Check if file exists"""
        raise NotImplementedError
    
    def delete(self, filename: str):
        """Delete file"""
        raise NotImplementedError
```

### 3.3 配置方式

#### 环境变量配置

```bash
# 存储类型
STORAGE_TYPE=s3

# S3 配置
S3_ENDPOINT=https://s3.amazonaws.com
S3_BUCKET_NAME=dify
S3_ACCESS_KEY=your_access_key
S3_SECRET_KEY=your_secret_key
S3_REGION=us-east-1

# 阿里云 OSS 配置
ALIYUN_OSS_BUCKET_NAME=dify
ALIYUN_OSS_ACCESS_KEY=your_access_key
ALIYUN_OSS_SECRET_KEY=your_secret_key
ALIYUN_OSS_ENDPOINT=https://oss-cn-hangzhou.aliyuncs.com

# Azure Blob 配置
AZURE_BLOB_ACCOUNT_NAME=your_account
AZURE_BLOB_ACCOUNT_KEY=your_key
AZURE_BLOB_CONTAINER_NAME=dify

# Google Cloud Storage 配置
GOOGLE_STORAGE_BUCKET_NAME=dify
GOOGLE_STORAGE_SERVICE_ACCOUNT_JSON_BASE64=base64_encoded_json

# 本地存储配置
STORAGE_LOCAL_PATH=/app/storage
```

## 4. 代码实现

### 4.1 核心代码路径

```
api/extensions/storage/
├── base_storage.py              # 存储基类
├── storage_type.py              # 存储类型枚举
├── aws_s3_storage.py           # S3 实现
├── aliyun_oss_storage.py       # 阿里云 OSS 实现
├── tencent_cos_storage.py      # 腾讯云 COS 实现
├── azure_blob_storage.py       # Azure Blob 实现
├── google_cloud_storage.py     # GCS 实现
├── huawei_obs_storage.py       # 华为云 OBS 实现
├── baidu_obs_storage.py        # 百度云 BOS 实现
├── volcengine_tos_storage.py   # 火山引擎 TOS 实现
├── oracle_oci_storage.py       # Oracle OCI 实现
├── supabase_storage.py         # Supabase 实现
├── opendal_storage.py          # OpenDAL 实现
└── clickzetta_volume/          # ClickZetta 实现

api/extensions/ext_storage.py   # 存储扩展初始化
```

### 4.2 存储类型枚举

```python
# api/extensions/storage/storage_type.py
from enum import StrEnum

class StorageType(StrEnum):
    ALIYUN_OSS = "aliyun-oss"
    AZURE_BLOB = "azure-blob"
    BAIDU_OBS = "baidu-obs"
    CLICKZETTA_VOLUME = "clickzetta-volume"
    GOOGLE_STORAGE = "google-storage"
    HUAWEI_OBS = "huawei-obs"
    LOCAL = "local"
    OCI_STORAGE = "oci-storage"
    OPENDAL = "opendal"
    S3 = "s3"
    TENCENT_COS = "tencent-cos"
    VOLCENGINE_TOS = "volcengine-tos"
    SUPABASE = "supabase"
```

### 4.3 存储工厂

```python
# api/extensions/ext_storage.py
from extensions.storage.storage_type import StorageType

def init_app(app):
    storage_type = app.config.get('STORAGE_TYPE')
    
    if storage_type == StorageType.S3:
        from extensions.storage.aws_s3_storage import AwsS3Storage
        app.extensions['storage'] = AwsS3Storage(
            bucket_name=app.config.get('S3_BUCKET_NAME'),
            # ... other config
        )
    elif storage_type == StorageType.ALIYUN_OSS:
        from extensions.storage.aliyun_oss_storage import AliyunOssStorage
        app.extensions['storage'] = AliyunOssStorage(
            bucket_name=app.config.get('ALIYUN_OSS_BUCKET_NAME'),
            # ... other config
        )
    # ... other storage types
```

## 5. 使用示例

### 5.1 保存文件

```python
from extensions.ext_storage import storage

# 保存文件
filename = "uploads/image.png"
with open("/tmp/image.png", "rb") as f:
    data = f.read()
    storage.save(filename, data)
```

### 5.2 加载文件

```python
# 加载文件
data = storage.load(filename)

# 写入本地
with open("/tmp/downloaded_image.png", "wb") as f:
    f.write(data)
```

### 5.3 下载文件

```python
# 直接下载到指定路径
storage.download(filename, "/tmp/downloaded_image.png")
```

### 5.4 检查文件存在

```python
# 检查文件是否存在
if storage.exists(filename):
    print("File exists")
else:
    print("File not found")
```

### 5.5 删除文件

```python
# 删除文件
storage.delete(filename)
```

## 6. 错误处理

### 6.1 常见错误

```python
try:
    data = storage.load(filename)
except FileNotFoundError:
    logger.error(f"File not found: {filename}")
except PermissionError:
    logger.error(f"Permission denied: {filename}")
except Exception as e:
    logger.error(f"Storage error: {e}")
```

### 6.2 重试策略

```python
from tenacity import retry, stop_after_attempt, wait_exponential

@retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=1, min=4, max=10)
)
def save_with_retry(filename, data):
    return storage.save(filename, data)
```

## 7. 性能优化

### 7.1 分块上传

```python
# 大文件分块上传
def upload_large_file(filename, filepath, chunk_size=5*1024*1024):
    with open(filepath, 'rb') as f:
        part_number = 1
        while True:
            chunk = f.read(chunk_size)
            if not chunk:
                break
            storage.save(f"{filename}.part{part_number}", chunk)
            part_number += 1
```

### 7.2 CDN 加速

```python
# 使用 CDN 域名访问文件
def get_file_url(filename):
    cdn_domain = dify_config.STORAGE_CDN_DOMAIN
    if cdn_domain:
        return f"https://{cdn_domain}/{filename}"
    return storage.get_url(filename)
```

### 7.3 缓存策略

```python
# 缓存小文件到 Redis
from extensions.ext_redis import redis_client

def load_with_cache(filename):
    cache_key = f"storage:file:{filename}"
    cached = redis_client.get(cache_key)
    
    if cached:
        return cached
    
    data = storage.load(filename)
    if len(data) < 1024 * 1024:  # 小于 1MB 缓存
        redis_client.setex(cache_key, 3600, data)
    
    return data
```

## 8. 监控与日志

### 8.1 存储监控

```python
import time

def monitor_storage_operation(operation_name):
    def decorator(func):
        def wrapper(*args, **kwargs):
            start_time = time.time()
            try:
                result = func(*args, **kwargs)
                end_time = time.time()
                logger.info(
                    f"Storage operation: {operation_name}, "
                    f"latency: {end_time - start_time:.2f}s"
                )
                return result
            except Exception as e:
                logger.error(f"Storage operation failed: {operation_name}, error: {e}")
                raise
        return wrapper
    return decorator

@monitor_storage_operation("save")
def save(filename, data):
    return storage.save(filename, data)
```

## 9. 测试

### 9.1 单元测试

```python
import pytest
from unittest.mock import Mock, patch

@patch('boto3.client')
def test_s3_save(mock_client):
    storage = AwsS3Storage(
        bucket_name="test-bucket",
        # ... config
    )
    
    storage.save("test.txt", b"test data")
    assert mock_client.called
```

## 10. 扩展新服务

### 10.1 实现存储类

```python
# api/extensions/storage/my_storage.py
from extensions.storage.base_storage import BaseStorage

class MyStorage(BaseStorage):
    def __init__(self, bucket_name: str, **kwargs):
        self.bucket_name = bucket_name
        # 初始化客户端
    
    def save(self, filename: str, data: bytes):
        # 实现保存逻辑
        pass
    
    def load(self, filename: str) -> bytes:
        # 实现加载逻辑
        pass
    
    def exists(self, filename: str) -> bool:
        # 实现检查逻辑
        pass
    
    def delete(self, filename: str):
        # 实现删除逻辑
        pass
```

### 10.2 添加到枚举

```python
# api/extensions/storage/storage_type.py
class StorageType(StrEnum):
    # ... existing types
    MY_STORAGE = "my-storage"
```

### 10.3 更新工厂

```python
# api/extensions/ext_storage.py
elif storage_type == StorageType.MY_STORAGE:
    from extensions.storage.my_storage import MyStorage
    app.extensions['storage'] = MyStorage(
        bucket_name=app.config.get('MY_STORAGE_BUCKET'),
        # ... other config
    )
```

## 11. 最佳实践

### 11.1 安全性

- 使用 IAM 角色而非固定密钥（在云环境中）
- 启用传输加密（HTTPS）
- 启用存储加密
- 设置合理的访问控制策略

### 11.2 成本优化

- 使用生命周期策略自动清理旧文件
- 选择合适的存储类型（标准/低频/归档）
- 启用压缩传输
- 使用 CDN 减少回源流量

### 11.3 可靠性

- 启用跨区域复制
- 定期备份重要数据
- 设置版本控制
- 监控存储配额和流量

## 12. 参考资源

- [AWS S3 文档](https://docs.aws.amazon.com/s3/)
- [阿里云 OSS 文档](https://help.aliyun.com/product/31815.html)
- [Azure Blob 文档](https://docs.microsoft.com/azure/storage/blobs/)
- [Google Cloud Storage 文档](https://cloud.google.com/storage/docs)
