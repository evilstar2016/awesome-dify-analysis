# 数据库与缓存集成

## 1. 集成概述

Dify 使用 PostgreSQL 作为主数据库，Redis 作为缓存和消息队列，SQLAlchemy 作为 ORM 框架，实现数据持久化和高性能缓存。

## 2. 支持的服务/产品

| 组件 | 服务 | 状态 | 说明 |
|------|------|------|------|
| 主数据库 | PostgreSQL | ✅ 支持 | 12+ 版本，推荐 15+ |
| 缓存 | Redis | ✅ 支持 | 6.0+，支持单机/哨兵/集群 |
| ORM | SQLAlchemy | ✅ 支持 | 2.x 版本 |
| 迁移 | Flask-Migrate/Alembic | ✅ 支持 | 数据库版本管理 |

## 3. PostgreSQL 集成

### 3.1 配置

```bash
# 数据库连接配置
DB_USERNAME=postgres
DB_PASSWORD=your_password
DB_HOST=db
DB_PORT=5432
DB_DATABASE=dify

# 连接池配置
SQLALCHEMY_POOL_SIZE=30
SQLALCHEMY_POOL_RECYCLE=3600
SQLALCHEMY_ECHO=false
```

### 3.2 连接管理

```python
# api/models/engine.py
from flask_sqlalchemy import SQLAlchemy

db = SQLAlchemy()

# api/extensions/ext_database.py
def init_app(app):
    db.init_app(app)
    
    # 配置连接池
    app.config['SQLALCHEMY_ENGINE_OPTIONS'] = {
        'pool_size': 30,
        'pool_recycle': 3600,
        'pool_pre_ping': True,
    }
```

### 3.3 模型定义

```python
from models.engine import db

class Account(db.Model):
    __tablename__ = 'accounts'
    
    id = db.Column(db.String(255), primary_key=True)
    name = db.Column(db.String(255), nullable=False)
    email = db.Column(db.String(255), unique=True, nullable=False)
    created_at = db.Column(db.DateTime, default=db.func.now())
```

### 3.4 查询操作

```python
# 查询
account = db.session.query(Account).filter_by(email=email).first()

# 插入
new_account = Account(id=id, name=name, email=email)
db.session.add(new_account)
db.session.commit()

# 更新
account.name = new_name
db.session.commit()

# 删除
db.session.delete(account)
db.session.commit()
```

## 4. Redis 集成

### 4.1 配置

```bash
# Redis 单机模式
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=your_password
REDIS_USE_SSL=false

# Redis 哨兵模式
REDIS_USE_SENTINEL=true
REDIS_SENTINELS=sentinel1:26379,sentinel2:26379
REDIS_SENTINEL_SERVICE_NAME=mymaster
REDIS_SENTINEL_USERNAME=sentinel_user
REDIS_SENTINEL_PASSWORD=sentinel_password

# Redis 集群模式
REDIS_USE_CLUSTER=true
REDIS_CLUSTER_NODES=node1:6379,node2:6379,node3:6379
```

### 4.2 连接管理

```python
# api/extensions/ext_redis.py
import redis
from redis.sentinel import Sentinel

class RedisClientWrapper:
    def __init__(self):
        self._client = None
    
    @property
    def client(self):
        if self._client is None:
            if dify_config.REDIS_USE_SENTINEL:
                self._client = self._create_sentinel_client()
            elif dify_config.REDIS_USE_CLUSTER:
                self._client = self._create_cluster_client()
            else:
                self._client = self._create_standalone_client()
        return self._client
    
    def _create_standalone_client(self):
        return redis.Redis(
            host=dify_config.REDIS_HOST,
            port=dify_config.REDIS_PORT,
            db=dify_config.REDIS_DB,
            password=dify_config.REDIS_PASSWORD,
            ssl=dify_config.REDIS_USE_SSL,
        )

redis_client = RedisClientWrapper().client
```

### 4.3 使用示例

```python
from extensions.ext_redis import redis_client

# 字符串操作
redis_client.set('key', 'value')
value = redis_client.get('key')

# 设置过期时间
redis_client.setex('key', 3600, 'value')  # 1小时过期

# Hash 操作
redis_client.hset('user:123', 'name', 'John')
redis_client.hget('user:123', 'name')

# List 操作
redis_client.lpush('queue', 'task1')
task = redis_client.rpop('queue')

# Set 操作
redis_client.sadd('tags', 'python', 'flask')
members = redis_client.smembers('tags')

# 分布式锁
lock = redis_client.lock('my_lock', timeout=10)
if lock.acquire(blocking=False):
    try:
        # 执行需要加锁的操作
        pass
    finally:
        lock.release()
```

## 5. Celery 集成

### 5.1 配置

```bash
# Celery Broker (Redis)
CELERY_BROKER_URL=redis://redis:6379/1

# Celery Backend (可选)
CELERY_RESULT_BACKEND=redis://redis:6379/2
```

### 5.2 任务定义

```python
# api/extensions/ext_celery.py
from celery import Celery

celery = Celery('dify')

@celery.task
def process_document(document_id):
    """异步处理文档"""
    # 处理逻辑
    pass

# 调用任务
process_document.delay(document_id='doc_123')
```

## 6. 数据迁移

### 6.1 创建迁移

```bash
# 创建新迁移
uv run --project api flask db migrate -m "Add new column"

# 应用迁移
uv run --project api flask db upgrade

# 回滚迁移
uv run --project api flask db downgrade
```

### 6.2 迁移文件

```python
# api/migrations/versions/xxx_add_column.py
def upgrade():
    op.add_column('accounts', 
        sa.Column('phone', sa.String(20), nullable=True)
    )

def downgrade():
    op.drop_column('accounts', 'phone')
```

## 7. 性能优化

### 7.1 数据库优化

```python
# 使用索引
class Account(db.Model):
    email = db.Column(db.String(255), index=True)
    created_at = db.Column(db.DateTime, index=True)

# 批量查询
accounts = db.session.query(Account).filter(
    Account.id.in_(account_ids)
).all()

# 预加载关联对象
from sqlalchemy.orm import joinedload
accounts = db.session.query(Account).options(
    joinedload(Account.tenant)
).all()
```

### 7.2 Redis 缓存模式

```python
def get_user_with_cache(user_id):
    """带缓存的用户查询"""
    cache_key = f"user:{user_id}"
    
    # 尝试从缓存获取
    cached = redis_client.get(cache_key)
    if cached:
        return json.loads(cached)
    
    # 从数据库查询
    user = db.session.query(User).get(user_id)
    
    # 写入缓存
    redis_client.setex(cache_key, 3600, json.dumps(user.to_dict()))
    
    return user
```

## 8. 监控与日志

```python
# 数据库慢查询日志
import logging
from sqlalchemy import event
from sqlalchemy.engine import Engine

logger = logging.getLogger(__name__)

@event.listens_for(Engine, "before_cursor_execute")
def before_cursor_execute(conn, cursor, statement, parameters, context, executemany):
    conn.info.setdefault('query_start_time', []).append(time.time())

@event.listens_for(Engine, "after_cursor_execute")
def after_cursor_execute(conn, cursor, statement, parameters, context, executemany):
    total = time.time() - conn.info['query_start_time'].pop(-1)
    if total > 1.0:  # 慢查询阈值 1 秒
        logger.warning(f"Slow query ({total:.2f}s): {statement}")
```

## 9. 最佳实践

### 9.1 数据库

- 使用事务确保数据一致性
- 避免 N+1 查询问题
- 合理使用索引
- 定期备份数据

### 9.2 Redis

- 设置合理的过期时间
- 避免大 key
- 使用 Pipeline 批量操作
- 监控内存使用

## 10. 参考资源

- [PostgreSQL 文档](https://www.postgresql.org/docs/)
- [Redis 文档](https://redis.io/documentation)
- [SQLAlchemy 文档](https://docs.sqlalchemy.org/)
- [Celery 文档](https://docs.celeryproject.org/)
