# 认证与监控集成

## 1. 集成概述

Dify 集成了认证、监控和可观测性服务，确保应用的安全性和可靠性。

## 2. 支持的服务/产品

| 服务类型 | 提供商 | 状态 | 说明 |
|---------|--------|------|------|
| 错误监控 | Sentry | ✅ 支持 | 错误追踪和性能监控 |
| 可观测性 | OpenTelemetry | ✅ 支持 | 分布式追踪和指标收集 |
| 认证 | OAuth 2.0 | ✅ 支持 | 标准 OAuth 认证 |
| 认证 | JWT | ✅ 支持 | Token 认证 |
| 认证 | API Key | ✅ 支持 | API 密钥认证 |
| 日志 | 标准日志 | ✅ 支持 | Python logging |

## 3. Sentry 集成

### 3.1 配置

```bash
# Sentry DSN
SENTRY_DSN=https://xxx@sentry.io/xxx

# 采样率
SENTRY_TRACES_SAMPLE_RATE=1.0
SENTRY_PROFILES_SAMPLE_RATE=1.0

# 环境
SENTRY_ENVIRONMENT=production
```

### 3.2 初始化

```python
# api/extensions/ext_sentry.py
import sentry_sdk
from sentry_sdk.integrations.flask import FlaskIntegration
from sentry_sdk.integrations.celery import CeleryIntegration

if dify_config.SENTRY_DSN:
    sentry_sdk.init(
        dsn=dify_config.SENTRY_DSN,
        integrations=[
            FlaskIntegration(),
            CeleryIntegration(),
        ],
        traces_sample_rate=dify_config.SENTRY_TRACES_SAMPLE_RATE,
        profiles_sample_rate=dify_config.SENTRY_PROFILES_SAMPLE_RATE,
        environment=dify_config.SENTRY_ENVIRONMENT,
    )
```

### 3.3 使用示例

```python
import sentry_sdk

# 捕获异常
try:
    # 业务逻辑
    process_data()
except Exception as e:
    sentry_sdk.capture_exception(e)
    raise

# 添加上下文
with sentry_sdk.push_scope() as scope:
    scope.set_tag("user_id", user_id)
    scope.set_context("request", {
        "url": request.url,
        "method": request.method
    })
    # 执行操作

# 记录消息
sentry_sdk.capture_message("Important event occurred", level="info")
```

## 4. OpenTelemetry 集成

### 4.1 配置

```bash
# OpenTelemetry 配置
OTEL_ENABLED=true
OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
OTEL_EXPORTER_OTLP_PROTOCOL=http/protobuf

# 服务信息
OTEL_SERVICE_NAME=dify-api
OTEL_RESOURCE_ATTRIBUTES=service.version=1.0.0
```

### 4.2 初始化

```python
# api/extensions/ext_otel.py
from opentelemetry import trace, metrics
from opentelemetry.sdk.trace import TracerProvider
from opentelemetry.sdk.metrics import MeterProvider
from opentelemetry.exporter.otlp.proto.http.trace_exporter import OTLPSpanExporter
from opentelemetry.exporter.otlp.proto.http.metric_exporter import OTLPMetricExporter

def init_app(app):
    if not dify_config.OTEL_ENABLED:
        return
    
    # 配置 Tracer
    trace.set_tracer_provider(TracerProvider())
    tracer_provider = trace.get_tracer_provider()
    tracer_provider.add_span_processor(
        BatchSpanProcessor(
            OTLPSpanExporter(
                endpoint=f"{dify_config.OTEL_EXPORTER_OTLP_ENDPOINT}/v1/traces"
            )
        )
    )
    
    # 配置 Meter
    metrics.set_meter_provider(MeterProvider())
    # ...
```

### 4.3 使用示例

```python
from opentelemetry import trace

tracer = trace.get_tracer(__name__)

# 创建 Span
with tracer.start_as_current_span("process_request") as span:
    span.set_attribute("user_id", user_id)
    span.set_attribute("request_id", request_id)
    
    # 业务逻辑
    result = process_data()
    
    span.set_attribute("result_count", len(result))

# 记录指标
from opentelemetry import metrics

meter = metrics.get_meter(__name__)
request_counter = meter.create_counter(
    "api_requests",
    description="API 请求计数"
)

request_counter.add(1, {"endpoint": "/api/chat", "status": "success"})
```

## 5. 认证集成

### 5.1 JWT 认证

```python
from libs.passport import PassportService

# 生成 Token
token = PassportService().issue(
    payload={
        "user_id": user_id,
        "exp": int(time.time()) + 3600  # 1 小时过期
    }
)

# 验证 Token
try:
    payload = PassportService().verify(token)
    user_id = payload.get("user_id")
except Exception as e:
    raise Unauthorized("Invalid token")
```

### 5.2 API Key 认证

```python
from flask import request
from werkzeug.exceptions import Unauthorized

@app.before_request
def authenticate():
    api_key = request.headers.get("X-API-Key")
    
    if not api_key:
        raise Unauthorized("API key required")
    
    # 验证 API key
    if not validate_api_key(api_key):
        raise Unauthorized("Invalid API key")
```

### 5.3 OAuth 2.0 认证

参考 [消息平台集成](./04-消息平台集成.md) 文档。

## 6. 日志集成

### 6.1 配置

```bash
# 日志级别
LOG_LEVEL=INFO

# 日志文件
LOG_FILE=/var/log/dify/app.log
```

### 6.2 使用示例

```python
import logging

logger = logging.getLogger(__name__)

# 记录日志
logger.debug("Debug message")
logger.info("Info message")
logger.warning("Warning message")
logger.error("Error message")
logger.critical("Critical message")

# 结构化日志
logger.info("User login", extra={
    "user_id": user_id,
    "ip_address": request.remote_addr,
    "user_agent": request.user_agent.string
})
```

## 7. 性能监控

### 7.1 请求追踪

```python
import time
from flask import request

@app.before_request
def start_timer():
    request.start_time = time.time()

@app.after_request
def log_request(response):
    latency = time.time() - request.start_time
    
    logger.info(
        f"{request.method} {request.path} "
        f"{response.status_code} {latency:.2f}s"
    )
    
    return response
```

### 7.2 资源监控

```python
import psutil

def log_system_metrics():
    """记录系统指标"""
    cpu_percent = psutil.cpu_percent()
    memory_percent = psutil.virtual_memory().percent
    
    logger.info(f"System metrics - CPU: {cpu_percent}%, Memory: {memory_percent}%")
```

## 8. 告警配置

### 8.1 Sentry 告警

在 Sentry 控制台配置：
- 错误率阈值告警
- 响应时间告警
- 特定错误类型告警

### 8.2 自定义告警

```python
def check_health():
    """健康检查"""
    # 检查数据库
    try:
        db.session.execute("SELECT 1")
    except Exception as e:
        send_alert("Database health check failed", str(e))
        return False
    
    # 检查 Redis
    try:
        redis_client.ping()
    except Exception as e:
        send_alert("Redis health check failed", str(e))
        return False
    
    return True

def send_alert(title, message):
    """发送告警"""
    # 通过 Sentry、邮件或其他方式发送告警
    sentry_sdk.capture_message(f"{title}: {message}", level="error")
```

## 9. 最佳实践

### 9.1 错误监控

- 捕获所有未处理的异常
- 添加足够的上下文信息
- 设置合理的采样率
- 配置告警规则

### 9.2 可观测性

- 追踪关键业务流程
- 记录性能指标
- 监控资源使用
- 分析用户行为

### 9.3 认证安全

- 使用 HTTPS 传输
- 定期轮换密钥
- 实施速率限制
- 记录认证事件

### 9.4 日志管理

- 结构化日志输出
- 敏感信息脱敏
- 集中式日志收集
- 设置日志保留期

## 10. 参考资源

- [Sentry 文档](https://docs.sentry.io/)
- [OpenTelemetry 文档](https://opentelemetry.io/docs/)
- [OAuth 2.0 RFC](https://tools.ietf.org/html/rfc6749)
- [JWT 文档](https://jwt.io/)
