# 核心模块（Core Modules）

> ⚙️ Dify 核心功能模块的架构设计与实现分析

## 📋 目录概览

本目录包含 Dify **8 大核心模块**的深度技术分析，每个模块都有独立的文档和架构图。

## 🗂️ 模块列表

### 🔄 [Workflow 工作流引擎](./workflow/)
**事件驱动的工作流编排与执行系统**

核心能力：
- 可视化工作流编排
- 多种节点类型（LLM、知识检索、代码执行、条件判断等）
- 事件驱动架构
- 异步执行与状态管理
- 支持串行、并行、条件分支

**推荐阅读**：
- [工作流管理技术文档](./workflow/workflow_management_technical_doc.md)
- [工作流类型说明](./workflow/workflow_types_documentation.md)
- [节点开发指南](./workflow/workflow_component_development_guide.md)

---

### 🤖 [Agent 智能体系统](./agent/)
**多策略 Agent 实现与工具调用机制**

核心能力：
- 策略模式：Function Calling、ReAct、Plan & Execute
- 工具自动发现与调用
- 思维链（Chain of Thought）
- 多轮对话管理
- 记忆系统（短期 + 长期）

**设计亮点**：
- 采用策略模式，易于扩展新的 Agent 类型
- 运行时动态切换策略
- 装饰器模式增强 Agent 能力

---

### 📚 [Knowledge Base 知识库系统](./knowledgeBase/)
**RAG（检索增强生成）完整实现**

核心能力：
- 多格式文档解析（PDF、Word、Markdown、TXT、HTML）
- 智能文本分片（固定长度、语义分片、递归分片）
- 向量化与索引构建
- 多种检索策略（语义检索、关键词检索、混合检索）
- 重排序（Rerank）优化

**技术栈**：
- 支持 28+ 种向量数据库
- 多种 Embedding 模型
- 文档处理管道（Extractor → Splitter → Embedding → Retrieval）

---

### 🔌 [Model Runtime 模型运行时](./model_runtime/)
**统一的多模型抽象层**

核心能力：
- 统一的模型调用接口
- 支持 40+ 主流 LLM 提供商
- 负载均衡与路由
- Token 计算与优化
- 错误处理与重试机制

**设计模式**：
- 工厂模式：创建不同的模型提供商
- 适配器模式：统一不同模型的 API
- 策略模式：不同的调用策略

---

### 💬 [Prompt 提示词工程](./prompt/)
**提示词管理与优化系统**

核心能力：
- Prompt 模板系统
- 变量管理与注入
- 多轮对话上下文管理
- Prompt 版本控制
- Prompt 优化建议

**应用场景**：
- 应用级 Prompt 管理
- Agent 的提示词构建
- 工作流节点的 Prompt 配置

---

### 🛠️ [Tools & Plugins 工具插件系统](./tools&plugins/)
**工具调用与插件扩展机制**

核心能力：
- 工具自动注册与发现
- 参数验证与类型检查
- 工具执行与结果解析
- 自定义工具开发
- 工具市场（社区贡献）

**内置工具**：
- API 调用工具
- 数据库查询工具
- 文件操作工具
- 代码执行工具

---

### 📊 [Observability 可观测性系统](./observability/)
**日志、追踪、监控完整方案**

核心能力：
- 结构化日志（Structured Logging）
- 分布式追踪（Distributed Tracing）
- 指标收集（Metrics）
- 错误追踪（Error Tracking）
- 性能分析（Performance Profiling）

**技术集成**：
- OpenTelemetry 标准
- Sentry 错误监控
- 自定义日志系统

---

### 🔐 [Permission 权限管理系统](./permission/)
**RBAC 权限模型与访问控制**

核心能力：
- 基于角色的访问控制（RBAC）
- 资源级权限管理
- 多租户隔离
- API 级别的权限检查
- 细粒度权限控制

**权限模型**：
- 用户（User）
- 角色（Role）
- 权限（Permission）
- 资源（Resource）

---

## 🏗️ 模块间关系

```
┌─────────────────────────────────────────────────────┐
│                   应用层                             │
│  Workflow / Agent / Knowledge Base                  │
└───────────┬─────────────────────────┬───────────────┘
            │                         │
            ↓                         ↓
┌───────────────────┐     ┌──────────────────────┐
│  Model Runtime    │     │  Tools & Plugins     │
│  (模型抽象)       │     │  (工具调用)          │
└───────────────────┘     └──────────────────────┘
            │                         │
            └──────────┬──────────────┘
                       ↓
            ┌──────────────────┐
            │  Prompt Engine   │
            │  (提示词管理)    │
            └──────────────────┘
                       │
        ┌──────────────┴──────────────┐
        ↓                             ↓
┌──────────────┐            ┌─────────────────┐
│ Observability│            │   Permission    │
│ (可观测性)   │            │   (权限管理)    │
└──────────────┘            └─────────────────┘
```

## 🎯 核心设计原则

### 1. 模块化设计
- 每个模块职责单一、边界清晰
- 模块间通过接口通信，降低耦合
- 支持独立开发、测试、部署

### 2. 可扩展性
- 采用策略模式、工厂模式等设计模式
- 支持插件化扩展
- 易于添加新功能而不修改现有代码

### 3. 高内聚低耦合
- 相关功能聚合在同一模块
- 模块间依赖最小化
- 通过事件或消息解耦

### 4. 领域驱动设计（DDD）
- 核心模块对应业务领域
- 清晰的领域边界
- 丰富的领域模型

## 📚 阅读建议

### 对于新手
1. 先阅读 [Workflow](./workflow/) 理解工作流概念
2. 再看 [Agent](./agent/) 了解智能体实现
3. 然后学习 [Knowledge Base](./knowledgeBase/) 掌握 RAG

### 对于架构师
1. 重点关注各模块的**设计模式**
2. 理解模块间的**依赖关系**
3. 学习 Dify 的**架构演进**过程

### 对于开发者
1. 查看感兴趣模块的详细文档
2. 阅读核心代码实现
3. 参考示例进行二次开发

## 🔗 快速导航

| 模块 | 核心文档 | 关键词 |
|------|---------|--------|
| [Workflow](./workflow/) | 工作流管理、节点开发 | `Workflow` 或 `工作流` |
| [Agent](./agent/) | 策略模式、工具调用 | `Agent` 或 `智能体` |
| [Knowledge Base](./knowledgeBase/) | RAG、向量检索 | `知识库` 或 `RAG` |
| [Model Runtime](./model_runtime/) | 模型抽象、负载均衡 | `模型运行时` 或 `模型` |
| [Prompt](./prompt/) | 模板管理、变量注入 | `Prompt` 或 `提示词` |
| [Tools & Plugins](./tools&plugins/) | 工具注册、插件开发 | `工具` 或 `插件` |
| [Observability](./observability/) | 日志、追踪、监控 | `可观测性` 或 `监控` |
| [Permission](./permission/) | RBAC、权限控制 | `权限` 或 `RBAC` |

---

## 📖 深入理解设计思想

本目录提供了 **8 大核心模块**的架构概览。

想深入理解**"为什么这样设计"**？我们定期发布：

### 🤔 设计分析系列
- **为什么 Agent 选择策略模式？** - 3 个方案的权衡分析
- **Workflow 的事件驱动架构演进** - 从 v0.1 到 v1.0
- **知识库为什么不用 LangChain 的 RAG？** - 技术选型考量
- **模型运行时的统一抽象设计** - 如何支持 40+ 种模型
- **Prompt 模板系统的 3 次重构** - 架构演进历程
- **工具调用的安全沙箱设计** - 平衡灵活性与安全
- **可观测性为什么选择 OpenTelemetry？** - 标准化选型
- **权限系统的演进：从简单到企业级** - RBAC 实践

### 🛠️ 实战经验系列
- **Workflow 执行超时的 3 种场景** - 附完整解决方案
- **Agent 陷入死循环：检测与熔断** - 生产问题实战
- **知识库检索不准确的 7 个原因** - 调优指南
- **大模型 Token 超限的限流策略** - 成本控制
- **大文档处理 OOM 优化** - 内存管理实战
- **向量数据库性能对比实测** - 选型参考
- **多租户数据隔离的 5 个大坑** - 企业级必读
- **生产部署 Checklist** - 21 个关键配置

📱 **关注公众号「AI架构解析」**

回复对应的**关键词**获取该模块的完整深度内容

<!-- ![公众号二维码](../qrcode.png) -->

---

💡 **我们的内容理念**

```
GitHub 开源（本目录）
    ↓
架构概览 + 核心流程
告诉你"是什么"（What）+ 基础的"怎么做"（How）
    ↓
公众号深度（定期更新）
    ↓
设计分析 + 实战经验
告诉你"为什么"（Why）+ "怎么避坑"（Pitfalls）
```

从理解架构到落地实战，一站式解决。

💬 **交流讨论**
- GitHub Issue/Discussion：技术问题讨论
- 公众号留言：一对一答疑

---

## 🤝 贡献指南

欢迎补充和完善模块分析文档：
- 发现文档错误或不准确的地方
- 有新的架构分析角度或见解
- 想贡献某个模块的深度分析

请提交 Issue 或 Pull Request！
