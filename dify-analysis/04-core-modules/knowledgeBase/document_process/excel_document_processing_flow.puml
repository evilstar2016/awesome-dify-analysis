@startuml Excel文档处理详细时序图

!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding      6
skinparam ParticipantPadding    30


title **Dify Excel文档(.xlsx/.xls)处理详细时序图**

actor "用户" as User
participant "文件上传API" as FileAPI
participant "数据集服务" as DatasetService
participant "索引运行器" as IndexingRunner
participant "Excel提取器" as ExcelExtractor
participant "openpyxl" as OpenPyXL
participant "pandas" as Pandas
participant "xlrd" as XLRD
database "PostgreSQL" as Database

== 1. 文件上传阶段 ==
User -> FileAPI: POST /files (上传.xlsx/.xls文件)
activate FileAPI
FileAPI -> FileAPI: 验证文件类型(.xlsx/.xls)
FileAPI -> FileAPI: 保存Excel文档
FileAPI -> Database: 创建UploadFile记录
FileAPI --> User: 返回文件ID
deactivate FileAPI

== 2. 创建数据集文档 ==
User -> DatasetService: POST /datasets/{id}/documents
activate DatasetService
DatasetService -> Database: 创建DatasetDocument记录
DatasetService -> IndexingRunner: 触发异步处理任务
DatasetService --> User: 返回处理任务ID
deactivate DatasetService

== 3. Excel文档解析处理 ==
activate IndexingRunner
IndexingRunner -> ExcelExtractor: 创建Excel提取器实例
activate ExcelExtractor
ExcelExtractor -> ExcelExtractor: 检查文件扩展名

alt .xlsx文件处理
    == 4a. XLSX文件处理 (.xlsx) ==
    ExcelExtractor -> OpenPyXL: load_workbook(file_path, data_only=True)
    activate OpenPyXL
    note right: data_only=True 获取计算值而非公式
    
    loop 遍历所有工作表
        ExcelExtractor -> OpenPyXL: 获取工作表名称列表
        ExcelExtractor -> OpenPyXL: 访问工作表 wb[sheet_name]
        ExcelExtractor -> OpenPyXL: 获取工作表数据 sheet.values
        
        ExcelExtractor -> Pandas: 创建DataFrame(data, columns=cols)
        activate Pandas
        Pandas -> Pandas: dropna(how="all", inplace=True)
        note right: 删除完全空白的行
        
        loop 遍历每一行数据
            ExcelExtractor -> Pandas: iterrows() 获取行数据
            
            loop 遍历行中每个单元格
                ExcelExtractor -> Pandas: 检查单元格值 pd.notna(v)
                
                alt 单元格有超链接
                    ExcelExtractor -> OpenPyXL: 获取单元格对象 sheet.cell()
                    ExcelExtractor -> OpenPyXL: 检查 cell.hyperlink
                    ExcelExtractor -> ExcelExtractor: 格式化为 [值](链接)
                    note right: 生成Markdown链接格式
                else 普通单元格
                    ExcelExtractor -> ExcelExtractor: 格式化为 "列名":"值"
                end
            end
            
            ExcelExtractor -> ExcelExtractor: 用分号连接单元格数据
            note right: 格式: "列名1":"值1";"列名2":"值2"
            
            ExcelExtractor -> ExcelExtractor: 创建Document对象
            note right
            Document包含:
            - page_content: 行数据字符串
            - metadata: {"source": file_path}
            end note
        end
        
        deactivate Pandas
    end
    deactivate OpenPyXL

else .xls文件处理
    == 4b. XLS文件处理 (.xls) ==
    ExcelExtractor -> Pandas: pd.ExcelFile(file_path, engine="xlrd")
    activate Pandas
    ExcelExtractor -> XLRD: 使用xlrd引擎读取旧版Excel
    activate XLRD
    
    loop 遍历所有工作表
        ExcelExtractor -> Pandas: excel_file.parse(sheet_name)
        ExcelExtractor -> Pandas: dropna(how="all", inplace=True)
        
        loop 遍历每一行数据
            ExcelExtractor -> Pandas: iterrows() 获取行数据
            
            loop 遍历行中每个单元格
                ExcelExtractor -> Pandas: 检查 pd.notna(v)
                ExcelExtractor -> ExcelExtractor: 格式化为 "列名":"值"
                note right: .xls格式不支持超链接检测
            end
            
            ExcelExtractor -> ExcelExtractor: 用分号连接单元格数据
            ExcelExtractor -> ExcelExtractor: 创建Document对象
        end
    end
    
    deactivate XLRD
    deactivate Pandas
end

== 5. 返回处理结果 ==
ExcelExtractor -> ExcelExtractor: 收集所有Document对象
ExcelExtractor --> IndexingRunner: 返回Document列表
deactivate ExcelExtractor

note right of IndexingRunner
**Excel处理特点**:
- 按行生成Document对象
- 每行数据格式化为键值对
- 支持多工作表处理
- 超链接转换为Markdown格式
- 自动跳过空行
end note

== 6. 后续标准流程 ==
IndexingRunner -> IndexingRunner: 文本分割处理
note right: 每个Document通常为一行数据，无需分割

IndexingRunner -> IndexingRunner: 向量化处理
note right: 将结构化数据转换为向量

IndexingRunner -> Database: 存储DocumentSegment记录
note right: 每行Excel数据对应一个Segment

IndexingRunner -> Database: 更新文档状态为COMPLETED
deactivate IndexingRunner

== 7. 查询示例 ==
User -> DatasetService: 查询包含特定数据的行
DatasetService -> DatasetService: 向量搜索匹配的行
DatasetService --> User: 返回相关的Excel行数据
note right: 格式: "列名1":"值1";"列名2":"值2"

== Excel vs 其他文档类型对比 ==
note over ExcelExtractor, Database
**Excel文档特殊处理**:
1. **行级处理**: 每行生成一个Document对象
2. **结构化数据**: 键值对格式，便于查询
3. **多工作表**: 支持一个文件包含多个表格
4. **超链接保持**: .xlsx支持超链接提取
5. **数据类型**: 保持原始数据类型和格式

**与其他文档的差异**:
- **Word/PDF**: 连续文本，按段落分割
- **Excel**: 结构化数据，按行处理
- **CSV**: 类似处理方式但更简单
- **表格优势**: 天然的结构化数据，便于精确查询
end note

== 配置和优化 ==
note over User, Database
**Excel处理配置**:
- 支持的格式: .xlsx, .xls
- 依赖库: openpyxl, pandas, xlrd
- 数据类型: 自动检测和保持
- 内存优化: 大文件时考虑分块处理

**性能优化建议**:
- 大Excel文件分工作表处理
- 空行自动跳过
- 数据类型优化存储
- 批量Document生成
end note

@enduml