@startuml AdvancedPromptTransform_Sequence
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding      6
skinparam ParticipantPadding    30

title AdvancedPromptTransform 核心流程时序图

actor "Workflow Node" as Node
participant "LLMNode / BaseAppRunner" as Caller
participant "AdvancedPromptTransform" as Advanced
participant "PromptTemplateParser" as Parser
participant "Jinja2Formatter" as Jinja
participant "TokenBufferMemory" as Memory
participant "VariablePool" as VarPool

== 1. 初始化阶段 ==

Node -> Caller: 执行 LLM 节点
activate Caller

Caller -> Advanced: new AdvancedPromptTransform(with_variable_tmpl=True)
activate Advanced

Caller -> Advanced: get_prompt(prompt_template, inputs, query, files, context, memory_config, memory, model_config)

== 2. 模板类型判断 ==

Advanced -> Advanced: 判断 prompt_template 类型

alt prompt_template is list[ChatModelMessage]
    Advanced -> Advanced: _get_chat_model_prompt_messages()
    
    == 3a. Chat 模式处理 ==
    
    loop 遍历每个 ChatModelMessage
        Advanced -> Advanced: 获取 raw_prompt 和 edition_type
        
        alt edition_type == "basic" 或 null
            alt with_variable_tmpl == true
                Advanced -> VarPool: 从 inputs 构建变量池
                activate VarPool
                VarPool --> Advanced: variable_pool
                deactivate VarPool
                
                Advanced -> VarPool: convert_template(raw_prompt)
                activate VarPool
                VarPool --> Advanced: formatted_prompt
                deactivate VarPool
            else with_variable_tmpl == false
                Advanced -> Parser: new PromptTemplateParser(raw_prompt)
                activate Parser
                Parser --> Advanced: parser
                deactivate Parser
                
                Advanced -> Advanced: _set_context_variable()
                
                Advanced -> Parser: format(prompt_inputs)
                activate Parser
                Parser --> Advanced: formatted_prompt
                deactivate Parser
            end
        else edition_type == "jinja2"
            Advanced -> Jinja: format(template, inputs)
            activate Jinja
            Jinja --> Advanced: formatted_prompt
            deactivate Jinja
        end
        
        Advanced -> Advanced: 创建对应角色的 PromptMessage
        note right
            role == USER -> UserPromptMessage
            role == SYSTEM -> SystemPromptMessage
            role == ASSISTANT -> AssistantPromptMessage
        end note
    end
    
    == 4a. 处理查询模板 ==
    
    alt query 存在 && memory_config.query_prompt_template 存在
        Advanced -> Parser: 解析 query_prompt_template
        activate Parser
        Parser --> Advanced: formatted_query
        deactivate Parser
    end
    
    == 5a. 追加历史消息 ==
    
    alt memory 存在 && memory_config 存在
        Advanced -> Advanced: _append_chat_histories()
        Advanced -> Memory: get_history_prompt_messages()
        activate Memory
        Memory --> Advanced: history_messages
        deactivate Memory
        Advanced -> Advanced: prompt_messages.extend(history_messages)
    end
    
else prompt_template is CompletionModelPromptTemplate
    Advanced -> Advanced: _get_completion_model_prompt_messages()
    
    == 3b. Completion 模式处理 ==
    
    Advanced -> Advanced: 获取 raw_prompt 和 edition_type
    
    alt edition_type == "basic" 或 null
        Advanced -> Parser: new PromptTemplateParser(raw_prompt)
        activate Parser
        Parser --> Advanced: parser
        deactivate Parser
        
        Advanced -> Advanced: _set_context_variable()
        
        alt memory 存在 && memory_config.role_prefix 存在
            == 4b. 处理历史消息 ==
            Advanced -> Advanced: _set_histories_variable()
            
            Advanced -> Advanced: 计算剩余 token
            Advanced -> Memory: get_history_prompt_text(human_prefix, ai_prefix)
            activate Memory
            Memory --> Advanced: histories_text
            deactivate Memory
            
            Advanced -> Advanced: prompt_inputs["#histories#"] = histories_text
        end
        
        Advanced -> Advanced: _set_query_variable()
        
        Advanced -> Parser: format(prompt_inputs)
        activate Parser
        Parser --> Advanced: formatted_prompt
        deactivate Parser
    else edition_type == "jinja2"
        Advanced -> Jinja: format(template, inputs)
        activate Jinja
        Jinja --> Advanced: formatted_prompt
        deactivate Jinja
    end
    
    Advanced -> Advanced: 创建 UserPromptMessage
end

== 6. 处理文件附件 ==

alt files 存在
    Advanced -> Advanced: 构建 PromptMessageContents
    loop 每个文件
        Advanced -> Advanced: file_manager.to_prompt_message_content(file)
    end
    Advanced -> Advanced: 添加 TextPromptMessageContent
end

== 7. 添加最终查询 ==

alt query 存在
    Advanced -> Advanced: 添加 UserPromptMessage(query)
end

Advanced --> Caller: prompt_messages
deactivate Advanced

Caller --> Node: prompt_messages
deactivate Caller

@enduml
