@startuml 工作流管理核心场景时序图
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding 6
skinparam ParticipantPadding 30

title Dify 工作流管理核心场景时序图

actor "用户" as User
participant "前端界面\n(React/Next.js)" as Frontend #E3F2FD
participant "工作流控制器\n(Flask API)" as Controller #E8F5E9
participant "工作流服务\n(WorkflowService)" as Service #E8F5E9
participant "应用生成服务\n(AppGenerateService)" as AppGen #E8F5E9
participant "工作流入口\n(WorkflowEntry)" as Entry #FFF3E0
participant "图执行引擎\n(GraphEngine)" as Engine #FFF3E0
participant "调度器\n(Dispatcher)" as Dispatcher #FFF3E0
participant "工作池\n(WorkerPool)" as WorkerPool #FFF3E0
participant "节点执行器\n(Node)" as Node #FFEBEE
participant "事件管理器\n(EventManager)" as EventMgr #FCE4EC
participant "命令通道\n(CommandChannel)" as CmdChannel #F3E5F5
database "PostgreSQL" as DB #BBDEFB
database "Redis" as Cache #C8E6C9

== 工作流创建/编辑阶段 ==
User -> Frontend ++: 创建/编辑工作流
Frontend -> Frontend: 初始化工作流状态\n(hooks-store)
Frontend -> Controller ++: POST /apps/{id}/workflows/draft
note right of Controller
**DraftWorkflowApi.post()**
解析graph/features配置
验证环境变量
end note
Controller -> Service ++: sync_draft_workflow()
Service -> Service: validate_features_structure()
Service -> DB ++: 创建/更新Workflow记录
DB --> Service --: 返回workflow对象
Service --> Controller --: 返回workflow + hash
Controller --> Frontend --: {result, hash, updated_at}
Frontend -> Frontend: 更新本地状态
Frontend --> User --: 显示编辑器

== 工作流发布阶段 ==
User -> Frontend ++: 发布工作流
Frontend -> Controller ++: POST /apps/{id}/workflows/publish
Controller -> Service ++: publish_workflow()
Service -> Service: _validate_workflow_credentials()
Service -> DB ++: 创建新版本Workflow
DB --> Service --: 返回published workflow
Service -> Service: app_published_workflow_was_updated事件
Service --> Controller --: 返回发布结果
Controller --> Frontend --: 发布成功
Frontend --> User --: 显示发布状态

== 工作流执行阶段 ==
User -> Frontend ++: 点击运行工作流
Frontend -> Frontend: handleStartWorkflowRun()
Frontend -> Controller ++: POST /workflows/draft/run
note right of Controller
**DraftWorkflowRunApi.post()**
解析inputs/files参数
end note
Controller -> AppGen ++: generate()
note right of AppGen
创建任务队列管理器
初始化工作流运行器
end note

AppGen -> Entry ++: 创建WorkflowEntry实例
note right of Entry
**初始化参数:**
• tenant_id, app_id
• graph配置
• variable_pool
• command_channel
end note

Entry -> Entry: 检查call_depth限制
Entry -> Engine ++: 创建GraphEngine实例
note right of Engine
**GraphEngine初始化:**
• GraphStateManager
• ReadyQueue
• EventManager
• EdgeProcessor
• SkipPropagator
• CommandProcessor
• WorkerPool
end note

Engine -> Engine: _validate_graph_state_consistency()
Engine -> Engine: 添加执行层(Layers)\n- DebugLoggingLayer\n- ExecutionLimitsLayer

AppGen -> Entry: run()
Entry -> Engine: run()

Engine -> EventMgr: 初始化Layers
Engine -> EventMgr ++: GraphRunStartedEvent
EventMgr --> Controller: 推送事件(SSE)
Controller --> Frontend: 实时更新状态
Frontend --> User: 显示执行开始

Engine -> Engine: _start_execution()
Engine -> WorkerPool ++: start()
note right of WorkerPool
**动态工作池:**
min_workers, max_workers
scale_up_threshold
end note
Engine -> Dispatcher ++: start()

loop 节点执行循环
    Dispatcher -> WorkerPool: 获取就绪节点
    WorkerPool -> Node ++: 执行节点
    
    alt 节点执行成功
        Node -> Node: _run()执行业务逻辑
        Node --> WorkerPool --: NodeRunResult
        WorkerPool -> EventMgr: NodeRunSucceededEvent
        EventMgr --> Controller: 推送事件
        Controller --> Frontend: 更新节点状态
        Frontend --> User: 显示节点完成
        
        Dispatcher -> Engine: EdgeProcessor处理后续边
        Engine -> Engine: 条件分支评估\nSkipPropagator跳过处理
        Engine -> Engine: 入队下一批节点
        
    else 节点执行失败
        Node --> WorkerPool --: 错误信息
        WorkerPool -> EventMgr: NodeRunFailedEvent
        EventMgr --> Controller: 推送错误
        Controller --> Frontend: 显示错误
        Frontend --> User: 错误提示
        
        alt ErrorStrategy.FAIL_BRANCH
            Engine -> Engine: 走失败分支
        else ErrorStrategy.CONTINUE
            Engine -> Engine: 继续执行
        else ErrorStrategy.STOP
            Engine -> Engine: 停止执行
        end
    end
    
    Dispatcher -> CmdChannel: 检查外部命令
    alt 收到AbortCommand
        CmdChannel --> Dispatcher: AbortCommand
        Dispatcher -> Engine: 标记aborted
        Engine -> EventMgr: GraphRunAbortedEvent
    else 收到PauseCommand
        CmdChannel --> Dispatcher: PauseCommand
        Dispatcher -> Engine: 标记paused
        Engine -> EventMgr: GraphRunPausedEvent
    end
end

alt 执行成功
    Engine -> EventMgr: GraphRunSucceededEvent
    EventMgr --> Entry --: outputs
    Entry --> AppGen --: 执行结果
    AppGen -> DB ++: 保存WorkflowRun记录
    DB --> AppGen --: 保存成功
    AppGen --> Controller --: 返回结果
    Controller --> Frontend --: 执行完成
    Frontend --> User --: 显示结果
    
else 部分成功
    Engine -> EventMgr: GraphRunPartialSucceededEvent
    EventMgr --> Entry --: outputs + exceptions_count
    Entry --> AppGen --: 部分成功结果
    AppGen --> Controller --: 返回部分结果
    Controller --> Frontend --: 部分完成
    Frontend --> User --: 显示部分结果
    
else 执行失败
    Engine -> EventMgr: GraphRunFailedEvent
    EventMgr --> Entry --: error信息
    Entry --> AppGen --: 失败信息
    AppGen -> DB ++: 记录失败状态
    DB --> AppGen --: 记录完成
    AppGen --> Controller --: 返回错误
    Controller --> Frontend --: 执行失败
    Frontend --> User --: 显示错误信息
end

Engine -> Dispatcher --: stop()
Engine -> WorkerPool --: stop()

== 工作流停止阶段 ==
User -> Frontend ++: 点击停止
Frontend -> Controller ++: POST /workflows/tasks/{task_id}/stop
Controller -> CmdChannel ++: GraphEngineManager.send_stop_command()
note right of CmdChannel
**RedisChannel发送命令:**
channel_key = workflow:{task_id}:commands
AbortCommand(reason)
end note
CmdChannel -> Cache ++: 发布停止命令
Cache --> CmdChannel --: 发布成功
CmdChannel --> Controller --: 命令已发送
Controller --> Frontend --: 停止请求已提交
Frontend --> User --: 显示停止中

== 单节点调试执行 ==
User -> Frontend ++: 单步调试节点
Frontend -> Controller ++: POST /workflows/draft/nodes/{id}/run
Controller -> Service ++: single_step_run()
Service -> Entry: WorkflowEntry.single_step_run()
Entry -> Entry: 获取节点配置
Entry -> Entry: 初始化GraphInitParams
Entry -> Node ++: 创建节点实例
Node -> Node: init_node_data()
Node -> Node: extract_variable_selector_to_variable_mapping()
Entry -> Entry: mapping_user_inputs_to_variable_pool()
Entry -> Node: run()
Node --> Entry --: Generator[NodeEvent]
Entry --> Service --: (node, generator)
Service --> Controller --: 节点执行结果
Controller --> Frontend --: 返回结果
Frontend --> User --: 显示节点输出

== 核心技术组件说明 ==

note right of Frontend
**前端技术栈**
━━━━━━━━━━━━━━━━
• React 19 + TypeScript
• Next.js 15 App Router
• Zustand 状态管理
• React Flow 工作流画布
• SSE 实时事件推送
• hooks-store 集中管理
end note

note right of Controller
**API层组件**
━━━━━━━━━━━━━━━━
• Flask-RESTX API框架
• JWT认证中间件
• 请求参数解析
• 响应序列化
• 错误处理装饰器
end note

note right of Engine
**图执行引擎核心**
━━━━━━━━━━━━━━━━
• GraphStateManager: 节点状态管理
• ReadyQueue: 就绪节点队列
• EdgeProcessor: 边处理/条件分支
• SkipPropagator: 跳过传播
• ResponseCoordinator: 响应协调
• Layer系统: 可插拔中间件
end note

note right of WorkerPool
**工作池管理**
━━━━━━━━━━━━━━━━
• 动态线程池扩缩容
• Flask上下文传递
• contextvars传播
• 并发执行控制
end note

note right of Node
**节点类型**
━━━━━━━━━━━━━━━━
• StartNode: 开始节点
• LLMNode: LLM调用
• AgentNode: 智能体
• CodeNode: 代码执行
• IfElseNode: 条件分支
• IterationNode: 迭代循环
• LoopNode: 循环节点
• ToolNode: 工具调用
• KnowledgeRetrievalNode: 知识检索
• AnswerNode: 回答输出
• EndNode: 结束节点
end note

note right of CmdChannel
**命令通道**
━━━━━━━━━━━━━━━━
• InMemoryChannel: 进程内通信
• RedisChannel: 分布式通信
• 支持命令: Abort, Pause
end note

note right of DB
**数据模型**
━━━━━━━━━━━━━━━━
• Workflow: 工作流定义
• WorkflowRun: 执行记录
• WorkflowNodeExecution: 节点执行
• VariablePool: 变量存储
end note

@enduml
