# Dify è´¦å·æƒé™ç®¡ç† - å¿«é€Ÿå‚è€ƒ

## ğŸ¯ 5 ä¸ªè§’è‰²ä¸€è§ˆ

| è§’è‰² | ç®€å†™ | æƒé™çº§åˆ« | èƒ½åšä»€ä¹ˆ | ä¸èƒ½åšä»€ä¹ˆ |
|------|------|---------|---------|----------|
| **OWNER** | ğŸ‘‘ | â˜…â˜…â˜…â˜…â˜… | æ‰€æœ‰æ“ä½œï¼ˆé‚€è¯·ã€ç§»é™¤ã€è½¬ç§»ã€è®¾ç½®ï¼‰ | æ—  |
| **ADMIN** | ğŸ”‘ | â˜…â˜…â˜…â˜…â˜† | é‚€è¯·æˆå‘˜ã€ä¿®æ”¹è®¾ç½®ã€ç¼–è¾‘åº”ç”¨ | ç§»é™¤æˆå‘˜ã€è½¬ç§»æ‰€æœ‰æƒ |
| **EDITOR** | âœï¸ | â˜…â˜…â˜…â˜†â˜† | ç¼–è¾‘åº”ç”¨ã€ç¼–è¾‘çŸ¥è¯†åº“ã€ä¸Šä¼ æ–‡æ¡£ | é‚€è¯·ã€ç®¡ç†æˆå‘˜ã€ä¿®æ”¹è®¾ç½® |
| **NORMAL** | ğŸ‘ï¸ | â˜…â˜…â˜†â˜†â˜† | æŸ¥çœ‹åº”ç”¨ã€ç¼–è¾‘çŸ¥è¯†åº“ã€ä¸Šä¼ æ–‡æ¡£ | åˆ›å»ºåº”ç”¨ã€åˆ é™¤å†…å®¹ |
| **DATASET_OPERATOR** | ğŸ“Š | â˜…â˜†â˜†â˜†â˜† | ä»…ç¼–è¾‘çŸ¥è¯†åº“ã€ä¸Šä¼ æ–‡æ¡£ | å…¶ä»–æ‰€æœ‰æ“ä½œ |

---

## ğŸ” ä»¤ç‰Œé€Ÿé€Ÿçœ‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä»¤ç‰Œä¸‰è§’å½¢                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  Access Token (çŸ­æœŸ)       Refresh Token (é•¿æœŸ)    â”‚
â”‚  â€¢ ç”Ÿå‘½å‘¨æœŸï¼š24å°æ—¶        â€¢ ç”Ÿå‘½å‘¨æœŸï¼š30å¤©       â”‚
â”‚  â€¢ ç”¨é€”ï¼šAPI è®¤è¯          â€¢ ç”¨é€”ï¼šè·å–æ–°ä»¤ç‰Œ      â”‚
â”‚  â€¢ ä½ç½®ï¼šCookie/Header     â€¢ ä½ç½®ï¼šCookie         â”‚
â”‚  â€¢ éªŒè¯ï¼šJWT ç­¾å          â€¢ å­˜å‚¨ï¼šRedis          â”‚
â”‚                              â€¢ æ¢å–ï¼šæ–°çš„ AT/RT    â”‚
â”‚                                                     â”‚
â”‚             CSRF Token (é˜²æŠ¤)                      â”‚
â”‚             â€¢ ç”Ÿå‘½å‘¨æœŸï¼šä¼šè¯æœŸé—´                   â”‚
â”‚             â€¢ ç”¨é€”ï¼šé˜²æ­¢è·¨ç«™ä¼ªé€                    â”‚
â”‚             â€¢ ä½ç½®ï¼šCookie/Header/Body             â”‚
â”‚             â€¢ æ£€æŸ¥ï¼šæ‰€æœ‰ POST/PUT/DELETE           â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ 8 ä¸ªæ ¸å¿ƒæµç¨‹

### 1ï¸âƒ£ ç™»å½•
```
ç”¨æˆ·è¾“å…¥é‚®ç®±å¯†ç  
  â†“
éªŒè¯è´¦å·çŠ¶æ€ (éBANNED/CLOSED)
  â†“
éªŒè¯å¯†ç  (SHA256 + Salt)
  â†“
æ›´æ–°ç™»å½•ä¿¡æ¯ (æ—¶é—´ã€IP)
  â†“
ç”Ÿæˆä»¤ç‰Œ (JWT + Refresh + CSRF)
  â†“
å­˜å‚¨åˆ°Redis
```

### 2ï¸âƒ£ é‚€è¯·æˆå‘˜
```
é‚€è¯·è€… (OWNER/ADMIN)
  â†“
æ£€æŸ¥æƒé™ & æˆå‘˜æ•°é‡é™åˆ¶
  â†“
ç”Ÿæˆé‚€è¯·ä»¤ç‰Œ (24h)
  â†“
å‘é€é‚®ä»¶ + æ¿€æ´»é“¾æ¥
  â†“
è¢«é‚€è¯·è€…ç‚¹å‡»é“¾æ¥
  â†“
åˆ›å»º/ç¡®è®¤è´¦å· â†’ åŠ å…¥å·¥ä½œåŒº
```

### 3ï¸âƒ£ æ›´æ–°è§’è‰²
```
æ“ä½œè€…æ£€æŸ¥ï¼šOWNER only
  â†“
ç›®æ ‡æˆå‘˜æ£€æŸ¥ï¼šå­˜åœ¨ + åœ¨å·¥ä½œåŒºå†…
  â†“
è‹¥æ–°è§’è‰²ä¸º OWNERï¼š
  â€¢ åŸæ‰€æœ‰è€… â†’ ADMIN
  â€¢ æ–°æˆå‘˜ â†’ OWNER
  â†“
å…¶ä»–è§’è‰²ï¼šç›´æ¥æ›´æ–°
  â†“
æ¸…é™¤è®¡è´¹ç¼“å­˜
```

### 4ï¸âƒ£ è½¬ç§»æ‰€æœ‰æƒ (3æ­¥)
```
ç¬¬ä¸€æ­¥ï¼šå‘é€ç¡®è®¤é‚®ä»¶
  å‘é€éªŒè¯ç  (6ä½æ•°) â†’ é‚®ä»¶ â†’ 1å°æ—¶æœ‰æ•ˆæœŸ
    â†“
ç¬¬äºŒæ­¥ï¼šéªŒè¯é‚®ç®±å’Œä»£ç 
  æ£€æŸ¥ Token â†’ æ£€æŸ¥é‚®ç®± â†’ æ£€æŸ¥ä»£ç  â†’ ç”Ÿæˆæ–° Token
    â†“
ç¬¬ä¸‰æ­¥ï¼šæ‰§è¡Œè½¬ç§»
  åŸæ‰€æœ‰è€… â†’ ADMIN | æ–°æ‰€æœ‰è€… â†’ OWNER â†’ å‘é€é€šçŸ¥
```

### 5ï¸âƒ£ æƒé™æ£€æŸ¥æµç¨‹
```
Step 1: è®¤è¯æ£€æŸ¥ (@login_required)
Step 2: åˆå§‹åŒ–æ£€æŸ¥ (@account_initialization_required)
Step 3: ä» TenantAccountJoin è·å–è§’è‰²
Step 4: æ£€æŸ¥æƒé™çŸ©é˜µ
Step 5: æ£€æŸ¥ä¸šåŠ¡è§„åˆ™ (ä¸èƒ½æ“ä½œè‡ªå·±ç­‰)
Step 6: æ‰§è¡Œæ“ä½œ
```

### 6ï¸âƒ£ å¯†ç é‡ç½®
```
ç”¨æˆ·è¾“å…¥é‚®ç®±
  â†“
ç”Ÿæˆé‡ç½® Token (1å°æ—¶)
  â†“
å‘é€é‚®ä»¶ + é‡ç½®é“¾æ¥
  â†“
ç”¨æˆ·ç‚¹å‡»é“¾æ¥ï¼Œè¾“å…¥æ–°å¯†ç 
  â†“
éªŒè¯ Token + æ›´æ–°å¯†ç 
  â†“
ä½¿ç”¨æ–°å¯†ç ç™»å½•
```

### 7ï¸âƒ£ ç§»é™¤æˆå‘˜
```
æ“ä½œè€…æ£€æŸ¥ï¼šOWNER only
  â†“
ç›®æ ‡æˆå‘˜æ£€æŸ¥ï¼šå­˜åœ¨ + åœ¨å·¥ä½œåŒºå†…
  â†“
é˜²æ­¢æ“ä½œè‡ªå·±
  â†“
åˆ é™¤ TenantAccountJoin è®°å½•
  â†“
æ¸…é™¤è®¡è´¹ç¼“å­˜
```

### 8ï¸âƒ£ å·¥ä½œåŒºåˆ‡æ¢
```
ç”¨æˆ·æ‹¥æœ‰å¤šä¸ªå·¥ä½œåŒº
  â†“
é€‰æ‹©è¦åˆ‡æ¢çš„å·¥ä½œåŒº
  â†“
éªŒè¯è´¦å·åœ¨è¯¥å·¥ä½œåŒºå­˜åœ¨
  â†“
æ›´æ–° TenantAccountJoin.current = True (å…¶ä»–ä¸ºFalse)
  â†“
åŠ è½½å·¥ä½œåŒºä¿¡æ¯å’Œç”¨æˆ·è§’è‰²
```

---

## ğŸš« 5 ä¸ªæƒé™æ£€æŸ¥çš„å…³é”®ä¿éšœ

```
1. è£…é¥°å™¨å±‚
   @login_required
   @account_initialization_required
   @edit_permission_required
   â†“
2. æ§åˆ¶å™¨å±‚
   current_user = current_account_with_tenant()
   if not user.has_edit_permission:
      abort(403)
   â†“
3. æœåŠ¡å±‚
   TenantService.check_member_permission(
       tenant, operator, member, action
   )
   â†“
4. æ•°æ®å±‚
   æ•°æ®åº“çº¦æŸï¼š(tenant_id, account_id) unique
   â†“
5. è¿è¡Œæ—¶
   è§’è‰²ä»æ•°æ®åº“é‡æ–°åŠ è½½
   æƒé™åŠ¨æ€æ£€æŸ¥
```

---

## ğŸ” æƒé™å†³ç­–æ ‘

```
è¯·æ±‚åˆ°è¾¾
  â†“
[æ˜¯å¦ç™»å½•?]
  â”œâ”€ å¦ â†’ 401 Unauthorized
  â””â”€ æ˜¯ â†“
[è´¦å·æ˜¯å¦åˆå§‹åŒ–?]
  â”œâ”€ å¦ â†’ éœ€åˆå§‹åŒ–
  â””â”€ æ˜¯ â†“
[æ˜¯å¦åœ¨å·¥ä½œåŒº?]
  â”œâ”€ å¦ â†’ 404 Not Found
  â””â”€ æ˜¯ â†“
[è·å–ç”¨æˆ·è§’è‰²]
  â†“ (ä» TenantAccountJoin)
[æ£€æŸ¥æƒé™çŸ©é˜µ]
  â”œâ”€ æƒé™ä¸è¶³ â†’ 403 Forbidden
  â””â”€ æƒé™å……è¶³ â†“
[æ£€æŸ¥ä¸šåŠ¡è§„åˆ™]
  â”œâ”€ è§„åˆ™è¿å â†’ 400 Bad Request
  â””â”€ è§„åˆ™åˆæ³• â†“
[æ‰§è¡Œæ“ä½œ]
  â””â”€ æˆåŠŸ â†’ 200 OK
```

---

## â±ï¸ æ—¶é—´é™åˆ¶å‚è€ƒ

| é¡¹ç›® | æœ‰æ•ˆæœŸ | è¯´æ˜ |
|------|--------|------|
| Access Token | 24å°æ—¶ | API è®¤è¯å‡­è¯ |
| Refresh Token | 30å¤© | åˆ·æ–°è®¿é—®ä»¤ç‰Œç”¨ |
| é‚€è¯·ä»¤ç‰Œ | 24å°æ—¶ | é‚€è¯·æ¿€æ´»ç”¨ |
| å¯†ç é‡ç½®ä»¤ç‰Œ | 1å°æ—¶ | å¯†ç é‡ç½®ç”¨ |
| æ‰€æœ‰æƒè½¬ç§»ä»¤ç‰Œ | 1å°æ—¶ | è½¬ç§»ç¡®è®¤ç”¨ |
| éªŒè¯ç  | 1å°æ—¶ | é‚®ä»¶éªŒè¯ç”¨ |
| ç™»å½•å¤±è´¥é™åˆ¶ | 1å°æ—¶ | é”™è¯¯æ¬¡æ•°è®¡æ•° |
| é‚®ä»¶å‘é€é™åˆ¶ | 1åˆ†é’Ÿ | IP çº§åˆ«é™åˆ¶ |

---

## ğŸ’¾ Redis é”®æ ¼å¼é€ŸæŸ¥

```
refresh_token:{token_hash}
  â†’ account_id

account_refresh_token:{account_id}
  â†’ refresh_token

invitation_token:{token_hash}
  â†’ {email, role, inviter_id}

owner_transfer_token:{token_hash}
  â†’ {email, code}

login_error_limit:{email}
  â†’ error_count

rate_limit:{tenant_id}
  â†’ sorted_set (æ—¶é—´æˆ³é›†åˆ)
```

---

## âŒ å¸¸è§é”™è¯¯åŠè§£å†³

| é”™è¯¯ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|---------|
| `403 Forbidden` | æƒé™ä¸è¶³ | æ£€æŸ¥ç”¨æˆ·è§’è‰²ï¼Œç¡®è®¤æ“ä½œæ˜¯å¦å…è®¸ |
| `401 Unauthorized` | æœªç™»å½•æˆ–ä»¤ç‰Œè¿‡æœŸ | é‡æ–°ç™»å½•æˆ–ä½¿ç”¨åˆ·æ–°ä»¤ç‰Œ |
| `404 Not Found` | èµ„æºä¸å­˜åœ¨ | æ£€æŸ¥ ID æ˜¯å¦æ­£ç¡®ï¼Œå·¥ä½œåŒºæ˜¯å¦å­˜åœ¨ |
| `400 cannot-operate-self` | å¯¹è‡ªå·±æ“ä½œ | ä¸èƒ½ç§»é™¤/ä¿®æ”¹è‡ªå·± |
| `400 member-not-found` | æˆå‘˜ä¸åœ¨å·¥ä½œåŒº | æ£€æŸ¥æˆå‘˜æ˜¯å¦åŠ å…¥å·¥ä½œåŒº |
| `429 Too Many Requests` | é€Ÿç‡é™åˆ¶ | ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯• |
| `EmailCodeError` | éªŒè¯ç é”™è¯¯ | æ£€æŸ¥é‚®ä»¶ä¸­çš„éªŒè¯ç  |
| `InvalidTokenError` | ä»¤ç‰Œè¿‡æœŸ/æ— æ•ˆ | é‡æ–°æ‰§è¡Œæ“ä½œï¼Œè·å–æ–°ä»¤ç‰Œ |

---

## ğŸ”— API å¿«é€ŸæŸ¥è¯¢

### è®¤è¯ç±»
```bash
# ç™»å½•
POST /auth/login
{email, password, remember_me, invite_token}

# æ³¨å†Œ
POST /auth/register
{email, password, name, language}

# é‡ç½®å¯†ç 
POST /auth/reset-password
{email, language}

# æ¿€æ´»è´¦å·ï¼ˆé‚€è¯·ï¼‰
POST /auth/activate
{email, password, token, language}

# ç™»å‡º
POST /auth/logout
```

### æˆå‘˜ç®¡ç†ç±»
```bash
# è·å–æˆå‘˜åˆ—è¡¨
GET /workspaces/current/members

# é‚€è¯·æˆå‘˜
POST /workspaces/current/members/invite-email
{emails: [], role, language}

# ç§»é™¤æˆå‘˜
DELETE /workspaces/current/members/{member_id}

# æ›´æ–°è§’è‰²
PUT /workspaces/current/members/{member_id}/update-role
{role}

# æ•°æ®é›†æ“ä½œå‘˜
GET /workspaces/current/dataset-operators
```

### æ‰€æœ‰æƒè½¬ç§»ç±»
```bash
# å‘é€ç¡®è®¤é‚®ä»¶
POST /workspaces/current/members/send-owner-transfer-confirm-email
{language}

# éªŒè¯éªŒè¯ç 
POST /workspaces/current/members/owner-transfer-check
{code, token}

# æ‰§è¡Œè½¬ç§»
POST /workspaces/current/members/{member_id}/owner-transfer
{token}
```

---

## ğŸ“Š çŠ¶æ€æœºå›¾

### è´¦å·çŠ¶æ€
```
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   PENDING   â”‚
         â”‚  (æ–°å»º)      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                  â”‚ (é¦–æ¬¡ç™»å½•)
                  â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  UNINITIALIZED  â”‚
         â”‚  (åˆå§‹åŒ–å‰)     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ (å®Œæˆåˆå§‹åŒ–)
                  â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   ACTIVE    â”‚ â†â”€â”€â”
         â”‚  (æ¿€æ´»)      â”‚    â”‚ (è§£ç¦)
         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
              â”‚ (ç¦ç”¨)     â”Œâ”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
              â””â”€â”€â”€â”€â”€â”€â”€â†’   â”‚  BANNED  â”‚
                          â”‚ (ç¦ç”¨)    â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚    CLOSED            â”‚
         â”‚ (å·²å…³é—­ï¼Œä¸å¯æ¢å¤)    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†‘ (åˆ é™¤)
           â””â”€â”€â”€â”€â”€â”€â”€ from any state
```

### å·¥ä½œåŒºçŠ¶æ€
```
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  NORMAL  â”‚
    â”‚ (æ­£å¸¸)   â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚ (å½’æ¡£)
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ARCHIVE  â”‚
    â”‚(å½’æ¡£)    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ å­¦ä¹ è·¯å¾„å»ºè®®

### åˆçº§ (ç†è§£åŸºç¡€)
1. é˜…è¯»è§’è‰²çŸ©é˜µå’Œ 5 ä¸ªæƒé™æ£€æŸ¥ä¿éšœ
2. æŸ¥çœ‹ 8 ä¸ªæ ¸å¿ƒæµç¨‹çš„æµç¨‹å›¾
3. ç†è§£ä»¤ç‰Œä¸‰è§’å½¢å’Œæ—¶é—´é™åˆ¶

### ä¸­çº§ (æŒæ¡å®ç°)
1. è¯»å®Œæ•´çš„åˆ†ææ–‡æ¡£
2. æŸ¥çœ‹æ‰€æœ‰ 4 ä¸ªæ—¶åºå›¾
3. ç†è§£æƒé™æ£€æŸ¥æµç¨‹å’Œå†³ç­–æ ‘

### é«˜çº§ (æ‰©å±•å’Œä¼˜åŒ–)
1. ç ”ç©¶å®ç°ç»†èŠ‚æ–‡æ¡£
2. åˆ†æ Redis ç¼“å­˜ç­–ç•¥
3. å­¦ä¹ æ‰©å±•æ€§æŒ‡å—ï¼ˆæ·»åŠ æ–°è§’è‰²ç­‰ï¼‰
4. ç ”ç©¶ä»£ç å®ç°ç»†èŠ‚

---

## ğŸ“ å¸¸ç”¨å‘½ä»¤å‚è€ƒ

### Redis æ£€æŸ¥
```bash
# æŸ¥çœ‹æ‰€æœ‰åˆ·æ–°ä»¤ç‰Œ
redis-cli KEYS "refresh_token:*"

# æŸ¥çœ‹ç‰¹å®šè´¦å·çš„ä»¤ç‰Œ
redis-cli GET "account_refresh_token:{account_id}"

# æ£€æŸ¥ç™»å½•å¤±è´¥æ¬¡æ•°
redis-cli GET "login_error_limit:{email}"
```

### æ•°æ®åº“æŸ¥è¯¢
```sql
-- æŸ¥çœ‹ç”¨æˆ·åœ¨æ‰€æœ‰å·¥ä½œåŒºçš„è§’è‰²
SELECT t.name, taj.role FROM tenants t
JOIN tenant_account_joins taj ON t.id = taj.tenant_id
WHERE taj.account_id = '{user_id}';

-- æŸ¥çœ‹å·¥ä½œåŒºçš„æ‰€æœ‰æˆå‘˜
SELECT a.name, a.email, taj.role FROM accounts a
JOIN tenant_account_joins taj ON a.id = taj.account_id
WHERE taj.tenant_id = '{tenant_id}';

-- æ£€æŸ¥å½“å‰çš„æ‰€æœ‰è€…
SELECT a.name, a.email FROM accounts a
JOIN tenant_account_joins taj ON a.id = taj.account_id
WHERE taj.tenant_id = '{tenant_id}' AND taj.role = 'owner';
```
