@startuml AccountPermission_MemberInvite
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #1976D2
skinparam sequenceActorBorderColor #426450ff
skinparam sequenceParticipantBorderColor #6C757D
skinparam SequenceParticipantBorderThickness 2
skinparam sequenceLifeLineBorderColor #9bd0f5ff
skinparam noteBackgroundColor #FFF3E0
skinparam noteBorderColor #F57C00
skinparam style strictuml
skinparam Padding 6
skinparam ParticipantPadding 30

title Dify 账号权限管理核心流程 - 2. 成员邀请与加入

participant Inviter as "邀请者\n(OWNER/ADMIN)"
participant API as "邀请API\n(/invite-email)"
participant AuthService as "认证检查"
participant TenantService as "TenantService\n(工作区服务)"
participant RegisterService as "RegisterService\n(注册服务)"
participant Database as "数据库"
participant EmailService as "邮件任务\n(Celery)"
participant Invitee as "被邀请者\n(邮件接收者)"

autonumber

Inviter ->> API: POST /workspaces/current/members/invite-email\n{emails: [email1, email2], role: "editor"}
activate API

note over API
  装饰器检查：
  - @login_required
  - @setup_required
  - @account_initialization_required
  - @cloud_edition_billing_resource_check("members")
end note

API ->> AuthService: current_account_with_tenant()
activate AuthService
AuthService -->> API: (current_user, current_tenant)
deactivate AuthService

note over API
  权限检查：
  - 验证当前用户的角色
  - 确认是否为 OWNER 或 ADMIN
  - 验证角色参数有效性
end note

API ->> TenantService: get_features()
activate TenantService
TenantService -->> API: workspace_members feature
deactivate TenantService

note over API
  业务逻辑检查：
  - 检查邀请数量不超过成员限制
  - 遍历邮箱列表进行邀请
end note

loop 对每个邀请邮箱
  API ->> RegisterService: invite_new_member(\n  tenant, email, language, role, inviter)
  activate RegisterService
  
  note over RegisterService
    1. 检查邮箱是否已存在账号
    2. 生成邀请令牌（包含email, role, inviter信息）
    3. 令牌存储在 Redis（有效期24小时）
  end note
  
  RegisterService ->> Database: 检查账号是否已在工作区
  activate Database
  Database -->> RegisterService: 结果
  deactivate Database
  
  alt 账号已在工作区
    RegisterService -->> API: AccountAlreadyInTenantError
    API ->> API: 记录为 "success"\n返回登录链接
  else 账号不存在或需要邀请
    RegisterService ->> RegisterService: token = generate_invitation_token(\n  {email, role, inviter_id})
    
    RegisterService ->> RegisterService: 令牌存储在 Redis\nEX 86400 (24小时)
    
    RegisterService ->> EmailService: send_invite_member_mail_task(\n  email, token, workspace_name, language)
    activate EmailService
    
    note over EmailService
      生成激活链接：
      {CONSOLE_WEB_URL}/activate?email={encoded_email}&token={token}
    end note
    
    EmailService -->> RegisterService: task_id
    deactivate EmailService
    
    RegisterService -->> API: token
    
    API ->> API: 构建响应\n{status: "success", url, email}
  end
  
  deactivate RegisterService
end

API -->> Inviter: {result: "success", invitation_results: [...]}\n200 Created

deactivate API

note over Inviter
  邀请完成，返回包含激活链接的URL列表
  邀请者可以复制链接或邮件会自动发送
end note

Invitee ->> Invitee: 收到邀请邮件\n点击激活链接

Invitee ->> API: GET /activate?email=...&token=...
activate API

API ->> RegisterService: get_invitation_if_token_valid(\n  email, token)
activate RegisterService

note over RegisterService
  令牌验证：
  1. 从 Redis 获取令牌数据
  2. 验证邮箱匹配
  3. 验证令牌未过期
  4. 提取 role 和 inviter 信息
end note

RegisterService ->> Database: 检查邮箱对应的账号
activate Database
Database -->> RegisterService: Account | null
deactivate Database

alt 账号不存在 (新用户)
  RegisterService ->> Database: 创建新账号\nAccount(email, name, status=PENDING)
  activate Database
  Database -->> RegisterService: new_account
  deactivate Database
else 账号存在
  note over RegisterService
    如果用户已有账号，直接使用
  end note
end

RegisterService -->> API: {token_valid: true, data: {email, role, inviter_id}}
deactivate RegisterService

API -->> Invitee: 返回激活页面\n(显示注册/设置密码表单)

deactivate API

Invitee ->> API: POST /activate\n{email, password, token, language}
activate API

note over API
  激活流程：
  1. 调用 AccountService.authenticate(\n     email, password, invite_token)
  2. 如果是邀请令牌，允许设置密码
  3. 创建 Tenant 如果不存在
  4. 添加成员到工作区
end note

API ->> TenantService: create_tenant_member(\n  tenant, account, role)
activate TenantService

TenantService ->> Database: INSERT INTO tenant_account_joins\n(tenant_id, account_id, role, invited_by)
activate Database
Database -->> TenantService: TenantAccountJoin record
deactivate Database

TenantService -->> API: success
deactivate TenantService

API -->> Invitee: {result: "success"}\n+ Set-Cookie (access_token, refresh_token)

deactivate API

note over Invitee
  激活完成，用户现已：
  1. 创建/确认账号
  2. 设置密码（新用户）
  3. 加入工作区，获得指定的角色
  4. 获得认证令牌，可登录使用
end note

@enduml
